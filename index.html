<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RKT - Rapor Kelas Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#ffffff" />
    
    <style>
        #loader-wrapper {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: rgba(248, 250, 252, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        #loader-wrapper.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loader {
            border: 4px solid #e2e8f0; border-top: 4px solid #4f46e5;
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        .loader-text { margin-top: 16px; color: #475569; font-weight: 500; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #offline-indicator {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #475569;
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 9999px;
            font-weight: 500;
            z-index: 10001;
            transition: bottom 0.5s ease-in-out;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #offline-indicator.show {
            bottom: 20px;
        }
    </style>

    <!-- Script loading order is critical for on-the-fly transpilation -->

    <!-- 1. Babel for transpilation (must be loaded before the fetch hook) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 2. Fetch hook to transpile JSX/TS before modules are executed -->
    <script>
      // This hook must be defined before es-module-shims is loaded to prevent race conditions.
      // It intercepts requests for local .js files and transpiles them using Babel.
      window.importShim = window.importShim || {};
      importShim.fetch = async function (url) {
        const response = await fetch(url);
        // Only transpile local .js files that are not from a CDN by checking the origin
        if (url.href.endsWith('.js') && url.origin === window.location.origin) {
            if (!response.ok) return response;
            const code = await response.text();
            try {
              // Ensure Babel is loaded
              if (!window.Babel) {
                  throw new Error("Babel is not loaded!");
              }
              const transformedCode = Babel.transform(code, {
                presets: ['react', 'typescript'],
                filename: url.href 
              }).code;
              return new Response(new Blob([transformedCode], { type: 'application/javascript' }));
            } catch(e) {
              console.error(`Babel Error in ${url.href}:`, e);
              // Return original code to see the syntax error in devtools
              return new Response(new Blob([code], { type: 'application/javascript' }));
            }
        }
        return response;
      };
    </script>

    <!-- 3. ES Module Shims for importmap and fetch hook support -->
    <script async src="https://unpkg.com/es-module-shims@1.10.0/dist/es-module-shims.js"></script>
    
    <!-- 4. Import Map for module resolution (must be after the shims script) -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "@google/genai": "https://esm.sh/@google/genai"
  }
}
</script>

  </head>
  <body class="bg-slate-50 flex flex-col min-h-screen">
    <div id="loader-wrapper">
        <div class="loader"></div>
        <p class="loader-text">Memuat Aplikasi...</p>
    </div>

    <div id="root" class="flex-grow"></div>

    <div id="offline-indicator">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
        </svg>
        <span>Anda sedang offline.</span>
    </div>

    <footer class="text-center py-4 px-4 text-xs text-slate-500">
        Dibuat dengan ❤️ untuk para pendidik | 
        <a href="./terms.html" target="_blank" rel="noopener noreferrer" class="font-medium text-indigo-600 hover:underline">Ketentuan Layanan</a> &
        <a href="./privacy.html" target="_blank" rel="noopener noreferrer" class="font-medium text-indigo-600 hover:underline">Kebijakan Privasi</a>
    </footer>

    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <!-- 5. Application Entry Point (now a module-shim) -->
    <script type="module-shim">
      import React from 'react';
      import ReactDOM from 'react-dom/client';
      import App from './App.js';

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>

    <!-- 6. PWA Helper Scripts -->
    <script>
      const offlineIndicator = document.getElementById('offline-indicator');
      const updateOnlineStatus = () => {
        if (navigator.onLine) {
          offlineIndicator.classList.remove('show');
        } else {
          offlineIndicator.classList.add('show');
        }
      };

      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus(); // Check status on initial load
    </script>
  </body>
</html>
