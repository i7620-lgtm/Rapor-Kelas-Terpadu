
<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Aplikasi rapor kelas yang berjalan sepenuhnya offline di browser. Semua data dapat diimpor dan diekspor melalui file Excel untuk portabilitas." />
    <title>Rapor Kelas Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Google API Scripts -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .report-card { box-shadow: none !important; border: none !important; page-break-after: always; }
        }
        .view { display: none; }
        .view.active { display: block; }
        .sidebar-item.active { background-color: #1d4ed8; color: white; }
        .grades-tab-btn, .p5-project-tab {
            border-color: transparent;
            color: #6b7280; /* text-gray-500 */
        }
        .grades-tab-btn.active, .p5-project-tab.active {
            border-color: #2563eb; /* border-blue-600 */
            color: #1e3a8a; /* text-blue-800 */
        }
        .overall-grades-table th.subject-col {
            width: 65px;
            text-align: center;
        }
        .overall-grades-table td {
            vertical-align: middle;
        }
        .sync-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #9ca3af; /* gray-400 */
        }
        .sync-status-indicator.synced { background-color: #22c55e; /* green-500 */ }
        .sync-status-indicator.syncing { background-color: #f59e0b; /* amber-500 */ }
        .sync-status-indicator.error { background-color: #ef4444; /* red-500 */ }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-64 bg-blue-900 text-white p-4 flex-shrink-0 no-print flex flex-col">
            <div class="text-center mb-8">
                <div class="text-5xl font-extrabold tracking-wider">RKT</div>
                <p class="text-lg mt-2 text-blue-200" style="font-size: 1.2rem; margin-top: 0.75rem;">Rapor Kelas Terpadu</p>
            </div>
            <ul class="space-y-2 flex-grow">
                <li><a href="#dashboard" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Dashboard</a></li>
                <li><a href="#students" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Siswa</a></li>
                <li><a href="#grades" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Nilai</a></li>
                <li><a href="#extracurricular" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Ekstrakurikuler</a></li>
                <li><a href="#p5" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Projek P5</a></li>
                <li><a href="#attendance" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Absensi</a></li>
                <li><a href="#notes" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Catatan Wali Kelas</a></li>
                <li><a href="#print" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Print Rapor</a></li>
                <li><a href="#settings" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Pengaturan</a></li>
            </ul>
            <!-- Google Sync Section -->
            <div id="google-sync-section" class="mt-4 pt-4 border-t border-blue-700">
                <div class="flex items-center mb-2">
                     <span id="sync-status-indicator" class="sync-status-indicator" title="Status Sinkronisasi"></span>
                     <span id="sync-status-text" class="text-sm font-medium text-blue-200">Sinkronisasi Google</span>
                </div>
                <div id="auth-container">
                    <button id="authorize_button" class="w-full bg-white text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">Login dengan Google</button>
                    <button id="signout_button" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors hidden">Logout</button>
                </div>
                <p id="user-profile" class="text-xs text-center mt-2 text-blue-300 hidden"></p>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            
            <!-- Dashboard View -->
            <section id="view-dashboard" class="view">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-3xl font-bold">Dashboard</h2>
                    <div id="dashboard-sync-status" class="flex items-center text-sm bg-gray-200 px-3 py-1 rounded-full">
                        <!-- Status will be injected by JS -->
                    </div>
                </div>
                <p class="text-lg text-gray-600 mb-6">Selamat datang, <span id="dashboard-teacher-name" class="font-semibold"></span>!</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Kelas</h3>
                        <p id="dashboard-class-name" class="text-3xl font-bold mt-2">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Jumlah Siswa</h3>
                        <p id="dashboard-student-count" class="text-3xl font-bold mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Tahun Ajaran</h3>
                        <p id="dashboard-school-year" class="text-3xl font-bold mt-2">-</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Semester</h3>
                        <p id="dashboard-semester" class="text-3xl font-bold mt-2">-</p>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Sinkronisasi & Analisis</h3>
                     <div id="dashboard-sync-controls" class="mb-4 text-center hidden">
                        <button id="google-sync-save-btn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 text-lg">
                            Simpan & Sinkronkan ke Google Sheets
                        </button>
                        <p class="text-sm mt-2 text-gray-500">Menyimpan data ke Google Sheets akan menimpa data yang ada di cloud.</p>
                    </div>
                    <div id="dashboard-analysis-content">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>
            </section>

            <!-- Students View -->
            <section id="view-students" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Siswa</h2>
                    <div class="flex gap-2">
                        <button id="add-student-btn" class="bg-sky-700 text-white px-4 py-2 rounded-md hover:bg-sky-800">Tambah Siswa</button>
                        <button id="download-template-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Unduh Data</button>
                        <label for="upload-students-input" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer">Unggah Data Siswa</label>
                        <input type="file" id="upload-students-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 w-16">No. Absen</th>
                                <th class="p-3">Nama Lengkap</th>
                                <th class="p-3">Nama Panggilan</th>
                                <th class="p-3">NIS</th>
                                <th class="p-3">NISN</th>
                                <th class="p-3 w-56 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <!-- Student rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Grades View -->
            <section id="view-grades" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Nilai</h2>
                    <div class="flex gap-2">
                        <button id="edit-grades-btn" class="bg-blue-800 text-white px-4 py-2 rounded-md hover:bg-blue-900">Edit Nilai Siswa</button>
                        <button id="download-grades-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Unduh Nilai</button>
                        <label for="upload-grades-input" class="bg-sky-500 text-white px-4 py-2 rounded-md hover:bg-sky-600 cursor-pointer">Unggah Data Nilai</label>
                        <input type="file" id="upload-grades-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex border-b mb-6">
                        <button data-tab="list" class="grades-tab-btn py-2 px-4 border-b-2 font-semibold transition-colors duration-300">Daftar Nilai Keseluruhan</button>
                        <button data-tab="input" class="grades-tab-btn py-2 px-4 border-b-2 font-semibold transition-colors duration-300">Input Nilai per Mapel</button>
                    </div>
                    
                    <!-- Overall Grades List View -->
                    <div id="grades-content-list" class="grades-content">
                        <!-- Content injected by JS -->
                    </div>
        
                    <!-- Grade Input by Subject View -->
                    <div id="grades-content-input" class="grades-content hidden">
                         <!-- Content injected by JS -->
                    </div>
                </div>
            </section>
            
            <!-- Extracurricular View -->
            <section id="view-extracurricular" class="view">
                <!-- JS will inject content -->
            </section>
            
            <!-- P5 View -->
            <section id="view-p5" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Projek P5</h2>
                    <a href="#settings" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Kelola Proyek P5</a>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="p5-project-tabs-container" class="flex border-b mb-6 overflow-x-auto">
                        <!-- Project tabs will be injected here -->
                    </div>
                    <div id="p5-project-content-container">
                        <!-- Content for the selected project will be injected here -->
                    </div>
                </div>
            </section>
            
            <!-- Attendance View -->
            <section id="view-attendance" class="view">
                <!-- JS will inject content -->
            </section>
            
            <!-- Notes View -->
            <section id="view-notes" class="view">
                <!-- JS will inject content -->
            </section>

            <!-- Print View -->
            <section id="view-print" class="view">
                <div class="no-print">
                    <h2 class="text-3xl font-bold mb-6">Print Rapor</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <p class="mb-4">Klik tombol di bawah ini untuk menghasilkan pratinjau semua rapor, lalu gunakan tombol cetak untuk mencetaknya.</p>
                        <button id="generate-all-reports-btn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 text-lg">Hasilkan Pratinjau Rapor</button>
                        <button id="print-all-reports-btn" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 text-lg ml-4 hidden">Cetak Semua Rapor</button>
                    </div>
                </div>
                <div id="print-output-area" class="mt-8 space-y-8">
                    <!-- Report cards will be injected here -->
                </div>
            </section>

            <!-- Settings View -->
            <section id="view-settings" class="view">
                <div class="sticky top-0 bg-gray-100 z-40 border-b -mx-8 -mt-8 px-8 pt-8 pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold">Pengaturan</h2>
                        <div class="flex items-center gap-3">
                            <button id="cancel-settings-btn" type="button" class="bg-white text-gray-700 px-5 py-2 rounded-md border border-gray-300 hover:bg-gray-50 text-base font-medium">Batal</button>
                            <button id="save-settings-btn" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 text-base font-medium">Simpan Perubahan</button>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-8 pt-4">
                    <!-- Profil Sekolah -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Profil Sekolah</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="setting-schoolName" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                                <input type="text" id="setting-schoolName" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-npsn" class="block text-sm font-medium text-gray-700 mb-1">NPSN</label>
                                <input type="text" id="setting-npsn" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="setting-schoolAddress" class="block text-sm font-medium text-gray-700 mb-1">Alamat Sekolah</label>
                                <input type="text" id="setting-schoolAddress" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-village" class="block text-sm font-medium text-gray-700 mb-1">Desa/Kelurahan</label>
                                <input type="text" id="setting-village" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-district" class="block text-sm font-medium text-gray-700 mb-1">Kecamatan</label>
                                <input type="text" id="setting-district" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-province" class="block text-sm font-medium text-gray-700 mb-1">Provinsi</label>
                                <input type="text" id="setting-province" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-postalCode" class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label>
                                <input type="text" id="setting-postalCode" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-schoolEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Sekolah</label>
                                <input type="email" id="setting-schoolEmail" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-schoolPhone" class="block text-sm font-medium text-gray-700 mb-1">Telepon Sekolah</label>
                                <input type="tel" id="setting-schoolPhone" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-website" class="block text-sm font-medium text-gray-700 mb-1">Website Sekolah</label>
                                <input type="url" id="setting-website" placeholder="https://..." class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-fax" class="block text-sm font-medium text-gray-700 mb-1">Faksimile</label>
                                <input type="text" id="setting-fax" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Logo Sekolah</label>
                                <div class="flex items-center gap-4 mt-2">
                                    <img id="logo-preview" src="" alt="Pratinjau Logo" class="h-24 w-24 object-contain rounded-md border p-1 bg-gray-50 hidden">
                                    <div id="logo-placeholder" class="h-24 w-24 flex items-center justify-center rounded-md border border-dashed bg-gray-50 text-gray-400 text-xs text-center p-2">Tidak ada logo</div>
                                    <input type="file" id="setting-schoolLogo" class="form-input text-sm w-full max-w-xs" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Periode Akademik -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Periode Akademik</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="setting-className" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                                <input type="text" id="setting-className" placeholder="e.g., Kelas 4A" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-schoolYear" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label>
                                <input type="text" id="setting-schoolYear" placeholder="e.g., 2024/2025" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-semester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="text" id="setting-semester" placeholder="e.g., Ganjil" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-reportDate" class="block text-sm font-medium text-gray-700 mb-1">Tempat, Tanggal Rapor</label>
                                <input type="text" id="setting-reportDate" placeholder="e.g., Jakarta, 17 Desember 2024" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Kepala Sekolah & Guru -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Kepala Sekolah & Guru</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                             <div>
                                <label for="setting-headmasterName" class="block text-sm font-medium text-gray-700 mb-1">Nama Kepala Sekolah</label>
                                <input type="text" id="setting-headmasterName" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-headmasterNip" class="block text-sm font-medium text-gray-700 mb-1">NIP Kepala Sekolah</label>
                                <input type="text" id="setting-headmasterNip" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-teacherName" class="block text-sm font-medium text-gray-700 mb-1">Nama Wali Kelas</label>
                                <input type="text" id="setting-teacherName" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-teacherNip" class="block text-sm font-medium text-gray-700 mb-1">NIP Wali Kelas</label>
                                <input type="text" id="setting-teacherNip" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Konfigurasi Akademik -->
                    <div id="academic-config-section" class="hidden">
                        <fieldset class="bg-white p-6 rounded-lg shadow-md">
                            <div class="border-b border-gray-200 pb-3 mb-4">
                               <h3 class="text-xl font-semibold text-gray-900">Konfigurasi Akademik Kelas <span id="academic-config-grade" class="font-bold"></span></h3>
                            </div>
                            
                            <!-- Grade Ranges -->
                            <h4 class="font-semibold text-lg mb-3">Rentang Nilai Predikat</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Predikat A (Mulai dari)</label>
                                    <input type="number" id="setting-grade-A" placeholder="e.g., 90" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Predikat B (Mulai dari)</label>
                                    <input type="number" id="setting-grade-B" placeholder="e.g., 80" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Predikat C (KKM)</label>
                                    <input type="number" id="setting-grade-C" placeholder="e.g., 70" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-2">Nilai di bawah ini akan ditandai.</p>
                                </div>
                            </div>

                            <!-- Subjects -->
                            <h4 class="font-semibold text-lg mb-3 border-t pt-4">Mata Pelajaran & Deskripsi Rapor</h4>
                            <div id="subjects-list" class="mb-6">
                                <!-- Subject editor will be injected here -->
                            </div>
                            <form id="add-subject-form" class="flex gap-4">
                                <input type="text" id="subject-name" placeholder="Nama Mata Pelajaran Baru" class="form-input flex-1 rounded-md border-gray-300 bg-gray-50" required>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Tambah Mapel</button>
                            </form>
                            
                            <!-- Deleted Subjects -->
                             <div id="deleted-subjects-container" class="mt-8 hidden">
                                <h5 class="font-semibold text-md mb-3 border-t pt-5 text-gray-800">Mata Pelajaran yang Dihapus</h5>
                                <p class="text-sm text-gray-500 mb-3">Klik untuk mengembalikan mata pelajaran ke daftar.</p>
                                <div id="deleted-subjects-list" class="flex flex-wrap gap-2">
                                    <!-- Deleted subject buttons will be injected here -->
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Konfigurasi Ekstrakurikuler -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Konfigurasi Ekstrakurikuler</h3>
                        </div>
                        <div id="extracurricular-config-list" class="mb-4 space-y-2">
                            <!-- JS will inject extracurricular list -->
                        </div>
                        <form id="add-extracurricular-form" class="flex gap-4">
                            <input type="text" id="extracurricular-name-input" placeholder="Nama Ekstrakurikuler Baru (e.g., Pramuka)" class="form-input flex-1 rounded-md border-gray-300 bg-gray-50" required>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Tambah Ekstrakurikuler</button>
                        </form>
                    </fieldset>

                    <!-- Konfigurasi Projek P5 -->
                    <fieldset id="p5-config-section" class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4 flex justify-between items-center">
                           <h3 class="text-xl font-semibold text-gray-900">Konfigurasi Projek P5</h3>
                           <button id="add-p5-project-btn" data-action="add-project" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Tambah Proyek Baru</button>
                        </div>
                        <div id="p5-editor-container" class="space-y-4">
                            <!-- P5 Editor will be injected here -->
                        </div>
                    </fieldset>

                </div>
            </section>
        </main>
    </div>

    <!-- Global Modal -->
    <div id="app-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div id="modal-content-wrapper" class="relative mx-auto p-2 border shadow-lg rounded-md bg-white w-full">
            <!-- Modal content goes here -->
        </div>
    </div>


<script>

// --- Google API Integration ---
// GANTI DENGAN KREDENSIAL ANDA DARI GOOGLE CLOUD CONSOLE
const API_KEY = 'AIzaSyCnWlB1fBkuFysAy81ui35FUFCKa1rn6F4';
const CLIENT_ID = '584511730006-665o1b5cgqp6bam2mdribmgk6j6ia7vt.apps.googleusercontent.com';

const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest", "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
const SCOPES = "https://www.googleapis.com/auth/drive.file";

let tokenClient;
let gapiInited = false;
let gisInited = false;
let isLoggedIn = false;

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: DISCOVERY_DOCS,
    });
    gapiInited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
    });
    gisInited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.visibility = 'visible';
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        isLoggedIn = true;
        updateUIOnLogin();
        await App.syncWithGoogleSheets(true); // Sync on login (fetch only)

        // Ambil info profil pengguna
        try {
            const profile = await gapi.client.oauth2.userinfo.get();
            document.getElementById('user-profile').textContent = `Login sebagai: ${profile.result.email}`;
            document.getElementById('user-profile').classList.remove('hidden');
        } catch(e) { console.error("Error fetching user profile", e); }
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        isLoggedIn = false;
        updateUIOnLogout();
    }
}

function updateUIOnLogin() {
    document.getElementById('authorize_button').classList.add('hidden');
    document.getElementById('signout_button').classList.remove('hidden');
    document.getElementById('dashboard-sync-controls').classList.remove('hidden');
    App.updateSyncStatus('synced', 'Terhubung ke Google');
}

function updateUIOnLogout() {
    document.getElementById('authorize_button').classList.remove('hidden');
    document.getElementById('signout_button').classList.add('hidden');
    document.getElementById('dashboard-sync-controls').classList.add('hidden');
    document.getElementById('user-profile').classList.add('hidden');
    App.updateSyncStatus('disconnected', 'Sinkronisasi Google');
}


// --- Main App Logic ---
document.addEventListener('DOMContentLoaded', () => {

    const App = {
        islamCpsByGrade: {
            1: [
                'Mengenal rukun iman dan rukun Islam.',
                'Menghafal doa-doa harian pendek.',
                'Meneladani akhlak terpuji di rumah dan sekolah.',
                'Mengenal kisah nabi dan rasul.'
            ],
            2: [
                'Memahami tata cara wudu dan salat dengan benar.',
                'Menghafal surat-surat pendek Al-Qur’an.',
                'Menunjukkan perilaku jujur dan amanah.',
                'Mengenal ibadah puasa dan zakat.'
            ],
            3: [
                'Memahami arti iman kepada malaikat, kitab, dan rasul.',
                'Menghafal doa-doa tambahan.',
                'Meneladani sifat sabar, syukur, dan tawakal.',
                'Mengenal sejarah dakwah Nabi Muhammad SAW.'
            ],
            4: [
                'Memahami makna iman kepada hari akhir dan qada-qadar.',
                'Membaca Al-Qur’an dengan tajwid sederhana.',
                'Mempraktikkan adab bergaul sesuai ajaran Islam.',
                'Mengenal tokoh-tokoh Islam berpengaruh.'
            ],
            5: [
                'Memahami hukum-hukum dasar fikih ibadah.',
                'Menghafal surat-surat pilihan Al-Qur’an.',
                'Meneladani sifat kepemimpinan yang baik.',
                'Mengenal perkembangan Islam di Indonesia.'
            ],
            6: [
                'Memahami konsep dakwah dan syiar Islam.',
                'Membaca Al-Qur’an dengan tajwid lebih baik.',
                'Meneladani perjuangan tokoh-tokoh Islam.',
                'Menerapkan nilai-nilai Islam dalam kehidupan bermasyarakat.'
            ]
        },

        kristenCpsByGrade: {
            1: [
                'Mengenal kasih Tuhan Yesus.',
                'Menghafal doa harian sederhana.',
                'Meneladani sikap sopan santun.',
                'Mengenal tokoh Alkitab.'
            ],
            2: [
                'Memahami ajaran kasih dalam keluarga.',
                'Membaca dan memahami cerita Alkitab sederhana.',
                'Mempraktikkan kejujuran dalam kehidupan sehari-hari.',
                'Menghafal ayat-ayat Alkitab pilihan.'
            ],
            3: [
                'Memahami perintah Tuhan dan maknanya.',
                'Menerapkan kasih dalam persahabatan.',
                'Mengenal tokoh-tokoh iman dalam Alkitab.',
                'Meneladani sikap rendah hati.'
            ],
            4: [
                'Memahami pengorbanan Tuhan Yesus.',
                'Menghafal dan memaknai ayat-ayat Alkitab.',
                'Mempraktikkan doa syafaat.',
                'Mengenal sejarah gereja.'
            ],
            5: [
                'Memahami karya keselamatan Tuhan.',
                'Menyampaikan kabar baik kepada orang lain.',
                'Meneladani tokoh-tokoh pelayanan.',
                'Mempraktikkan kepedulian sosial.'
            ],
            6: [
                'Memahami tugas misi gereja.',
                'Menguatkan iman melalui pelayanan.',
                'Memahami peran gereja dalam masyarakat.',
                'Menunjukkan teladan hidup Kristen.'
            ]
        },

        katolikCpsByGrade: {
            1: [
                'Mengenal Allah sebagai Bapa yang penuh kasih.',
                'Menghafal doa-doa dasar Gereja Katolik.',
                'Menunjukkan sikap kasih kepada keluarga.',
                'Mengenal Yesus sebagai Sahabat.'
            ],
            2: [
                'Memahami cerita Yesus dalam Kitab Suci.',
                'Mempraktikkan perilaku saling membantu.',
                'Menghafal doa Bapa Kami, Salam Maria, dan Kemuliaan.',
                'Mengenal sakramen-sakramen Gereja.'
            ],
            3: [
                'Memahami perintah Allah.',
                'Meneladani Yesus dalam kehidupan sehari-hari.',
                'Mengikuti perayaan Ekaristi dengan sikap hormat.',
                'Mengenal tokoh-tokoh kudus.'
            ],
            4: [
                'Memahami ajaran Yesus tentang kasih dan pengampunan.',
                'Mengenal sejarah Gereja Katolik.',
                'Mempraktikkan doa Rosario.',
                'Meneladani teladan santo dan santa.'
            ],
            5: [
                'Memahami peran Gereja dalam masyarakat.',
                'Menghidupi nilai iman dan pengharapan.',
                'Mengikuti kegiatan pelayanan.',
                'Mengenal misi Gereja.'
            ],
            6: [
                'Menganalisis ajaran Yesus dalam Injil.',
                'Memahami makna sakramen.',
                'Mempraktikkan hidup bersyukur.',
                'Menjadi saksi iman di lingkungan sekitar.'
            ]
        },

        hinduCpsByGrade: {
            1: [
                'Mengenal Tuhan (Ida Sang Hyang Widhi Wasa) dan ciptaan-Nya.',
                'Menghafal doa Tri Sandhya sederhana.',
                'Menunjukkan perilaku sopan kepada orang tua.',
                'Mengenal pura sebagai tempat ibadah.'
            ],
            2: [
                'Memahami ajaran tatwam asi (kebersamaan).',
                'Menghafal doa-doa harian Hindu.',
                'Mengenal upacara sederhana di rumah.',
                'Mempraktikkan perilaku disiplin.'
            ],
            3: [
                'Mengenal dewa-dewi utama Hindu.',
                'Memahami makna Tri Hita Karana.',
                'Mengikuti upacara di pura dengan sikap hormat.',
                'Menjaga kebersihan lingkungan.'
            ],
            4: [
                'Memahami ajaran karma phala.',
                'Mengenal kitab suci Weda.',
                'Mempraktikkan yoga sederhana.',
                'Mengenal hari raya Hindu.'
            ],
            5: [
                'Menganalisis nilai-nilai dharma.',
                'Menghafal sloka pilihan.',
                'Mengikuti kegiatan yadnya di masyarakat.',
                'Mengenal tokoh-tokoh Hindu.'
            ],
            6: [
                'Memahami reinkarnasi dalam ajaran Hindu.',
                'Menerapkan nilai satya, siwam, sundaram.',
                'Mempraktikkan meditasi sederhana.',
                'Menjaga keharmonisan hubungan dengan alam.'
            ]
        },

        buddhaCpsByGrade: {
            1: [
                'Mengenal Buddha sebagai Guru Agung.',
                'Menghafal doa namo tassa sederhana.',
                'Menunjukkan sikap welas asih kepada teman.',
                'Mengenal vihara sebagai tempat ibadah.'
            ],
            2: [
                'Memahami kisah kelahiran Siddharta Gautama.',
                'Menghafal Pancasila Buddhis.',
                'Mempraktikkan perilaku jujur.',
                'Mengenal hari besar Waisak.'
            ],
            3: [
                'Memahami Empat Kebenaran Mulia.',
                'Mempraktikkan Jalan Mulia Berunsur Delapan.',
                'Mengikuti kebaktian di vihara.',
                'Menjaga kebersihan diri.'
            ],
            4: [
                'Memahami hukum karma.',
                'Mengenal Jataka (kisah kelahiran Buddha).',
                'Mempraktikkan meditasi sederhana.',
                'Menghormati semua makhluk hidup.'
            ],
            5: [
                'Menganalisis ajaran cinta kasih universal.',
                'Menghafal paritta pilihan.',
                'Mengikuti kegiatan sosial vihara.',
                'Mengenal tokoh-tokoh Buddhis.'
            ],
            6: [
                'Memahami siklus kelahiran kembali.',
                'Menerapkan ajaran moral Buddhis dalam kehidupan.',
                'Mempraktikkan meditasi lebih mendalam.',
                'Meneladani sifat welas asih Buddha.'
            ]
        },

        khonghucuCpsByGrade: {
            1: [
                'Mengenal Tian (Tuhan) dan ajaran Nabi Kongzi.',
                'Menghafal doa harian Khonghucu.',
                'Menunjukkan sikap hormat kepada orang tua.',
                'Mengenal litang sebagai tempat ibadah.'
            ],
            2: [
                'Memahami ajaran Xiao (bakti kepada orang tua).',
                'Menghafal ayat-ayat Lunyu sederhana.',
                'Mempraktikkan perilaku sopan santun.',
                'Mengenal hari besar Imlek.'
            ],
            3: [
                'Memahami ajaran Ren (cinta kasih).',
                'Mengenal tokoh-tokoh dalam sejarah Khonghucu.',
                'Mengikuti upacara di litang.',
                'Menjaga kebersihan lingkungan.'
            ],
            4: [
                'Memahami ajaran Yi (benar) dan Li (tata krama).',
                'Menghafal doa-doa pilihan Khonghucu.',
                'Mengikuti perayaan tradisi Tionghoa.',
                'Menghormati sesama tanpa membedakan.'
            ],
            5: [
                'Menganalisis ajaran-ajaran dalam Kitab Sishu.',
                'Memahami makna kebajikan dalam kehidupan.',
                'Berpartisipasi dalam kegiatan sosial.',
                'Mengenal tokoh-tokoh Khonghucu berpengaruh.'
            ],
            6: [
                'Memahami ajaran harmoni dalam keluarga dan masyarakat.',
                'Mempraktikkan nilai kejujuran dan kesetiaan.',
                'Mengamalkan ajaran Nabi Kongzi.',
                'Menjadi teladan dalam menjaga kerukunan.'
            ]
        },
        
        ipasCpsByGrade: {
            1: [
                'Mengenal diri dan lingkungan terdekat melalui pengamatan, menanyakan, dan menceritakan kembali hasil pengamatan secara sederhana.',
                'Mengenal makhluk hidup dan benda di lingkungan sekitar serta kebutuhannya.',
                'Mengenal perubahan yang terjadi di lingkungan sekitar dalam kehidupan sehari-hari.'
            ],
            2: [
                'Mengidentifikasi hubungan antara makhluk hidup dengan lingkungannya melalui pengamatan langsung.',
                'Menjelaskan sifat-sifat benda dan perubahannya secara sederhana.',
                'Mengenal peran anggota masyarakat dan pekerjaan di lingkungan sekitar.'
            ],
            3: [
                'Mengidentifikasi siklus hidup makhluk hidup dan keterkaitannya dengan lingkungan.',
                'Mengenal sumber daya alam, pemanfaatannya, dan cara menjaga kelestariannya.',
                'Mengenal perubahan lingkungan dan perkembangan wilayah setempat dari waktu ke waktu.'
            ],
            4: [
                'Menjelaskan hubungan antar makhluk hidup dalam ekosistem serta pengaruh perubahan lingkungan.',
                'Mengidentifikasi bentuk energi, perubahannya, dan peranannya dalam kehidupan sehari-hari.',
                'Memahami keragaman sosial, budaya, dan sumber daya di Indonesia.'
            ],
            5: [
                'Memahami sistem organ pada manusia dan hubungannya dengan kesehatan.',
                'Menganalisis pengaruh kegiatan manusia terhadap keseimbangan lingkungan.',
                'Mengidentifikasi perkembangan teknologi dan perannya dalam kehidupan masyarakat.'
            ],
            6: [
                'Menganalisis interaksi manusia dengan lingkungan alam dan sosial pada skala lokal hingga global.',
                'Menjelaskan peristiwa alam, tata surya, dan dampaknya terhadap kehidupan di bumi.',
                'Menganalisis perkembangan wilayah, hubungan internasional, dan dampaknya terhadap kehidupan masyarakat.'
            ]
        },
        
        seniDaerahCpsByGrade: {
            1: [
                'Mengenal lagu daerah dan menyanyikannya dengan sederhana.',
                'Menirukan gerak tari daerah yang mudah.',
                'Mengenal alat musik tradisional daerah setempat.'
            ],
            2: [
                'Menyanyikan lagu daerah dengan pengucapan yang benar.',
                'Mempraktikkan gerak tari sederhana dari daerah setempat.',
                'Memainkan alat musik ritmis tradisional secara sederhana.'
            ],
            3: [
                'Memahami makna lagu daerah melalui liriknya.',
                'Menampilkan tarian sederhana secara berkelompok.',
                'Memainkan pola irama sederhana pada alat musik tradisional.'
            ],
            4: [
                'Menyanyikan lagu daerah dengan teknik vokal yang lebih baik.',
                'Menampilkan tarian daerah dengan pola lantai sederhana.',
                'Mengenal fungsi alat musik tradisional dalam pertunjukan seni.'
            ],
            5: [
                'Menampilkan lagu daerah dengan iringan musik tradisional.',
                'Memodifikasi gerak tari daerah menjadi kreasi baru sederhana.',
                'Memainkan alat musik tradisional secara berkelompok.'
            ],
            6: [
                'Menampilkan pertunjukan seni daerah (musik/tari) hasil kreasi kelompok.',
                'Memadukan unsur musik, tari, dan busana daerah dalam pertunjukan.',
                'Menjelaskan makna pertunjukan seni daerah bagi masyarakat.'
            ]
        },

        kerajinanDaerahCpsByGrade: {
            1: [
                'Mengenal jenis-jenis kerajinan sederhana khas daerah.',
                'Membuat karya kerajinan sederhana dengan bantuan guru.',
                'Menghias karya dengan motif daerah sederhana.'
            ],
            2: [
                'Mengenal bahan-bahan alami untuk kerajinan daerah.',
                'Mempraktikkan teknik dasar membuat kerajinan tangan.',
                'Menyelesaikan kerajinan sederhana seperti anyaman atau lipatan.'
            ],
            3: [
                'Mengenal teknik dasar batik, tenun, atau ukir sesuai daerah.',
                'Membuat produk sederhana yang terinspirasi dari kerajinan daerah.',
                'Menjelaskan fungsi kerajinan dalam kehidupan sehari-hari.'
            ],
            4: [
                'Menggunakan teknik dasar membuat kerajinan dengan alat sederhana.',
                'Membuat motif daerah pada karya kerajinan.',
                'Menyajikan karya kerajinan kepada teman atau keluarga.'
            ],
            5: [
                'Mengembangkan karya kerajinan yang memiliki fungsi praktis.',
                'Menggunakan lebih dari satu teknik pembuatan kerajinan.',
                'Menjelaskan makna motif atau bentuk dalam kerajinan daerah.'
            ],
            6: [
                'Membuat karya kerajinan yang memiliki nilai seni dan fungsi.',
                'Memodifikasi bentuk atau motif kerajinan khas daerah.',
                'Menyajikan hasil karya dalam pameran sekolah.'
            ]
        },

        kearifanLokalCpsByGrade: {
            1: [
                'Mengenal kebiasaan dan tradisi sederhana di lingkungan sekitar.',
                'Mengikuti permainan tradisional yang mudah dipraktikkan.',
                'Menunjukkan sikap sopan santun sesuai adat setempat.'
            ],
            2: [
                'Memahami kebiasaan masyarakat dalam kegiatan sehari-hari.',
                'Mengenal pakaian adat dan penggunaannya pada acara khusus.',
                'Berpartisipasi dalam permainan tradisional kelompok.'
            ],
            3: [
                'Mengenal upacara adat di daerah setempat.',
                'Menjelaskan makna simbol atau hiasan tradisional.',
                'Mempraktikkan permainan rakyat yang melibatkan kerja sama.'
            ],
            4: [
                'Memahami proses pelaksanaan upacara adat secara sederhana.',
                'Mengidentifikasi peralatan dan perlengkapan adat.',
                'Memainkan permainan tradisional yang memerlukan strategi.'
            ],
            5: [
                'Menggali nilai-nilai yang terkandung dalam kearifan lokal daerah.',
                'Membandingkan tradisi setempat dengan daerah lain.',
                'Mempraktikkan salah satu tradisi secara sederhana di sekolah.'
            ],
            6: [
                'Menganalisis peran kearifan lokal dalam menjaga persatuan.',
                'Mengidentifikasi ancaman terhadap kelestarian tradisi.',
                'Merancang kegiatan untuk melestarikan tradisi di lingkungan sekitar.'
            ]
        },

        bahasaDaerahCpsByGrade: {
            1: [
                'Mengenal kosakata dasar bahasa daerah (anggota tubuh, keluarga, benda sekitar).',
                'Mengucapkan salam dan sapaan sederhana sesuai tata krama daerah.',
                'Menyebutkan angka 1–10 dalam bahasa daerah.'
            ],
            2: [
                'Memperluas kosakata tentang hewan, tumbuhan, dan kegiatan sehari-hari.',
                'Menggunakan kalimat sederhana untuk bertanya dan menjawab.',
                'Menyanyikan lagu anak daerah dengan pengucapan yang tepat.'
            ],
            3: [
                'Memahami cerita rakyat sederhana dalam bahasa daerah.',
                'Menyusun kalimat sederhana dengan struktur yang benar.',
                'Menggunakan bahasa daerah dalam percakapan sehari-hari di kelas.'
            ],
            4: [
                'Memahami ungkapan sopan dan peribahasa daerah.',
                'Menceritakan kembali cerita rakyat dengan bahasa daerah.',
                'Menulis kalimat sederhana dalam bahasa daerah.'
            ],
            5: [
                'Menggunakan bahasa daerah untuk menjelaskan suatu kegiatan atau pengalaman.',
                'Membaca teks sederhana dengan intonasi dan lafal yang tepat.',
                'Mengenal variasi dialek dalam bahasa daerah setempat.'
            ],
            6: [
                'Menyampaikan pidato atau sambutan singkat dalam bahasa daerah.',
                'Menulis paragraf sederhana dengan ejaan bahasa daerah yang benar.',
                'Memahami makna sastra lisan seperti pantun, tembang, atau syair daerah.'
            ]
        },
        
        bahasaInggrisCpsByGrade: {
            1: [
                'Mengenal kosakata dasar (warna, angka, benda kelas, keluarga) melalui gambar atau lagu.',
                'Mengucapkan salam dan perkenalan diri secara sederhana.',
                'Memahami instruksi sederhana guru dalam bahasa Inggris (misalnya: stand up, sit down).'
            ],
            2: [
                'Memperluas kosakata tentang hewan, tumbuhan, dan bagian tubuh.',
                'Mengajukan dan menjawab pertanyaan sederhana (What is this? / This is…).',
                'Menyanyikan lagu anak-anak berbahasa Inggris dengan pengucapan sederhana.'
            ],
            3: [
                'Memahami teks lisan pendek berupa perintah, sapaan, atau instruksi sederhana.',
                'Memperkenalkan diri, teman, dan benda sekitar menggunakan kalimat sederhana.',
                'Membaca dan menulis kosakata dasar dengan ejaan yang benar.'
            ],
            4: [
                'Memahami kosakata tentang waktu, cuaca, dan kegiatan sehari-hari.',
                'Menyusun kalimat sederhana menggunakan pola Subjek + Kata Kerja + Objek.',
                'Membaca teks pendek (dialog, deskripsi benda) dan menjawab pertanyaan sederhana.'
            ],
            5: [
                'Memahami kosakata dan ungkapan tentang hobi, makanan, dan tempat.',
                'Menyusun percakapan sederhana untuk berinteraksi dengan teman sebaya.',
                'Menulis kalimat sederhana untuk menggambarkan benda, orang, atau kegiatan.'
            ],
            6: [
                'Memahami teks deskriptif sederhana tentang orang, tempat, atau benda.',
                'Menyampaikan informasi sederhana secara lisan (memperkenalkan, menceritakan pengalaman singkat).',
                'Menulis paragraf sederhana dengan struktur yang benar (misalnya: about myself, my family, my school).'
            ]
        },

        pjokCpsByGrade: {
            1: [
                'Melakukan gerak dasar lokomotor (berjalan, berlari, melompat) dengan benar.',
                'Mempraktikkan gerak dasar non-lokomotor (membungkuk, memutar badan).',
                'Mengenal permainan sederhana secara berkelompok.',
                'Memahami kebiasaan hidup bersih dan sehat.'
            ],
            2: [
                'Mengombinasikan gerak lokomotor dan non-lokomotor dalam permainan.',
                'Mempraktikkan koordinasi gerak sederhana.',
                'Mengenal peraturan dasar dalam permainan.',
                'Memahami pentingnya makan bergizi.'
            ],
            3: [
                'Melakukan variasi gerak dasar lokomotor, non-lokomotor, dan manipulatif (melempar, menangkap).',
                'Mengikuti permainan tradisional yang memerlukan kerja sama.',
                'Memahami konsep keselamatan saat beraktivitas fisik.',
                'Mengenal cara menjaga kebugaran tubuh.'
            ],
            4: [
                'Mempraktikkan keterampilan gerak dasar dalam permainan bola kecil dan besar.',
                'Melakukan aktivitas kebugaran jasmani sederhana.',
                'Memahami pentingnya pemanasan dan pendinginan.',
                'Mengenal pola hidup sehat.'
            ],
            5: [
                'Mengembangkan keterampilan dalam cabang olahraga tertentu (sepak bola, bola voli, bulu tangkis).',
                'Mempraktikkan kebugaran jasmani dengan intensitas sedang.',
                'Menganalisis faktor yang memengaruhi kesehatan tubuh.',
                'Mengenal pertolongan pertama pada kecelakaan ringan.'
            ],
            6: [
                'Menunjukkan keterampilan bermain dalam cabang olahraga tertentu dengan peraturan sederhana.',
                'Mengikuti kegiatan kebugaran jasmani secara teratur.',
                'Menunjukkan sikap sportivitas dan kerja sama tim.',
                'Memahami upaya menjaga kesehatan tubuh dan lingkungan.'
            ]
        },

        prakaryaCpsByGrade: {
            1: [
                'Membuat kerajinan sederhana dari bahan alam atau bekas.',
                'Mempraktikkan teknik dasar melipat, menggunting, dan menempel.',
                'Menghias karya sederhana dengan warna atau motif.'
            ],
            2: [
                'Membuat karya kolase sederhana dari bahan alam atau buatan.',
                'Menggunakan teknik anyaman atau lipatan sederhana.',
                'Menghias karya agar lebih menarik secara visual.'
            ],
            3: [
                'Membuat kerajinan tangan berbahan alam atau buatan dengan fungsi sederhana.',
                'Mempraktikkan teknik sambung dan rekat sederhana.',
                'Menghias karya sesuai tema tertentu.'
            ],
            4: [
                'Membuat karya keterampilan berbahan daur ulang.',
                'Menggunakan teknik potong, lipat, rekat, atau anyaman dalam karya.',
                'Menambahkan unsur estetis pada karya yang dibuat.'
            ],
            5: [
                'Membuat kerajinan fungsional sederhana berbahan alam atau buatan.',
                'Menerapkan teknik konstruksi sederhana.',
                'Menghias karya agar memiliki nilai estetika.'
            ],
            6: [
                'Membuat produk keterampilan yang memiliki nilai guna dan estetika.',
                'Menggunakan berbagai teknik dalam satu karya.',
                'Menyajikan karya keterampilan secara menarik.'
            ]
        },

        seniMusikCpsByGrade: {
            1: [
                'Mengekspresikan diri melalui nyanyian sederhana dengan irama dan tempo tepat.',
                'Mengenal perbedaan tinggi-rendah nada.',
                'Mengenal suara alat musik ritmis sederhana.'
            ],
            2: [
                'Menyanyikan lagu anak dengan intonasi dan tempo benar.',
                'Mengenal alat musik melodis sederhana.',
                'Memainkan pola irama sederhana dengan alat musik ritmis.'
            ],
            3: [
                'Menyanyikan lagu daerah dengan sikap yang benar.',
                'Mengenal tanda birama sederhana.',
                'Memainkan alat musik ritmis atau melodis dengan pola sederhana.'
            ],
            4: [
                'Memainkan alat musik ritmis dalam ansambel sederhana.',
                'Menyanyikan lagu wajib nasional dengan teknik vokal yang benar.',
                'Mengenal tanda tempo dan dinamik sederhana.'
            ],
            5: [
                'Menyanyikan lagu dengan teknik pernapasan yang baik.',
                'Memainkan alat musik melodis sederhana secara berkelompok.',
                'Menciptakan pola irama sederhana.'
            ],
            6: [
                'Menyanyikan lagu nasional dan daerah dengan teknik vokal baik.',
                'Memainkan ansambel musik sederhana dengan koordinasi kelompok.',
                'Memodifikasi irama atau melodi sederhana.'
            ]
        },

        seniRupaCpsByGrade: {
            1: [
                'Mengenal unsur garis, bentuk, dan warna dalam karya gambar.',
                'Menggambar bentuk sederhana dari benda di sekitar.',
                'Mewarnai gambar dengan teknik sederhana.'
            ],
            2: [
                'Menggambar bentuk benda di sekitar dengan proporsi sederhana.',
                'Mengenal pola, tekstur, dan motif sederhana.',
                'Menggunakan kombinasi warna dalam gambar.'
            ],
            3: [
                'Menggambar dengan teknik pewarnaan, arsiran, atau titik.',
                'Menggunakan komposisi sederhana dalam karya.',
                'Membuat karya dua dimensi bertema lingkungan.'
            ],
            4: [
                'Menggambar objek dengan memperhatikan proporsi sederhana.',
                'Menciptakan karya tiga dimensi sederhana dari tanah liat atau plastisin.',
                'Menggunakan teknik campuran dalam menggambar atau melukis.'
            ],
            5: [
                'Menggambar atau melukis dengan variasi media (kuas, spidol, pensil warna).',
                'Menciptakan karya seni bertema budaya daerah.',
                'Menggambar perspektif sederhana.'
            ],
            6: [
                'Melukis atau menggambar dengan proporsi dan perspektif lebih tepat.',
                'Membuat karya tiga dimensi yang memiliki nilai estetika.',
                'Menggunakan teknik dan media campuran dalam karya seni rupa.'
            ]
        },

        seniTariCpsByGrade: {
            1: [
                'Melakukan gerakan tubuh sederhana sesuai irama lagu.',
                'Meniru gerak dasar tari anak-anak.',
                'Menampilkan gerakan kreatif sederhana secara berkelompok.'
            ],
            2: [
                'Melakukan variasi gerak dasar tari anak-anak.',
                'Mempraktikkan gerakan sesuai pola lantai sederhana.',
                'Menampilkan tarian sederhana dengan ekspresi ceria.'
            ],
            3: [
                'Mempraktikkan gerak dasar tari daerah.',
                'Menyesuaikan gerak tari dengan irama dan tempo musik pengiring.',
                'Menampilkan tarian sederhana secara berkelompok.'
            ],
            4: [
                'Menampilkan tarian daerah dengan pola lantai dasar.',
                'Mempraktikkan kombinasi gerak tangan, kaki, dan kepala.',
                'Menghafal urutan gerak dalam satu tarian sederhana.'
            ],
            5: [
                'Menampilkan tarian daerah dengan variasi pola lantai.',
                'Menyesuaikan gerakan dengan ekspresi yang tepat.',
                'Memodifikasi gerak tari sederhana menjadi tarian baru.'
            ],
            6: [
                'Menampilkan karya tari hasil kreasi sendiri atau kelompok.',
                'Memadukan gerakan, musik, dan properti sederhana dalam tari.',
                'Menunjukkan kerjasama yang baik dalam penampilan tari berkelompok.'
            ]
        },

        pancasilaCpsByGrade: {
            1: [
                'Mengenal simbol negara seperti bendera, lambang Garuda Pancasila, dan lagu kebangsaan.',
                'Memahami aturan sederhana di rumah dan sekolah.',
                'Menunjukkan sikap saling menghormati di rumah dan sekolah.',
                'Meneladani perilaku tokoh nasional sederhana.'
            ],
            2: [
                'Memahami makna sila-sila Pancasila dalam kehidupan sehari-hari.',
                'Mempraktikkan perilaku sesuai nilai-nilai Pancasila di lingkungan sekolah.',
                'Memahami hak dan kewajiban sebagai anggota keluarga dan warga sekolah.',
                'Menghargai keberagaman teman di sekolah.'
            ],
            3: [
                'Memahami pentingnya persatuan di lingkungan sekolah dan masyarakat.',
                'Mempraktikkan musyawarah dalam pengambilan keputusan sederhana.',
                'Menghormati perbedaan agama, suku, dan budaya.',
                'Menunjukkan kepedulian terhadap lingkungan sekitar.'
            ],
            4: [
                'Memahami makna simbol negara dan peraturan perundang-undangan sederhana.',
                'Menghargai jasa pahlawan nasional dan daerah.',
                'Mempraktikkan demokrasi di lingkungan sekolah.',
                'Menjalankan hak dan kewajiban sebagai warga sekolah dan masyarakat.'
            ],
            5: [
                'Memahami peran lembaga pemerintahan di tingkat daerah.',
                'Menunjukkan sikap gotong royong dan toleransi.',
                'Menganalisis peristiwa sejarah kemerdekaan Indonesia yang mencerminkan nilai Pancasila.',
                'Memahami peran Indonesia dalam kerja sama antarnegara di ASEAN.'
            ],
            6: [
                'Menganalisis nilai-nilai Pancasila dalam kehidupan berbangsa dan bernegara.',
                'Memahami sistem pemerintahan Indonesia.',
                'Mengkaji peraturan perundang-undangan dan penerapannya dalam kehidupan.',
                'Menunjukkan sikap cinta tanah air dalam tindakan nyata.'
            ]
        },

        matematikaCpsByGrade: {
            1: [
                'Mengenal dan menulis bilangan 1–100, membandingkan, dan mengurutkan bilangan.',
                'Melakukan penjumlahan dan pengurangan bilangan sampai 20 secara lancar.',
                'Mengenal konsep panjang, berat, waktu, dan mengukur menggunakan satuan tidak baku.',
                'Mengenal bentuk bangun datar dan bangun ruang sederhana.',
                'Mengumpulkan dan mengelompokkan data sederhana.'
            ],
            2: [
                'Menghitung penjumlahan dan pengurangan bilangan sampai 1000.',
                'Mengenal perkalian dan pembagian sebagai operasi berulang.',
                'Mengukur panjang, berat, dan waktu dengan satuan baku.',
                'Mengenal sifat-sifat bangun datar dan bangun ruang sederhana.',
                'Menyajikan data sederhana dalam tabel atau diagram gambar.'
            ],
            3: [
                'Melakukan penjumlahan, pengurangan, perkalian, dan pembagian bilangan sampai 10.000.',
                'Mengenal pecahan sederhana dan hubungan antar pecahan.',
                'Mengukur keliling dan luas bangun datar sederhana.',
                'Mengidentifikasi simetri lipat dan simetri putar bangun datar.',
                'Membaca dan menyajikan data dalam tabel dan diagram batang.'
            ],
            4: [
                'Mengoperasikan bilangan cacah dan pecahan (penjumlahan, pengurangan, perkalian, pembagian).',
                'Mengubah pecahan ke bentuk desimal dan persen.',
                'Menghitung keliling, luas, dan volume bangun sederhana.',
                'Mengenal sudut, garis, dan hubungan antar garis.',
                'Menginterpretasi data dari tabel dan diagram.'
            ],
            5: [
                'Mengoperasikan bilangan bulat, pecahan, desimal, dan persen.',
                'Memecahkan masalah perbandingan dan skala.',
                'Menghitung luas bangun datar gabungan dan volume kubus serta balok.',
                'Memahami konsep sudut dan pengukuran sudut.',
                'Menganalisis data dan menyajikan dalam diagram garis atau lingkaran.'
            ],
            6: [
                'Memecahkan masalah yang melibatkan operasi bilangan bulat, pecahan, dan desimal.',
                'Menggunakan konsep rasio, proporsi, dan persentase dalam pemecahan masalah.',
                'Menghitung luas bangun datar kompleks dan volume bangun ruang sederhana.',
                'Memahami transformasi (translasi, refleksi, rotasi) sederhana pada bangun datar.',
                'Menyajikan dan menafsirkan data dalam berbagai bentuk diagram.'
            ]
        },

        bahasaIndonesiaCpsByGrade: {
            1: [
                'Mengenali huruf, kata, dan tanda baca sederhana dalam teks pendek.',
                'Membaca nyaring teks sederhana dengan lafal, intonasi, dan jeda yang tepat.',
                'Menemukan informasi sederhana dari teks yang dibacakan atau dibaca sendiri.',
                'Menulis kata dan kalimat sederhana dengan ejaan yang benar.',
                'Mengungkapkan pendapat atau perasaan secara lisan menggunakan kalimat sederhana.',
                'Mendengarkan dan menceritakan kembali isi cerita atau pengalaman pribadi secara runtut.'
            ],
            2: [
                'Membaca teks narasi dan deskripsi sederhana dengan lafal dan intonasi yang tepat.',
                'Mengidentifikasi tokoh, peristiwa, dan pesan dari teks.',
                'Menulis cerita atau deskripsi sederhana dengan penggunaan ejaan yang benar.',
                'Menyampaikan pendapat atau informasi secara lisan dengan bahasa santun.',
                'Menggunakan kosakata baku sesuai konteks dalam berbicara dan menulis.'
            ],
            3: [
                'Membaca teks narasi, deskripsi, dan informatif untuk menemukan ide pokok dan informasi penting.',
                'Menulis teks sederhana (cerita, laporan, atau deskripsi) dengan struktur yang tepat.',
                'Menyunting tulisan sendiri atau teman untuk memperbaiki ejaan dan tanda baca.',
                'Menyampaikan informasi atau cerita secara lisan dengan runtut dan jelas.'
            ],
            4: [
                'Memahami teks narasi, eksplanasi, prosedur, dan deskripsi dari berbagai sumber.',
                'Menulis laporan hasil pengamatan dengan bahasa baku dan kalimat efektif.',
                'Menentukan informasi penting dalam teks dan menyusunnya kembali secara singkat.',
                'Mengungkapkan pendapat dalam diskusi kelompok dengan alasan yang jelas.'
            ],
            5: [
                'Menganalisis isi dan struktur teks narasi, eksposisi, prosedur, dan ulasan.',
                'Menulis teks sesuai struktur dan ciri kebahasaannya dengan ejaan yang tepat.',
                'Menyunting teks untuk memperbaiki kosakata, ejaan, dan tata bahasa.',
                'Menyampaikan pendapat dan argumen secara lisan dalam diskusi atau presentasi.'
            ],
            6: [
                'Memahami isi teks fiksi dan nonfiksi dengan analisis mendalam.',
                'Menulis teks cerita, ulasan, dan laporan dengan bahasa baku dan sumber yang tepat.',
                'Menggunakan kutipan dan daftar pustaka sederhana dalam karya tulis.',
                'Berpartisipasi dalam debat atau presentasi dengan argumen yang logis dan meyakinkan.'
            ]
        },

        // --- STATE MANAGEMENT ---
        state: {
            settings: {},
            students: [],
            grades: {},
            extracurricularGrades: {}, // { studentId: [{ id: 'extraId', grade: 'A', description: '...' }] }
            attendance: {}, // { studentId: { s: 0, i: 0, a: 0 } }
            p5Grades: {}, // { studentId: { projectId: { targetId: 'BB' | 'MB' | 'BSH' | 'SB' } } }
            teacherNotes: {}, // { studentId: '...' }
        },
        
        pendingGradeImport: null,
        pendingExtraImport: null,
        pendingAttendanceImport: null,
        selectedSubjectName: null,
        selectedGradeInputSubject: null,
        spreadsheetId: null,

        STORAGE_KEY: 'digitalReportApp',
        
        SHEET_NAMES: {
            SETTINGS: 'Settings',
            STUDENTS: 'Students',
            GRADES: 'Grades',
            EXTRAS: 'Extracurricular',
            ATTENDANCE: 'Attendance',
            P5_GRADES: 'P5_Grades',
            NOTES: 'TeacherNotes',
        },

        getEmptyStudent() {
            return { id: '', nis: '', nisn: '', name: '', panggilan: '', ttl: '', jenisKelamin: '', agama: '', kewarganegaraan: '', statusKeluarga: '', anakKe: '', asalTk: '', alamat: '', namaAyah: '', namaIbu: '', pekerjaanAyah: '', pekerjaanIbu: '', alamatOrtu: '', teleponOrtu: '', kelurahan: '', kecamatan: '', kabupaten: '', provinsi: '', namaWali: '', pekerjaanWali: '', alamatWali: '', teleponWali: '' };
        },

        getDefaultSettings() {
            const createSubject = (name, capaian, descs) => ({
                name,
                capaian: Array.isArray(capaian) ? capaian : [capaian],
                deskripsi: {
                    A: descs.A, B: descs.B, C: descs.C
                }
            });
            
            const defaultReligionDesc = { 
                A: '[nama], pemahamanmu tentang [cp] sangat mendalam. Teruslah menjadi teladan yang baik!', 
                B: '[nama], kamu sudah memahami [cp] dengan baik. Tingkatkan terus keimanan dan ketakwaanmu ya!', 
                C: '[nama], kamu sudah cukup mengerti tentang [cp]. Jangan ragu untuk bertanya agar pemahamanmu semakin kuat.' 
            };
            
            const defaultArtSportDesc = {
                A: '[nama], bakat dan kreativitasmu dalam [cp] sangat menonjol. Terus kembangkan potensimu, karyamu keren!',
                B: '[nama], kamu menunjukkan kemampuan yang baik dalam [cp]. Teruslah berlatih dengan semangat, kamu pasti bisa!',
                C: '[nama], kamu sudah cukup mampu dalam [cp]. Jangan ragu untuk mencoba dan berekspresi lebih bebas ya!',
            };

            const defaultGrade = 4;

            const defaultIslamCps = this.islamCpsByGrade[defaultGrade] || [];
            const defaultKristenCps = this.kristenCpsByGrade[defaultGrade] || [];
            const defaultKatolikCps = this.katolikCpsByGrade[defaultGrade] || [];
            const defaultHinduCps = this.hinduCpsByGrade[defaultGrade] || [];
            const defaultBuddhaCps = this.buddhaCpsByGrade[defaultGrade] || [];
            const defaultKhonghucuCps = this.khonghucuCpsByGrade[defaultGrade] || [];
            const defaultPancasilaCps = this.pancasilaCpsByGrade[defaultGrade] || [];
            const defaultBahasaIndonesiaCps = this.bahasaIndonesiaCpsByGrade[defaultGrade] || [];
            const defaultMatematikaCps = this.matematikaCpsByGrade[defaultGrade] || [];
            const defaultIpasCps = this.ipasCpsByGrade[defaultGrade] || [];
            const defaultSeniDaerahCps = this.seniDaerahCpsByGrade[defaultGrade] || [];
            const defaultKerajinanDaerahCps = this.kerajinanDaerahCpsByGrade[defaultGrade] || [];
            const defaultKearifanLokalCps = this.kearifanLokalCpsByGrade[defaultGrade] || [];
            const defaultBahasaDaerahCps = this.bahasaDaerahCpsByGrade[defaultGrade] || [];
            const defaultBahasaInggrisCps = this.bahasaInggrisCpsByGrade[defaultGrade] || [];
            const defaultPjokCps = this.pjokCpsByGrade[defaultGrade] || [];
            const defaultPrakaryaCps = this.prakaryaCpsByGrade[defaultGrade] || [];
            const defaultSeniMusikCps = this.seniMusikCpsByGrade[defaultGrade] || [];
            const defaultSeniRupaCps = this.seniRupaCpsByGrade[defaultGrade] || [];
            const defaultSeniTariCps = this.seniTariCpsByGrade[defaultGrade] || [];

            return {
                schoolName: 'SDN 1 Harapan Bangsa', npsn: '', schoolAddress: '', village: '', district: '', province: '', postalCode: '', schoolEmail: '', schoolPhone: '', website: '', fax: '', schoolLogo: '',
                className: 'Kelas 4A', schoolYear: '2024/2025', semester: 'Ganjil', reportDate: '',
                headmasterName: 'Nama Kepala Sekolah, M.Pd.', headmasterNip: '197001012000011001',
                teacherName: 'Nama Wali Kelas, S.Pd.', teacherNip: '198001012010011001',
                passingGrade: 70,
                gradeRanges: { A: 90, B: 80, C: 70 },
                extracurriculars: [
                    { id: 'e1', name: 'Pramuka' },
                    { id: 'e2', name: 'PMR' },
                    { id: 'e3', name: 'Sepak Bola' }
                ],
                p5Projects: [
                    {
                        id: 'p5-proj-1',
                        name: 'Hidup Sehat di Mulai dari Makanan',
                        description: 'Projek ini adalah projek pertama di kelas 6. Projek ini diharapkan membangun dua dimensi Profil Pelajar Pancasila, yakni mandiri dan kreatif. Adapun tujuan dari projek ini adalah menumbuhkan kemandirian dan kreativitas peserta didik dengan memotivasi peserta didik untuk makan makanan sehat setiap hari. Melalui edukasi tentang makanan sehat, peserta didik diharapkan mampu menunjukkan inisiatif dan bekerja secara mandiri, serta mengembangkan gagasan/ide yang dimiliki untuk membuat kombinasi hal yang baru dan imajinatif.',
                        dimensions: [
                            {
                                id: 'dim1', name: 'Mandiri',
                                subElements: [
                                    { 
                                        id: 'sub1-1', name: 'Menunjukkan inisiatif dan bekerja secara mandiri',
                                        targets: [
                                            { id: 't1-1-1', description: 'Memahami arti penting bekerja secara mandiri serta inisiatif untuk melakukannya dalam menunjang pembelajaran dan pengembangan dirinya.' },
                                        ]
                                    }
                                ]
                            },
                            {
                                id: 'dim2', name: 'Kreatif',
                                subElements: [
                                    { 
                                        id: 'sub2-1', name: 'Menghasilkan gagasan yang orisinal',
                                        targets: [
                                            { id: 't2-1-1', description: 'Mengembangkan gagasan yang ia miliki untuk membuat kombinasi hal yang baru dan imajinatif untuk mengekspresikan pikiran dan/atau perasaannya.' },
                                        ]
                                    }
                                ]
                            }
                        ]
                    }
                ],
                subjects: [
                    createSubject('Pendidikan Agama dan Budi Pekerti (Islam)', defaultIslamCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Kristen)', defaultKristenCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Katolik)', defaultKatolikCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Hindu)', defaultHinduCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Buddha)', defaultBuddhaCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Khonghucu)', defaultKhonghucuCps, defaultReligionDesc),
                    createSubject('Pendidikan Pancasila', defaultPancasilaCps, { A: '[nama], kamu menunjukkan sikap yang sangat baik dalam [cp]. Kamu adalah calon pemimpin masa depan!', B: '[nama], sikapmu dalam [cp] sudah baik. Teruslah amalkan nilai-nilai Pancasila dalam kehidupanmu!', C: '[nama], kamu sudah cukup memahami tentang [cp]. Terus belajar menjadi warga negara yang baik ya.' }),
                    createSubject('Bahasa Indonesia', defaultBahasaIndonesiaCps, { A: '[nama], kamu sangat terampil dalam [cp]. Kemampuan berbahasamu luar biasa, teruslah berkarya!', B: '[nama], keterampilanmu dalam [cp] sudah bagus. Rajin membaca dan menulis akan membuatmu semakin hebat!', C: '[nama], kamu sudah cukup terampil dalam [cp]. Perbanyak latihan agar komunikasimu makin lancar.' }),
                    createSubject('Matematika', defaultMatematikaCps, { A: '[nama], kamu sangat menguasai [cp]. Logikamu tajam sekali, teruslah tantang dirimu dengan soal-soal baru!', B: '[nama], penguasaanmu pada [cp] sudah baik. Jangan takut pada angka, teruslah berlatih ya!', C: '[nama], kamu sudah cukup menguasai [cp]. Matematika itu seru, ayo kita pecahkan lebih banyak teka-teki angka bersama!' }),
                    createSubject('Ilmu Pengetahuan Alam dan Sosial (IPAS)', defaultIpasCps, { A: '[nama], rasa ingin tahumu tentang [cp] sangat tinggi. Kamu adalah ilmuwan cilik yang hebat!', B: '[nama], pemahamanmu tentang [cp] sudah baik. Teruslah menjelajahi keajaiban alam dan sosial di sekitarmu!', C: '[nama], kamu sudah cukup memahami [cp]. Ayo lebih banyak bertanya dan melakukan pengamatan, pasti seru!' }),
                    createSubject('Seni Budaya (Prakarya)', defaultPrakaryaCps, defaultArtSportDesc),
                    createSubject('Seni Budaya (Seni Musik)', defaultSeniMusikCps, defaultArtSportDesc),
                    createSubject('Seni Budaya (Seni Rupa)', defaultSeniRupaCps, defaultArtSportDesc),
                    createSubject('Seni Budaya (Seni Tari)', defaultSeniTariCps, defaultArtSportDesc),
                    createSubject('Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)', defaultPjokCps, defaultArtSportDesc),
                    createSubject('Bahasa Inggris', defaultBahasaInggrisCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Bahasa Daerah)', defaultBahasaDaerahCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Kearifan Lokal)', defaultKearifanLokalCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Kerajinan Daerah)', defaultKerajinanDaerahCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Seni Daerah)', defaultSeniDaerahCps, defaultArtSportDesc)
                ]
            };
        },

        loadState() {
            const savedState = localStorage.getItem(this.STORAGE_KEY);
            if (savedState) {
                this.state = JSON.parse(savedState);
                
                const defaultSettings = this.getDefaultSettings();
                this.state.settings = { ...defaultSettings, ...this.state.settings };
                
                // Ensure new state properties exist
                this.state.extracurricularGrades = this.state.extracurricularGrades || {};
                this.state.attendance = this.state.attendance || {};
                this.state.p5Grades = this.state.p5Grades || {};
                this.state.teacherNotes = this.state.teacherNotes || {};
                this.state.settings.extracurriculars = this.state.settings.extracurriculars || defaultSettings.extracurriculars;
                this.state.settings.p5Projects = this.state.settings.p5Projects || defaultSettings.p5Projects;

                // Remove old character/p5notes data if it exists
                delete this.state.characterGrades;
                delete this.state.settings.characters;
                delete this.state.p5Notes;


                // Migration logic for old data structure
                if (this.state.settings.subjects.length > 0) {
                    this.state.settings.subjects = this.state.settings.subjects.map(subject => {
                        const newSubject = { ...subject };
                        // Migrate capaian from string to array
                        if (typeof newSubject.capaian === 'string') {
                            newSubject.capaian = newSubject.capaian ? [newSubject.capaian] : [];
                        }
                        // Migrate deskripsi from string to object
                        if (typeof newSubject.deskripsi === 'string') {
                            const oldDeskripsi = newSubject.deskripsi;
                            newSubject.deskripsi = { A: oldDeskripsi, B: oldDeskripsi, C: oldDeskripsi };
                        } else if (!newSubject.deskripsi) {
                            newSubject.deskripsi = { A: '', B: '', C: '' };
                        }
                        return newSubject;
                    });
                }
                
                if (!this.state.settings.gradeRanges) this.state.settings.gradeRanges = defaultSettings.gradeRanges;
                if (this.state.settings.gradeRanges.C) {
                    this.state.settings.passingGrade = this.state.settings.gradeRanges.C;
                }

                // Migration from old deletedSubjects array to isDeleted flag on subject items
                if (this.state.settings.deletedSubjects && Array.isArray(this.state.settings.deletedSubjects)) {
                    this.state.settings.deletedSubjects.forEach(deletedSub => {
                        const existingSubject = this.state.settings.subjects.find(s => s.name === deletedSub.name);
                        if (!existingSubject) {
                             this.state.settings.subjects.push({ ...deletedSub, isDeleted: true });
                        }
                    });
                }
                delete this.state.settings.deletedSubjects;

                // Ensure all subjects have isDeleted flag for consistent logic
                this.state.settings.subjects.forEach(subject => {
                    if (subject.isDeleted === undefined) {
                        subject.isDeleted = false;
                    }
                });

                const emptyStudent = this.getEmptyStudent();
                this.state.students = this.state.students.map(student => ({ ...emptyStudent, ...student }));
                
                // Migration for grades data structure
                if (this.state.grades) {
                    Object.keys(this.state.grades).forEach(studentId => {
                        const studentGrades = this.state.grades[studentId];
                        Object.keys(studentGrades).forEach(subject => {
                            let currentGrade = studentGrades[subject];
                            
                            // Old migration: number to array
                            if (typeof currentGrade === 'number' || currentGrade === null) {
                                currentGrade = currentGrade !== null ? [currentGrade] : [];
                            }
                            
                            // New migration: array to object {cp, pts, pas}
                            if (Array.isArray(currentGrade)) {
                                studentGrades[subject] = {
                                    cp: currentGrade,
                                    pts: null,
                                    pas: null
                                };
                            }
                        });
                    });
                }


            } else {
                 this.state = {
                    settings: this.getDefaultSettings(),
                    students: [
                        { ...this.getEmptyStudent(), id: 's1', name: 'Budi Hartono', nis: '12345', nisn: '001', panggilan: 'Budi', agama: 'Islam' },
                        { ...this.getEmptyStudent(), id: 's2', name: 'Siti Aminah', nis: '12346', nisn: '002', panggilan: 'Siti', agama: 'Islam' }
                    ],
                    grades: { 
                        's1': { 
                            'Matematika': { cp: [85], pts: null, pas: null }, 
                            'Bahasa Indonesia': { cp: [92], pts: null, pas: null } 
                        }, 
                        's2': { 
                            'Matematika': { cp: [88], pts: null, pas: null }, 
                            'Bahasa Indonesia': { cp: [68], pts: null, pas: null } 
                        } 
                    },
                    extracurricularGrades: {},
                    attendance: {},
                    p5Grades: {},
                    teacherNotes: {},
                };
            }
        },

        saveState() {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state));
            if (isLoggedIn) {
                this.syncWithGoogleSheets(false); // false means save, not fetch
            }
        },
        
        async findOrCreateSpreadsheet() {
            if (this.spreadsheetId) return this.spreadsheetId;

            const fileName = 'Rapor Kelas Terpadu Data';
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`,
                    fields: 'files(id, name)',
                });

                if (response.result.files && response.result.files.length > 0) {
                    this.spreadsheetId = response.result.files[0].id;
                    const spreadsheet = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: this.spreadsheetId,
                        fields: 'sheets.properties.title'
                    });
                    const existingSheets = spreadsheet.result.sheets.map(s => s.properties.title);
                    const requiredSheets = Object.values(this.SHEET_NAMES);
                    const missingSheets = requiredSheets.filter(name => !existingSheets.includes(name));

                    if (missingSheets.length > 0) {
                        this.updateSyncStatus('syncing', 'Menyiapkan sheet...');
                        const requests = missingSheets.map(title => ({ addSheet: { properties: { title } } }));
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: this.spreadsheetId,
                            resource: { requests }
                        });
                    }

                    const oldSheet = spreadsheet.result.sheets.find(s => s.properties.title === 'P5Notes');
                    if (oldSheet) {
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: this.spreadsheetId,
                            resource: { requests: [{ deleteSheet: { sheetId: oldSheet.properties.sheetId } }] }
                        });
                    }
                    return this.spreadsheetId;
                } else {
                    this.updateSyncStatus('syncing', 'Membuat file baru...');
                    const sheets = Object.values(this.SHEET_NAMES).map(title => ({ properties: { title } }));
                    const spreadsheet = await gapi.client.sheets.spreadsheets.create({
                        properties: { title: fileName },
                        sheets: sheets
                    });
                    this.spreadsheetId = spreadsheet.result.spreadsheetId;
                    return this.spreadsheetId;
                }
            } catch (err) {
                console.error("Error finding or creating spreadsheet", err);
                this.updateSyncStatus('error', 'Gagal akses Drive');
                return null;
            }
        },
        
        async syncWithGoogleSheets(fetchOnly = false) {
            if (!isLoggedIn) return;

            this.updateSyncStatus('syncing', fetchOnly ? 'Mengambil data...' : 'Menyimpan...');
            const spreadsheetId = await this.findOrCreateSpreadsheet();
            if (!spreadsheetId) return;

            try {
                if (fetchOnly) {
                    const ranges = Object.values(this.SHEET_NAMES).map(name => `${name}!A:Z`);
                    const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                        spreadsheetId: spreadsheetId,
                        ranges: ranges,
                    });
                    
                    const valueRanges = response.result.valueRanges;
                    const getSheetData = (sheetName) => {
                        const sheetIndex = Object.keys(this.SHEET_NAMES).indexOf(Object.keys(this.SHEET_NAMES).find(key => this.SHEET_NAMES[key] === sheetName));
                        return valueRanges[sheetIndex]?.values || [];
                    };

                    const settingsData = getSheetData(this.SHEET_NAMES.SETTINGS);
                    const studentsData = getSheetData(this.SHEET_NAMES.STUDENTS);
                    
                    if (studentsData.length === 0 && settingsData.length === 0) {
                        this.updateSyncStatus('syncing', 'Data cloud kosong, menyimpan...');
                        await this.syncWithGoogleSheets(false);
                        return;
                    }

                    const newState = {};
                    const reconstructedSettings = {};
                    if (settingsData.length > 1) { // has headers
                        settingsData.slice(1).forEach(row => {
                            if (!row || row.length < 2 || !row[0]) return;
                            const key = row[0];
                            let value = row[1];
                            
                            // Logic to handle both old JSON and new key-value format
                             try {
                                const parsedValue = JSON.parse(value);
                                reconstructedSettings[key] = parsedValue;
                            } catch (e) {
                                // Not a JSON string, treat as regular value
                                if (key.startsWith('gradeRanges.')) {
                                    const subKey = key.split('.')[1];
                                    if (!reconstructedSettings.gradeRanges) reconstructedSettings.gradeRanges = {};
                                    const numVal = parseInt(value, 10);
                                    reconstructedSettings.gradeRanges[subKey] = isNaN(numVal) ? 0 : numVal;
                                } else {
                                    const numVal = parseFloat(value);
                                    const isStringifiedNum = String(value).trim() !== '' && String(numVal) === String(value).trim();
                                    reconstructedSettings[key] = isStringifiedNum ? numVal : value;
                                }
                            }
                        });
                        newState.settings = reconstructedSettings;
                    } else if (settingsData.length === 1 && settingsData[0].length === 1) { // Old format check
                         try { newState.settings = JSON.parse(settingsData[0][0]); } 
                         catch(e) { console.warn("Failed to parse old settings format"); }
                    }


                    if (studentsData.length > 1) {
                        const headers = studentsData[0];
                        newState.students = studentsData.slice(1).map(row => {
                            const student = {};
                            headers.forEach((header, index) => { student[header] = row[index] !== undefined ? row[index] : ''; });
                            return student;
                        });
                    } else { newState.students = []; }
                    
                    const gradesData = getSheetData(this.SHEET_NAMES.GRADES);
                    const gradesMap = {};
                    if (gradesData.length > 1) {
                        gradesData.slice(1).forEach(row => {
                            const [studentId, subjectName, gradesJson] = row;
                            if (studentId && subjectName && gradesJson) {
                                if (!gradesMap[studentId]) gradesMap[studentId] = {};
                                try { gradesMap[studentId][subjectName] = JSON.parse(gradesJson); } catch (e) { console.warn(`Gagal parse nilai untuk ${studentId} - ${subjectName}`); }
                            }
                        });
                    }
                    newState.grades = gradesMap;

                    const extrasData = getSheetData(this.SHEET_NAMES.EXTRAS);
                    const extrasMap = {};
                    if (extrasData.length > 1) {
                        extrasData.slice(1).forEach(row => {
                            const [studentId, extrasJson] = row;
                            if (studentId && extrasJson) {
                                try { extrasMap[studentId] = JSON.parse(extrasJson); } catch(e) { console.warn(`Gagal parse ekstrakurikuler untuk ${studentId}`); }
                            }
                        });
                    }
                    newState.extracurricularGrades = extrasMap;
                    
                    const attendanceData = getSheetData(this.SHEET_NAMES.ATTENDANCE);
                    const attendanceMap = {};
                    if (attendanceData.length > 1) {
                        attendanceData.slice(1).forEach(row => {
                            const [studentId, s, i, a] = row;
                            if (studentId) attendanceMap[studentId] = { s: parseInt(s, 10) || 0, i: parseInt(i, 10) || 0, a: parseInt(a, 10) || 0 };
                        });
                    }
                    newState.attendance = attendanceMap;
                    
                    const p5Data = getSheetData(this.SHEET_NAMES.P5_GRADES);
                    const p5Map = {};
                    if(p5Data.length > 1) {
                        p5Data.slice(1).forEach(row => {
                            const [studentId, gradesJson] = row;
                            if(studentId && gradesJson) {
                                try { p5Map[studentId] = JSON.parse(gradesJson); }
                                catch(e) { console.warn(`Gagal parse P5 grade untuk ${studentId}`); }
                            }
                        });
                    }
                    newState.p5Grades = p5Map;
                    
                    const notesData = getSheetData(this.SHEET_NAMES.NOTES);
                    const notesMap = {};
                    if(notesData.length > 1) notesData.slice(1).forEach(row => notesMap[row[0]] = row[1] || '');
                    newState.teacherNotes = notesMap;

                    this.state = newState;
                    this.loadState();
                    this.navigateTo(window.location.hash || '#dashboard');
                    alert('Data berhasil dimuat dari Google Sheets!');
                    this.updateSyncStatus('synced', 'Sinkronisasi berhasil');

                } else {
                    const data = [];
                    // New settings format
                    const settingsValues = [];
                    const settings = this.state.settings;
                    Object.keys(settings).forEach(key => {
                        const value = settings[key];
                        if (typeof value === 'object' && value !== null) {
                            settingsValues.push([key, JSON.stringify(value, null, 2)]);
                        } else {
                            settingsValues.push([key, value]);
                        }
                    });
                    data.push({ range: `${this.SHEET_NAMES.SETTINGS}!A1`, values: [['key', 'value'], ...settingsValues] });


                    if (this.state.students.length > 0) {
                        const studentHeaders = Object.keys(this.getEmptyStudent());
                        const studentValues = this.state.students.map(s => studentHeaders.map(h => s[h]));
                        data.push({ range: this.SHEET_NAMES.STUDENTS, values: [studentHeaders, ...studentValues] });
                    }

                    const gradesRows = [];
                    for (const studentId in this.state.grades) {
                        for (const subjectName in this.state.grades[studentId]) {
                            gradesRows.push([studentId, subjectName, JSON.stringify(this.state.grades[studentId][subjectName])]);
                        }
                    }
                    if (gradesRows.length > 0) data.push({ range: this.SHEET_NAMES.GRADES, values: [['studentId', 'subjectName', 'gradesJson'], ...gradesRows] });

                    const extrasRows = Object.entries(this.state.extracurricularGrades).map(([studentId, arr]) => [studentId, JSON.stringify(arr)]);
                    if (extrasRows.length > 0) data.push({ range: this.SHEET_NAMES.EXTRAS, values: [['studentId', 'extrasJson'], ...extrasRows] });
                    
                    const attendanceRows = Object.entries(this.state.attendance).map(([studentId, att]) => [studentId, att.s, att.i, att.a]);
                    if (attendanceRows.length > 0) data.push({ range: this.SHEET_NAMES.ATTENDANCE, values: [['studentId', 'sakit', 'izin', 'alfa'], ...attendanceRows] });

                    const p5Rows = Object.entries(this.state.p5Grades).map(([studentId, grades]) => [studentId, JSON.stringify(grades)]);
                     if (p5Rows.length > 0) data.push({ range: this.SHEET_NAMES.P5_GRADES, values: [['studentId', 'gradesJson'], ...p5Rows] });

                    const notesRows = Object.entries(this.state.teacherNotes).map(([studentId, note]) => [studentId, note]);
                    if (notesRows.length > 0) data.push({ range: this.SHEET_NAMES.NOTES, values: [['studentId', 'note'], ...notesRows] });
                    
                    await gapi.client.sheets.spreadsheets.values.batchClear({
                        spreadsheetId: spreadsheetId,
                        resource: { ranges: Object.values(this.SHEET_NAMES) }
                    });

                    if (data.length > 0) {
                        await gapi.client.sheets.spreadsheets.values.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: { valueInputOption: 'USER_ENTERED', data: data }
                        });
                    }
                    this.updateSyncStatus('synced', 'Tersimpan di Google');
                }
            } catch (err) {
                console.error("Execute error", err);
                alert('Terjadi kesalahan saat sinkronisasi: ' + (err.result?.error?.message || err.message));
                this.updateSyncStatus('error', 'Gagal sinkronisasi');
            }
        },

        updateSyncStatus(status, text) {
            // Sidebar update
            const sidebarIndicator = document.getElementById('sync-status-indicator');
            const sidebarStatusText = document.getElementById('sync-status-text');
            sidebarIndicator.className = 'sync-status-indicator'; // reset
            if (status === 'synced') sidebarIndicator.classList.add('synced');
            else if (status === 'syncing') sidebarIndicator.classList.add('syncing');
            else if (status === 'error') sidebarIndicator.classList.add('error');
            sidebarStatusText.textContent = text;
            
            // Dashboard header update
            const dashboardStatusContainer = document.getElementById('dashboard-sync-status');
            if (dashboardStatusContainer) {
                let indicatorClass = 'bg-gray-400';
                let textColorClass = 'text-gray-600';
                let statusMessage = 'Sinkronisasi Otomatis Nonaktif (Login untuk mengaktifkan).';
                let bgColorClass = 'bg-gray-200';

                if(isLoggedIn) {
                    switch(status) {
                        case 'synced':
                            indicatorClass = 'bg-green-500';
                            textColorClass = 'text-green-800';
                            bgColorClass = 'bg-green-100';
                            statusMessage = 'Sinkronisasi otomatis aktif dan data telah tersimpan.';
                            break;
                        case 'syncing':
                            indicatorClass = 'bg-amber-500 animate-pulse';
                            textColorClass = 'text-amber-800';
                            bgColorClass = 'bg-amber-100';
                            statusMessage = 'Menyimpan perubahan...';
                            break;
                        case 'error':
                            indicatorClass = 'bg-red-500';
                            textColorClass = 'text-red-800';
                            bgColorClass = 'bg-red-100';
                            statusMessage = 'Gagal sinkronisasi. Periksa koneksi Anda.';
                            break;
                        default: // disconnected state while logged in
                             indicatorClass = 'bg-gray-400';
                             textColorClass = 'text-gray-600';
                             bgColorClass = 'bg-gray-200';
                             statusMessage = 'Terputus. Sinkronisasi otomatis nonaktif.';
                    }
                }
                
                dashboardStatusContainer.className = `flex items-center text-sm px-3 py-1 rounded-full ${bgColorClass} ${textColorClass}`;
                dashboardStatusContainer.innerHTML = `
                    <span class="w-2 h-2 rounded-full mr-2 ${indicatorClass}"></span>
                    <span class="font-medium">${statusMessage}</span>
                `;
            }
        },

        getFinalScore(scoreData) {
            if (!scoreData || (typeof scoreData !== 'object')) {
                return null;
            }
            const cpScores = scoreData.cp || [];
            const ptsScore = scoreData.pts;
            const pasScore = scoreData.pas;
        
            const allScores = [...cpScores, ptsScore, pasScore];
            
            const numericScores = allScores
                .map(s => (s === null || s === '') ? NaN : Number(s))
                .filter(s => !isNaN(s));
        
            if (numericScores.length === 0) {
                return null;
            }
            const sum = numericScores.reduce((a, b) => a + b, 0);
            return Math.round(sum / numericScores.length);
        },
        
        getPredicate(score) {
            if (score == null) return '-';
            score = parseInt(score, 10);
            const { gradeRanges } = this.state.settings;
            if (score >= gradeRanges.A) return 'A'; 
            if (score >= gradeRanges.B) return 'B'; 
            if (score >= gradeRanges.C) return 'C';
            return 'D';
        },

        getSubjectAbbreviation(columnName) {
            const map = {
                'Pendidikan Agama dan Budi Pekerti': 'PABP',
                'Pendidikan Pancasila': 'PP',
                'Bahasa Indonesia': 'B.Indo',
                'Matematika': 'MTK',
                'Ilmu Pengetahuan Alam dan Sosial (IPAS)': 'IPAS',
                'Seni Budaya': 'SB',
                'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)': 'PJOK',
                'Bahasa Inggris': 'B.Ing',
            };
            
            if (columnName.startsWith('Muatan Lokal')) {
                 const match = columnName.match(/\(([^)]+)\)/);
                 if (match) {
                     return match[1].split(' ').map(word => word[0]).join('').toUpperCase();
                 }
                 return 'Mulok';
            }

            for (const key in map) {
                if (columnName.startsWith(key)) {
                    return map[key];
                }
            }

            return columnName;
        },

        init() {
            this.loadState();
            this.setupEventListeners();
            this.navigateTo(window.location.hash || '#dashboard');
        },
        
        setupEventListeners() {
            window.addEventListener('hashchange', () => this.navigateTo(window.location.hash));
            document.querySelectorAll('.sidebar-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.navigateTo(e.currentTarget.getAttribute('href'));
                });
            });

            // Google Auth
            document.getElementById('authorize_button').onclick = handleAuthClick;
            document.getElementById('signout_button').onclick = handleSignoutClick;
            document.getElementById('google-sync-save-btn').onclick = () => this.saveState();


            // Settings
            document.getElementById('save-settings-btn').addEventListener('click', this.handleSaveSettings.bind(this));
            document.getElementById('cancel-settings-btn').addEventListener('click', this.renderSettings.bind(this));
            document.getElementById('add-subject-form').addEventListener('submit', this.handleAddSubject.bind(this));
            document.getElementById('setting-schoolLogo').addEventListener('change', this.handleLogoUpload.bind(this));
            document.getElementById('setting-className').addEventListener('input', this.handleClassNameChange.bind(this));
            const academicConfigSection = document.getElementById('academic-config-section');
            academicConfigSection.addEventListener('click', this.handleAcademicConfigActions.bind(this));
            academicConfigSection.addEventListener('change', e => {
                if (e.target.id === 'subject-select-dropdown') {
                    this.handleSubjectSelect(e);
                }
            });
            academicConfigSection.addEventListener('input', e => {
                if (e.target.matches('.subject-card textarea')) {
                    this.handleSubjectDataUpdate(e.target);
                }
            });
            
            // New settings listeners
            document.getElementById('add-extracurricular-form').addEventListener('submit', this.handleAddExtracurricular.bind(this));
            document.getElementById('extracurricular-config-list').addEventListener('click', this.handleDeleteExtracurricular.bind(this));
            
            const p5ConfigSection = document.getElementById('p5-config-section');
            if (p5ConfigSection) {
                p5ConfigSection.addEventListener('click', this.handleP5ManagementActions.bind(this));
                p5ConfigSection.addEventListener('input', this.handleP5ManagementInput.bind(this));
            }


            // Students View Buttons
            document.getElementById('add-student-btn').addEventListener('click', () => this.showStudentModal());
            document.getElementById('download-template-btn').addEventListener('click', this.handleDownloadTemplate.bind(this));
            document.getElementById('upload-students-input').addEventListener('change', this.handleUploadStudents.bind(this));
            document.getElementById('students-table-body').addEventListener('click', this.handleStudentActions.bind(this));
            
            // Grades
            document.querySelector('#view-grades').addEventListener('click', (e) => {
                if(e.target.matches('.grades-tab-btn')) {
                    this.handleGradesTabClick(e);
                }
            });
            document.getElementById('edit-grades-btn').addEventListener('click', this.showEditStudentGradesModal.bind(this));
            document.getElementById('download-grades-btn').addEventListener('click', this.showDownloadGradesModal.bind(this));
            document.getElementById('upload-grades-input').addEventListener('change', this.handleUploadGrades.bind(this));
        
            // Print
            document.getElementById('generate-all-reports-btn').addEventListener('click', this.renderAllReportCards.bind(this));
            document.getElementById('print-all-reports-btn').addEventListener('click', () => window.print());

            // Modal
            document.getElementById('app-modal').addEventListener('click', (e) => {
                if (e.target.id === 'app-modal' || e.target.classList.contains('modal-close-btn')) {
                    this.closeModal();
                }
            });
        },

        navigateTo(hash) {
            const safeHash = hash || '#dashboard';
            if(window.location.hash !== safeHash) window.location.hash = safeHash;
            
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));

            const viewId = 'view-' + safeHash.substring(1);
            const activeView = document.getElementById(viewId);
            const activeLink = document.querySelector(`.sidebar-item[href="${safeHash}"]`);

            if (activeView) activeView.classList.add('active');
            if (activeLink) activeLink.classList.add('active');

            // Force rerender on navigation to ensure data is fresh
            const renderMap = {
                '#dashboard': this.renderDashboard,
                '#settings': this.renderSettings,
                '#students': this.renderStudents,
                '#grades': this.renderGrades,
                '#extracurricular': this.renderExtracurricular,
                '#p5': this.renderP5,
                '#attendance': this.renderAttendance,
                '#notes': this.renderTeacherNotes,
                '#print': this.renderPrintView
            };

            const renderFunction = renderMap[safeHash];
            if (renderFunction) {
                renderFunction.call(this);
            }
        },

        handleP5ManagementInput(e) {
            const { target } = e;
            if(!target.dataset.field) return; 

            const { field, projectId, dimensionId, subelementId, targetId } = target.dataset;

            const project = this.state.settings.p5Projects.find(p => p.id === projectId);
            if (!project) return;

            switch(field) {
                case 'name':
                    project.name = target.value;
                    const summary = target.closest('details').querySelector('summary > span');
                    if (summary) summary.textContent = target.value || 'Proyek Baru';
                    break;
                case 'description':
                    project.description = target.value;
                    break;
                case 'dimension-name':
                    project.dimensions.find(d => d.id === dimensionId).name = target.value;
                    break;
                case 'subelement-name':
                    project.dimensions.find(d => d.id === dimensionId)
                        .subElements.find(s => s.id === subelementId).name = target.value;
                    break;
                case 'target-description':
                    project.dimensions.find(d => d.id === dimensionId)
                        .subElements.find(s => s.id === subelementId)
                        .targets.find(t => t.id === targetId).description = target.value;
                    break;
            }
            this.saveState();
        },

        handleP5ManagementActions(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const { action, projectId, dimensionId, subelementId } = button.dataset;
            let project;
            let dimension;
            let subElement;
            
            if (projectId) project = this.state.settings.p5Projects.find(p => p.id === projectId);
            if (project && dimensionId) dimension = project.dimensions.find(d => d.id === dimensionId);
            if (dimension && subelementId) subElement = dimension.subElements.find(s => s.id === subelementId);

            const reRenderEditor = () => {
                this.renderP5ProjectEditor();
            };

            switch(action) {
                case 'add-project':
                    this.state.settings.p5Projects.push({
                        id: 'proj-' + Date.now(),
                        name: 'Proyek Baru', description: '', dimensions: []
                    });
                    reRenderEditor();
                    break;
                case 'delete-project':
                    if (confirm(`Yakin ingin menghapus proyek "${project.name}"? Semua data penilaian terkait akan hilang.`)) {
                        this.state.settings.p5Projects = this.state.settings.p5Projects.filter(p => p.id !== projectId);
                        Object.keys(this.state.p5Grades).forEach(studentId => {
                            if (this.state.p5Grades[studentId] && this.state.p5Grades[studentId][projectId]) {
                                delete this.state.p5Grades[studentId][projectId];
                            }
                        });
                        reRenderEditor();
                    }
                    break;
                case 'add-dimension':
                    project.dimensions.push({ id: 'dim-' + Date.now(), name: 'Dimensi Baru', subElements: [] });
                    reRenderEditor();
                    break;
                case 'delete-dimension':
                     if (confirm(`Hapus dimensi "${dimension.name}"?`)) {
                        project.dimensions = project.dimensions.filter(d => d.id !== dimensionId);
                        reRenderEditor();
                    }
                    break;
                case 'add-subelement':
                    dimension.subElements.push({ id: 'sub-' + Date.now(), name: 'Sub Elemen Baru', targets: [] });
                    reRenderEditor();
                    break;
                case 'delete-subelement':
                    dimension.subElements = dimension.subElements.filter(s => s.id !== button.dataset.subelementId);
                    reRenderEditor();
                    break;
                case 'add-target':
                    subElement.targets.push({ id: 'target-' + Date.now(), description: '' });
                    reRenderEditor();
                    break;
                case 'delete-target':
                    project.dimensions.forEach(d => {
                        d.subElements.forEach(s => {
                            s.targets = s.targets.filter(t => t.id !== button.dataset.targetId);
                        });
                    });
                    reRenderEditor();
                    break;
            }
            
            if (action.includes('delete') || action.includes('add')) {
                this.saveState();
            }
        },

        // --- RENDER FUNCTIONS ---
        renderDashboard() {
            const { settings, students, grades } = this.state;
            document.getElementById('dashboard-teacher-name').textContent = settings.teacherName || 'Guru';
            document.getElementById('dashboard-class-name').textContent = settings.className || '-';
            document.getElementById('dashboard-student-count').textContent = students.length;
            document.getElementById('dashboard-school-year').textContent = settings.schoolYear || '-';
            document.getElementById('dashboard-semester').textContent = settings.semester || '-';

            // Initial sync status render on dashboard load
            this.updateSyncStatus(
                isLoggedIn ? 'synced' : 'disconnected', 
                isLoggedIn ? 'Terhubung ke Google' : 'Sinkronisasi Google'
            );

            const analysisContainer = document.getElementById('dashboard-analysis-content');
            analysisContainer.innerHTML = ''; 

            if (!isLoggedIn) {
                 analysisContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Silakan login dengan akun Google Anda untuk memulai sinkronisasi data.</p>`;
                 return;
            }

            if (!settings.className.trim()) {
                analysisContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Silakan tentukan nama kelas di menu <a href="#settings" class="text-blue-600 hover:underline" onclick="document.querySelector('a[href=\\'#settings\\']').click()">Pengaturan</a>.</p>`;
                return;
            }
            if (students.length === 0) {
                analysisContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa. Silakan tambahkan siswa di menu <a href="#students" class="text-blue-600 hover:underline" onclick="document.querySelector('a[href=\\'#students\\']').click()">Data Siswa</a>.</p>`;
                return;
            }

            const passingGrade = settings.passingGrade || 70;
            const lowScorers = students.map(student => {
                const studentGrades = grades[student.id] || {};
                const lowScores = Object.entries(studentGrades)
                    .map(([subject, scoreObject]) => ({ subject, score: this.getFinalScore(scoreObject) }))
                    .filter(({score}) => score !== null && score < passingGrade);
                return { name: student.name, nisn: student.nisn, scores: lowScores };
            }).filter(s => s.scores.length > 0);

            if (lowScorers.length > 0) {
                analysisContainer.innerHTML = `<h4 class="font-semibold text-red-600 mb-3">Siswa dengan Nilai di Bawah KKM (${passingGrade})</h4><ul class="space-y-3">${lowScorers.map(student => `<li class="p-3 bg-red-50 border border-red-200 rounded-md"><p class="font-bold">${student.name} (NISN: ${student.nisn})</p><ul class="list-disc list-inside text-sm mt-1">${student.scores.map(s => `<li>${s.subject}: <span class="font-semibold">${s.score}</span></li>`).join('')}</ul></li>`).join('')}</ul>`;
            } else {
                const subjectStats = {};
                settings.subjects.forEach(subject => {
                    const finalScores = students.map(s => this.getFinalScore((grades[s.id] || {})[subject.name])).filter(score => score != null);
                    if (finalScores.length > 0) {
                        subjectStats[subject.name] = { avg: (finalScores.reduce((a, b) => a + b, 0) / finalScores.length).toFixed(1), min: Math.min(...finalScores), max: Math.max(...finalScores), count: finalScores.length };
                    } else { subjectStats[subject.name] = null; }
                });
                analysisContainer.innerHTML = `<h4 class="font-semibold text-green-700 mb-3">Semua siswa telah mencapai nilai KKM. Bagus!</h4><p class="mb-4 text-gray-600">Berikut adalah statistik nilai per mata pelajaran:</p><table class="w-full text-left text-sm"><thead class="bg-gray-100"><tr><th class="p-2">Mata Pelajaran</th><th class="p-2 text-center">Rata-rata</th><th class="p-2 text-center">Tertinggi</th><th class="p-2 text-center">Terendah</th><th class="p-2 text-center">Siswa Terisi</th></tr></thead><tbody>${Object.entries(subjectStats).map(([subject, stats]) => stats ? `<tr class="border-b"><td class="p-2 font-medium">${subject}</td><td class="p-2 text-center">${stats.avg}</td><td class="p-2 text-center">${stats.max}</td><td class="p-2 text-center">${stats.min}</td><td class="p-2 text-center">${stats.count} / ${students.length}</td></tr>` : `<tr class="border-b"><td class="p-2 font-medium">${subject}</td><td class="p-2 text-center text-gray-400" colspan="4">Belum ada nilai</td></tr>`).join('')}</tbody></table>`;
            }
        },

        renderSettings() {
            const { settings } = this.state;
            document.getElementById('setting-schoolName').value = settings.schoolName;
            document.getElementById('setting-npsn').value = settings.npsn;
            document.getElementById('setting-schoolAddress').value = settings.schoolAddress;
            document.getElementById('setting-village').value = settings.village;
            document.getElementById('setting-district').value = settings.district;
            document.getElementById('setting-province').value = settings.province;
            document.getElementById('setting-postalCode').value = settings.postalCode;
            document.getElementById('setting-schoolEmail').value = settings.schoolEmail;
            document.getElementById('setting-schoolPhone').value = settings.schoolPhone;
            document.getElementById('setting-website').value = settings.website;
            document.getElementById('setting-fax').value = settings.fax;
            document.getElementById('setting-className').value = settings.className;
            document.getElementById('setting-schoolYear').value = settings.schoolYear;
            document.getElementById('setting-semester').value = settings.semester;
            document.getElementById('setting-reportDate').value = settings.reportDate;
            document.getElementById('setting-headmasterName').value = settings.headmasterName;
            document.getElementById('setting-headmasterNip').value = settings.headmasterNip;
            document.getElementById('setting-teacherName').value = settings.teacherName;
            document.getElementById('setting-teacherNip').value = settings.teacherNip;
            document.getElementById('setting-grade-A').value = settings.gradeRanges.A;
            document.getElementById('setting-grade-B').value = settings.gradeRanges.B;
            document.getElementById('setting-grade-C').value = settings.gradeRanges.C;

            const logoPreview = document.getElementById('logo-preview');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            if (settings.schoolLogo) {
                logoPreview.src = settings.schoolLogo;
                logoPreview.classList.remove('hidden');
                logoPlaceholder.classList.add('hidden');
            } else {
                logoPreview.classList.add('hidden');
                logoPlaceholder.classList.remove('hidden');
            }
            
            this.handleClassNameChange({ target: { value: settings.className } });
            this.renderSubjectEditor();
            this.renderExtracurricularConfig();
            this.renderP5ProjectEditor();
        },
        
        renderP5ProjectEditor() {
            const container = document.getElementById('p5-editor-container');
            if (!container) return;

            const projects = this.state.settings.p5Projects || [];
            
            if (projects.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">Belum ada proyek. Klik "Tambah Proyek Baru" untuk memulai.</p>';
                return;
            }

            container.innerHTML = projects.map(project => `
                <details class="bg-white rounded-lg shadow-sm" open>
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-semibold text-lg border">
                        <span>${project.name || 'Proyek Baru'}</span>
                        <div class="flex items-center gap-2">
                            <button data-action="delete-project" data-project-id="${project.id}" class="text-red-500 hover:text-red-700 text-sm font-medium">Hapus Proyek</button>
                        </div>
                    </summary>
                    <div class="p-4 border border-t-0 rounded-b-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Proyek</label>
                                <input type="text" data-field="name" data-project-id="${project.id}" value="${project.name}" class="form-input w-full rounded-md border-gray-300" placeholder="e.g., Gaya Hidup Berkelanjutan">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Proyek</label>
                                <textarea data-field="description" data-project-id="${project.id}" class="form-textarea w-full rounded-md border-gray-300" rows="3" placeholder="Jelaskan tujuan dan aktivitas proyek secara singkat...">${project.description}</textarea>
                            </div>
                            
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-2">
                                   <h4 class="font-semibold">Dimensi & Target</h4>
                                   <button data-action="add-dimension" data-project-id="${project.id}" class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-md hover:bg-blue-200">+ Tambah Dimensi</button>
                                </div>
                                <div class="space-y-3">
                                ${project.dimensions.map(dim => `
                                    <div class="bg-gray-50 p-3 rounded-md border">
                                        <div class="flex items-center gap-2 mb-2">
                                            <input type="text" data-field="dimension-name" data-project-id="${project.id}" data-dimension-id="${dim.id}" value="${dim.name}" class="form-input flex-grow rounded-md border-gray-300 text-sm" placeholder="Nama Dimensi">
                                            <button data-action="delete-dimension" data-project-id="${project.id}" data-dimension-id="${dim.id}" class="text-red-500 hover:text-red-700 p-1 rounded-full"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                        </div>
                                        ${dim.subElements.map(sub => `
                                            <div class="pl-4 border-l-2 ml-2 mb-2">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <input type="text" data-field="subelement-name" data-project-id="${project.id}" data-dimension-id="${dim.id}" data-subelement-id="${sub.id}" value="${sub.name}" class="form-input flex-grow rounded-md border-gray-300 text-xs" placeholder="Nama Sub Elemen">
                                                    <button data-action="delete-subelement" data-project-id="${project.id}" data-dimension-id="${dim.id}" data-subelement-id="${sub.id}" class="text-red-500 hover:text-red-700 p-1 rounded-full"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                                </div>
                                                <div class="pl-4 space-y-1">
                                                    ${sub.targets.map(target => `
                                                        <div class="flex items-center gap-2">
                                                            <textarea data-field="target-description" data-project-id="${project.id}" data-dimension-id="${dim.id}" data-subelement-id="${sub.id}" data-target-id="${target.id}" class="form-textarea flex-grow rounded-md border-gray-300 text-xs" rows="1">${target.description}</textarea>
                                                            <button data-action="delete-target" data-project-id="${project.id}" data-target-id="${target.id}" class="text-red-500 hover:text-red-700 p-1 rounded-full"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                                        </div>
                                                    `).join('')}
                                                    <button data-action="add-target" data-project-id="${project.id}" data-dimension-id="${dim.id}" data-subelement-id="${sub.id}" class="text-gray-500 text-xs font-bold hover:text-blue-600">+ Target Pencapaian</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                        <button data-action="add-subelement" data-project-id="${project.id}" data-dimension-id="${dim.id}" class="text-blue-600 text-xs font-bold ml-2 mt-2 hover:text-blue-800">+ Sub Elemen</button>
                                    </div>
                                `).join('') || '<p class="text-sm text-center text-gray-500 py-4">Belum ada dimensi.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </details>
            `).join('');
        },

        renderExtracurricularConfig() {
            const container = document.getElementById('extracurricular-config-list');
            container.innerHTML = this.state.settings.extracurriculars.map(extra => `
                <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                    <span>${extra.name}</span>
                    <button type="button" data-id="${extra.id}" class="text-red-500 hover:text-red-700">Hapus</button>
                </div>
            `).join('');
        },
        
        renderSubjectEditor() {
            const container = document.getElementById('subjects-list');
            const subjects = this.state.settings.subjects.filter(s => !s.isDeleted).sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = `
                <label for="subject-select-dropdown" class="block text-sm font-medium text-gray-700 mb-2">Pilih mata pelajaran untuk di-edit:</label>
                <select id="subject-select-dropdown" class="form-select w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                    <option value="">-- Pilih Mata Pelajaran --</option>
                    ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                </select>
                <div id="subject-details-container" class="mt-4 min-h-[100px]"></div>
            `;
            
            const dropdown = document.getElementById('subject-select-dropdown');
            if (this.selectedSubjectName && subjects.some(s => s.name === this.selectedSubjectName)) {
                dropdown.value = this.selectedSubjectName;
            } else {
                this.selectedSubjectName = dropdown.value;
            }
            this.renderSubjectDetails(this.selectedSubjectName);

            // Render deleted subjects list
            const deletedContainer = document.getElementById('deleted-subjects-container');
            const deletedListEl = document.getElementById('deleted-subjects-list');
            const deletedSubjects = this.state.settings.subjects.filter(s => s.isDeleted).sort((a, b) => a.name.localeCompare(b.name));
            
            deletedListEl.innerHTML = '';
            if (deletedSubjects.length > 0) {
                deletedContainer.classList.remove('hidden');
                deletedSubjects.forEach(subject => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.action = 'restore-subject';
                    button.dataset.subjectName = subject.name;
                    button.className = 'bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm hover:bg-gray-300 flex items-center gap-2 transition-colors';
                    button.innerHTML = `<span>${subject.name}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>`;
                    deletedListEl.appendChild(button);
                });
            } else {
                deletedContainer.classList.add('hidden');
            }
        },
        
        renderSubjectDetails(subjectName) {
            const container = document.getElementById('subject-details-container');
            if (!container) return;

            if (!subjectName) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8 bg-gray-50 rounded-md border">Pilih mata pelajaran dari daftar di atas untuk melihat dan mengedit detailnya.</p>';
                return;
            }
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) {
                container.innerHTML = '<p class="text-center text-red-500 p-8">Mata pelajaran tidak ditemukan.</p>';
                return;
            }

            const studentForPreview = this.state.students.length > 0 ? this.state.students[0] : null;
            const studentNickname = studentForPreview ? (studentForPreview.panggilan || studentForPreview.name.split(' ')[0]) : 'Siswa';
            
            const capaianHTML = subject.capaian.map((cp, cpIndex) => `
                <div class="flex items-center gap-2">
                    <textarea data-field="capaian" data-cp-index="${cpIndex}" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="1" placeholder="Tulis capaian pembelajaran...">${cp}</textarea>
                    <button type="button" data-action="delete-cp" data-cp-index="${cpIndex}" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 hover:bg-red-200">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('');

            const capaianText = subject.capaian.join(', ');
            const previewA = subject.deskripsi.A.replace(/\[nama\]/gi, studentNickname).replace(/\[cp\]/gi, capaianText);
            const previewB = subject.deskripsi.B.replace(/\[nama\]/gi, studentNickname).replace(/\[cp\]/gi, capaianText);
            const previewC = subject.deskripsi.C.replace(/\[nama\]/gi, studentNickname).replace(/\[cp\]/gi, capaianText);
            
            container.innerHTML = `
                <div class="subject-card p-4 bg-gray-50 border rounded-md" data-subject-name="${subject.name}">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3">
                             <button type="button" data-action="add-cp" class="text-xs font-medium text-blue-600 bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded-md">+ Capaian</button>
                        </div>
                        <button type="button" data-action="delete-subject" data-subject-name="${subject.name}" class="text-red-500 hover:text-red-700 text-sm font-medium">Hapus Mapel</button>
                    </div>

                    <div class="space-y-3 pl-2 border-l-2 border-gray-200 ml-1">
                        <div>
                            <label class="text-sm font-semibold text-gray-600 mb-2 block">Daftar Capaian Pembelajaran (CP)</label>
                            <div class="space-y-2">
                                ${capaianHTML || `<p class="text-xs text-gray-500">Belum ada CP. Klik "+ Capaian" untuk menambahkan.</p>`}
                            </div>
                        </div>

                        <div>
                            <div class="space-y-3 mt-4">
                                <div>
                                    <label class="text-sm font-medium text-green-700">Deskripsi Predikat A (Sangat Baik)</label>
                                    <textarea data-field="deskripsi-A" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="2" placeholder="Tulis deskripsi...">${previewA}</textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-700">Deskripsi Predikat B (Baik)</label>
                                    <textarea data-field="deskripsi-B" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="2" placeholder="Tulis deskripsi...">${previewB}</textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-yellow-700">Deskripsi Predikat C (Cukup)</label>
                                    <textarea data-field="deskripsi-C" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="2" placeholder="Tulis deskripsi...">${previewC}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        renderStudents() {
            const tableBody = document.getElementById('students-table-body');
            tableBody.innerHTML = '';
            if (this.state.students.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Tidak ada data siswa. Tambahkan siswa secara manual atau unggah file Excel.</td></tr>`;
                return;
            }
            this.state.students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-3 text-center">${index + 1}</td>
                    <td class="p-3">${student.name}</td>
                    <td class="p-3">${student.panggilan || '-'}</td>
                    <td class="p-3">${student.nis || '-'}</td>
                    <td class="p-3">${student.nisn || '-'}</td>
                    <td class="p-3 text-center space-x-1">
                        <button data-action="edit-student" data-id="${student.id}" class="text-blue-600 hover:underline px-2 py-1 font-bold">Edit</button>
                        <button data-action="edit-grades" data-id="${student.id}" class="text-purple-600 hover:underline px-2 py-1 font-bold">Nilai</button>
                        <button data-action="print-report" data-id="${student.id}" class="text-green-600 hover:underline px-2 py-1 font-bold">Print</button>
                        <button data-action="delete-student" data-id="${student.id}" class="text-red-600 hover:underline px-2 py-1 font-bold">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        },

        renderGrades() {
            // Set default tab
            document.querySelector('.grades-tab-btn[data-tab="list"]').classList.add('active');
            document.querySelector('.grades-tab-btn[data-tab="input"]').classList.remove('active');
            document.getElementById('grades-content-list').classList.remove('hidden');
            document.getElementById('grades-content-input').classList.add('hidden');
            this.renderOverallGradesTable();
        },
        
        renderOverallGradesTable(sortBy = 'absen') {
            const container = document.getElementById('grades-content-list');
            if (this.state.students.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }
        
            const { students, grades, settings } = this.state;
        
            // Define column structure with custom order
            const subjectColumns = [
                'Pendidikan Agama dan Budi Pekerti', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 
                'Ilmu Pengetahuan Alam dan Sosial (IPAS)', 'Seni Budaya', 
                'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)', 'Bahasa Inggris', 'Muatan Lokal'
            ];
        
            // Pre-process student data with scores, total, average
            let studentData = students.map((student, index) => {
                const studentGrades = grades[student.id] || {};
                const finalScores = Object.values(studentGrades)
                                        .map(scoreObject => this.getFinalScore(scoreObject))
                                        .filter(score => score !== null);
                const total = finalScores.reduce((sum, score) => sum + score, 0);
                const average = finalScores.length > 0 ? (total / finalScores.length) : 0;
                return { student, index, total, average };
            });
        
            // Calculate ranks based on total score
            studentData.sort((a, b) => b.total - a.total);
            let rank = 1;
            for (let i = 0; i < studentData.length; i++) {
                if (i > 0 && studentData[i].total < studentData[i-1].total) {
                    rank = i + 1;
                }
                studentData[i].rank = rank;
            }
        
            // Sort data for display
            if (sortBy === 'absen') {
                studentData.sort((a, b) => a.index - b.index);
            } // 'rank' is already sorted
        
            // Helper to get the correct grade for a student and a column header
            const getGradeForColumn = (student, header) => {
                const studentGrades = grades[student.id] || {};
                let prefix = '';
                if (header.startsWith('Pendidikan Agama')) prefix = 'Pendidikan Agama';
                else if (header.startsWith('Seni Budaya')) prefix = 'Seni Budaya';
                else if (header.startsWith('Muatan Lokal')) prefix = 'Muatan Lokal';
                else { // Direct match for other subjects
                    return this.getFinalScore(studentGrades[header]) ?? '-';
                }
        
                for (const subjectName in studentGrades) {
                    if (subjectName.startsWith(prefix)) {
                         if (prefix === 'Pendidikan Agama') {
                            const religionInSubject = subjectName.match(/\(([^)]+)\)/)?.[1];
                            if (student.agama && religionInSubject && student.agama.toLowerCase() === religionInSubject.toLowerCase()) {
                                return this.getFinalScore(studentGrades[subjectName]) ?? '-';
                            }
                        } else {
                            // For SB and Mulok, return the first one found that has a score
                            const finalScore = this.getFinalScore(studentGrades[subjectName]);
                            if (finalScore !== null) return finalScore;
                        }
                    }
                }
                return '-';
            };
        
            const headerHtml = subjectColumns.map(col => `<th class="p-2 border whitespace-nowrap subject-col">${this.getSubjectAbbreviation(col)}</th>`).join('');
            
            const bodyHtml = studentData.map(data => {
                return `
                <tr class="border-b">
                    <td class="p-2 border text-center">${data.index + 1}</td>
                    <td class="p-2 border whitespace-nowrap overflow-hidden text-ellipsis" title="${data.student.name}">${data.student.name}</td>
                    ${subjectColumns.map(col => `<td class="p-2 border text-center">${getGradeForColumn(data.student, col)}</td>`).join('')}
                    <td class="p-2 border text-center font-semibold">${data.total}</td>
                    <td class="p-2 border text-center font-semibold">${Math.round(data.average)}</td>
                    <td class="p-2 border text-center font-bold">${data.rank}</td>
                </tr>
            `}).join('');
        
            container.innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <span class="font-medium">Urutkan berdasarkan:</span>
                    <button class="px-3 py-1 rounded-md ${sortBy === 'absen' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" onclick="App.renderOverallGradesTable('absen')">No. Absen</button>
                    <button class="px-3 py-1 rounded-md ${sortBy === 'rank' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" onclick="App.renderOverallGradesTable('rank')">Peringkat</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse overall-grades-table" style="table-layout: fixed;">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border" style="width: 40px;">No</th>
                                <th class="p-2 border" style="width: 200px;">Nama Siswa</th>
                                ${headerHtml}
                                <th class="p-2 border" style="width: 70px;">Jumlah</th>
                                <th class="p-2 border" style="width: 70px;">Rata-rata</th>
                                <th class="p-2 border" style="width: 70px;">Peringkat</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>`;
        },
        
        renderGradeInput() {
            const container = document.getElementById('grades-content-input');
        
            const getSubjectSortOrder = (subjectName) => {
                const order = ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam dan Sosial', 'Seni Budaya', 'Pendidikan Jasmani', 'Bahasa Inggris', 'Muatan Lokal'];
                const index = order.findIndex(prefix => subjectName.startsWith(prefix));
                return index === -1 ? order.length : index;
            };
        
            const sortedSubjects = [...this.state.settings.subjects]
                .filter(s => !s.isDeleted)
                .sort((a, b) => {
                    const orderA = getSubjectSortOrder(a.name);
                    const orderB = getSubjectSortOrder(b.name);
                    return orderA !== orderB ? orderA - orderB : a.name.localeCompare(b.name);
                });
        
            container.innerHTML = `
                <form id="grade-input-form">
                    <div class="flex items-center mb-4">
                        <div class="flex-grow">
                            <label for="grade-subject-select" class="block font-medium mb-1">Pilih Mata Pelajaran:</label>
                            <select id="grade-subject-select" class="form-select w-full md:w-2/3 rounded-md border-gray-300 bg-gray-50">
                                <option value="">-- Pilih Mapel --</option>
                                ${sortedSubjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="grade-input-save-button-container" class="ml-4 pt-6">
                            <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>Simpan Nilai</button>
                        </div>
                    </div>
                    <div id="grade-input-table-container"></div>
                </form>
            `;
            
            const selectEl = document.getElementById('grade-subject-select');
            selectEl.addEventListener('change', (e) => {
                this.selectedGradeInputSubject = e.target.value;
                const saveBtn = container.querySelector('button[type="submit"]');
                if (this.selectedGradeInputSubject) {
                    saveBtn.disabled = false;
                } else {
                    saveBtn.disabled = true;
                }
                this.renderGradeInputTable(this.selectedGradeInputSubject);
            });
            
            document.getElementById('grade-input-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (this.selectedGradeInputSubject) {
                    this.handleSaveGradesForSubject(this.selectedGradeInputSubject);
                }
            });
        },
        
        renderGradeInputTable(subjectName) {
            const container = document.getElementById('grade-input-table-container');
            if (!subjectName) {
                container.innerHTML = `<p class="text-center text-gray-500 py-8 border-t mt-4">Pilih mata pelajaran untuk mulai memasukkan nilai.</p>`;
                return;
            }
        
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) {
                container.innerHTML = `<p class="text-center text-red-500 py-4">Error: Mata pelajaran tidak ditemukan.</p>`;
                return;
            }
            
            let studentsForSubject = [...this.state.students];
            const religionMatch = subjectName.match(/Pendidikan Agama dan Budi Pekerti \(([^)]+)\)/);
        
            if (religionMatch && religionMatch[1]) {
                const religion = religionMatch[1].toLowerCase();
                studentsForSubject = studentsForSubject.filter(s => s.agama && s.agama.toLowerCase() === religion);
            }
        
            if (studentsForSubject.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4 border-t mt-4">Tidak ada siswa yang sesuai untuk mata pelajaran ini.</p>`;
                return;
            }

            const capaian = subject.capaian || [];
            if (capaian.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4 border-t mt-4">Mata pelajaran ini belum memiliki Capaian Pembelajaran (CP). Silakan tambahkan CP di menu <a href="#settings" class="text-blue-600 hover:underline">Pengaturan</a>.</p>`;
                return;
            }

            const headerCols = capaian.map((cp, index) => 
                `<th class="p-2 text-center font-bold" title="${cp}">CP ${index + 1}</th>`
            ).join('');
        
            const tableRows = studentsForSubject.map((student, index) => {
                const gradeData = this.state.grades[student.id]?.[subjectName] || { cp: [], pts: null, pas: null };
                const cpScores = gradeData.cp || [];
                const ptsScore = gradeData.pts ?? '';
                const pasScore = gradeData.pas ?? '';
                const finalScore = this.getFinalScore(gradeData);

                const inputClass = "form-input w-full text-center rounded-md border-gray-300 bg-gray-100 hover:bg-gray-200 focus:bg-white focus:ring-1 focus:ring-blue-500 transition-colors";

                const inputCols = capaian.map((_, cpIndex) => `
                    <td class="p-1">
                        <input type="number" data-studentid="${student.id}" data-cp-index="${cpIndex}" value="${cpScores[cpIndex] ?? ''}" class="${inputClass}" placeholder="-" min="0" max="100" oninput="App.updateGradeAverage('${student.id}')">
                    </td>
                `).join('');

                const ptsInput = `
                    <td class="p-1">
                        <input type="number" data-studentid="${student.id}" data-score-type="pts" value="${ptsScore}" class="${inputClass}" placeholder="-" min="0" max="100" oninput="App.updateGradeAverage('${student.id}')">
                    </td>`;
                
                const pasInput = `
                    <td class="p-1">
                        <input type="number" data-studentid="${student.id}" data-score-type="pas" value="${pasScore}" class="${inputClass}" placeholder="-" min="0" max="100" oninput="App.updateGradeAverage('${student.id}')">
                    </td>`;

                return `
                    <tr class="border-b">
                        <td class="p-2 text-center">${index + 1}</td>
                        <td class="p-2 whitespace-nowrap overflow-hidden text-ellipsis" title="${student.name}">${student.name}</td>
                        ${inputCols}
                        ${ptsInput}
                        ${pasInput}
                        <td class="p-2 text-center font-semibold" data-average-for="${student.id}">${finalScore ?? '-'}</td>
                    </tr>
                `;
            }).join('');
        
            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 mt-4 pt-4 border-t">Input Nilai: ${subjectName}</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-center" style="width: 50px;">No</th>
                                <th class="p-2 text-left" style="width: 250px;">Nama Siswa</th>
                                ${headerCols}
                                <th class="p-2 text-center font-bold" style="width: 80px;">PTS</th>
                                <th class="p-2 text-center font-bold" style="width: 80px;">PAS</th>
                                <th class="p-2 text-center font-bold" style="width: 90px;">Rata-rata</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;
        },
        
        renderExtracurricular() {
            const view = document.getElementById('view-extracurricular');
            const { students, settings, extracurricularGrades } = this.state;

            if (students.length === 0) {
                view.innerHTML = `<h2 class="text-3xl font-bold mb-6">Manajemen Data Ekstrakurikuler</h2><p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }

            const availableExtras = settings.extracurriculars || [];
            const extraOptions = `<option value="">-- Kosong --</option>` + availableExtras.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            const MAX_EXTRAS = 5;

            const tableRows = students.map((student, index) => {
                const studentExtras = extracurricularGrades[student.id] || [];
                let extraCells = '';
                for (let i = 0; i < MAX_EXTRAS; i++) {
                    const extraData = studentExtras[i];
                    extraCells += `
                        <td class="p-2 border-b">
                            <div class="space-y-1">
                                <select data-student-id="${student.id}" data-extra-index="${i}" data-field="id" class="form-select bg-gray-50 w-full text-xs rounded-md border-gray-300 p-1">
                                    ${extraOptions.replace(`value="${extraData?.id}"`, `value="${extraData?.id}" selected`)}
                                </select>
                                <input type="text" data-student-id="${student.id}" data-extra-index="${i}" data-field="grade" value="${extraData?.grade || ''}" class="form-input bg-gray-50 w-full text-xs rounded-md border-gray-300 p-1" placeholder="Predikat">
                                <input type="text" data-student-id="${student.id}" data-extra-index="${i}" data-field="description" value="${extraData?.description || ''}" class="form-input bg-gray-50 w-full text-xs rounded-md border-gray-300 p-1" placeholder="Deskripsi">
                            </div>
                        </td>
                    `;
                }

                return `
                    <tr>
                        <td class="p-2 border-b text-center align-top">${index + 1}</td>
                        <td class="p-2 border-b font-medium align-top whitespace-nowrap">${student.name}</td>
                        ${extraCells}
                    </tr>
                `;
            }).join('');

            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Ekstrakurikuler</h2>
                    <div class="flex gap-2">
                        <button id="download-extracurriculars-btn" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">Unduh Data</button>
                        <label for="upload-extracurriculars-input" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer">Unggah Data</label>
                        <input type="file" id="upload-extracurriculars-input" class="hidden" accept=".xlsx, .xls">
                        <button id="save-extracurriculars-btn" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Semua Perubahan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 w-12">No</th>
                                <th class="p-2 text-left" style="min-width: 150px;">Nama Siswa</th>
                                ${Array.from({ length: MAX_EXTRAS }, (_, i) => `<th class="p-2 text-center" style="min-width: 150px;">Ekstra ${i + 1}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="extracurricular-table-body">${tableRows}</tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('save-extracurriculars-btn').addEventListener('click', this.handleSaveAllExtracurriculars.bind(this));
            document.getElementById('download-extracurriculars-btn').addEventListener('click', this.handleDownloadExtracurriculars.bind(this));
            document.getElementById('upload-extracurriculars-input').addEventListener('change', this.handleUploadExtracurriculars.bind(this));
        },
        
        renderGenericNotesView(viewId, title, stateKey) {
            const view = document.getElementById(viewId);
            const { students } = this.state;
            const notesData = this.state[stateKey] || {};

            if (students.length === 0) {
                view.innerHTML = `<h2 class="text-3xl font-bold mb-6">${title}</h2><p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }

            const bodyHtml = students.map((student, index) => `
                <tr class="border-b">
                    <td class="p-2 text-center align-top">${index + 1}</td>
                    <td class="p-2 font-medium align-top">${student.name}</td>
                    <td class="p-2">
                        <textarea data-student-id="${student.id}" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-gray-50" rows="3">${notesData[student.id] || ''}</textarea>
                    </td>
                </tr>
            `).join('');
            
            const isTeacherNotesView = stateKey === 'teacherNotes';
            const extraButtonHtml = isTeacherNotesView 
                ? `<button id="generate-preset-notes-btn" class="bg-sky-600 text-white px-5 py-2 rounded-md hover:bg-sky-700">Buat Catatan Preset</button>` 
                : '';

            view.innerHTML = `
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">${title}</h2>
                    <div class="flex gap-2">
                        ${extraButtonHtml}
                        <button data-action="save" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Perubahan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 w-12">No</th>
                                <th class="p-2 text-left w-64">Nama Siswa</th>
                                <th class="p-2 text-left">Catatan</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>
            `;
            
            view.querySelector('button[data-action="save"]').addEventListener('click', () => {
                const textareas = view.querySelectorAll('textarea[data-student-id]');
                textareas.forEach(ta => {
                    const studentId = ta.dataset.studentId;
                    this.state[stateKey][studentId] = ta.value.trim();
                });
                this.saveState();
                alert('Data berhasil disimpan!');
            });
            
            if (isTeacherNotesView) {
                document.getElementById('generate-preset-notes-btn').addEventListener('click', this.handleGeneratePresetNotes.bind(this));
            }
        },
        
        renderP5() {
            const projects = this.state.settings.p5Projects || [];
            const tabsContainer = document.getElementById('p5-project-tabs-container');

            if (projects.length === 0) {
                tabsContainer.innerHTML = '';
                document.getElementById('p5-project-content-container').innerHTML = `
                    <p class="text-center text-gray-500 py-8">Belum ada proyek P5 yang dibuat. Silakan klik "Kelola Proyek P5" untuk memulai.</p>`;
                return;
            }

            const activeProjectId = this.state.activeP5Project || projects[0].id;

            tabsContainer.innerHTML = projects.map(p => `
                <button data-project-id="${p.id}" class="p5-project-tab py-2 px-4 border-b-2 font-semibold transition-colors duration-300 ${p.id === activeProjectId ? 'active' : ''}">
                    ${p.name}
                </button>
            `).join('');
            
            tabsContainer.querySelectorAll('.p5-project-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.state.activeP5Project = e.currentTarget.dataset.projectId;
                    this.renderP5();
                });
            });

            this.renderP5ProjectDetails(activeProjectId);
        },

        renderP5ProjectDetails(projectId) {
            const container = document.getElementById('p5-project-content-container');
            const project = this.state.settings.p5Projects.find(p => p.id === projectId);

            if (!project) {
                container.innerHTML = `<p class="text-center text-red-500 py-8">Projek tidak ditemukan.</p>`;
                return;
            }
            
            const allTargets = project.dimensions.flatMap(d => d.subElements.flatMap(s => s.targets));

            const headerHTML = project.dimensions.map(dim => {
                const targetCount = dim.subElements.flatMap(s => s.targets).length;
                return `<th colspan="${targetCount}" class="p-2 border border-gray-300 text-center bg-gray-100">${dim.name}</th>`;
            }).join('');
            
            const subHeaderHTML = project.dimensions.flatMap(dim => 
                dim.subElements.flatMap(sub => 
                    sub.targets.map(target => `<th class="p-2 border border-gray-300 text-center text-xs font-normal align-bottom" title="${target.description}">${sub.name}</th>`)
                )
            ).join('');

            const p5Levels = {
                'BB': 'Belum Berkembang',
                'MB': 'Mulai Berkembang',
                'BSH': 'Berkembang Sesuai Harapan',
                'SB': 'Sangat Berkembang'
            };
            const levelOptions = `<option value="">-</option>` + Object.entries(p5Levels).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');

            const studentRowsHTML = this.state.students.map((student, index) => {
                const studentGrades = this.state.p5Grades[student.id]?.[projectId] || {};
                const gradeCells = allTargets.map(target => {
                    const grade = studentGrades[target.id] || '';
                    return `<td class="p-1 border border-gray-300"><select data-student-id="${student.id}" data-target-id="${target.id}" class="form-select w-full text-xs p-1 rounded-md border-gray-300 bg-gray-50">${levelOptions.replace(`value="${grade}"`, `value="${grade}" selected`)}</select></td>`;
                }).join('');
                return `<tr><td class="p-2 border border-gray-300 text-center">${index+1}</td><td class="p-2 border border-gray-300">${student.name}</td>${gradeCells}</tr>`;
            }).join('');

            container.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-blue-800">${project.name}</h3>
                    <p class="text-sm text-gray-600 mt-1">${project.description}</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th rowspan="2" class="p-2 border border-gray-300 bg-gray-100" style="width: 40px;">No</th>
                                <th rowspan="2" class="p-2 border border-gray-300 bg-gray-100" style="min-width: 200px;">Nama Siswa</th>
                                ${headerHTML}
                            </tr>
                            <tr>
                                ${subHeaderHTML}
                            </tr>
                        </thead>
                        <tbody>
                            ${studentRowsHTML}
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="save-p5-grades-btn" data-project-id="${projectId}" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Penilaian Projek Ini</button>
                </div>
            `;
            
            document.getElementById('save-p5-grades-btn').addEventListener('click', this.handleSaveP5Grades.bind(this));
        },
        
        renderTeacherNotes() {
            this.renderGenericNotesView('view-notes', 'Manajemen Catatan Wali Kelas', 'teacherNotes');
        },

        renderAttendance() {
            const view = document.getElementById('view-attendance');
            const { students, attendance } = this.state;

            if (students.length === 0) {
                view.innerHTML = `<h2 class="text-3xl font-bold mb-6">Manajemen Data Absensi</h2><p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }
            
            const bodyHtml = students.map((student, index) => {
                const studentAttendance = attendance[student.id] || { s: 0, i: 0, a: 0 };
                return `<tr class="border-b">
                    <td class="p-2 text-center">${index + 1}</td>
                    <td class="p-2 font-medium">${student.name}</td>
                    <td class="p-2"><input type="number" min="0" data-student-id="${student.id}" data-type="s" class="form-input w-20 text-center rounded-md bg-gray-50" value="${studentAttendance.s}"></td>
                    <td class="p-2"><input type="number" min="0" data-student-id="${student.id}" data-type="i" class="form-input w-20 text-center rounded-md bg-gray-50" value="${studentAttendance.i}"></td>
                    <td class="p-2"><input type="number" min="0" data-student-id="${student.id}" data-type="a" class="form-input w-20 text-center rounded-md bg-gray-50" value="${studentAttendance.a}"></td>
                </tr>`;
            }).join('');

            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Absensi</h2>
                    <div class="flex gap-2">
                        <button id="download-attendance-btn" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">Unduh Data</button>
                        <label for="upload-attendance-input" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer">Unggah Data</label>
                        <input type="file" id="upload-attendance-input" class="hidden" accept=".xlsx, .xls">
                        <button id="save-attendance-btn" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Perubahan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 w-12">No</th>
                                <th class="p-2 text-left">Nama Siswa</th>
                                <th class="p-2 w-24 text-center">Sakit (S)</th>
                                <th class="p-2 w-24 text-center">Izin (I)</th>
                                <th class="p-2 w-24 text-center">Alfa (A)</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>`;
                
            document.getElementById('save-attendance-btn').addEventListener('click', this.handleSaveAttendance.bind(this));
            document.getElementById('download-attendance-btn').addEventListener('click', this.handleDownloadAttendance.bind(this));
            document.getElementById('upload-attendance-input').addEventListener('change', this.handleUploadAttendance.bind(this));
        },
        
        renderPrintView() {
            document.getElementById('print-output-area').innerHTML = '<div class="text-center text-gray-500">Klik "Hasilkan Pratinjau Rapor" untuk melihat rapor di sini.</div>';
            document.getElementById('print-all-reports-btn').classList.add('hidden');
        },
        
        renderAllReportCards() {
            const outputArea = document.getElementById('print-output-area');
            outputArea.innerHTML = '';
            if (this.state.students.length === 0) {
                 outputArea.innerHTML = '<div class="text-center text-red-500">Tidak ada data siswa untuk membuat rapor.</div>';
                 return;
            }
            this.state.students.forEach(student => {
                outputArea.innerHTML += this.createReportCardHTML(student, this.state.grades[student.id] || {});
            });
            document.getElementById('print-all-reports-btn').classList.remove('hidden');
        },

        // --- EVENT HANDLERS ---
        handleSaveSettings() {
            const settings = this.state.settings;
            settings.schoolName = document.getElementById('setting-schoolName').value;
            settings.npsn = document.getElementById('setting-npsn').value;
            settings.schoolAddress = document.getElementById('setting-schoolAddress').value;
            settings.village = document.getElementById('setting-village').value;
            settings.district = document.getElementById('setting-district').value;
            settings.province = document.getElementById('setting-province').value;
            settings.postalCode = document.getElementById('setting-postalCode').value;
            settings.schoolEmail = document.getElementById('setting-schoolEmail').value;
            settings.schoolPhone = document.getElementById('setting-schoolPhone').value;
            settings.website = document.getElementById('setting-website').value;
            settings.fax = document.getElementById('setting-fax').value;
            settings.className = document.getElementById('setting-className').value;
            settings.schoolYear = document.getElementById('setting-schoolYear').value;
            settings.semester = document.getElementById('setting-semester').value;
            settings.reportDate = document.getElementById('setting-reportDate').value;
            settings.headmasterName = document.getElementById('setting-headmasterName').value;
            settings.headmasterNip = document.getElementById('setting-headmasterNip').value;
            settings.teacherName = document.getElementById('setting-teacherName').value;
            settings.teacherNip = document.getElementById('setting-teacherNip').value;
            
            settings.gradeRanges.A = parseInt(document.getElementById('setting-grade-A').value, 10) || 90;
            settings.gradeRanges.B = parseInt(document.getElementById('setting-grade-B').value, 10) || 80;
            settings.gradeRanges.C = parseInt(document.getElementById('setting-grade-C').value, 10) || 70;
            settings.passingGrade = settings.gradeRanges.C;
            
            this.saveState();
            alert('Pengaturan berhasil disimpan!');
            this.renderDashboard();
        },

        handleAddExtracurricular(e) {
            e.preventDefault();
            const input = document.getElementById('extracurricular-name-input');
            const name = input.value.trim();
            if (name && !this.state.settings.extracurriculars.some(ex => ex.name === name)) {
                this.state.settings.extracurriculars.push({ id: 'e' + Date.now(), name });
                this.saveState();
                this.renderExtracurricularConfig();
                input.value = '';
            }
        },

        handleDeleteExtracurricular(e) {
            if (e.target.tagName === 'BUTTON') {
                const extraId = e.target.dataset.id;
                this.state.settings.extracurriculars = this.state.settings.extracurriculars.filter(ex => ex.id !== extraId);
                // Also remove grades associated with this extracurricular
                Object.keys(this.state.extracurricularGrades).forEach(studentId => {
                    this.state.extracurricularGrades[studentId] = this.state.extracurricularGrades[studentId].filter(ex => ex.id !== extraId);
                });
                this.saveState();
                this.renderExtracurricularConfig();
            }
        },

        handleSaveAllExtracurriculars() {
            const newGrades = {};
            const MAX_EXTRAS = 5;

            this.state.students.forEach(student => {
                const studentExtras = [];
                for (let i = 0; i < MAX_EXTRAS; i++) {
                    const id = document.querySelector(`select[data-student-id="${student.id}"][data-extra-index="${i}"]`).value;
                    if (id) {
                        const description = document.querySelector(`input[data-student-id="${student.id}"][data-extra-index="${i}"][data-field="description"]`).value;
                        const grade = document.querySelector(`input[data-student-id="${student.id}"][data-extra-index="${i}"][data-field="grade"]`).value;
                        studentExtras.push({ id, description, grade });
                    }
                }
                newGrades[student.id] = studentExtras;
            });
            
            this.state.extracurricularGrades = newGrades;
            this.saveState();
            alert('Data ekstrakurikuler berhasil disimpan!');
        },

        handleDownloadExtracurriculars() {
            const { students, settings, extracurricularGrades } = this.state;
            const MAX_EXTRAS = 5;

            // 1. Create metadata
            const metadata = [
                ['Nama Kelas', settings.className],
                ['Tahun Ajaran / Semester', `${settings.schoolYear} / ${settings.semester}`],
                ['Daftar Ekstrakurikuler Tersedia', settings.extracurriculars.map(e => e.name).join(', ')],
                [] // Empty row
            ];

            // 2. Create headers
            const headers = ['No. Absen', 'NISN', 'Nama Siswa'];
            for (let i = 0; i < MAX_EXTRAS; i++) {
                headers.push(`Ekstra ${i + 1} - Nama`);
                headers.push(`Ekstra ${i + 1} - Predikat`);
                headers.push(`Ekstra ${i + 1} - Deskripsi`);
            }

            // 3. Create student data rows
            const studentRows = students.map((student, index) => {
                const row = [
                    index + 1,
                    student.nisn || '',
                    student.name
                ];

                const studentExtras = extracurricularGrades[student.id] || [];

                for (let i = 0; i < MAX_EXTRAS; i++) {
                    const extraData = studentExtras[i];
                    let extraName = '';
                    if (extraData && extraData.id) {
                        const extraSetting = settings.extracurriculars.find(e => e.id === extraData.id);
                        if (extraSetting) {
                            extraName = extraSetting.name;
                        }
                    }
                    row.push(extraName);
                    row.push(extraData?.grade || '');
                    row.push(extraData?.description || '');
                }

                return row;
            });
            
            // 4. Combine data
            const finalSheetData = [...metadata, headers, ...studentRows];

            // 5. Create worksheet and workbook
            const ws = XLSX.utils.aoa_to_sheet(finalSheetData);
            
            // 6. Adjust column widths
            ws['!cols'] = headers.map((header, i) => {
                const defaultWidth = String(header).length;
                const maxLength = Math.max(
                    defaultWidth,
                    ...finalSheetData.map(row => (row[i] ? String(row[i]).length : 0))
                );
                return { wch: Math.min(maxLength + 2, 60) };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Ekstrakurikuler");
            XLSX.writeFile(wb, "data_ekstrakurikuler.xlsx");
        },

        handleUploadExtracurriculars(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws);

                    const previewData = { validChanges: [], errors: [], warnings: [] };
                    const appStudentsByNisn = new Map(this.state.students.map(s => [String(s.nisn || '').trim(), s]));
                    const extraSettingsByName = new Map(this.state.settings.extracurriculars.map(ex => [ex.name, ex.id]));
                    const MAX_EXTRAS = 5;

                    jsonData.forEach((row, rowIndex) => {
                        const nisn = String(row['NISN'] || '').trim();
                        if (!nisn) {
                            previewData.warnings.push({ message: `Baris ${rowIndex + 2}: Ditemukan data tanpa NISN. Baris ini diabaikan.`});
                            return;
                        }
                        
                        const student = appStudentsByNisn.get(nisn);
                        if (!student) {
                            previewData.warnings.push({ message: `Siswa dengan NISN "${nisn}" (${row['Nama Siswa']}) tidak ditemukan. Data diabaikan.`});
                            return;
                        }

                        const newStudentExtras = [];
                        let hasChange = false;

                        for (let i = 1; i <= MAX_EXTRAS; i++) {
                            const extraName = row[`Ekstra ${i} - Nama`]?.trim();
                            if (extraName) {
                                const extraId = extraSettingsByName.get(extraName);
                                if (extraId) {
                                    const grade = row[`Ekstra ${i} - Predikat`] || '';
                                    const description = row[`Ekstra ${i} - Deskripsi`] || '';
                                    newStudentExtras.push({ id: extraId, grade, description });
                                    hasChange = true;
                                } else {
                                     previewData.warnings.push({ message: `Ekstrakurikuler "${extraName}" untuk siswa ${student.name} tidak ditemukan di Pengaturan. Data ini diabaikan.`});
                                }
                            }
                        }

                        if (hasChange) {
                            previewData.validChanges.push({ studentId: student.id, studentName: student.name, newExtras: newStudentExtras });
                        }
                    });

                    this.showUploadExtrasPreviewModal(previewData);

                } catch (error) {
                    console.error("Error processing Excel file for extracurriculars:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showUploadExtrasPreviewModal(previewData) {
            this.pendingExtraImport = previewData.validChanges;
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';

            const warningsHtml = previewData.warnings.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-yellow-600">Peringatan (Data Bermasalah Akan Diabaikan):</h4>
                <ul class="list-disc list-inside text-sm text-yellow-700">${previewData.warnings.map(w => `<li>${w.message}</li>`).join('')}</ul></div>` : '';
            
            const changesHtml = this.pendingExtraImport.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-blue-600">Data yang akan Diimpor (${this.pendingExtraImport.length} siswa):</h4>
                <ul class="list-disc list-inside text-sm text-blue-700 max-h-40 overflow-y-auto">${this.pendingExtraImport.map(change => `<li><b>${change.studentName}:</b> ${change.newExtras.length} kegiatan ekstra.</li>`).join('')}</ul></div>` : '<p class="text-gray-500">Tidak ada data baru yang akan diimpor.</p>';

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Pratinjau Unggah Data Ekstrakurikuler</h3>
                    <div class="max-h-80 overflow-y-auto pr-2">
                        ${warningsHtml}
                        ${changesHtml}
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Mengimpor data ini akan MENIMPA semua data ekstrakurikuler yang ada untuk siswa yang terpengaruh.</p>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Tutup</button>
                        <button id="confirm-extra-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ${this.pendingExtraImport.length === 0 ? 'hidden' : ''}">Konfirmasi Import</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-extra-import-btn').onclick = this.applyExtraImport.bind(this);
            this.openModal();
        },

        applyExtraImport() {
            if (!this.pendingExtraImport) return;
            
            this.pendingExtraImport.forEach(change => {
                this.state.extracurricularGrades[change.studentId] = change.newExtras;
            });
            
            this.saveState();
            this.pendingExtraImport = null;
            alert('Data ekstrakurikuler berhasil diimpor!');
            this.closeModal();
            this.renderExtracurricular();
        },

        handleClassNameChange(e) {
            const academicConfigSection = document.getElementById('academic-config-section');
            const className = e.target.value.trim();
            if (className) {
                const gradeMatch = className.match(/\d+/);
                const grade = gradeMatch ? parseInt(gradeMatch[0], 10) : null;
                
                if (grade) {
                    document.getElementById('academic-config-grade').textContent = grade;
                    academicConfigSection.classList.remove('hidden');

                    let needsRender = false;

                    const islamSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Islam)');
                    if (islamSubject && this.islamCpsByGrade[grade]) {
                        islamSubject.capaian = this.islamCpsByGrade[grade];
                        needsRender = true;
                    }
                    const kristenSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Kristen)');
                    if (kristenSubject && this.kristenCpsByGrade[grade]) {
                        kristenSubject.capaian = this.kristenCpsByGrade[grade];
                        needsRender = true;
                    }
                    const katolikSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Katolik)');
                    if (katolikSubject && this.katolikCpsByGrade[grade]) {
                        katolikSubject.capaian = this.katolikCpsByGrade[grade];
                        needsRender = true;
                    }
                    const hinduSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Hindu)');
                    if (hinduSubject && this.hinduCpsByGrade[grade]) {
                        hinduSubject.capaian = this.hinduCpsByGrade[grade];
                        needsRender = true;
                    }
                    const buddhaSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Buddha)');
                    if (buddhaSubject && this.buddhaCpsByGrade[grade]) {
                        buddhaSubject.capaian = this.buddhaCpsByGrade[grade];
                        needsRender = true;
                    }
                    const khonghucuSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Khonghucu)');
                    if (khonghucuSubject && this.khonghucuCpsByGrade[grade]) {
                        khonghucuSubject.capaian = this.khonghucuCpsByGrade[grade];
                        needsRender = true;
                    }

                    const pancasilaSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Pancasila');
                    if (pancasilaSubject && this.pancasilaCpsByGrade[grade]) {
                        pancasilaSubject.capaian = this.pancasilaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const matematikaSubject = this.state.settings.subjects.find(s => s.name === 'Matematika');
                    if (matematikaSubject && this.matematikaCpsByGrade[grade]) {
                        matematikaSubject.capaian = this.matematikaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const bahasaIndonesiaSubject = this.state.settings.subjects.find(s => s.name === 'Bahasa Indonesia');
                    if (bahasaIndonesiaSubject && this.bahasaIndonesiaCpsByGrade[grade]) {
                        bahasaIndonesiaSubject.capaian = this.bahasaIndonesiaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const ipasSubject = this.state.settings.subjects.find(s => s.name === 'Ilmu Pengetahuan Alam dan Sosial (IPAS)');
                    if (ipasSubject && this.ipasCpsByGrade[grade]) {
                        ipasSubject.capaian = this.ipasCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniDaerahSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Seni Daerah)');
                    if (seniDaerahSubject && this.seniDaerahCpsByGrade[grade]) {
                        seniDaerahSubject.capaian = this.seniDaerahCpsByGrade[grade];
                        needsRender = true;
                    }

                    const kerajinanDaerahSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Kerajinan Daerah)');
                    if (kerajinanDaerahSubject && this.kerajinanDaerahCpsByGrade[grade]) {
                        kerajinanDaerahSubject.capaian = this.kerajinanDaerahCpsByGrade[grade];
                        needsRender = true;
                    }

                    const kearifanLokalSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Kearifan Lokal)');
                    if (kearifanLokalSubject && this.kearifanLokalCpsByGrade[grade]) {
                        kearifanLokalSubject.capaian = this.kearifanLokalCpsByGrade[grade];
                        needsRender = true;
                    }
                    
                    const bahasaDaerahSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Bahasa Daerah)');
                    if (bahasaDaerahSubject && this.bahasaDaerahCpsByGrade[grade]) {
                        bahasaDaerahSubject.capaian = this.bahasaDaerahCpsByGrade[grade];
                        needsRender = true;
                    }

                    const bahasaInggrisSubject = this.state.settings.subjects.find(s => s.name === 'Bahasa Inggris');
                    if (bahasaInggrisSubject && this.bahasaInggrisCpsByGrade[grade]) {
                        bahasaInggrisSubject.capaian = this.bahasaInggrisCpsByGrade[grade];
                        needsRender = true;
                    }
                    
                    const pjokSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)');
                    if (pjokSubject && this.pjokCpsByGrade[grade]) {
                        pjokSubject.capaian = this.pjokCpsByGrade[grade];
                        needsRender = true;
                    }
                    
                    const prakaryaSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Prakarya)');
                    if (prakaryaSubject && this.prakaryaCpsByGrade[grade]) {
                        prakaryaSubject.capaian = this.prakaryaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniMusikSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Seni Musik)');
                    if (seniMusikSubject && this.seniMusikCpsByGrade[grade]) {
                        seniMusikSubject.capaian = this.seniMusikCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniRupaSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Seni Rupa)');
                    if (seniRupaSubject && this.seniRupaCpsByGrade[grade]) {
                        seniRupaSubject.capaian = this.seniRupaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniTariSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Seni Tari)');
                    if (seniTariSubject && this.seniTariCpsByGrade[grade]) {
                        seniTariSubject.capaian = this.seniTariCpsByGrade[grade];
                        needsRender = true;
                    }

                    if (needsRender) {
                        this.renderSubjectEditor();
                    }
                } else {
                    academicConfigSection.classList.add('hidden');
                }
            } else {
                academicConfigSection.classList.add('hidden');
            }
        },

        handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                this.state.settings.schoolLogo = event.target.result;
                const preview = document.getElementById('logo-preview');
                const placeholder = document.getElementById('logo-placeholder');
                preview.src = this.state.settings.schoolLogo;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        },

        handleAddSubject(e) {
            e.preventDefault();
            const input = document.getElementById('subject-name');
            const newSubjectName = input.value.trim();
            if (newSubjectName && !this.state.settings.subjects.some(s => s.name === newSubjectName)) {
                this.state.settings.subjects.push({ 
                    name: newSubjectName, 
                    capaian: [], 
                    deskripsi: { A: '', B: '', C: '' },
                    isDeleted: false
                });
                this.renderSubjectEditor();
                input.value = '';
            } else {
                alert('Mata pelajaran sudah ada atau nama tidak valid.');
            }
        },
        
        handleAcademicConfigActions(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const subjectCard = button.closest('.subject-card');
            const subjectName = subjectCard ? subjectCard.dataset.subjectName : button.dataset.subjectName;

            const subject = this.state.settings.subjects.find(s => s.name === subjectName);

            switch(action) {
                case 'delete-subject':
                    if (!confirm(`Hapus mapel "${subjectName}"? Ini akan menghapus semua nilai terkait, namun bisa dikembalikan nanti.`)) return;
                    if (subject) {
                        subject.isDeleted = true;
                        Object.keys(this.state.grades).forEach(studentId => delete this.state.grades[studentId][subjectName]);
                        this.selectedSubjectName = null;
                        this.renderSubjectEditor();
                    }
                    break;
                case 'restore-subject':
                    if (subject) {
                        subject.isDeleted = false;
                        this.selectedSubjectName = subjectName;
                        this.renderSubjectEditor();
                    }
                    break;
                case 'add-cp':
                    if (subject) {
                        subject.capaian.push('');
                        this.renderSubjectDetails(subject.name);
                    }
                    break;
                case 'delete-cp':
                    if (subject) {
                        const cpIndex = parseInt(button.dataset.cpIndex, 10);
                        subject.capaian.splice(cpIndex, 1);
                        this.renderSubjectDetails(subject.name);
                    }
                    break;
            }
        },
        
        handleSubjectSelect(e) {
            this.selectedSubjectName = e.target.value;
            this.renderSubjectDetails(this.selectedSubjectName);
        },
        
        handleSubjectDataUpdate(targetTextarea) {
            const subjectCard = targetTextarea.closest('.subject-card');
            if (!subjectCard) return;

            const subjectName = subjectCard.dataset.subjectName;
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) return;

            const field = targetTextarea.dataset.field;
            
            if (field === 'capaian') {
                const cpIndex = parseInt(targetTextarea.dataset.cpIndex, 10);
                subject.capaian[cpIndex] = targetTextarea.value;
            } else if (field.startsWith('deskripsi-')) {
                const studentForPreview = this.state.students.length > 0 ? this.state.students[0] : null;
                const studentNickname = studentForPreview ? (studentForPreview.panggilan || studentForPreview.name.split(' ')[0]) : 'Siswa';
                const capaianText = subject.capaian.join(', ');

                const convertToTemplate = (previewText) => {
                    let template = previewText.replace(new RegExp(studentNickname.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), '[nama]');
                    if (capaianText) {
                        const escapedCapaianText = capaianText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        template = template.replace(new RegExp(escapedCapaianText, 'g'), '[cp]');
                    }
                    return template;
                };

                if(field === 'deskripsi-A') subject.deskripsi.A = convertToTemplate(targetTextarea.value);
                if(field === 'deskripsi-B') subject.deskripsi.B = convertToTemplate(targetTextarea.value);
                if(field === 'deskripsi-C') subject.deskripsi.C = convertToTemplate(targetTextarea.value);
            }
        },

        handleStudentActions(e) {
            const target = e.target.closest('button, a');
            if (!target) return;
            const action = target.dataset.action;
            const id = target.dataset.id;
            switch(action) {
                case 'edit-student': this.showStudentModal(id); break;
                case 'delete-student': this.handleDeleteStudent(id); break;
                case 'print-report': this.showPrintModalForStudent(id); break;
                case 'edit-grades': this.showEditStudentGradesModal(id); break;
            }
        },
        
        handleDeleteStudent(studentId) {
             if (confirm('Apakah Anda yakin ingin menghapus siswa ini beserta semua datanya?')) {
                this.state.students = this.state.students.filter(s => s.id !== studentId);
                delete this.state.grades[studentId];
                delete this.state.extracurricularGrades[studentId];
                delete this.state.attendance[studentId];
                delete this.state.p5Grades[studentId];
                delete this.state.teacherNotes[studentId];
                this.saveState();
                this.renderStudents();
            }
        },
        
        handleGradesTabClick(e) {
            const tab = e.target.dataset.tab;
            document.querySelectorAll('.grades-tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
        
            document.querySelectorAll('.grades-content').forEach(content => content.classList.add('hidden'));
            const activeContent = document.getElementById(`grades-content-${tab}`);
            activeContent.classList.remove('hidden');
        
            if (tab === 'list') {
                this.renderOverallGradesTable();
            } else if (tab === 'input') {
                this.renderGradeInput();
            }
        },
        
        handleSaveGradesForSubject(subjectName) {
            const form = document.getElementById('grade-input-form');
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) return;

            const inputs = form.querySelectorAll(`input[type="number"][data-studentid]`);
            const studentScores = {}; // { studentId: { cp: [...], pts: null, pas: null } }

            inputs.forEach(input => {
                const studentId = input.dataset.studentid;
                
                if (!studentScores[studentId]) {
                    studentScores[studentId] = {
                        cp: new Array(subject.capaian.length).fill(null),
                        pts: null,
                        pas: null
                    };
                }

                const value = input.value.trim() === '' ? null : parseInt(input.value, 10);
                
                if (input.dataset.cpIndex) {
                    const cpIndex = parseInt(input.dataset.cpIndex, 10);
                    studentScores[studentId].cp[cpIndex] = value;
                } else if (input.dataset.scoreType === 'pts') {
                    studentScores[studentId].pts = value;
                } else if (input.dataset.scoreType === 'pas') {
                    studentScores[studentId].pas = value;
                }
            });

            Object.keys(studentScores).forEach(studentId => {
                if (!this.state.grades[studentId]) {
                    this.state.grades[studentId] = {};
                }
                this.state.grades[studentId][subjectName] = studentScores[studentId];
            });
            
            this.saveState();
            alert(`Nilai untuk ${subjectName} berhasil disimpan!`);
        },
        
        handleSaveAttendance() {
            const inputs = document.querySelectorAll('#view-attendance input[type="number"]');
            inputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const type = input.dataset.type;
                if (!this.state.attendance[studentId]) {
                    this.state.attendance[studentId] = { s: 0, i: 0, a: 0 };
                }
                this.state.attendance[studentId][type] = parseInt(input.value, 10) || 0;
            });
            this.saveState();
            alert('Data absensi berhasil disimpan!');
        },

        handleDownloadAttendance() {
            const { students, settings, attendance } = this.state;
            
            const metadata = [
                ['Nama Kelas', settings.className],
                ['Tahun Ajaran / Semester', `${settings.schoolYear} / ${settings.semester}`],
                [] // Empty row
            ];

            const headers = ['No. Absen', 'NISN', 'Nama Siswa', 'Sakit', 'Izin', 'Alfa'];

            const studentRows = students.map((student, index) => {
                const studentAttendance = attendance[student.id] || { s: 0, i: 0, a: 0 };
                return [
                    index + 1,
                    student.nisn || '',
                    student.name,
                    studentAttendance.s,
                    studentAttendance.i,
                    studentAttendance.a
                ];
            });

            const finalSheetData = [...metadata, headers, ...studentRows];

            const ws = XLSX.utils.aoa_to_sheet(finalSheetData);
            
            ws['!cols'] = headers.map((header, i) => {
                const defaultWidth = String(header).length;
                const maxLength = Math.max(
                    defaultWidth,
                    ...finalSheetData.map(row => (row[i] ? String(row[i]).length : 0))
                );
                return { wch: Math.min(maxLength + 2, 60) };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Absensi");
            XLSX.writeFile(wb, "data_absensi.xlsx");
        },

        handleUploadAttendance(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { range: 3 }); // Skip metadata

                    const previewData = { validChanges: [], errors: [], warnings: [] };
                    const appStudentsByNisn = new Map(this.state.students.map(s => [String(s.nisn || '').trim(), s]));

                    jsonData.forEach((row, rowIndex) => {
                        const nisn = String(row['NISN'] || '').trim();
                        if (!nisn) {
                            previewData.warnings.push({ message: `Baris ${rowIndex + 5}: Ditemukan data tanpa NISN. Baris ini diabaikan.` });
                            return;
                        }
                        
                        const student = appStudentsByNisn.get(nisn);
                        if (!student) {
                            previewData.warnings.push({ message: `Siswa dengan NISN "${nisn}" (${row['Nama Siswa']}) tidak ditemukan. Data diabaikan.` });
                            return;
                        }
                        
                        const sakit = parseInt(row['Sakit'], 10) || 0;
                        const izin = parseInt(row['Izin'], 10) || 0;
                        const alfa = parseInt(row['Alfa'], 10) || 0;
                        
                        previewData.validChanges.push({ 
                            studentId: student.id, 
                            studentName: student.name, 
                            attendance: { s: sakit, i: izin, a: alfa } 
                        });
                    });

                    this.showUploadAttendancePreviewModal(previewData);

                } catch (error) {
                    console.error("Error processing Excel file for attendance:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showUploadAttendancePreviewModal(previewData) {
            this.pendingAttendanceImport = previewData.validChanges;
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';

            const warningsHtml = previewData.warnings.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-yellow-600">Peringatan (Data Bermasalah Akan Diabaikan):</h4>
                <ul class="list-disc list-inside text-sm text-yellow-700">${previewData.warnings.map(w => `<li>${w.message}</li>`).join('')}</ul></div>` : '';
            
            const changesHtml = this.pendingAttendanceImport.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-blue-600">Data Absensi yang akan Diimpor (${this.pendingAttendanceImport.length} siswa):</h4>
                <ul class="list-disc list-inside text-sm text-blue-700 max-h-40 overflow-y-auto">${this.pendingAttendanceImport.map(change => `<li><b>${change.studentName}:</b> S: ${change.attendance.s}, I: ${change.attendance.i}, A: ${change.attendance.a}</li>`).join('')}</ul></div>` : '<p class="text-gray-500">Tidak ada data baru yang akan diimpor.</p>';

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Pratinjau Unggah Data Absensi</h3>
                    <div class="max-h-80 overflow-y-auto pr-2">
                        ${warningsHtml}
                        ${changesHtml}
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Mengimpor data ini akan MENIMPA semua data absensi yang ada untuk siswa yang terpengaruh.</p>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Tutup</button>
                        <button id="confirm-attendance-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ${this.pendingAttendanceImport.length === 0 ? 'hidden' : ''}">Konfirmasi Import</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-attendance-import-btn').onclick = this.applyAttendanceImport.bind(this);
            this.openModal();
        },

        applyAttendanceImport() {
            if (!this.pendingAttendanceImport) return;
            
            this.pendingAttendanceImport.forEach(change => {
                this.state.attendance[change.studentId] = change.attendance;
            });
            
            this.saveState();
            this.pendingAttendanceImport = null;
            alert('Data absensi berhasil diimpor!');
            this.closeModal();
            this.renderAttendance();
        },

        handleGeneratePresetNotes() {
            if (!confirm('Tindakan ini akan menimpa semua catatan wali kelas yang ada dengan preset baru. Lanjutkan?')) {
                return;
            }

            const { students, grades } = this.state;

            students.forEach(student => {
                const studentGrades = grades[student.id] || {};
                
                let excellentSubjects = [];
                let highestScore = -1;
                let subjectWithHighestScore = null;

                Object.entries(studentGrades).forEach(([subjectName, scoreObject]) => {
                    const finalScore = this.getFinalScore(scoreObject);
                    if (finalScore !== null) {
                        if (this.getPredicate(finalScore) === 'A') {
                            excellentSubjects.push(subjectName);
                        }
                        if (finalScore > highestScore) {
                            highestScore = finalScore;
                            subjectWithHighestScore = subjectName;
                        }
                    }
                });

                let bestSubjectText = '';
                if (excellentSubjects.length > 0) {
                    const mainSubjects = new Set();
                    excellentSubjects.forEach(s => {
                        mainSubjects.add(s.split('(')[0].trim());
                    });
                    bestSubjectText = Array.from(mainSubjects).join(', ');
                } else if (subjectWithHighestScore) {
                    bestSubjectText = subjectWithHighestScore.split('(')[0].trim();
                }

                const praises = [
                    "Sikap positif dan rasa ingin tahu Ananda sangat tinggi.",
                    "Ananda menunjukkan bakat dan potensi yang luar biasa.",
                    "Ananda adalah aset berharga di kelas ini dengan semangat belajarnya.",
                    "Kemampuan Ananda dalam beradaptasi dan bekerja sama sangat baik."
                ];

                const motivations = [
                    "Teruslah belajar dan berusaha menjadi versi terbaik dari dirimu.",
                    "Ibu/Bapak Guru yakin Ananda bisa meraih semua cita-cita.",
                    "Jangan pernah ragu untuk bertanya dan terus kembangkan potensimu.",
                    "Pertahankan semangat yang membara ini hingga akhir semester."
                ];
                
                const randomPraise = praises[Math.floor(Math.random() * praises.length)];
                const randomMotivation = motivations[Math.floor(Math.random() * motivations.length)];
                const studentNickname = student.panggilan || student.name.split(' ')[0];
                
                let note = '';
                if (bestSubjectText) {
                    note = `${studentNickname} menunjukkan pencapaian yang sangat baik, terutama dalam mata pelajaran ${bestSubjectText}. ${randomPraise} ${randomMotivation} Pertahankan terus prestasi dan semangat belajarmu, ya!`;
                } else {
                    note = `${studentNickname} adalah siswa yang rajin dan bersemangat. ${randomPraise} ${randomMotivation} Tingkatkan terus prestasimu di semester depan agar lebih gemilang!`;
                }

                this.state.teacherNotes[student.id] = note;
            });

            this.renderTeacherNotes();
            alert('Catatan preset berhasil dibuat untuk semua siswa!');
        },

        updateGradeAverage(studentId) {
            const scoreInputs = document.querySelectorAll(`input[data-studentid="${studentId}"]`);
            const gradeData = { cp: [], pts: null, pas: null };

            let maxCpIndex = -1;
            scoreInputs.forEach(input => {
                if (input.dataset.cpIndex) {
                    maxCpIndex = Math.max(maxCpIndex, parseInt(input.dataset.cpIndex, 10));
                }
            });
            gradeData.cp = new Array(maxCpIndex + 1).fill(null);

            scoreInputs.forEach(input => {
                const val = input.value.trim() === '' ? null : Number(input.value);
                if (input.dataset.cpIndex) {
                    gradeData.cp[parseInt(input.dataset.cpIndex, 10)] = val;
                } else if (input.dataset.scoreType === 'pts') {
                    gradeData.pts = val;
                } else if (input.dataset.scoreType === 'pas') {
                    gradeData.pas = val;
                }
            });
            
            const finalScore = this.getFinalScore(gradeData);
            const averageCell = document.querySelector(`td[data-average-for="${studentId}"]`);
            if (averageCell) {
                averageCell.textContent = finalScore ?? '-';
            }
        },

        handleDownloadTemplate() {
            let exportData;
            if (this.state.students.length > 0) {
                 exportData = this.state.students.map((student, index) => ({
                    'No. Absen': index + 1, 'NIS': student.nis, 'NISN': student.nisn, 'Nama Siswa': student.name, 'Panggilan': student.panggilan, 'Tempat, Tanggal Lahir': student.ttl, 'Jenis Kelamin': student.jenisKelamin, 'Agama': student.agama, 'Kewarganegaraan': student.kewarganegaraan, 'Status dalam Keluarga': student.statusKeluarga, 'Anak ke': student.anakKe, 'Asal TK': student.asalTk, 'Alamat Siswa': student.alamat, 'Nama Ayah': student.namaAyah, 'Nama Ibu': student.namaIbu, 'Pekerjaan Ayah': student.pekerjaanAyah, 'Pekerjaan Ibu': student.pekerjaanIbu, 'Alamat Orang Tua': student.alamatOrtu, 'Telepon Orang Tua': student.teleponOrtu, 'Kelurahan/Desa': student.kelurahan, 'Kecamatan': student.kecamatan, 'Kabupaten/Kota': student.kabupaten, 'Provinsi': student.provinsi, 'Nama Wali': student.namaWali, 'Pekerjaan Wali': student.pekerjaanWali, 'Alamat Wali': student.alamatWali, 'Telepon Wali': student.teleponWali
                }));
            } else {
                exportData = [{
                    'No. Absen': 1, 'NIS': '12345', 'NISN': '0012345678', 'Nama Siswa': 'Siswa Contoh', 'Panggilan': 'Contoh', 'Tempat, Tanggal Lahir': 'Jakarta, 1 Januari 2015', 'Jenis Kelamin': 'L/P', 'Agama': 'Islam', 'Kewarganegaraan': 'WNI', 'Status dalam Keluarga': 'Anak Kandung', 'Anak ke': 1, 'Asal TK': 'TK Tunas Bangsa', 'Alamat Siswa': 'Jl. Pendidikan No. 1', 'Nama Ayah': 'Bapak Contoh', 'Nama Ibu': 'Ibu Contoh', 'Pekerjaan Ayah': 'Wiraswasta', 'Pekerjaan Ibu': 'Ibu Rumah Tangga', 'Alamat Orang Tua': 'Jl. Pendidikan No. 1', 'Telepon Orang Tua': '081234567890', 'Kelurahan/Desa': 'Cipedak', 'Kecamatan': 'Jagakarsa', 'Kabupaten/Kota': 'Jakarta Selatan', 'Provinsi': 'DKI Jakarta', 'Nama Wali': '-', 'Pekerjaan Wali': '-', 'Alamat Wali': '-', 'Telepon Wali': '-'
                }];
            }
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");
            const filename = this.state.students.length > 0 ? "data_siswa.xlsx" : "template_data_siswa.xlsx";
            XLSX.writeFile(wb, filename);
        },

        handleUploadStudents(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (!confirm('Mengunggah file ini akan MENGGANTIKAN semua data siswa yang ada. Lanjutkan?')) {
                event.target.value = ''; return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);
                    if (json.length > 0 && 'NIS' in json[0] && 'NISN' in json[0] && 'Nama Siswa' in json[0]) {
                        this.state.students = json.map((row, i) => ({
                            id: 's' + Date.now() + i,
                            nis: String(row['NIS'] || '').trim(), nisn: String(row['NISN'] || '').trim(), name: String(row['Nama Siswa'] || '').trim(), panggilan: String(row['Panggilan'] || '').trim(), ttl: String(row['Tempat, Tanggal Lahir'] || '').trim(), jenisKelamin: String(row['Jenis Kelamin'] || '').trim(), agama: String(row['Agama'] || '').trim(), kewarganegaraan: String(row['Kewarganegaraan'] || '').trim(), statusKeluarga: String(row['Status dalam Keluarga'] || '').trim(), anakKe: String(row['Anak ke'] || '').trim(), asalTk: String(row['Asal TK'] || '').trim(), alamat: String(row['Alamat Siswa'] || '').trim(), namaAyah: String(row['Nama Ayah'] || '').trim(), namaIbu: String(row['Nama Ibu'] || '').trim(), pekerjaanAyah: String(row['Pekerjaan Ayah'] || '').trim(), pekerjaanIbu: String(row['Pekerjaan Ibu'] || '').trim(), alamatOrtu: String(row['Alamat Orang Tua'] || '').trim(), teleponOrtu: String(row['Telepon Orang Tua'] || '').trim(), kelurahan: String(row['Kelurahan/Desa'] || '').trim(), kecamatan: String(row['Kecamatan'] || '').trim(), kabupaten: String(row['Kabupaten/Kota'] || '').trim(), provinsi: String(row['Provinsi'] || '').trim(), namaWali: String(row['Nama Wali'] || '').trim(), pekerjaanWali: String(row['Pekerjaan Wali'] || '').trim(), alamatWali: String(row['Alamat Wali'] || '').trim(), teleponWali: String(row['Telepon Wali'] || '').trim()
                        }));
                        this.state.grades = {}; this.saveState(); this.renderStudents(); alert(`${this.state.students.length} siswa berhasil diimpor.`);
                    } else { alert('Format file tidak sesuai. Pastikan file Excel memiliki kolom "NIS", "NISN", dan "Nama Siswa".'); }
                } catch (error) { console.error("Error processing Excel file:", error); alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar."); } 
                finally { event.target.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        },
        
        // --- NEW GRADE MANAGEMENT HANDLERS ---
        
        showEditStudentGradesModal(studentId = null) {
             if (this.state.students.length === 0) {
                alert('Tidak ada data siswa untuk diedit.');
                return;
            }
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto bg-white w-full max-w-4xl rounded-lg shadow-xl';
            
            // If called from student list, studentId is provided.
            if (studentId) {
                modalContent.innerHTML = `
                    <div class="max-h-[85vh] overflow-y-auto">
                         <div class="sticky top-0 bg-white p-4 border-b z-10">
                            <h3 class="text-2xl font-semibold">Edit Nilai Siswa</h3>
                         </div>
                        <div id="student-grade-editor-container" class="p-6"></div>
                    </div>`;
                this.renderStudentGradeEditorForm(studentId);
            } else { // Called from "Manajemen Data Nilai"
                modalContent.innerHTML = `
                    <div class="max-h-[85vh] overflow-y-auto">
                        <div class="sticky top-0 bg-white p-4 border-b z-10">
                            <h3 class="text-2xl font-semibold">Edit Nilai Siswa</h3>
                            <div class="mt-4">
                                <label for="student-grade-edit-select" class="block mb-1 font-medium text-sm">Pilih Siswa:</label>
                                <select id="student-grade-edit-select" class="form-select w-full md:w-1/2 rounded-md border-gray-300" onchange="App.renderStudentGradeEditorForm(this.value)">
                                    <option value="">-- Pilih Siswa --</option>
                                    ${this.state.students.map(s => `<option value="${s.id}">${s.name} (NISN: ${s.nisn})</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        <div id="student-grade-editor-container" class="p-6">
                            <p class="text-center text-gray-500 py-8">Silakan pilih siswa untuk menampilkan form nilai.</p>
                        </div>
                    </div>`;
            }
            this.openModal();
        },
        
        renderStudentGradeEditorForm(studentId) {
            const container = document.getElementById('student-grade-editor-container');
            if (!studentId) {
                container.innerHTML = `<p class="text-center text-gray-500 py-8">Silakan pilih siswa untuk menampilkan form nilai.</p>`;
                return;
            }
            
            const student = this.state.students.find(s => s.id === studentId);
            if (!student) {
                container.innerHTML = `<p class="text-center text-red-500 py-8">Siswa tidak ditemukan.</p>`;
                return;
            }
            
            // Also update the select dropdown if it exists (for the "Manajemen Data Nilai" flow)
            const select = document.getElementById('student-grade-edit-select');
            if(select) select.value = studentId;

            const studentGrades = this.state.grades[student.id] || {};
            const inputClass = "form-input w-full text-center rounded-md border-gray-300 bg-gray-100 hover:bg-gray-200 focus:bg-white focus:ring-1 focus:ring-blue-500 transition-colors text-sm p-1";

            const subjectsHtml = this.state.settings.subjects
                .filter(subject => {
                    if (!subject.isDeleted) {
                        const religionMatch = subject.name.match(/Pendidikan Agama dan Budi Pekerti \(([^)]+)\)/);
                        if (religionMatch) {
                            return student.agama && student.agama.toLowerCase() === religionMatch[1].toLowerCase();
                        }
                        return true;
                    }
                    return false;
                })
                .map(subject => {
                    const gradeData = studentGrades[subject.name] || { cp: [], pts: null, pas: null };
                    const cpScores = gradeData.cp || [];
                    const ptsScore = gradeData.pts ?? '';
                    const pasScore = gradeData.pas ?? '';

                    const cpInputs = subject.capaian.map((cp, index) => `
                        <div>
                            <label class="block text-xs mb-1 text-center" title="${cp}">CP ${index + 1}</label>
                            <input type="number" min="0" max="100" class="${inputClass}" value="${cpScores[index] ?? ''}" data-subject="${subject.name}" data-cp-index="${index}">
                        </div>`).join('');

                    return `
                    <details class="border rounded-md" open>
                        <summary class="font-semibold cursor-pointer p-3 bg-gray-50 rounded-t-md">${subject.name}</summary>
                        <div class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-3 p-4 border-t">
                            ${cpInputs}
                            <div>
                                <label class="block text-xs mb-1 text-center font-bold">PTS</label>
                                <input type="number" min="0" max="100" class="${inputClass}" value="${ptsScore}" data-subject="${subject.name}" data-score-type="pts">
                            </div>
                            <div>
                                <label class="block text-xs mb-1 text-center font-bold">PAS</label>
                                <input type="number" min="0" max="100" class="${inputClass}" value="${pasScore}" data-subject="${subject.name}" data-score-type="pas">
                            </div>
                        </div>
                    </details>`;
                }).join('');

            container.innerHTML = `
                <form id="student-all-grades-form" class="space-y-4">
                    <p class="font-bold text-lg mb-4">Menampilkan nilai untuk: ${student.name}</p>
                    ${subjectsHtml}
                    <div class="flex justify-end gap-3 pt-4 sticky bottom-0 bg-white py-4 border-t -mx-6 px-6">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan Semua Nilai</button>
                    </div>
                </form>
            `;
            
            document.getElementById('student-all-grades-form').onsubmit = (e) => {
                e.preventDefault();
                this.handleSaveStudentAllGrades(studentId, e.target);
            };
        },
        
        handleSaveStudentAllGrades(studentId, form) {
            if (!this.state.grades[studentId]) {
                this.state.grades[studentId] = {};
            }
            
            const inputs = form.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                const subjectName = input.dataset.subject;
                const subjectSettings = this.state.settings.subjects.find(s => s.name === subjectName);
                if (!subjectSettings) return;

                if (!this.state.grades[studentId][subjectName]) {
                    this.state.grades[studentId][subjectName] = { cp: new Array(subjectSettings.capaian.length).fill(null), pts: null, pas: null };
                }
                
                const value = input.value.trim() === '' ? null : parseInt(input.value, 10);

                if (input.dataset.cpIndex) {
                    const cpIndex = parseInt(input.dataset.cpIndex, 10);
                    this.state.grades[studentId][subjectName].cp[cpIndex] = value;
                } else if (input.dataset.scoreType === 'pts') {
                    this.state.grades[studentId][subjectName].pts = value;
                } else if (input.dataset.scoreType === 'pas') {
                    this.state.grades[studentId][subjectName].pas = value;
                }
            });
            
            this.saveState();
            alert('Semua nilai untuk siswa berhasil disimpan!');
            this.closeModal();
            this.renderOverallGradesTable();
        },
        
        showDownloadGradesModal() {
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-lg';
            
            const subjectsHtml = this.state.settings.subjects
                .filter(s => !s.isDeleted)
                .map(s => `
                    <div class="flex items-center">
                        <input id="sub-check-${s.name.replace(/\W/g, '_')}" type="checkbox" name="selectedSubjects" value="${s.name}" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <label for="sub-check-${s.name.replace(/\W/g, '_')}" class="ml-3 block text-sm font-medium text-gray-700">${s.name}</label>
                    </div>
                `).join('');

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Unduh Template Nilai</h3>
                    <p class="text-sm text-gray-600 mb-4">Pilih mata pelajaran yang ingin diunduh. Setiap mata pelajaran akan menjadi sheet terpisah dalam satu file Excel.</p>
                    <div class="space-y-2 max-h-64 overflow-y-auto border p-3 rounded-md">
                        ${subjectsHtml}
                    </div>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button id="perform-grade-download-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Unduh Template</button>
                    </div>
                </div>`;
            
            document.getElementById('perform-grade-download-btn').onclick = this.handlePerformGradeDownload.bind(this);
            this.openModal();
        },

        handlePerformGradeDownload() {
            const selectedSubjects = Array.from(document.querySelectorAll('input[name="selectedSubjects"]:checked')).map(cb => cb.value);
            if (selectedSubjects.length === 0) {
                alert('Pilih setidaknya satu mata pelajaran.');
                return;
            }

            const wb = XLSX.utils.book_new();
            const { settings, students, grades } = this.state;
            
            selectedSubjects.forEach(subjectName => {
                const subject = settings.subjects.find(s => s.name === subjectName);
                if (!subject || !subject.capaian) return;

                const metadata = [
                    ['Nama Kelas', settings.className],
                    ['Tahun Ajaran / Semester', `${settings.schoolYear} / ${settings.semester}`],
                    ['Mata Pelajaran', subjectName],
                    [] // Empty row
                ];
                
                const headers = ['No. Absen', 'NISN', 'Nama Siswa'];
                subject.capaian.forEach((cp, index) => headers.push(`CP ${index + 1}`));
                headers.push('PTS', 'PAS');
                
                let studentsForSheet = [...students];
                const religionMatch = subjectName.match(/Pendidikan Agama dan Budi Pekerti \(([^)]+)\)/);
                if (religionMatch) {
                    studentsForSheet = students.filter(s => s.agama && s.agama.toLowerCase() === religionMatch[1].toLowerCase());
                }

                const studentRows = studentsForSheet.map((student, index) => {
                    const gradeData = grades[student.id]?.[subjectName] || { cp: [], pts: null, pas: null };
                    const row = [index + 1, student.nisn || '', student.name];
                    subject.capaian.forEach((_, cpIndex) => {
                        row.push(gradeData.cp[cpIndex] ?? '');
                    });
                    row.push(gradeData.pts ?? '');
                    row.push(gradeData.pas ?? '');
                    return row;
                });
                
                const finalSheetData = [...metadata, headers, ...studentRows];
                const ws = XLSX.utils.aoa_to_sheet(finalSheetData);

                // Set column widths
                ws['!cols'] = headers.map((header, i) => {
                    const defaultWidth = String(header).length;
                    const maxLength = Math.max(
                        defaultWidth,
                        ...finalSheetData.map(row => (row[i] ? String(row[i]).length : 0))
                    );
                    return { wch: Math.min(maxLength + 2, 60) };
                });

                // Shorten sheet name if too long
                const safeSheetName = subjectName.replace(/[\\/:*?"<>|]/g, "").substring(0, 31);
                XLSX.utils.book_append_sheet(wb, ws, safeSheetName);
            });

            XLSX.writeFile(wb, "template_nilai.xlsx");
            this.closeModal();
        },
        
        handleUploadGrades(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const previewData = { validChanges: [], errors: [], warnings: [] };
                    const appStudentsByNisn = new Map(this.state.students.map(s => [String(s.nisn || '').trim(), s]));

                    workbook.SheetNames.forEach(sheetName => {
                        const ws = workbook.Sheets[sheetName];
                        const sheetJson = XLSX.utils.sheet_to_json(ws, { header: 1 });
                        
                        if (sheetJson.length < 5) return; // Not a valid grade sheet
                        
                        const subjectName = sheetJson[2]?.[1];
                        if (!subjectName || !this.state.settings.subjects.find(s => s.name === subjectName)) {
                            previewData.warnings.push({ message: `Sheet "${sheetName}" diabaikan karena nama mata pelajaran tidak valid atau tidak ditemukan.` });
                            return;
                        }

                        const subject = this.state.settings.subjects.find(s => s.name === subjectName);
                        const dataRows = sheetJson.slice(4);

                        dataRows.forEach((row, rowIndex) => {
                            const nisn = String(row[1] || '').trim();
                            if (!nisn) return;
                            
                            const student = appStudentsByNisn.get(nisn);
                            if (!student) {
                                previewData.warnings.push({ message: `Di sheet "${sheetName}", siswa dengan NISN "${nisn}" (${row[2]}) tidak ditemukan. Data diabaikan.` });
                                return;
                            }
                            
                            const cpScores = subject.capaian.map((_, index) => {
                                const score = row[3 + index];
                                return (score === null || score === undefined || score === '') ? null : parseInt(score, 10);
                            });
                            const ptsScore = row[3 + subject.capaian.length];
                            const pasScore = row[3 + subject.capaian.length + 1];
                            
                            const newGradeData = {
                                cp: cpScores,
                                pts: (ptsScore === null || ptsScore === undefined || ptsScore === '') ? null : parseInt(ptsScore, 10),
                                pas: (pasScore === null || pasScore === undefined || pasScore === '') ? null : parseInt(pasScore, 10)
                            };

                            previewData.validChanges.push({
                                studentId: student.id, studentName: student.name, subject: subjectName, newGrade: newGradeData
                            });
                        });
                    });
                    
                    this.showUploadGradesPreviewModal(previewData);

                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        },
        
        showUploadGradesPreviewModal(previewData) {
            this.pendingGradeImport = previewData.validChanges;
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';

            const warningsHtml = previewData.warnings.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-yellow-600">Peringatan (Data Bermasalah Akan Diabaikan):</h4>
                <ul class="list-disc list-inside text-sm text-yellow-700">${previewData.warnings.map(w => `<li>${w.message}</li>`).join('')}</ul></div>` : '';
            
            const changesByStudent = this.pendingGradeImport.reduce((acc, change) => {
                if (!acc[change.studentName]) acc[change.studentName] = [];
                acc[change.studentName].push(change.subject);
                return acc;
            }, {});
            
            const changesHtml = Object.keys(changesByStudent).length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-blue-600">Nilai yang akan Diimpor:</h4>
                <ul class="list-disc list-inside text-sm text-blue-700 max-h-40 overflow-y-auto">${Object.entries(changesByStudent).map(([name, subjects]) => `<li><b>${name}:</b> ${subjects.join(', ')}</li>`).join('')}</ul></div>` : '<p class="text-gray-500">Tidak ada nilai baru yang akan diimpor.</p>';

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Pratinjau Unggah Nilai</h3>
                    <div class="max-h-80 overflow-y-auto pr-2">
                        ${warningsHtml}
                        ${changesHtml}
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Mengimpor data ini akan MENIMPA nilai yang ada untuk siswa dan mata pelajaran yang terpengaruh.</p>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button id="confirm-grade-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ${this.pendingGradeImport.length === 0 ? 'hidden' : ''}">Konfirmasi Import</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-grade-import-btn').onclick = this.applyGradeImport.bind(this);
            this.openModal();
        },
        
        applyGradeImport() {
            if (!this.pendingGradeImport) return;
            
            this.pendingGradeImport.forEach(change => {
                if (!this.state.grades[change.studentId]) {
                    this.state.grades[change.studentId] = {};
                }
                this.state.grades[change.studentId][change.subject] = change.newGrade;
            });
            
            this.saveState();
            this.pendingGradeImport = null;
            alert('Data nilai berhasil diimpor!');
            this.closeModal();
            
            // Re-render if on grades view
            if (window.location.hash === '#grades') {
                this.renderGrades();
            }
        },

        handleSaveP5Grades(e) {
            const projectId = e.target.dataset.projectId;
            const selects = document.querySelectorAll(`#p5-project-content-container select[data-student-id]`);
            selects.forEach(select => {
                const studentId = select.dataset.studentId;
                const targetId = select.dataset.targetId;
                const value = select.value;

                if (!this.state.p5Grades[studentId]) {
                    this.state.p5Grades[studentId] = {};
                }
                if (!this.state.p5Grades[studentId][projectId]) {
                    this.state.p5Grades[studentId][projectId] = {};
                }

                if (value) {
                    this.state.p5Grades[studentId][projectId][targetId] = value;
                } else {
                    delete this.state.p5Grades[studentId][projectId][targetId];
                }
            });
            
            this.saveState();
            alert('Penilaian projek berhasil disimpan!');
        },

        // --- MODAL & UI HELPERS ---

        showStudentModal(studentId = null) {
            const student = studentId ? this.state.students.find(s => s.id === studentId) : this.getEmptyStudent();
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-3xl';

            const formFields = [
                { id: 'name', label: 'Nama Lengkap', required: true, type: 'text', span: 'col-span-2' },
                { id: 'panggilan', label: 'Nama Panggilan', required: false, type: 'text' },
                { id: 'nis', label: 'NIS', required: false, type: 'text' },
                { id: 'nisn', label: 'NISN', required: true, type: 'text' },
                { id: 'ttl', label: 'Tempat, Tanggal Lahir', required: false, type: 'text' },
                { id: 'jenisKelamin', label: 'Jenis Kelamin', required: false, type: 'text' },
                { id: 'agama', label: 'Agama', required: false, type: 'text' },
                { id: 'kewarganegaraan', label: 'Kewarganegaraan', required: false, type: 'text' },
                { id: 'statusKeluarga', label: 'Status dalam Keluarga', required: false, type: 'text' },
                { id: 'anakKe', label: 'Anak ke', required: false, type: 'number' },
                { id: 'asalTk', label: 'Asal TK', required: false, type: 'text' },
                { id: 'alamat', label: 'Alamat Siswa', required: false, type: 'textarea', span: 'col-span-2' },
                { id: 'namaAyah', label: 'Nama Ayah', required: false, type: 'text' },
                { id: 'pekerjaanAyah', label: 'Pekerjaan Ayah', required: false, type: 'text' },
                { id: 'namaIbu', label: 'Nama Ibu', required: false, type: 'text' },
                { id: 'pekerjaanIbu', label: 'Pekerjaan Ibu', required: false, type: 'text' },
                { id: 'alamatOrtu', label: 'Alamat Orang Tua', required: false, type: 'textarea', span: 'col-span-2' },
                { id: 'teleponOrtu', label: 'Telepon Orang Tua', required: false, type: 'tel' },
                { id: 'namaWali', label: 'Nama Wali', required: false, type: 'text' },
                { id: 'pekerjaanWali', label: 'Pekerjaan Wali', required: false, type: 'text' },
                { id: 'alamatWali', label: 'Alamat Wali', required: false, type: 'textarea', span: 'col-span-2' },
                { id: 'teleponWali', label: 'Telepon Wali', required: false, type: 'tel' }
            ];
            
            const fieldHTML = formFields.map(f => {
                const inputType = f.type === 'textarea' ? `<textarea id="student-${f.id}" rows="2" class="form-textarea w-full rounded-md border-gray-300 bg-gray-50"></textarea>` : `<input type="${f.type}" id="student-${f.id}" class="form-input w-full rounded-md border-gray-300 bg-gray-50">`;
                return `<div class="${f.span || ''}"><label for="student-${f.id}" class="block text-sm font-medium text-gray-700 mb-1">${f.label}${f.required ? '<span class="text-red-500">*</span>' : ''}</label>${inputType}</div>`;
            }).join('');

            modalContent.innerHTML = `
                <div class="max-h-[85vh] overflow-y-auto">
                    <form id="student-form">
                        <div class="p-6">
                            <h3 class="text-2xl font-semibold mb-4">${studentId ? 'Edit Data Siswa' : 'Tambah Siswa Baru'}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">${fieldHTML}</div>
                        </div>
                        <div class="flex justify-end gap-3 p-4 bg-gray-50 border-t rounded-b-md sticky bottom-0">
                            <button type="button" class="modal-close-btn px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-100">Batal</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan</button>
                        </div>
                    </form>
                </div>`;

            formFields.forEach(f => {
                document.getElementById(`student-${f.id}`).value = student[f.id] || '';
            });

            document.getElementById('student-form').onsubmit = (e) => {
                e.preventDefault();
                const newStudentData = {};
                formFields.forEach(f => newStudentData[f.id] = document.getElementById(`student-${f.id}`).value.trim());
                
                if (studentId) {
                    const studentIndex = this.state.students.findIndex(s => s.id === studentId);
                    this.state.students[studentIndex] = { ...this.state.students[studentIndex], ...newStudentData };
                } else {
                    newStudentData.id = 's' + Date.now();
                    this.state.students.push(newStudentData);
                }
                this.saveState();
                this.renderStudents();
                this.closeModal();
            };
            this.openModal();
        },
        
        showPrintModalForStudent(studentId) {
            const student = this.state.students.find(s => s.id === studentId);
            const studentGrades = this.state.grades[studentId] || {};
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto border shadow-lg rounded-md bg-white w-full max-w-4xl';
            
            modalContent.innerHTML = `
                <div class="p-4 flex justify-between items-center no-print">
                    <h3 class="text-lg font-bold">Pratinjau Rapor: ${student.name}</h3>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-md" onclick="window.print()">Cetak</button>
                </div>
                <div class="print-area">
                    ${this.createReportCardHTML(student, studentGrades)}
                </div>
            `;
            this.openModal();
        },

        createReportCardHTML(student, studentGrades) {
            const { settings } = this.state;
            const studentNickname = student.panggilan || student.name.split(' ')[0];
            
            let academicRows = '';
            
            // Group subjects for reporting
            const subjectGroups = {
                'Kelompok A': ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam dan Sosial (IPAS)'],
                'Kelompok B': ['Seni Budaya', 'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)'],
                'Muatan Lokal': ['Muatan Lokal']
            };

            const getSubjectDescription = (subjectName, finalScore) => {
                const subjectConfig = settings.subjects.find(s => s.name === subjectName);
                if (!subjectConfig) return 'Deskripsi tidak tersedia.';
                
                const predicate = this.getPredicate(finalScore);
                const descTemplate = subjectConfig.deskripsi[predicate] || '';
                const capaianText = subjectConfig.capaian.join(', ');
                
                return descTemplate
                    .replace(/\[nama\]/gi, studentNickname)
                    .replace(/\[cp\]/gi, capaianText);
            };
            
            const processedSubjects = new Set();

            Object.entries(subjectGroups).forEach(([groupName, prefixes]) => {
                let groupRows = '';
                let subjectCounter = 1;

                prefixes.forEach(prefix => {
                    settings.subjects
                        .filter(s => !s.isDeleted && s.name.startsWith(prefix) && !processedSubjects.has(s.name))
                        .forEach(subject => {
                            let shouldRender = true;
                            // Special handling for religion
                            if (prefix === 'Pendidikan Agama') {
                                const religionInSubject = subject.name.match(/\(([^)]+)\)/)?.[1];
                                if (!student.agama || !religionInSubject || student.agama.toLowerCase() !== religionInSubject.toLowerCase()) {
                                    shouldRender = false;
                                }
                            }
                            
                            if (shouldRender) {
                                const finalScore = this.getFinalScore(studentGrades[subject.name]);
                                groupRows += `
                                    <tr>
                                        <td class="border p-2 text-center">${subjectCounter++}</td>
                                        <td class="border p-2">${subject.name}</td>
                                        <td class="border p-2 text-center">${finalScore ?? '-'}</td>
                                        <td class="border p-2 text-justify text-xs">${finalScore !== null ? getSubjectDescription(subject.name, finalScore) : ''}</td>
                                    </tr>
                                `;
                                processedSubjects.add(subject.name);
                            }
                        });
                });
                
                if (groupRows) {
                     academicRows += `<tr class="bg-gray-100 font-bold"><td colspan="4" class="border p-2">${groupName}</td></tr>${groupRows}`;
                }
            });
            
            // Extracurriculars
            const studentExtras = this.state.extracurricularGrades[student.id] || [];
            const extracurricularRows = studentExtras.map((extra, i) => {
                const extraConfig = settings.extracurriculars.find(e => e.id === extra.id);
                return `<tr>
                    <td class="border p-2 text-center">${i+1}</td>
                    <td class="border p-2">${extraConfig?.name || 'Tidak Diketahui'}</td>
                    <td class="border p-2">${extra.grade || '-'}</td>
                    <td class="border p-2 text-justify text-xs">${extra.description || ''}</td>
                </tr>`
            }).join('') || `<tr><td colspan="4" class="border p-2 text-center">-</td></tr>`;
            
            // Attendance
            const attendance = this.state.attendance[student.id] || { s:0, i:0, a:0 };
            
            // P5 Report
            const p5Levels = { BB: 'Belum Berkembang', MB: 'Mulai Berkembang', BSH: 'Berkembang Sesuai Harapan', SB: 'Sangat Berkembang' };
            let p5ReportHTML = '';
            (settings.p5Projects || []).forEach(project => {
                const studentP5Grades = this.state.p5Grades[student.id]?.[project.id] || {};
                const dimensionReports = project.dimensions.map(dim => {
                    const achievedTargets = dim.subElements.flatMap(sub => sub.targets)
                        .filter(target => (studentP5Grades[target.id] === 'BSH' || studentP5Grades[target.id] === 'SB'))
                        .map(target => target.description)
                        .join(' ');
                    
                    if(achievedTargets) {
                        return `<p>Dalam dimensi <strong>${dim.name}</strong>, Ananda ${studentNickname} menunjukkan kemampuan dalam hal ${achievedTargets}</p>`;
                    }
                    return '';
                }).filter(Boolean).join('');
                
                if (dimensionReports) {
                     p5ReportHTML += `<div class="p-2 border mt-2"><h4 class="font-bold text-sm">${project.name}</h4><div class="text-xs text-justify space-y-1">${dimensionReports}</div></div>`;
                }
            });

            return `<div class="bg-white p-8 mx-auto my-4 max-w-4xl shadow-lg border rounded-md font-serif report-card print-area">
                <header class="text-center mb-6">
                    <div class="flex items-center justify-center gap-4">
                        ${settings.schoolLogo ? `<img src="${settings.schoolLogo}" alt="Logo Sekolah" class="h-20 w-20 object-contain">` : ''}
                        <div>
                            <h1 class="text-xl font-bold uppercase">${settings.schoolName}</h1>
                            <p class="text-sm">${settings.schoolAddress}, ${settings.postalCode}</p>
                            <p class="text-sm">Telp: ${settings.schoolPhone} | Email: ${settings.schoolEmail}</p>
                        </div>
                    </div>
                     <hr class="my-3 border-t-2 border-black">
                    <h2 class="text-lg font-bold">LAPORAN HASIL BELAJAR</h2>
                </header>
                <main>
                    <table class="w-full text-sm mb-4">
                        <tr>
                            <td class="w-1/4">Nama Peserta Didik</td><td class="w-1/2">: ${student.name}</td>
                            <td class="w-1/4">Kelas</td><td>: ${settings.className}</td>
                        </tr>
                        <tr>
                            <td>NIS/NISN</td><td>: ${student.nis} / ${student.nisn}</td>
                            <td>Semester</td><td>: ${settings.semester}</td>
                        </tr>
                        <tr>
                            <td>Nama Sekolah</td><td>: ${settings.schoolName}</td>
                            <td>Tahun Pelajaran</td><td>: ${settings.schoolYear}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold text-md mt-4 mb-1">A. SIKAP</h3>
                    <div class="border p-2 text-justify text-sm">
                        Selama semester ini, Ananda ${studentNickname} menunjukkan sikap yang baik, disiplin, dan bertanggung jawab.
                    </div>

                    <h3 class="font-bold text-md mt-4 mb-1">B. AKADEMIK</h3>
                    <table class="w-full text-sm border-collapse">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th class="border p-2 w-10">No</th>
                                <th class="border p-2 text-left">Mata Pelajaran</th>
                                <th class="border p-2 w-20">Nilai Akhir</th>
                                <th class="border p-2 text-left">Capaian Kompetensi</th>
                            </tr>
                        </thead>
                        <tbody>${academicRows}</tbody>
                    </table>

                    <h3 class="font-bold text-md mt-4 mb-1">C. EKSTRAKURIKULER</h3>
                    <table class="w-full text-sm border-collapse">
                        <thead class="bg-gray-100 font-bold">
                            <tr>
                                <th class="border p-2 w-10">No</th>
                                <th class="border p-2 text-left">Kegiatan Ekstrakurikuler</th>
                                <th class="border p-2 w-20">Predikat</th>
                                <th class="border p-2 text-left">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody>${extracurricularRows}</tbody>
                    </table>
                    
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <h3 class="font-bold text-md mb-1">D. KETIDAKHADIRAN</h3>
                            <table class="w-full text-sm border-collapse">
                                <tr><td class="border p-2 w-2/3">Sakit</td><td class="border p-2 text-center">${attendance.s} hari</td></tr>
                                <tr><td class="border p-2">Izin</td><td class="border p-2 text-center">${attendance.i} hari</td></tr>
                                <tr><td class="border p-2">Tanpa Keterangan</td><td class="border p-2 text-center">${attendance.a} hari</td></tr>
                            </table>
                        </div>
                         <div>
                            <h3 class="font-bold text-md mb-1">E. CATATAN WALI KELAS</h3>
                            <div class="border p-2 text-justify text-sm h-full">${this.state.teacherNotes[student.id] || ''}</div>
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-md mt-4 mb-1">F. LAPORAN PROJEK PENGUATAN PROFIL PELAJAR PANCASILA</h3>
                    <div class="border p-2 text-sm">${p5ReportHTML || '<p class="text-center">-</p>'}</div>
                    
                    <div class="text-sm mt-6 flex justify-between">
                        <div class="text-center">
                            <p>Mengetahui,</p>
                            <p>Orang Tua/Wali</p>
                            <br><br><br>
                            <p class="font-bold">.........................</p>
                        </div>
                        <div class="text-center">
                            <p>${settings.reportDate}</p>
                            <p>Wali Kelas</p>
                            <br><br><br>
                            <p class="font-bold underline">${settings.teacherName}</p>
                            <p>NIP. ${settings.teacherNip}</p>
                        </div>
                    </div>
                    <div class="text-center mt-6">
                        <p>Kepala Sekolah</p>
                        <br><br><br>
                        <p class="font-bold underline">${settings.headmasterName}</p>
                        <p>NIP. ${settings.headmasterNip}</p>
                    </div>
                </main>
            </div>`;
        },

        openModal() {
            document.getElementById('app-modal').classList.remove('hidden');
        },

        closeModal() {
            const modal = document.getElementById('app-modal');
            modal.classList.add('hidden');
            modal.querySelector('#modal-content-wrapper').innerHTML = '';
        }
    };

    window.App = App;
    App.init();
});

</script>
</body>
</html>
