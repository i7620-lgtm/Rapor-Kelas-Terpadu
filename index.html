<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Aplikasi rapor kelas yang berjalan sepenuhnya offline di browser. Semua data dapat diimpor dan diekspor melalui file Excel untuk portabilitas." />
    <title>Rapor Kelas Terpadu</title>
    <script src="https://cdn.tailwindcss.com">
// ========== Fungsi Sinkronisasi Google Sheets ==========
App.syncWithGoogleSheets = async function (fetchOnly = false) {
  try {
    const spreadsheetId = App.settings?.googleSpreadsheetId;
    if (!spreadsheetId) {
      console.error("Spreadsheet ID belum diset di pengaturan.");
      return;
    }

    // FETCH DATA
    if (fetchOnly) {
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId,
        range: "Sheet1!A:B"
      });

      const rows = response.result.values || [];
      if (rows.length > 0) {
        const chunks = rows.map(r => r[1]);
        const fullString = chunks.join("");
        const data = JSON.parse(fullString);

        App.data = data;
        App.updateSyncStatus("synced", "Data berhasil dimuat dari Google Sheets");
      }
      return;
    }

    // SIMPAN DATA
    const dataString = JSON.stringify(App.data || {});
    const chunks = [];
    for (let i = 0; i < dataString.length; i += 49000) {
      chunks.push(dataString.substring(i, i + 49000));
    }
    const values = chunks.map((chunk, i) => [`PART-${i+1}`, chunk]);

    await gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId,
      range: "Sheet1!A:B"
    });

    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId,
      range: "Sheet1!A1",
      valueInputOption: "RAW",
      resource: { values }
    });

    App.updateSyncStatus("synced", "Data berhasil disinkronkan ke Google Sheets");
  } catch (err) {
    console.error("Sinkronisasi gagal:", err);
    App.updateSyncStatus("error", "Terjadi kesalahan saat sinkronisasi");
    alert("Terjadi kesalahan saat sinkronisasi: " + err.message);
  }
};
// =======================================================

</script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Google API Scripts -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            .report-card { box-shadow: none !important; border: none !important; page-break-after: always; }
        }
        .view { display: none; }
        .view.active { display: block; }
        .sidebar-item.active { background-color: #1d4ed8; color: white; }
        .grades-tab-btn, .p5-project-tab {
            border-color: transparent;
            color: #6b7280; /* text-gray-500 */
        }
        .grades-tab-btn.active, .p5-project-tab.active {
            border-color: #2563eb; /* border-blue-600 */
            color: #1e3a8a; /* text-blue-800 */
        }
        .overall-grades-table th.subject-col {
            width: 65px;
            text-align: center;
        }
        .overall-grades-table td {
            vertical-align: middle;
        }
        .sync-status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            background-color: #9ca3af; /* gray-400 */
        }
        .sync-status-indicator.synced { background-color: #22c55e; /* green-500 */ }
        .sync-status-indicator.syncing { background-color: #f59e0b; /* amber-500 */ }
        .sync-status-indicator.error { background-color: #ef4444; /* red-500 */ }
    </style>
</head>
<body class="bg-gray-100  text-gray-800">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <nav class="w-64 bg-blue-900 text-white p-4 flex-shrink-0 no-print flex flex-col">
            <div class="text-center mb-8">
                <div class="text-5xl font-extrabold tracking-wider">RKT</div>
                <p class="text-lg mt-2 text-blue-200" style="font-size: 1.2rem; margin-top: 0.75rem;">Rapor Kelas Terpadu</p>
            </div>
            <ul class="space-y-2 flex-grow">
                <li><a href="#dashboard" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Dashboard</a></li>
                <li><a href="#students" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Siswa</a></li>
                <li><a href="#grades" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Nilai</a></li>
                <li><a href="#extracurricular" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Ekstrakurikuler</a></li>
                <li><a href="#p5" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Proyek P5</a></li>
                <li><a href="#attendance" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Data Absensi</a></li>
                <li><a href="#notes" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Catatan Wali Kelas</a></li>
                <li><a href="#print" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Print Rapor</a></li>
                <li><a href="#settings" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-blue-700 transition-colors">Pengaturan</a></li>
            </ul>
            <!-- Google Sync Section -->
            <div id="google-sync-section" class="mt-4 pt-4 border-t border-blue-700">
                <div class="flex items-center mb-2">
                     <span id="sync-status-indicator" class="sync-status-indicator" title="Status Sinkronisasi"></span>
                     <span id="sync-status-text" class="text-sm font-medium text-blue-200">Sinkronisasi Google</span>
                </div>
                <div id="auth-container">
                    <button id="authorize_button" class="w-full bg-white text-blue-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200 transition-colors">Login dengan Google</button>
                    <button id="signout_button" class="w-full bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors hidden">Logout</button>
                </div>
                <p id="user-profile" class="text-xs text-center mt-2 text-blue-300 hidden"></p>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            
            <!-- Dashboard View -->
            <section id="view-dashboard" class="view">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-3xl font-bold">Dashboard</h2>
                    <div id="dashboard-sync-status" class="flex items-center text-sm bg-gray-200 px-3 py-1 rounded-full">
                        <!-- Status will be injected by JS -->
                    </div>
                </div>
                <p class="text-lg text-gray-600 mb-6">Selamat datang, <span id="dashboard-teacher-name" class="font-semibold"></span>!</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Kelas</h3>
                        <p id="dashboard-class-name" class="text-3xl font-bold mt-2">-</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Jumlah Siswa</h3>
                        <p id="dashboard-student-count" class="text-3xl font-bold mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Tahun Ajaran</h3>
                        <p id="dashboard-school-year" class="text-3xl font-bold mt-2">-</p>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700">Semester</h3>
                        <p id="dashboard-semester" class="text-3xl font-bold mt-2">-</p>
                    </div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-4 border-b pb-2">Sinkronisasi & Analisis</h3>
                     <div id="dashboard-sync-controls" class="mb-4 text-center hidden">
                        <button id="google-sync-save-btn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 text-lg">
                            Simpan & Sinkronkan ke Google Sheets
                        </button>
                        <p class="text-sm mt-2 text-gray-500">Menyimpan data ke Google Sheets akan menimpa data yang ada di cloud.</p>
                    </div>
                    <div id="dashboard-analysis-content">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>
            </section>

            <!-- Students View -->
            <section id="view-students" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Siswa</h2>
                    <div class="flex gap-2">
                        <button id="add-student-btn" class="bg-sky-700 text-white px-4 py-2 rounded-md hover:bg-sky-800">Tambah Siswa</button>
                        <button id="download-template-btn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">Unduh Data</button>
                        <label for="upload-students-input" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer">Unggah Data Siswa</label>
                        <input type="file" id="upload-students-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-3 w-16">No. Absen</th>
                                <th class="p-3">Nama Lengkap</th>
                                <th class="p-3">Nama Panggilan</th>
                                <th class="p-3">NIS</th>
                                <th class="p-3">NISN</th>
                                <th class="p-3 w-56 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="students-table-body">
                            <!-- Student rows will be injected here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Grades View -->
            <section id="view-grades" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Nilai</h2>
                    <div class="flex gap-2">
                        <button id="edit-grades-btn" class="bg-blue-800 text-white px-4 py-2 rounded-md hover:bg-blue-900">Edit Nilai Siswa</button>
                        <button id="download-grades-btn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">Unduh Nilai</button>
                        <label for="upload-grades-input" class="bg-sky-500 text-white px-4 py-2 rounded-md hover:bg-sky-600 cursor-pointer">Unggah Data Nilai</label>
                        <input type="file" id="upload-grades-input" class="hidden" accept=".xlsx, .xls">
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div class="flex border-b mb-6">
                        <button data-tab="list" class="grades-tab-btn py-2 px-4 border-b-2 font-semibold transition-colors duration-300">Daftar Nilai Keseluruhan</button>
                        <button data-tab="input" class="grades-tab-btn py-2 px-4 border-b-2 font-semibold transition-colors duration-300">Input Nilai per Mapel</button>
                    </div>
                    
                    <!-- Overall Grades List View -->
                    <div id="grades-content-list" class="grades-content">
                        <!-- Content injected by JS -->
                    </div>
        
                    <!-- Grade Input by Subject View -->
                    <div id="grades-content-input" class="grades-content hidden">
                         <!-- Content injected by JS -->
                    </div>
                </div>
            </section>
            
            <!-- Extracurricular View -->
            <section id="view-extracurricular" class="view">
                <!-- JS will inject content -->
            </section>
            
            <!-- P5 View -->
            <section id="view-p5" class="view">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Proyek P5</h2>
                    <a href="#settings" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" onclick="App.navigateTo('#settings'); setTimeout(() => document.getElementById('p5-config-section').scrollIntoView({ behavior: 'smooth' }), 100);">Kelola Proyek P5</a>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md">
                    <div id="p5-project-tabs-container" class="flex border-b mb-6 overflow-x-auto">
                        <!-- Project tabs will be injected here -->
                    </div>
                    <div id="p5-project-content-container">
                        <!-- Content for the selected project will be injected here -->
                    </div>
                </div>
            </section>
            
            <!-- Attendance View -->
            <section id="view-attendance" class="view">
                <!-- JS will inject content -->
            </section>
            
            <!-- Notes View -->
            <section id="view-notes" class="view">
                <!-- JS will inject content -->
            </section>

            <!-- Print View -->
            <section id="view-print" class="view">
                <div class="no-print">
                    <h2 class="text-3xl font-bold mb-6">Print Rapor</h2>
                    <div class="bg-white p-6 rounded-lg shadow-md text-center">
                        <p class="mb-4">Klik tombol di bawah ini untuk menghasilkan pratinjau semua rapor, lalu gunakan tombol cetak untuk mencetaknya.</p>
                        <button id="generate-all-reports-btn" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 text-lg">Hasilkan Pratinjau Rapor</button>
                        <button id="print-all-reports-btn" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 text-lg ml-4 hidden">Cetak Semua Rapor</button>
                    </div>
                </div>
                <div id="print-output-area" class="mt-8 space-y-8">
                    <!-- Report cards will be injected here -->
                </div>
            </section>

            <!-- Settings View -->
            <section id="view-settings" class="view">
                <div class="sticky top-0 bg-gray-100 z-40 border-b -mx-8 -mt-8 px-8 pt-8 pb-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-3xl font-bold">Pengaturan</h2>
                        <div class="flex items-center gap-3">
                            <button id="cancel-settings-btn" type="button" class="bg-white text-gray-700 px-5 py-2 rounded-md border border-gray-300 hover:bg-gray-50 text-base font-medium">Batal</button>
                            <button id="save-settings-btn" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 text-base font-medium">Simpan Perubahan</button>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-8 pt-4">
                    <!-- Profil Sekolah -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Profil Sekolah</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="setting-schoolName" class="block text-sm font-medium text-gray-700 mb-1">Nama Sekolah</label>
                                <input type="text" id="setting-schoolName" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-npsn" class="block text-sm font-medium text-gray-700 mb-1">NPSN</label>
                                <input type="text" id="setting-npsn" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label for="setting-schoolAddress" class="block text-sm font-medium text-gray-700 mb-1">Alamat Sekolah</label>
                                <input type="text" id="setting-schoolAddress" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-village" class="block text-sm font-medium text-gray-700 mb-1">Desa/Kelurahan</label>
                                <input type="text" id="setting-village" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-district" class="block text-sm font-medium text-gray-700 mb-1">Kecamatan</label>
                                <input type="text" id="setting-district" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-province" class="block text-sm font-medium text-gray-700 mb-1">Provinsi</label>
                                <input type="text" id="setting-province" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-postalCode" class="block text-sm font-medium text-gray-700 mb-1">Kode Pos</label>
                                <input type="text" id="setting-postalCode" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-schoolEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Sekolah</label>
                                <input type="email" id="setting-schoolEmail" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-schoolPhone" class="block text-sm font-medium text-gray-700 mb-1">Telepon Sekolah</label>
                                <input type="tel" id="setting-schoolPhone" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-website" class="block text-sm font-medium text-gray-700 mb-1">Website Sekolah</label>
                                <input type="url" id="setting-website" placeholder="https://..." class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-fax" class="block text-sm font-medium text-gray-700 mb-1">Faksimile</label>
                                <input type="text" id="setting-fax" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Logo Sekolah</label>
                                <div class="flex items-center gap-4 mt-2">
                                    <img id="logo-preview" src="" alt="Pratinjau Logo" class="h-24 w-24 object-contain rounded-md border p-1 bg-gray-50 hidden">
                                    <div id="logo-placeholder" class="h-24 w-24 flex items-center justify-center rounded-md border border-dashed bg-gray-50 text-gray-400 text-xs text-center p-2">Tidak ada logo</div>
                                    <input type="file" id="setting-schoolLogo" class="form-input text-sm w-full max-w-xs" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Periode Akademik -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Periode Akademik</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div>
                                <label for="setting-className" class="block text-sm font-medium text-gray-700 mb-1">Nama Kelas</label>
                                <input type="text" id="setting-className" placeholder="e.g., Kelas 4A" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-schoolYear" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label>
                                <input type="text" id="setting-schoolYear" placeholder="e.g., 2024/2025" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-semester" class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                                <input type="text" id="setting-semester" placeholder="e.g., Ganjil" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="setting-reportDate" class="block text-sm font-medium text-gray-700 mb-1">Tempat, Tanggal Rapor</label>
                                <input type="text" id="setting-reportDate" placeholder="e.g., Jakarta, 17 Desember 2024" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </fieldset>

                    <!-- Kepala Sekolah & Guru -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Kepala Sekolah & Guru</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                             <div>
                                <label for="setting-headmasterName" class="block text-sm font-medium text-gray-700 mb-1">Nama Kepala Sekolah</label>
                                <input type="text" id="setting-headmasterName" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-headmasterNip" class="block text-sm font-medium text-gray-700 mb-1">NIP Kepala Sekolah</label>
                                <input type="text" id="setting-headmasterNip" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-teacherName" class="block text-sm font-medium text-gray-700 mb-1">Nama Wali Kelas</label>
                                <input type="text" id="setting-teacherName" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="setting-teacherNip" class="block text-sm font-medium text-gray-700 mb-1">NIP Wali Kelas</label>
                                <input type="text" id="setting-teacherNip" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                            </div>
                        </div>
                    </fieldset>
                    
                    <!-- Konfigurasi Akademik -->
                    <div id="academic-config-section" class="hidden">
                        <fieldset class="bg-white p-6 rounded-lg shadow-md">
                            <div class="border-b border-gray-200 pb-3 mb-4">
                               <h3 class="text-xl font-semibold text-gray-900">Konfigurasi Akademik Kelas <span id="academic-config-grade" class="font-bold"></span></h3>
                            </div>
                            
                            <!-- Grade Ranges -->
                            <h4 class="font-semibold text-lg mb-3">Rentang Nilai Predikat</h4>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Predikat A (Mulai dari)</label>
                                    <input type="number" id="setting-grade-A" placeholder="e.g., 90" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Predikat B (Mulai dari)</label>
                                    <input type="number" id="setting-grade-B" placeholder="e.g., 80" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Predikat C (KKM)</label>
                                    <input type="number" id="setting-grade-C" placeholder="e.g., 70" class="form-input w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                                    <p class="text-xs text-gray-500 mt-2">Nilai di bawah ini akan ditandai.</p>
                                </div>
                            </div>

                            <!-- Subjects -->
                            <h4 class="font-semibold text-lg mb-3 border-t pt-4">Mata Pelajaran & Deskripsi Rapor</h4>
                            <div id="subjects-list" class="mb-6">
                                <!-- Subject editor will be injected here -->
                            </div>
                            <form id="add-subject-form" class="flex gap-4">
                                <input type="text" id="subject-name" placeholder="Nama Mata Pelajaran Baru" class="form-input flex-1 rounded-md border-gray-300 bg-gray-50" required>
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Tambah Mapel</button>
                            </form>
                            
                            <!-- Deleted Subjects -->
                             <div id="deleted-subjects-container" class="mt-8 hidden">
                                <h5 class="font-semibold text-md mb-3 border-t pt-5 text-gray-800">Mata Pelajaran yang Dihapus</h5>
                                <p class="text-sm text-gray-500 mb-3">Klik untuk mengembalikan mata pelajaran ke daftar.</p>
                                <div id="deleted-subjects-list" class="flex flex-wrap gap-2">
                                    <!-- Deleted subject buttons will be injected here -->
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <!-- Konfigurasi Ekstrakurikuler -->
                    <fieldset class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4">
                           <h3 class="text-xl font-semibold text-gray-900">Konfigurasi Ekstrakurikuler</h3>
                        </div>
                        <div id="extracurricular-config-list" class="mb-4 space-y-2">
                            <!-- JS will inject extracurricular list -->
                        </div>
                        <form id="add-extracurricular-form" class="flex gap-4">
                            <input type="text" id="extracurricular-name-input" placeholder="Nama Ekstrakurikuler Baru (e.g., Pramuka)" class="form-input flex-1 rounded-md border-gray-300 bg-gray-50" required>
                            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Tambah Ekstrakurikuler</button>
                        </form>
                    </fieldset>

                    <!-- Konfigurasi Proyek P5 -->
                    <fieldset id="p5-config-section" class="bg-white p-6 rounded-lg shadow-md">
                        <div class="border-b border-gray-200 pb-3 mb-4 flex justify-between items-center">
                           <h3 class="text-xl font-semibold text-gray-900">Konfigurasi Proyek P5</h3>
                           <button id="add-p5-project-btn" data-action="add-project" class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Tambah Proyek Baru</button>
                        </div>
                        <div id="p5-editor-container" class="space-y-4">
                            <!-- P5 Editor will be injected here -->
                        </div>
                    </fieldset>

                </div>
            </section>
        </main>
    </div>

    <!-- Global Modal -->
    <div id="app-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center p-4">
        <div id="modal-content-wrapper" class="relative mx-auto p-2 border shadow-lg rounded-md bg-white w-full">
            <!-- Modal content goes here -->
        </div>
    </div>


<script>

// --- Google API Integration ---
// GANTI DENGAN KREDENSIAL ANDA DARI GOOGLE CLOUD CONSOLE
const API_KEY = 'AIzaSyCnWlB1fBkuFysAy81ui35FUFCKa1rn6F4';
const CLIENT_ID = '584511730006-665o1b5cgqp6bam2mdribmgk6j6ia7vt.apps.googleusercontent.com';

const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest", "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest", "https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"];
const SCOPES = "https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

let tokenClient;
let gapiInited = false;
let gisInited = false;
let isLoggedIn = false;

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: DISCOVERY_DOCS,
    });
    gapiInited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: '', // defined later
    });
    gisInited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorize_button').style.visibility = 'visible';
    }
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            throw (resp);
        }
        isLoggedIn = true;
        updateUIOnLogin();
        
        // Fetch user profile info
        try {
            const response = await gapi.client.oauth2.userinfo.get();
            const profile = response.result;
            document.getElementById('user-profile').textContent = `Login sebagai: ${profile.email}`;
            document.getElementById('user-profile').classList.remove('hidden');
        } catch (err) {
            console.error("Error fetching user profile", err);
        } finally {
            // Sync on login (fetch only)
            await App.syncWithGoogleSheets(true);
        }
    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({prompt: 'consent'});
    } else {
        tokenClient.requestAccessToken({prompt: ''});
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken('');
        isLoggedIn = false;
        updateUIOnLogout();
    }
}

function updateUIOnLogin() {
    document.getElementById('authorize_button').classList.add('hidden');
    document.getElementById('signout_button').classList.remove('hidden');
    document.getElementById('dashboard-sync-controls').classList.remove('hidden');
    App.updateSyncStatus('synced', 'Terhubung ke Google');
}

function updateUIOnLogout() {
    document.getElementById('authorize_button').classList.remove('hidden');
    document.getElementById('signout_button').classList.add('hidden');
    document.getElementById('dashboard-sync-controls').classList.add('hidden');
    document.getElementById('user-profile').classList.add('hidden');
    App.updateSyncStatus('disconnected', 'Sinkronisasi Google');
}


// --- Main App Logic ---
document.addEventListener('DOMContentLoaded', () => {

    const App = {
        islamCpsByGrade: {
            1: [
                'Mengenal rukun iman dan rukun Islam.',
                'Menghafal doa-doa harian pendek.',
                'Meneladani akhlak terpuji di rumah dan sekolah.',
                'Mengenal kisah nabi dan rasul.'
            ],
            2: [
                'Memahami tata cara wudu dan salat dengan benar.',
                'Menghafal surat-surat pendek Al-Qur’an.',
                'Menunjukkan perilaku jujur dan amanah.',
                'Mengenal ibadah puasa dan zakat.'
            ],
            3: [
                'Memahami arti iman kepada malaikat, kitab, dan rasul.',
                'Menghafal doa-doa tambahan.',
                'Meneladani sifat sabar, syukur, dan tawakal.',
                'Mengenal sejarah dakwah Nabi Muhammad SAW.'
            ],
            4: [
                'Memahami makna iman kepada hari akhir dan qada-qadar.',
                'Membaca Al-Qur’an dengan tajwid sederhana.',
                'Mempraktikkan adab bergaul sesuai ajaran Islam.',
                'Mengenal tokoh-tokoh Islam berpengaruh.'
            ],
            5: [
                'Memahami hukum-hukum dasar fikih ibadah.',
                'Menghafal surat-surat pilihan Al-Qur’an.',
                'Meneladani sifat kepemimpinan yang baik.',
                'Mengenal perkembangan Islam di Indonesia.'
            ],
            6: [
                'Memahami konsep dakwah dan syiar Islam.',
                'Membaca Al-Qur’an dengan tajwid lebih baik.',
                'Meneladani perjuangan tokoh-tokoh Islam.',
                'Menerapkan nilai-nilai Islam dalam kehidupan bermasyarakat.'
            ]
        },

        kristenCpsByGrade: {
            1: [
                'Mengenal kasih Tuhan Yesus.',
                'Menghafal doa harian sederhana.',
                'Meneladani sikap sopan santun.',
                'Mengenal tokoh Alkitab.'
            ],
            2: [
                'Memahami ajaran kasih dalam keluarga.',
                'Membaca dan memahami cerita Alkitab sederhana.',
                'Mempraktikkan kejujuran dalam kehidupan sehari-hari.',
                'Menghafal ayat-ayat Alkitab pilihan.'
            ],
            3: [
                'Memahami perintah Tuhan dan maknanya.',
                'Menerapkan kasih dalam persahabatan.',
                'Mengenal tokoh-tokoh iman dalam Alkitab.',
                'Meneladani sikap rendah hati.'
            ],
            4: [
                'Memahami pengorbanan Tuhan Yesus.',
                'Menghafal dan memaknai ayat-ayat Alkitab.',
                'Mempraktikkan doa syafaat.',
                'Mengenal sejarah gereja.'
            ],
            5: [
                'Memahami karya keselamatan Tuhan.',
                'Menyampaikan kabar baik kepada orang lain.',
                'Meneladani tokoh-tokoh pelayanan.',
                'Mempraktikkan kepedulian sosial.'
            ],
            6: [
                'Memahami tugas misi gereja.',
                'Menguatkan iman melalui pelayanan.',
                'Memahami peran gereja dalam masyarakat.',
                'Menunjukkan teladan hidup Kristen.'
            ]
        },

        katolikCpsByGrade: {
            1: [
                'Mengenal Allah sebagai Bapa yang penuh kasih.',
                'Menghafal doa-doa dasar Gereja Katolik.',
                'Menunjukkan sikap kasih kepada keluarga.',
                'Mengenal Yesus sebagai Sahabat.'
            ],
            2: [
                'Memahami cerita Yesus dalam Kitab Suci.',
                'Mempraktikkan perilaku saling membantu.',
                'Menghafal doa Bapa Kami, Salam Maria, dan Kemuliaan.',
                'Mengenal sakramen-sakramen Gereja.'
            ],
            3: [
                'Memahami perintah Allah.',
                'Meneladani Yesus dalam kehidupan sehari-hari.',
                'Mengikuti perayaan Ekaristi dengan sikap hormat.',
                'Mengenal tokoh-tokoh kudus.'
            ],
            4: [
                'Memahami ajaran Yesus tentang kasih dan pengampunan.',
                'Mengenal sejarah Gereja Katolik.',
                'Mempraktikkan doa Rosario.',
                'Meneladani teladan santo dan santa.'
            ],
            5: [
                'Memahami peran Gereja dalam masyarakat.',
                'Menghidupi nilai iman dan pengharapan.',
                'Mengikuti kegiatan pelayanan.',
                'Mengenal misi Gereja.'
            ],
            6: [
                'Menganalisis ajaran Yesus dalam Injil.',
                'Memahami makna sakramen.',
                'Mempraktikkan hidup bersyukur.',
                'Menjadi saksi iman di lingkungan sekitar.'
            ]
        },

        hinduCpsByGrade: {
            1: [
                'Mengenal Tuhan (Ida Sang Hyang Widhi Wasa) dan ciptaan-Nya.',
                'Menghafal doa Tri Sandhya sederhana.',
                'Menunjukkan perilaku sopan kepada orang tua.',
                'Mengenal pura sebagai tempat ibadah.'
            ],
            2: [
                'Memahami ajaran tatwam asi (kebersamaan).',
                'Menghafal doa-doa harian Hindu.',
                'Mengenal upacara sederhana di rumah.',
                'Mempraktikkan perilaku disiplin.'
            ],
            3: [
                'Mengenal dewa-dewi utama Hindu.',
                'Memahami makna Tri Hita Karana.',
                'Mengikuti upacara di pura dengan sikap hormat.',
                'Menjaga kebersihan lingkungan.'
            ],
            4: [
                'Memahami ajaran karma phala.',
                'Mengenal kitab suci Weda.',
                'Mempraktikkan yoga sederhana.',
                'Mengenal hari raya Hindu.'
            ],
            5: [
                'Menganalisis nilai-nilai dharma.',
                'Menghafal sloka pilihan.',
                'Mengikuti kegiatan yadnya di masyarakat.',
                'Mengenal tokoh-tokoh Hindu.'
            ],
            6: [
                'Memahami reinkarnasi dalam ajaran Hindu.',
                'Menerapkan nilai satya, siwam, sundaram.',
                'Mempraktikkan meditasi sederhana.',
                'Menjaga keharmonisan hubungan dengan alam.'
            ]
        },

        buddhaCpsByGrade: {
            1: [
                'Mengenal Buddha sebagai Guru Agung.',
                'Menghafal doa namo tassa sederhana.',
                'Menunjukkan sikap welas asih kepada teman.',
                'Mengenal vihara sebagai tempat ibadah.'
            ],
            2: [
                'Memahami kisah kelahiran Siddharta Gautama.',
                'Menghafal Pancasila Buddhis.',
                'Mempraktikkan perilaku jujur.',
                'Mengenal hari besar Waisak.'
            ],
            3: [
                'Memahami Empat Kebenaran Mulia.',
                'Mempraktikkan Jalan Mulia Berunsur Delapan.',
                'Mengikuti kebaktian di vihara.',
                'Menjaga kebersihan diri.'
            ],
            4: [
                'Memahami hukum karma.',
                'Mengenal Jataka (kisah kelahiran Buddha).',
                'Mempraktikkan meditasi sederhana.',
                'Menghormati semua makhluk hidup.'
            ],
            5: [
                'Menganalisis ajaran cinta kasih universal.',
                'Menghafal paritta pilihan.',
                'Mengikuti kegiatan sosial vihara.',
                'Mengenal tokoh-tokoh Buddhis.'
            ],
            6: [
                'Memahami siklus kelahiran kembali.',
                'Menerapkan ajaran moral Buddhis dalam kehidupan.',
                'Mempraktikkan meditasi lebih mendalam.',
                'Meneladani sifat welas asih Buddha.'
            ]
        },

        khonghucuCpsByGrade: {
            1: [
                'Mengenal Tian (Tuhan) dan ajaran Nabi Kongzi.',
                'Menghafal doa harian Khonghucu.',
                'Menunjukkan sikap hormat kepada orang tua.',
                'Mengenal litang sebagai tempat ibadah.'
            ],
            2: [
                'Memahami ajaran Xiao (bakti kepada orang tua).',
                'Menghafal ayat-ayat Lunyu sederhana.',
                'Mempraktikkan perilaku sopan santun.',
                'Mengenal hari besar Imlek.'
            ],
            3: [
                'Memahami ajaran Ren (cinta kasih).',
                'Mengenal tokoh-tokoh dalam sejarah Khonghucu.',
                'Mengikuti upacara di litang.',
                'Menjaga kebersihan lingkungan.'
            ],
            4: [
                'Memahami ajaran Yi (benar) dan Li (tata krama).',
                'Menghafal doa-doa pilihan Khonghucu.',
                'Mengikuti perayaan tradisi Tionghoa.',
                'Menghormati sesama tanpa membedakan.'
            ],
            5: [
                'Menganalisis ajaran-ajaran dalam Kitab Sishu.',
                'Memahami makna kebajikan dalam kehidupan.',
                'Berpartisipasi dalam kegiatan sosial.',
                'Mengenal tokoh-tokoh Khonghucu berpengaruh.'
            ],
            6: [
                'Memahami ajaran harmoni dalam keluarga dan masyarakat.',
                'Mempraktikkan nilai kejujuran dan kesetiaan.',
                'Mengamalkan ajaran Nabi Kongzi.',
                'Menjadi teladan dalam menjaga kerukunan.'
            ]
        },
        
        ipasCpsByGrade: {
            1: [
                'Mengenal diri dan lingkungan terdekat melalui pengamatan, menanyakan, dan menceritakan kembali hasil pengamatan secara sederhana.',
                'Mengenal makhluk hidup dan benda di lingkungan sekitar serta kebutuhannya.',
                'Mengenal perubahan yang terjadi di lingkungan sekitar dalam kehidupan sehari-hari.'
            ],
            2: [
                'Mengidentifikasi hubungan antara makhluk hidup dengan lingkungannya melalui pengamatan langsung.',
                'Menjelaskan sifat-sifat benda dan perubahannya secara sederhana.',
                'Mengenal peran anggota masyarakat dan pekerjaan di lingkungan sekitar.'
            ],
            3: [
                'Mengidentifikasi siklus hidup makhluk hidup dan keterkaitannya dengan lingkungan.',
                'Mengenal sumber daya alam, pemanfaatannya, dan cara menjaga kelestariannya.',
                'Mengenal perubahan lingkungan dan perkembangan wilayah setempat dari waktu ke waktu.'
            ],
            4: [
                'Menjelaskan hubungan antar makhluk hidup dalam ekosistem serta pengaruh perubahan lingkungan.',
                'Mengidentifikasi bentuk energi, perubahannya, dan peranannya dalam kehidupan sehari-hari.',
                'Memahami keragaman sosial, budaya, dan sumber daya di Indonesia.'
            ],
            5: [
                'Memahami sistem organ pada manusia dan hubungannya dengan kesehatan.',
                'Menganalisis pengaruh kegiatan manusia terhadap keseimbangan lingkungan.',
                'Mengidentifikasi perkembangan teknologi dan perannya dalam kehidupan masyarakat.'
            ],
            6: [
                'Menganalisis interaksi manusia dengan lingkungan alam dan sosial pada skala lokal hingga global.',
                'Menjelaskan peristiwa alam, tata surya, dan dampaknya terhadap kehidupan di bumi.',
                'Menganalisis perkembangan wilayah, hubungan internasional, dan dampaknya terhadap kehidupan masyarakat.'
            ]
        },
        
        seniDaerahCpsByGrade: {
            1: [
                'Mengenal lagu daerah dan menyanyikannya dengan sederhana.',
                'Menirukan gerak tari daerah yang mudah.',
                'Mengenal alat musik tradisional daerah setempat.'
            ],
            2: [
                'Menyanyikan lagu daerah dengan pengucapan yang benar.',
                'Mempraktikkan gerak tari sederhana dari daerah setempat.',
                'Memainkan alat musik ritmis tradisional secara sederhana.'
            ],
            3: [
                'Memahami makna lagu daerah melalui liriknya.',
                'Menampilkan tarian sederhana secara berkelompok.',
                'Memainkan pola irama sederhana pada alat musik tradisional.'
            ],
            4: [
                'Menyanyikan lagu daerah dengan teknik vokal yang lebih baik.',
                'Menampilkan tarian daerah dengan pola lantai sederhana.',
                'Mengenal fungsi alat musik tradisional dalam pertunjukan seni.'
            ],
            5: [
                'Menampilkan lagu daerah dengan iringan musik tradisional.',
                'Memodifikasi gerak tari daerah menjadi kreasi baru sederhana.',
                'Memainkan alat musik tradisional secara berkelompok.'
            ],
            6: [
                'Menampilkan pertunjukan seni daerah (musik/tari) hasil kreasi kelompok.',
                'Memadukan unsur musik, tari, dan busana daerah dalam pertunjukan.',
                'Menjelaskan makna pertunjukan seni daerah bagi masyarakat.'
            ]
        },

        kerajinanDaerahCpsByGrade: {
            1: [
                'Mengenal jenis-jenis kerajinan sederhana khas daerah.',
                'Membuat karya kerajinan sederhana dengan bantuan guru.',
                'Menghias karya dengan motif daerah sederhana.'
            ],
            2: [
                'Mengenal bahan-bahan alami untuk kerajinan daerah.',
                'Mempraktikkan teknik dasar membuat kerajinan tangan.',
                'Menyelesaikan kerajinan sederhana seperti anyaman atau lipatan.'
            ],
            3: [
                'Mengenal teknik dasar batik, tenun, atau ukir sesuai daerah.',
                'Membuat produk sederhana yang terinspirasi dari kerajinan daerah.',
                'Menjelaskan fungsi kerajinan dalam kehidupan sehari-hari.'
            ],
            4: [
                'Menggunakan teknik dasar membuat kerajinan dengan alat sederhana.',
                'Membuat motif daerah pada karya kerajinan.',
                'Menyajikan karya kerajinan kepada teman atau keluarga.'
            ],
            5: [
                'Mengembangkan karya kerajinan yang memiliki fungsi praktis.',
                'Menggunakan lebih dari satu teknik pembuatan kerajinan.',
                'Menjelaskan makna motif atau bentuk dalam kerajinan daerah.'
            ],
            6: [
                'Membuat karya kerajinan yang memiliki nilai seni dan fungsi.',
                'Memodifikasi bentuk atau motif kerajinan khas daerah.',
                'Menyajikan hasil karya dalam pameran sekolah.'
            ]
        },

        kearifanLokalCpsByGrade: {
            1: [
                'Mengenal kebiasaan dan tradisi sederhana di lingkungan sekitar.',
                'Mengikuti permainan tradisional yang mudah dipraktikkan.',
                'Menunjukkan sikap sopan santun sesuai adat setempat.'
            ],
            2: [
                'Memahami kebiasaan masyarakat dalam kegiatan sehari-hari.',
                'Mengenal pakaian adat dan penggunaannya pada acara khusus.',
                'Berpartisipasi dalam permainan tradisional kelompok.'
            ],
            3: [
                'Mengenal upacara adat di daerah setempat.',
                'Menjelaskan makna simbol atau hiasan tradisional.',
                'Mempraktikkan permainan rakyat yang melibatkan kerja sama.'
            ],
            4: [
                'Memahami proses pelaksanaan upacara adat secara sederhana.',
                'Mengidentifikasi peralatan dan perlengkapan adat.',
                'Memainkan permainan tradisional yang memerlukan strategi.'
            ],
            5: [
                'Menggali nilai-nilai yang terkandung dalam kearifan lokal daerah.',
                'Membandingkan tradisi setempat dengan daerah lain.',
                'Mempraktikkan salah satu tradisi secara sederhana di sekolah.'
            ],
            6: [
                'Menganalisis peran kearifan lokal dalam menjaga persatuan.',
                'Mengidentifikasi ancaman terhadap kelestarian tradisi.',
                'Merancang kegiatan untuk melestarikan tradisi di lingkungan sekitar.'
            ]
        },

        bahasaDaerahCpsByGrade: {
            1: [
                'Mengenal kosakata dasar bahasa daerah (anggota tubuh, keluarga, benda sekitar).',
                'Mengucapkan salam dan sapaan sederhana sesuai tata krama daerah.',
                'Menyebutkan angka 1–10 dalam bahasa daerah.'
            ],
            2: [
                'Memperluas kosakata tentang hewan, tumbuhan, dan kegiatan sehari-hari.',
                'Menggunakan kalimat sederhana untuk bertanya dan menjawab.',
                'Menyanyikan lagu anak daerah dengan pengucapan yang tepat.'
            ],
            3: [
                'Memahami cerita rakyat sederhana dalam bahasa daerah.',
                'Menyusun kalimat sederhana dengan struktur yang benar.',
                'Menggunakan bahasa daerah dalam percakapan sehari-hari di kelas.'
            ],
            4: [
                'Memahami ungkapan sopan dan peribahasa daerah.',
                'Menceritakan kembali cerita rakyat dengan bahasa daerah.',
                'Menulis kalimat sederhana dalam bahasa daerah.'
            ],
            5: [
                'Menggunakan bahasa daerah untuk menjelaskan suatu kegiatan atau pengalaman.',
                'Membaca teks sederhana dengan intonasi dan lafal yang tepat.',
                'Mengenal variasi dialek dalam bahasa daerah setempat.'
            ],
            6: [
                'Menyampaikan pidato atau sambutan singkat dalam bahasa daerah.',
                'Menulis paragraf sederhana dengan ejaan bahasa daerah yang benar.',
                'Memahami makna sastra lisan seperti pantun, tembang, atau syair daerah.'
            ]
        },
        
        bahasaInggrisCpsByGrade: {
            1: [
                'Mengenal kosakata dasar (warna, angka, benda kelas, keluarga) melalui gambar atau lagu.',
                'Mengucapkan salam dan perkenalan diri secara sederhana.',
                'Memahami instruksi sederhana guru dalam bahasa Inggris (misalnya: stand up, sit down).'
            ],
            2: [
                'Memperluas kosakata tentang hewan, tumbuhan, dan bagian tubuh.',
                'Mengajukan dan menjawab pertanyaan sederhana (What is this? / This is…).',
                'Menyanyikan lagu anak-anak berbahasa Inggris dengan pengucapan sederhana.'
            ],
            3: [
                'Memahami teks lisan pendek berupa perintah, sapaan, atau instruksi sederhana.',
                'Memperkenalkan diri, teman, dan benda sekitar menggunakan kalimat sederhana.',
                'Membaca dan menulis kosakata dasar dengan ejaan yang benar.'
            ],
            4: [
                'Memahami kosakata tentang waktu, cuaca, dan kegiatan sehari-hari.',
                'Menyusun kalimat sederhana menggunakan pola Subjek + Kata Kerja + Objek.',
                'Membaca teks pendek (dialog, deskripsi benda) dan menjawab pertanyaan sederhana.'
            ],
            5: [
                'Memahami kosakata dan ungkapan tentang hobi, makanan, dan tempat.',
                'Menyusun percakapan sederhana untuk berinteraksi dengan teman sebaya.',
                'Menulis kalimat sederhana untuk menggambarkan benda, orang, atau kegiatan.'
            ],
            6: [
                'Memahami teks deskriptif sederhana tentang orang, tempat, atau benda.',
                'Menyampaikan informasi sederhana secara lisan (memperkenalkan, menceritakan pengalaman singkat).',
                'Menulis paragraf sederhana dengan struktur yang benar (misalnya: about myself, my family, my school).'
            ]
        },

        pjokCpsByGrade: {
            1: [
                'Melakukan gerak dasar lokomotor (berjalan, berlari, melompat) dengan benar.',
                'Mempraktikkan gerak dasar non-lokomotor (membungkuk, memutar badan).',
                'Mengenal permainan sederhana secara berkelompok.',
                'Memahami kebiasaan hidup bersih dan sehat.'
            ],
            2: [
                'Mengombinasikan gerak lokomotor dan non-lokomotor dalam permainan.',
                'Mempraktikkan koordinasi gerak sederhana.',
                'Mengenal peraturan dasar dalam permainan.',
                'Memahami pentingnya makan bergizi.'
            ],
            3: [
                'Melakukan variasi gerak dasar lokomotor, non-lokomotor, dan manipulatif (melempar, menangkap).',
                'Mengikuti permainan tradisional yang memerlukan kerja sama.',
                'Memahami konsep keselamatan saat beraktivitas fisik.',
                'Mengenal cara menjaga kebugaran tubuh.'
            ],
            4: [
                'Mempraktikkan keterampilan gerak dasar dalam permainan bola kecil dan besar.',
                'Melakukan aktivitas kebugaran jasmani sederhana.',
                'Memahami pentingnya pemanasan dan pendinginan.',
                'Mengenal pola hidup sehat.'
            ],
            5: [
                'Mengembangkan keterampilan dalam cabang olahraga tertentu (sepak bola, bola voli, bulu tangkis).',
                'Mempraktikkan kebugaran jasmani dengan intensitas sedang.',
                'Menganalisis faktor yang memengaruhi kesehatan tubuh.',
                'Mengenal pertolongan pertama pada kecelakaan ringan.'
            ],
            6: [
                'Menunjukkan keterampilan bermain dalam cabang olahraga tertentu dengan peraturan sederhana.',
                'Mengikuti kegiatan kebugaran jasmani secara teratur.',
                'Menunjukkan sikap sportivitas dan kerja sama tim.',
                'Memahami upaya menjaga kesehatan tubuh dan lingkungan.'
            ]
        },

        prakaryaCpsByGrade: {
            1: [
                'Membuat kerajinan sederhana dari bahan alam atau bekas.',
                'Mempraktikkan teknik dasar melipat, menggunting, dan menempel.',
                'Menghias karya sederhana dengan warna atau motif.'
            ],
            2: [
                'Membuat karya kolase sederhana dari bahan alam atau buatan.',
                'Menggunakan teknik anyaman atau lipatan sederhana.',
                'Menghias karya agar lebih menarik secara visual.'
            ],
            3: [
                'Membuat kerajinan tangan berbahan alam atau buatan dengan fungsi sederhana.',
                'Mempraktikkan teknik sambung dan rekat sederhana.',
                'Menghias karya sesuai tema tertentu.'
            ],
            4: [
                'Membuat karya keterampilan berbahan daur ulang.',
                'Menggunakan teknik potong, lipat, rekat, atau anyaman dalam karya.',
                'Menambahkan unsur estetis pada karya yang dibuat.'
            ],
            5: [
                'Membuat kerajinan fungsional sederhana berbahan alam atau buatan.',
                'Menerapkan teknik konstruksi sederhana.',
                'Menghias karya agar memiliki nilai estetika.'
            ],
            6: [
                'Membuat produk keterampilan yang memiliki nilai guna dan estetika.',
                'Menggunakan berbagai teknik dalam satu karya.',
                'Menyajikan karya keterampilan secara menarik.'
            ]
        },

        seniMusikCpsByGrade: {
            1: [
                'Mengekspresikan diri melalui nyanyian sederhana dengan irama dan tempo tepat.',
                'Mengenal perbedaan tinggi-rendah nada.',
                'Mengenal suara alat musik ritmis sederhana.'
            ],
            2: [
                'Menyanyikan lagu anak dengan intonasi dan tempo benar.',
                'Mengenal alat musik melodis sederhana.',
                'Memainkan pola irama sederhana dengan alat musik ritmis.'
            ],
            3: [
                'Menyanyikan lagu daerah dengan sikap yang benar.',
                'Mengenal tanda birama sederhana.',
                'Memainkan alat musik ritmis atau melodis dengan pola sederhana.'
            ],
            4: [
                'Memainkan alat musik ritmis dalam ansambel sederhana.',
                'Menyanyikan lagu wajib nasional dengan teknik vokal yang benar.',
                'Mengenal tanda tempo dan dinamik sederhana.'
            ],
            5: [
                'Menyanyikan lagu dengan teknik pernapasan yang baik.',
                'Memainkan alat musik melodis sederhana secara berkelompok.',
                'Menciptakan pola irama sederhana.'
            ],
            6: [
                'Menyanyikan lagu nasional dan daerah dengan teknik vokal baik.',
                'Memainkan ansambel musik sederhana dengan koordinasi kelompok.',
                'Memodifikasi irama atau melodi sederhana.'
            ]
        },

        seniRupaCpsByGrade: {
            1: [
                'Mengenal unsur garis, bentuk, dan warna dalam karya gambar.',
                'Menggambar bentuk sederhana dari benda di sekitar.',
                'Mewarnai gambar dengan teknik sederhana.'
            ],
            2: [
                'Menggambar bentuk benda di sekitar dengan proporsi sederhana.',
                'Mengenal pola, tekstur, dan motif sederhana.',
                'Menggunakan kombinasi warna dalam gambar.'
            ],
            3: [
                'Menggambar dengan teknik pewarnaan, arsiran, atau titik.',
                'Menggunakan komposisi sederhana dalam karya.',
                'Membuat karya dua dimensi bertema lingkungan.'
            ],
            4: [
                'Menggambar objek dengan memperhatikan proporsi sederhana.',
                'Menciptakan karya tiga dimensi sederhana dari tanah liat atau plastisin.',
                'Menggunakan teknik campuran dalam menggambar atau melukis.'
            ],
            5: [
                'Menggambar atau melukis dengan variasi media (kuas, spidol, pensil warna).',
                'Menciptakan karya seni bertema budaya daerah.',
                'Menggambar perspektif sederhana.'
            ],
            6: [
                'Melukis atau menggambar dengan proporsi dan perspektif lebih tepat.',
                'Membuat karya tiga dimensi yang memiliki nilai estetika.',
                'Menggunakan teknik dan media campuran dalam karya seni rupa.'
            ]
        },

        seniTariCpsByGrade: {
            1: [
                'Melakukan gerakan tubuh sederhana sesuai irama lagu.',
                'Meniru gerak dasar tari anak-anak.',
                'Menampilkan gerakan kreatif sederhana secara berkelompok.'
            ],
            2: [
                'Melakukan variasi gerak dasar tari anak-anak.',
                'Mempraktikkan gerakan sesuai pola lantai sederhana.',
                'Menampilkan tarian sederhana dengan ekspresi ceria.'
            ],
            3: [
                'Mempraktikkan gerak dasar tari daerah.',
                'Menyesuaikan gerak tari dengan irama dan tempo musik pengiring.',
                'Menampilkan tarian sederhana secara berkelompok.'
            ],
            4: [
                'Menampilkan tarian daerah dengan pola lantai dasar.',
                'Mempraktikkan kombinasi gerak tangan, kaki, dan kepala.',
                'Menghafal urutan gerak dalam satu tarian sederhana.'
            ],
            5: [
                'Menampilkan tarian daerah dengan variasi pola lantai.',
                'Menyesuaikan gerakan dengan ekspresi yang tepat.',
                'Memodifikasi gerak tari sederhana menjadi tarian baru.'
            ],
            6: [
                'Menampilkan karya tari hasil kreasi sendiri atau kelompok.',
                'Memadukan gerakan, musik, dan properti sederhana dalam tari.',
                'Menunjukkan kerjasama yang baik dalam penampilan tari berkelompok.'
            ]
        },

        pancasilaCpsByGrade: {
            1: [
                'Mengenal simbol negara seperti bendera, lambang Garuda Pancasila, dan lagu kebangsaan.',
                'Memahami aturan sederhana di rumah dan sekolah.',
                'Menunjukkan sikap saling menghormati di rumah dan sekolah.',
                'Meneladani perilaku tokoh nasional sederhana.'
            ],
            2: [
                'Memahami makna sila-sila Pancasila dalam kehidupan sehari-hari.',
                'Mempraktikkan perilaku sesuai nilai-nilai Pancasila di lingkungan sekolah.',
                'Memahami hak dan kewajiban sebagai anggota keluarga dan warga sekolah.',
                'Menghargai keberagaman teman di sekolah.'
            ],
            3: [
                'Memahami pentingnya persatuan di lingkungan sekolah dan masyarakat.',
                'Mempraktikkan musyawarah dalam pengambilan keputusan sederhana.',
                'Menghormati perbedaan agama, suku, dan budaya.',
                'Menunjukkan kepedulian terhadap lingkungan sekitar.'
            ],
            4: [
                'Memahami makna simbol negara dan peraturan perundang-undangan sederhana.',
                'Menghargai jasa pahlawan nasional dan daerah.',
                'Mempraktikkan demokrasi di lingkungan sekolah.',
                'Menjalankan hak dan kewajiban sebagai warga sekolah dan masyarakat.'
            ],
            5: [
                'Memahami peran lembaga pemerintahan di tingkat daerah.',
                'Menunjukkan sikap gotong royong dan toleransi.',
                'Menganalisis peristiwa sejarah kemerdekaan Indonesia yang mencerminkan nilai Pancasila.',
                'Memahami peran Indonesia dalam kerja sama antarnegara di ASEAN.'
            ],
            6: [
                'Menganalisis nilai-nilai Pancasila dalam kehidupan berbangsa dan bernegara.',
                'Memahami sistem pemerintahan Indonesia.',
                'Mengkaji peraturan perundang-undangan dan penerapannya dalam kehidupan.',
                'Menunjukkan sikap cinta tanah air dalam tindakan nyata.'
            ]
        },

        matematikaCpsByGrade: {
            1: [
                'Mengenal dan menulis bilangan 1–100, membandingkan, dan mengurutkan bilangan.',
                'Melakukan penjumlahan dan pengurangan bilangan sampai 20 secara lancar.',
                'Mengenal konsep panjang, berat, waktu, dan mengukur menggunakan satuan tidak baku.',
                'Mengenal bentuk bangun datar dan bangun ruang sederhana.',
                'Mengumpulkan dan mengelompokkan data sederhana.'
            ],
            2: [
                'Menghitung penjumlahan dan pengurangan bilangan sampai 1000.',
                'Mengenal perkalian dan pembagian sebagai operasi berulang.',
                'Mengukur panjang, berat, dan waktu dengan satuan baku.',
                'Mengenal sifat-sifat bangun datar dan bangun ruang sederhana.',
                'Menyajikan data sederhana dalam tabel atau diagram gambar.'
            ],
            3: [
                'Melakukan penjumlahan, pengurangan, perkalian, dan pembagian bilangan sampai 10.000.',
                'Mengenal pecahan sederhana dan hubungan antar pecahan.',
                'Mengukur keliling dan luas bangun datar sederhana.',
                'Mengidentifikasi simetri lipat dan simetri putar bangun datar.',
                'Membaca dan menyajikan data dalam tabel dan diagram batang.'
            ],
            4: [
                'Mengoperasikan bilangan cacah dan pecahan (penjumlahan, pengurangan, perkalian, pembagian).',
                'Mengubah pecahan ke bentuk desimal dan persen.',
                'Menghitung keliling, luas, dan volume bangun sederhana.',
                'Mengenal sudut, garis, dan hubungan antar garis.',
                'Menginterpretasi data dari tabel dan diagram.'
            ],
            5: [
                'Mengoperasikan bilangan bulat, pecahan, desimal, dan persen.',
                'Memecahkan masalah perbandingan dan skala.',
                'Menghitung luas bangun datar gabungan dan volume kubus serta balok.',
                'Memahami konsep sudut dan pengukuran sudut.',
                'Menganalisis data dan menyajikan dalam diagram garis atau lingkaran.'
            ],
            6: [
                'Memecahkan masalah yang melibatkan operasi bilangan bulat, pecahan, dan desimal.',
                'Menggunakan konsep rasio, proporsi, dan persentase dalam pemecahan masalah.',
                'Menghitung luas bangun datar kompleks dan volume bangun ruang sederhana.',
                'Memahami transformasi (translasi, refleksi, rotasi) sederhana pada bangun datar.',
                'Menyajikan dan menafsirkan data dalam berbagai bentuk diagram.'
            ]
        },

        bahasaIndonesiaCpsByGrade: {
            1: [
                'Mengenali huruf, kata, dan tanda baca sederhana dalam teks pendek.',
                'Membaca nyaring teks sederhana dengan lafal, intonasi, dan jeda yang tepat.',
                'Menemukan informasi sederhana dari teks yang dibacakan atau dibaca sendiri.',
                'Menulis kata dan kalimat sederhana dengan ejaan yang benar.',
                'Mengungkapkan pendapat atau perasaan secara lisan menggunakan kalimat sederhana.',
                'Mendengarkan dan menceritakan kembali isi cerita atau pengalaman pribadi secara runtut.'
            ],
            2: [
                'Membaca teks narasi dan deskripsi sederhana dengan lafal dan intonasi yang tepat.',
                'Mengidentifikasi tokoh, peristiwa, dan pesan dari teks.',
                'Menulis cerita atau deskripsi sederhana dengan penggunaan ejaan yang benar.',
                'Menyampaikan pendapat atau informasi secara lisan dengan bahasa santun.',
                'Menggunakan kosakata baku sesuai konteks dalam berbicara dan menulis.'
            ],
            3: [
                'Membaca teks narasi, deskripsi, dan informatif untuk menemukan ide pokok dan informasi penting.',
                'Menulis teks sederhana (cerita, laporan, atau deskripsi) dengan struktur yang tepat.',
                'Menyunting tulisan sendiri atau teman untuk memperbaiki ejaan dan tanda baca.',
                'Menyampaikan informasi atau cerita secara lisan dengan runtut dan jelas.'
            ],
            4: [
                'Memahami teks narasi, eksplanasi, prosedur, dan deskripsi dari berbagai sumber.',
                'Menulis laporan hasil pengamatan dengan bahasa baku dan kalimat efektif.',
                'Menentukan informasi penting dalam teks dan menyusunnya kembali secara singkat.',
                'Mengungkapkan pendapat dalam diskusi kelompok dengan alasan yang jelas.'
            ],
            5: [
                'Menganalisis isi dan struktur teks narasi, eksposisi, prosedur, dan ulasan.',
                'Menulis teks sesuai struktur dan ciri kebahasaannya dengan ejaan yang tepat.',
                'Menyunting teks untuk memperbaiki kosakata, ejaan, dan tata bahasa.',
                'Menyampaikan pendapat dan argumen secara lisan dalam diskusi atau presentasi.'
            ],
            6: [
                'Memahami isi teks fiksi dan nonfiksi dengan analisis mendalam.',
                'Menulis teks cerita, ulasan, dan laporan dengan bahasa baku dan sumber yang tepat.',
                'Menggunakan kutipan dan daftar pustaka sederhana dalam karya tulis.',
                'Berpartisipasi dalam debat atau presentasi dengan argumen yang logis dan meyakinkan.'
            ]
        },

        p5ProfileData: {
            dimensions: [
                {
                    id: 'dim-1', name: 'Beriman, Bertakwa kepada Tuhan YME, dan Berakhlak Mulia',
                    elements: [
                        { id: 'el-1-1', name: 'Akhlak Beragama', subElements: [
                            { id: 'sub-1-1-1', name: 'Mengenal dan Mencintai Tuhan YME', faseB: 'Memahami sifat-sifat Tuhan utama lainnya dan mengaitkan sifat-sifat tersebut dengan konsep dirinya dan ciptaan-Nya.' },
                            { id: 'sub-1-1-2', name: 'Pemahaman Agama/Kepercayaan', faseB: 'Memahami unsur-unsur utama agama/kepercayaan (seperti: simbol-simbol, kitab suci, dan sejarahnya).' },
                            { id: 'sub-1-1-3', name: 'Pelaksanaan Ritual Ibadah', faseB: 'Melaksanakan ibadah secara rutin dan mandiri sesuai tuntunan agama/kepercayaan serta menyadari arti penting ibadah tersebut.' }
                        ]},
                        { id: 'el-1-2', name: 'Akhlak Pribadi', subElements: [
                            { id: 'sub-1-2-1', name: 'Integritas', faseB: 'Membiasakan bersikap jujur terhadap diri sendiri dan orang lain dan berani menyampaikan kebenaran atau fakta.' },
                            { id: 'sub-1-2-2', name: 'Merawat Diri secara Fisik, Mental, dan Spiritual', faseB: 'Mengidentifikasi pentingnya menjaga keseimbangan kesehatan jasmani, mental, dan rohani serta berupaya menyeimbangkan ketiganya dalam beraktivitas.' }
                        ]},
                        { id: 'el-1-3', name: 'Akhlak kepada Manusia', subElements: [
                            { id: 'sub-1-3-1', name: 'Mengutamakan persamaan dengan orang lain dan menghargai perbedaan', faseB: 'Mengidentifikasi kesamaan dengan orang lain sebagai perekat hubungan sosial dan mewujudkannya dalam aktivitas kelompok.' },
                            { id: 'sub-1-3-2', name: 'Berempati kepada orang lain', faseB: 'Mengidentifikasi emosi, minat, dan kebutuhan orang-orang terdekat dan meresponnya secara positif.' }
                        ]},
                        { id: 'el-1-4', name: 'Akhlak kepada Alam', subElements: [
                            { id: 'sub-1-4-1', name: 'Memahami Keterhubungan Ekosistem Bumi', faseB: 'Memahami keterhubungan antara satu ciptaan dengan ciptaan Tuhan yang lainnya.' },
                            { id: 'sub-1-4-2', name: 'Menjaga Lingkungan Alam Sekitar', faseB: 'Mewujudkan rasa syukur dengan berinisiatif untuk menyelesaikan permasalahan lingkungan alam sekitarnya dengan mengajukan alternatif solusi dan mulai menerapkan solusi tersebut.' }
                        ]},
                        { id: 'el-1-5', name: 'Akhlak Bernegara', subElements: [
                            { id: 'sub-1-5-1', name: 'Melaksanakan Hak dan Kewajiban sebagai Warga Negara Indonesia', faseB: 'Mengidentifikasi hak dan tanggung jawabnya sebagai anak di rumah, sekolah, serta kaitannya dengan keimanan dan kepercayaannya.' }
                        ]}
                    ]
                },
                {
                    id: 'dim-2', name: 'Berkebinekaan Global',
                    elements: [
                        { id: 'el-2-1', name: 'Mengenal dan menghargai budaya', subElements: [
                            { id: 'sub-2-1-1', name: 'Mendalami budaya dan identitas budaya', faseB: 'Mengidentifikasi dan mendeskripsikan keragaman budaya di sekitarnya; serta menjelaskan peran budaya dan Bahasa dalam membentuk identitas dirinya.' },
                            { id: 'sub-2-1-2', name: 'Mengeksplorasi dan membandingkan pengetahuan budaya, kepercayaan, serta praktiknya', faseB: 'Mendeskripsikan dan membandingkan pengetahuan, keterampilan, dan sikap yang dimiliki oleh berbagai kelompok budaya.' },
                            { id: 'sub-2-1-3', name: 'Menumbuhkan rasa menghormati terhadap keanekaragaman budaya', faseB: 'Memahami bahwa kemajemukan dapat memberikan kesempatan untuk mendapatkan pengalaman dan pemahaman yang baru.' }
                        ]},
                        { id: 'el-2-2', name: 'Komunikasi dan interaksi antar budaya', subElements: [
                            { id: 'sub-2-2-1', name: 'Berkomunikasi antar budaya', faseB: 'Memahami adanya potensi perbedaan cara berkomunikasi dan berinteraksi antar budaya.' },
                            { id: 'sub-2-2-2', name: 'Mempertimbangkan dan menumbuhkan berbagai perspektif', faseB: 'Menjelaskan apa yang dipikirkan, dirasakan, dan dilakukan oleh orang lain, serta mengakui adanya kemungkinan orang lain memiliki perspektif yang berbeda.' }
                        ]},
                        { id: 'el-2-3', name: 'Refleksi dan tanggung jawab terhadap pengalaman kebinekaan', subElements: [
                            { id: 'sub-2-3-1', name: 'Refleksi terhadap pengalaman kebinekaan', faseB: 'Menyebutkan apa yang telah dipelajari tentang orang atau kelompok lain dari interaksi dan pengalaman yang telah dialami.' },
                            { id: 'sub-2-3-2', name: 'Menghilangkan stereotip dan prasangka', faseB: 'Mengidentifikasi dan membandingkan berbagai stereotip dan prasangka yang ada tentang individu atau kelompok serta mencari alternatif cara pandang yang lebih adil.' },
                            { id: 'sub-2-3-3', name: 'Menyelaraskan perbedaan budaya', faseB: 'Menyebutkan contoh tindakan, kebiasaan, atau kepercayaan yang berbeda dari lingkungan budayanya.' }
                        ]},
                        { id: 'el-2-4', name: 'Berkeadilan Sosial', subElements: [
                            { id: 'sub-2-4-1', name: 'Berpartisipasi dalam proses pengambilan keputusan bersama', faseB: 'Menyebutkan contoh-contoh tindakan dan perilaku yang menjaga serta yang merusak keharmonisan dalam lingkungan sekitarnya.' }
                        ]}
                    ]
                },
                {
                    id: 'dim-3', name: 'Gotong Royong',
                    elements: [
                        { id: 'el-3-1', name: 'Kolaborasi', subElements: [
                            { id: 'sub-3-1-1', name: 'Kerja sama', faseB: 'Menerima dan melaksanakan tugas serta peran yang diberikan kelompok dalam sebuah kegiatan bersama.' },
                            { id: 'sub-3-1-2', name: 'Komunikasi untuk mencapai tujuan bersama', faseB: 'Memahami informasi sederhana dari orang lain dan menyampaikan informasi sederhana kepada orang lain menggunakan kata-katanya sendiri.' },
                            { id: 'sub-3-1-3', name: 'Saling-ketergantungan positif', faseB: 'Menyadari bahwa setiap orang membutuhkan orang lain dalam memenuhi kebutuhannya dan bagaimana mereka dapat saling membantu.' },
                            { id: 'sub-3-1-4', name: 'Koordinasi Sosial', faseB: 'Melaksanakan aktivitas kelompok sesuai dengan kesepakatan.' }
                        ]},
                        { id: 'el-3-2', name: 'Kepedulian', subElements: [
                            { id: 'sub-3-2-1', name: 'Tanggap terhadap lingkungan Sosial', faseB: 'Peka dan mengapresiasi orang-orang di lingkungan sekitar, kemudian melakukan tindakan sederhana untuk mengungkapkannya.' },
                            { id: 'sub-3-2-2', name: 'Persepsi sosial', faseB: 'Mengenali dan mengekspresikan emosi diri sendiri serta mengenali emosi orang lain.' }
                        ]},
                        { id: 'el-3-3', name: 'Berbagi', subElements: [
                            { id: 'sub-3-3-1', name: 'Berbagi', faseB: 'Memberi dan menerima hal yang dianggap berharga dan penting kepada/dari orang-orang di lingkungan sekitar.' }
                        ]}
                    ]
                },
                {
                    id: 'dim-4', name: 'Mandiri',
                    elements: [
                        { id: 'el-4-1', name: 'Pemahaman diri dan situasi yang dihadapi', subElements: [
                            { id: 'sub-4-1-1', name: 'Mengenali kualitas dan minat diri serta tantangan yang dihadapi', faseB: 'Mengidentifikasi kemampuan, prestasi, dan ketertarikannya serta tantangan yang dihadapinya berdasarkan kejadian-kejadian yang dialaminya dalam kehidupan sehari-hari.' },
                            { id: 'sub-4-1-2', name: 'Mengembangkan refleksi diri', faseB: 'Melakukan refleksi untuk mengidentifikasi kekuatan, kelemahan, dan prestasi dirinya, serta situasi yang dapat mendukung dan menghambat pembelajaran dan pengembangannya.' }
                        ]},
                        { id: 'el-4-2', name: 'Regulasi Diri', subElements: [
                            { id: 'sub-4-2-1', name: 'Regulasi emosi', faseB: 'Mengidentifikasi perbedaan emosi yang dirasakannya dan situasi-situasi yang menyebabkannya; serta mengekspresikan emosi secara wajar.' },
                            { id: 'sub-4-2-2', name: 'Menetapkan tujuan dan rencana strategis pengembangan diri dan prestasi', faseB: 'Mengidentifikasi target belajar yang realistis untuk dicapai dan menyusun rencana sederhana dengan bantuan orang dewasa.' },
                            { id: 'sub-4-2-3', name: 'Menunjukkan inisiatif dan bekerja secara mandiri', faseB: 'Berinisiatif untuk mengerjakan tugas-tugas rutin secara mandiri di bawah pengawasan dan dukungan orang dewasa.' },
                            { id: 'sub-4-2-4', name: 'Mengembangkan pengendalian dan disiplin diri', faseB: 'Mengendalikan dorongan-dorongan yang bersifat segera atau instan dalam mengerjakan aktivitas.' },
                            { id: 'sub-4-2-5', name: 'Percaya diri, tangguh (resilient), dan adaptif', faseB: 'Meminta bantuan kepada teman dan orang dewasa ketika menghadapi tantangan dalam belajar.' }
                        ]}
                    ]
                },
                {
                    id: 'dim-5', name: 'Bernalar Kritis',
                    elements: [
                        { id: 'el-5-1', name: 'Memperoleh dan memproses informasi dan gagasan', subElements: [
                            { id: 'sub-5-1-1', name: 'Mengajukan pertanyaan', faseB: 'Mengajukan pertanyaan untuk mengidentifikasi suatu permasalahan dan mengkonfirmasi pemahaman terhadap suatu permasalahan mengenai dirinya dan lingkungan sekitarnya.' },
                            { id: 'sub-5-1-2', name: 'Mengidentifikasi, mengklarifikasi, dan mengolah informasi dan gagasan', faseB: 'Mengumpulkan, mengklasifikasikan, membandingkan, dan memilih informasi dari berbagai sumber, serta menyampaikan kembali dengan bahasanya sendiri.' }
                        ]},
                        { id: 'el-5-2', name: 'Menganalisis dan mengevaluasi penalaran dan prosedurnya', subElements: [
                            { id: 'sub-5-2-1', name: 'Menjelaskan alasan yang relevan dalam penyelesaian masalah dan pengambilan keputusan', faseB: 'Menjelaskan alasan yang relevan dalam menyimpulkan atau mengambil keputusan.' }
                        ]},
                        { id: 'el-5-3', name: 'Merefleksi dan mengevaluasi pemikirannya sendiri', subElements: [
                            { id: 'sub-5-3-1', name: 'Merefleksi dan mengevaluasi pemikirannya sendiri', faseB: 'Menyampaikan apa yang sedang dipikirkan secara terperinci.' }
                        ]}
                    ]
                },
                {
                    id: 'dim-6', name: 'Kreatif',
                    elements: [
                        { id: 'el-6-1', name: 'Menghasilkan gagasan yang orisinal', subElements: [
                            { id: 'sub-6-1-1', name: 'Menggabungkan beberapa gagasan menjadi ide atau gagasan imajinatif yang bermakna untuk mengekspresikan pikiran dan/atau perasaannya.', faseB: 'Memunculkan gagasan imajinatif baru yang bermakna dari beberapa gagasan yang berbeda sebagai ekspresi pikiran dan/atau perasaannya.' }
                        ]},
                        { id: 'el-6-2', name: 'Menghasilkan karya dan tindakan yang orisinal', subElements: [
                            { id: 'sub-6-2-1', name: 'Mengeksplorasi dan mengekspresikan pikiran dan/atau perasaannya dalam bentuk karya dan/atau tindakan, serta mengevaluasinya dan mempertimbangkan dampaknya bagi orang lain.', faseB: 'Mengeksplorasi dan mengekspresikan pikiran dan/atau perasaannya sesuai dengan minat dan kesukaannya dalam bentuk karya dan/atau tindakan serta mengapresiasi karya dan tindakan yang dihasilkan.' }
                        ]},
                        { id: 'el-6-3', name: 'Memiliki keluwesan berpikir dalam mencari alternatif solusi permasalahan', subElements: [
                            { id: 'sub-6-3-1', name: 'Mengidentifikasi gagasan-gagasan kreatif untuk menghadapi situasi dan permasalahan.', faseB: 'Membandingkan gagasan-gagasan kreatif untuk menghadapi situasi dan permasalahan.' }
                        ]}
                    ]
                }
            ]
        },

        // --- STATE MANAGEMENT ---
        state: {
            settings: {},
            students: [],
            grades: {},
            extracurricularGrades: {}, // { studentId: [{ id: 'extraId', grade: 'A', description: '...' }] }
            attendance: {}, // { studentId: { s: 0, i: 0, a: 0 } }
            p5Grades: {}, // { studentId: { projectId: { subElementId: 'BB' | 'MB' | 'BSH' | 'SB' } } }
            teacherNotes: {}, // { studentId: '...' }
        },
        
        pendingGradeImport: null,
        pendingExtraImport: null,
        pendingAttendanceImport: null,
        selectedSubjectName: null,
        selectedGradeInputSubject: null,
        spreadsheetId: null,

        STORAGE_KEY: 'digitalReportApp',
        
        SHEET_NAMES: {
            SETTINGS: 'Settings',
            STUDENTS: 'Students',
            GRADES: 'Grades',
            EXTRAS: 'Extracurricular',
            ATTENDANCE: 'Attendance',
            P5_GRADES: 'P5_Grades',
            NOTES: 'TeacherNotes',
        },

        getEmptyStudent() {
            return { id: '', nis: '', nisn: '', name: '', panggilan: '', ttl: '', jenisKelamin: '', agama: '', kewarganegaraan: '', statusKeluarga: '', anakKe: '', asalTk: '', alamat: '', namaAyah: '', namaIbu: '', pekerjaanAyah: '', pekerjaanIbu: '', alamatOrtu: '', teleponOrtu: '', kelurahan: '', kecamatan: '', kabupaten: '', provinsi: '', namaWali: '', pekerjaanWali: '', alamatWali: '', teleponWali: '' };
        },

        getDefaultSettings() {
            const createSubject = (name, capaian, descs) => ({
                name,
                capaian: Array.isArray(capaian) ? capaian : [capaian],
                deskripsi: {
                    A: descs.A, B: descs.B, C: descs.C
                }
            });
            
            const defaultReligionDesc = { 
                A: '[nama], pemahamanmu tentang [cp] sangat mendalam. Teruslah menjadi teladan yang baik!', 
                B: '[nama], kamu sudah memahami [cp] dengan baik. Tingkatkan terus keimanan dan ketakwaanmu ya!', 
                C: '[nama], kamu sudah cukup mengerti tentang [cp]. Jangan ragu untuk bertanya agar pemahamanmu semakin kuat.' 
            };
            
            const defaultArtSportDesc = {
                A: '[nama], bakat dan kreativitasmu dalam [cp] sangat menonjol. Terus kembangkan potensimu, karyamu keren!',
                B: '[nama], kamu menunjukkan kemampuan yang baik dalam [cp]. Teruslah berlatih dengan semangat, kamu pasti bisa!',
                C: '[nama], kamu sudah cukup mampu dalam [cp]. Jangan ragu untuk mencoba dan berekspresi lebih bebas ya!',
            };

            const defaultGrade = 4;

            const defaultIslamCps = this.islamCpsByGrade[defaultGrade] || [];
            const defaultKristenCps = this.kristenCpsByGrade[defaultGrade] || [];
            const defaultKatolikCps = this.katolikCpsByGrade[defaultGrade] || [];
            const defaultHinduCps = this.hinduCpsByGrade[defaultGrade] || [];
            const defaultBuddhaCps = this.buddhaCpsByGrade[defaultGrade] || [];
            const defaultKhonghucuCps = this.khonghucuCpsByGrade[defaultGrade] || [];
            const defaultPancasilaCps = this.pancasilaCpsByGrade[defaultGrade] || [];
            const defaultBahasaIndonesiaCps = this.bahasaIndonesiaCpsByGrade[defaultGrade] || [];
            const defaultMatematikaCps = this.matematikaCpsByGrade[defaultGrade] || [];
            const defaultIpasCps = this.ipasCpsByGrade[defaultGrade] || [];
            const defaultSeniDaerahCps = this.seniDaerahCpsByGrade[defaultGrade] || [];
            const defaultKerajinanDaerahCps = this.kerajinanDaerahCpsByGrade[defaultGrade] || [];
            const defaultKearifanLokalCps = this.kearifanLokalCpsByGrade[defaultGrade] || [];
            const defaultBahasaDaerahCps = this.bahasaDaerahCpsByGrade[defaultGrade] || [];
            const defaultBahasaInggrisCps = this.bahasaInggrisCpsByGrade[defaultGrade] || [];
            const defaultPjokCps = this.pjokCpsByGrade[defaultGrade] || [];
            const defaultPrakaryaCps = this.prakaryaCpsByGrade[defaultGrade] || [];
            const defaultSeniMusikCps = this.seniMusikCpsByGrade[defaultGrade] || [];
            const defaultSeniRupaCps = this.seniRupaCpsByGrade[defaultGrade] || [];
            const defaultSeniTariCps = this.seniTariCpsByGrade[defaultGrade] || [];

            return {
                schoolName: 'SDN 1 Harapan Bangsa', npsn: '', schoolAddress: '', village: '', district: '', province: '', postalCode: '', schoolEmail: '', schoolPhone: '', website: '', fax: '', schoolLogo: '',
                className: 'Kelas 4A', schoolYear: '2024/2025', semester: 'Ganjil', reportDate: '',
                headmasterName: 'Nama Kepala Sekolah, M.Pd.', headmasterNip: '197001012000011001',
                teacherName: 'Nama Wali Kelas, S.Pd.', teacherNip: '198001012010011001',
                passingGrade: 70,
                gradeRanges: { A: 90, B: 80, C: 70 },
                extracurriculars: [
                    { id: 'e1', name: 'Pramuka' },
                    { id: 'e2', name: 'PMR' },
                    { id: 'e3', name: 'Sepak Bola' }
                ],
                p5Projects: [
                    {
                        id: 'p5-proj-1',
                        name: 'Gaya Hidup Berkelanjutan',
                        description: 'Proyek ini bertujuan untuk membangun kesadaran siswa tentang pentingnya menjaga lingkungan dan menerapkan gaya hidup berkelanjutan dalam kehidupan sehari-hari melalui kegiatan pengelolaan sampah dan penghematan energi.',
                        dimensions: [
                            { dimensionId: 'dim-1', subElementIds: ['sub-1-4-2'] },
                            { dimensionId: 'dim-3', subElementIds: ['sub-3-1-1', 'sub-3-2-1'] },
                            { dimensionId: 'dim-6', subElementIds: ['sub-6-2-1'] }
                        ]
                    }
                ],
                subjects: [
                    createSubject('Pendidikan Agama dan Budi Pekerti (Islam)', defaultIslamCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Kristen)', defaultKristenCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Katolik)', defaultKatolikCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Hindu)', defaultHinduCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Buddha)', defaultBuddhaCps, defaultReligionDesc),
                    createSubject('Pendidikan Agama dan Budi Pekerti (Khonghucu)', defaultKhonghucuCps, defaultReligionDesc),
                    createSubject('Pendidikan Pancasila', defaultPancasilaCps, { A: '[nama], kamu menunjukkan sikap yang sangat baik dalam [cp]. Kamu adalah calon pemimpin masa depan!', B: '[nama], sikapmu dalam [cp] sudah baik. Teruslah amalkan nilai-nilai Pancasila dalam kehidupanmu!', C: '[nama], kamu sudah cukup memahami tentang [cp]. Terus belajar menjadi warga negara yang baik ya.' }),
                    createSubject('Bahasa Indonesia', defaultBahasaIndonesiaCps, { A: '[nama], kamu sangat terampil dalam [cp]. Kemampuan berbahasamu luar biasa, teruslah berkarya!', B: '[nama], keterampilanmu dalam [cp] sudah bagus. Rajin membaca dan menulis akan membuatmu semakin hebat!', C: '[nama], kamu sudah cukup terampil dalam [cp]. Perbanyak latihan agar komunikasimu makin lancar.' }),
                    createSubject('Matematika', defaultMatematikaCps, { A: '[nama], kamu sangat menguasai [cp]. Logikamu tajam sekali, teruslah tantang dirimu dengan soal-soal baru!', B: '[nama], penguasaanmu pada [cp] sudah baik. Jangan takut pada angka, teruslah berlatih ya!', C: '[nama], kamu sudah cukup menguasai [cp]. Matematika itu seru, ayo kita pecahkan lebih banyak teka-teki angka bersama!' }),
                    createSubject('Ilmu Pengetahuan Alam dan Sosial (IPAS)', defaultIpasCps, { A: '[nama], rasa ingin tahumu tentang [cp] sangat tinggi. Kamu adalah ilmuwan cilik yang hebat!', B: '[nama], pemahamanmu tentang [cp] sudah baik. Teruslah menjelajahi keajaiban alam dan sosial di sekitarmu!', C: '[nama], kamu sudah cukup memahami [cp]. Ayo lebih banyak bertanya dan melakukan pengamatan, pasti seru!' }),
                    createSubject('Seni Budaya (Prakarya)', defaultPrakaryaCps, defaultArtSportDesc),
                    createSubject('Seni Budaya (Seni Musik)', defaultSeniMusikCps, defaultArtSportDesc),
                    createSubject('Seni Budaya (Seni Rupa)', defaultSeniRupaCps, defaultArtSportDesc),
                    createSubject('Seni Budaya (Seni Tari)', defaultSeniTariCps, defaultArtSportDesc),
                    createSubject('Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)', defaultPjokCps, defaultArtSportDesc),
                    createSubject('Bahasa Inggris', defaultBahasaInggrisCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Bahasa Daerah)', defaultBahasaDaerahCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Kearifan Lokal)', defaultKearifanLokalCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Kerajinan Daerah)', defaultKerajinanDaerahCps, defaultArtSportDesc),
                    createSubject('Muatan Lokal (Seni Daerah)', defaultSeniDaerahCps, defaultArtSportDesc)
                ]
            };
        },

        loadState() {
            const savedState = localStorage.getItem(this.STORAGE_KEY);
            if (savedState) {
                try {
                    this.state = JSON.parse(savedState);
                } catch (error) {
                    console.error("Could not parse state from localStorage, it might be corrupted.", error);
                    localStorage.removeItem(this.STORAGE_KEY);
                    this.state = {}; 
                }
                
                const defaultSettings = this.getDefaultSettings();
                this.state.settings = { ...defaultSettings, ...this.state.settings };
                
                this.state.extracurricularGrades = this.state.extracurricularGrades || {};
                this.state.attendance = this.state.attendance || {};
                this.state.p5Grades = this.state.p5Grades || {};
                this.state.teacherNotes = this.state.teacherNotes || {};
                this.state.settings.extracurriculars = this.state.settings.extracurriculars || defaultSettings.extracurriculars;
                this.state.settings.p5Projects = this.state.settings.p5Projects || defaultSettings.p5Projects;
                 if (this.state.settings.p5Projects.length > 0 && this.state.settings.p5Projects[0].dimensions[0].targets) {
                    this.state.settings.p5Projects = defaultSettings.p5Projects;
                 }


                delete this.state.characterGrades;
                delete this.state.settings.characters;
                delete this.state.p5Notes;

                if (this.state.settings.subjects && this.state.settings.subjects.length > 0) {
                    this.state.settings.subjects = this.state.settings.subjects.map(subject => {
                        const newSubject = { ...subject };
                        if (typeof newSubject.capaian === 'string') {
                            newSubject.capaian = newSubject.capaian ? [newSubject.capaian] : [];
                        }
                        if (typeof newSubject.deskripsi === 'string') {
                            const oldDeskripsi = newSubject.deskripsi;
                            newSubject.deskripsi = { A: oldDeskripsi, B: oldDeskripsi, C: oldDeskripsi };
                        } else if (!newSubject.deskripsi) {
                            newSubject.deskripsi = { A: '', B: '', C: '' };
                        }
                        return newSubject;
                    });
                }
                
                if (!this.state.settings.gradeRanges) this.state.settings.gradeRanges = defaultSettings.gradeRanges;
                if (this.state.settings.gradeRanges.C) {
                    this.state.settings.passingGrade = this.state.settings.gradeRanges.C;
                }

                if (this.state.settings.deletedSubjects && Array.isArray(this.state.settings.deletedSubjects)) {
                    this.state.settings.deletedSubjects.forEach(deletedSub => {
                        const existingSubject = this.state.settings.subjects.find(s => s.name === deletedSub.name);
                        if (!existingSubject) {
                             this.state.settings.subjects.push({ ...deletedSub, isDeleted: true });
                        }
                    });
                }
                delete this.state.settings.deletedSubjects;

                if (this.state.settings.subjects) {
                    this.state.settings.subjects.forEach(subject => {
                        if (subject.isDeleted === undefined) {
                            subject.isDeleted = false;
                        }
                    });
                }

                const emptyStudent = this.getEmptyStudent();
                this.state.students = (this.state.students || []).map(student => ({ ...emptyStudent, ...student }));
                
                if (this.state.grades) {
                    Object.keys(this.state.grades).forEach(studentId => {
                        const studentGrades = this.state.grades[studentId];
                        Object.keys(studentGrades).forEach(subject => {
                            let currentGrade = studentGrades[subject];
                            
                            if (typeof currentGrade === 'number' || currentGrade === null) {
                                currentGrade = currentGrade !== null ? [currentGrade] : [];
                            }
                            
                            if (Array.isArray(currentGrade)) {
                                studentGrades[subject] = {
                                    cp: currentGrade,
                                    pts: null,
                                    pas: null
                                };
                            }
                        });
                    });
                }


            } else {
                 this.state = {
                    settings: this.getDefaultSettings(),
                    students: [
                        { ...this.getEmptyStudent(), id: 's1', name: 'Budi Hartono', nis: '12345', nisn: '001', panggilan: 'Budi', agama: 'Islam' },
                        { ...this.getEmptyStudent(), id: 's2', name: 'Siti Aminah', nis: '12346', nisn: '002', panggilan: 'Siti', agama: 'Islam' }
                    ],
                    grades: { 
                        's1': { 
                            'Matematika': { cp: [85], pts: null, pas: null }, 
                            'Bahasa Indonesia': { cp: [92], pts: null, pas: null } 
                        }, 
                        's2': { 
                            'Matematika': { cp: [88], pts: null, pas: null }, 
                            'Bahasa Indonesia': { cp: [68], pts: null, pas: null } 
                        } 
                    },
                    extracurricularGrades: {},
                    attendance: {},
                    p5Grades: {},
                    teacherNotes: {},
                };
            }
        },

        saveState() {
            localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.state));
            if (isLoggedIn) {
                this.syncWithGoogleSheets(false); 
            }
        },
        
        async findOrCreateSpreadsheet() {
            if (this.spreadsheetId) return this.spreadsheetId;

            const fileName = 'Rapor Kelas Terpadu Data';
            try {
                const response = await gapi.client.drive.files.list({
                    q: `name='${fileName}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`,
                    fields: 'files(id, name)',
                });

                if (response.result.files && response.result.files.length > 0) {
                    this.spreadsheetId = response.result.files[0].id;
                    const spreadsheet = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: this.spreadsheetId,
                        fields: 'sheets.properties.title'
                    });
                    const existingSheets = spreadsheet.result.sheets.map(s => s.properties.title);
                    const requiredSheets = Object.values(this.SHEET_NAMES);
                    const missingSheets = requiredSheets.filter(name => !existingSheets.includes(name));

                    if (missingSheets.length > 0) {
                        this.updateSyncStatus('syncing', 'Menyiapkan sheet...');
                        const requests = missingSheets.map(title => ({ addSheet: { properties: { title } } }));
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: this.spreadsheetId,
                            resource: { requests }
                        });
                    }

                    const oldSheet = spreadsheet.result.sheets.find(s => s.properties.title === 'P5Notes');
                    if (oldSheet) {
                        await gapi.client.sheets.spreadsheets.batchUpdate({
                            spreadsheetId: this.spreadsheetId,
                            resource: { requests: [{ deleteSheet: { sheetId: oldSheet.properties.sheetId } }] }
                        });
                    }
                    return this.spreadsheetId;
                } else {
                    this.updateSyncStatus('syncing', 'Membuat file baru...');
                    const sheets = Object.values(this.SHEET_NAMES).map(title => ({ properties: { title } }));
                    const spreadsheet = await gapi.client.sheets.spreadsheets.create({
                        properties: { title: fileName },
                        sheets: sheets
                    });
                    this.spreadsheetId = spreadsheet.result.spreadsheetId;
                    return this.spreadsheetId;
                }
            } catch (err) {
                console.error("Error finding or creating spreadsheet", err);
                this.updateSyncStatus('error', 'Gagal akses Drive');
                return null;
            }
        },
        
        async syncWithGoogleSheets(fetchOnly = false) {
            if (!isLoggedIn) return;

            this.updateSyncStatus('syncing', fetchOnly ? 'Mengambil data...' : 'Menyimpan...');
            const spreadsheetId = await this.findOrCreateSpreadsheet();
            if (!spreadsheetId) return;

            try {
                if (fetchOnly) {
                    const ranges = Object.values(this.SHEET_NAMES).map(name => `${name}!A:Z`);
                    const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                        spreadsheetId: spreadsheetId,
                        ranges: ranges,
                    });
                    
                    const valueRanges = response.result.valueRanges;
                    const getSheetData = (sheetName) => {
                        const sheetIndex = Object.keys(this.SHEET_NAMES).indexOf(Object.keys(this.SHEET_NAMES).find(key => this.SHEET_NAMES[key] === sheetName));
                        return valueRanges[sheetIndex]?.values || [];
                    };

                    const settingsData = getSheetData(this.SHEET_NAMES.SETTINGS);
                    const studentsData = getSheetData(this.SHEET_NAMES.STUDENTS);
                    
                    if (studentsData.length === 0 && settingsData.length === 0) {
                        this.updateSyncStatus('syncing', 'Data cloud kosong, menyimpan...');
                        await this.syncWithGoogleSheets(false);
                        return;
                    }

                    const newState = {};
                    const reconstructedSettings = {};
                    if (settingsData.length > 1) { 
                        settingsData.slice(1).forEach(row => {
                            if (!row || row.length < 2 || !row[0]) return;
                            const key = row[0];
                            let value = row[1];
                            
                             try {
                                const parsedValue = JSON.parse(value);
                                reconstructedSettings[key] = parsedValue;
                            } catch (e) {
                                if (key.startsWith('gradeRanges.')) {
                                    const subKey = key.split('.')[1];
                                    if (!reconstructedSettings.gradeRanges) reconstructedSettings.gradeRanges = {};
                                    const numVal = parseInt(value, 10);
                                    reconstructedSettings.gradeRanges[subKey] = isNaN(numVal) ? 0 : numVal;
                                } else {
                                    const numVal = parseFloat(value);
                                    const isStringifiedNum = String(value).trim() !== '' && String(numVal) === String(value).trim();
                                    reconstructedSettings[key] = isStringifiedNum ? numVal : value;
                                }
                            }
                        });
                        newState.settings = reconstructedSettings;
                    } else if (settingsData.length === 1 && settingsData[0].length === 1) { 
                         try { newState.settings = JSON.parse(settingsData[0][0]); } 
                         catch(e) { console.warn("Failed to parse old settings format"); }
                    }


                    if (studentsData.length > 1) {
                        const headers = studentsData[0];
                        newState.students = studentsData.slice(1).map(row => {
                            const student = {};
                            headers.forEach((header, index) => { student[header] = row[index] !== undefined ? row[index] : ''; });
                            return student;
                        });
                    } else { newState.students = []; }
                    
                    const gradesData = getSheetData(this.SHEET_NAMES.GRADES);
                    const gradesMap = {};
                    if (gradesData.length > 1) {
                        gradesData.slice(1).forEach(row => {
                            const [studentId, subjectName, gradesJson] = row;
                            if (studentId && subjectName && gradesJson) {
                                if (!gradesMap[studentId]) gradesMap[studentId] = {};
                                try { gradesMap[studentId][subjectName] = JSON.parse(gradesJson); } catch (e) { console.warn(`Gagal parse nilai untuk ${studentId} - ${subjectName}`); }
                            }
                        });
                    }
                    newState.grades = gradesMap;

                    const extrasData = getSheetData(this.SHEET_NAMES.EXTRAS);
                    const extrasMap = {};
                    if (extrasData.length > 1) {
                        extrasData.slice(1).forEach(row => {
                            const [studentId, extrasJson] = row;
                            if (studentId && extrasJson) {
                                try { extrasMap[studentId] = JSON.parse(extrasJson); } catch(e) { console.warn(`Gagal parse ekstrakurikuler untuk ${studentId}`); }
                            }
                        });
                    }
                    newState.extracurricularGrades = extrasMap;
                    
                    const attendanceData = getSheetData(this.SHEET_NAMES.ATTENDANCE);
                    const attendanceMap = {};
                    if (attendanceData.length > 1) {
                        attendanceData.slice(1).forEach(row => {
                            const [studentId, s, i, a] = row;
                            if (studentId) attendanceMap[studentId] = { s: parseInt(s, 10) || 0, i: parseInt(i, 10) || 0, a: parseInt(a, 10) || 0 };
                        });
                    }
                    newState.attendance = attendanceMap;
                    
                    const p5Data = getSheetData(this.SHEET_NAMES.P5_GRADES);
                    const p5Map = {};
                    if(p5Data.length > 1) {
                        p5Data.slice(1).forEach(row => {
                            const [studentId, gradesJson] = row;
                            if(studentId && gradesJson) {
                                try { p5Map[studentId] = JSON.parse(gradesJson); }
                                catch(e) { console.warn(`Gagal parse P5 grade untuk ${studentId}`); }
                            }
                        });
                    }
                    newState.p5Grades = p5Map;
                    
                    const notesData = getSheetData(this.SHEET_NAMES.NOTES);
                    const notesMap = {};
                    if(notesData.length > 1) notesData.slice(1).forEach(row => notesMap[row[0]] = row[1] || '');
                    newState.teacherNotes = notesMap;

                    this.state = newState;
                    this.loadState();
                    this.navigateTo(window.location.hash || '#dashboard');
                    alert('Data berhasil dimuat dari Google Sheets!');
                    this.updateSyncStatus('synced', 'Sinkronisasi berhasil');

                } else {
                    const data = [];
                    const settingsValues = [];
                    const settings = this.state.settings;
                    Object.keys(settings).forEach(key => {
                        const value = settings[key];
                        if (typeof value === 'object' && value !== null) {
                            settingsValues.push([key, JSON.stringify(value, null, 2)]);
                        } else {
                            settingsValues.push([key, value]);
                        }
                    });
                    data.push({ range: `${this.SHEET_NAMES.SETTINGS}!A1`, values: [['key', 'value'], ...settingsValues] });


                    if (this.state.students.length > 0) {
                        const studentHeaders = Object.keys(this.getEmptyStudent());
                        const studentValues = this.state.students.map(s => studentHeaders.map(h => s[h]));
                        data.push({ range: this.SHEET_NAMES.STUDENTS, values: [studentHeaders, ...studentValues] });
                    }

                    const gradesRows = [];
                    for (const studentId in this.state.grades) {
                        for (const subjectName in this.state.grades[studentId]) {
                            gradesRows.push([studentId, subjectName, JSON.stringify(this.state.grades[studentId][subjectName])]);
                        }
                    }
                    if (gradesRows.length > 0) data.push({ range: this.SHEET_NAMES.GRADES, values: [['studentId', 'subjectName', 'gradesJson'], ...gradesRows] });

                    const extrasRows = Object.entries(this.state.extracurricularGrades).map(([studentId, arr]) => [studentId, JSON.stringify(arr)]);
                    if (extrasRows.length > 0) data.push({ range: this.SHEET_NAMES.EXTRAS, values: [['studentId', 'extrasJson'], ...extrasRows] });
                    
                    const attendanceRows = Object.entries(this.state.attendance).map(([studentId, att]) => [studentId, att.s, att.i, att.a]);
                    if (attendanceRows.length > 0) data.push({ range: this.SHEET_NAMES.ATTENDANCE, values: [['studentId', 'sakit', 'izin', 'alfa'], ...attendanceRows] });

                    const p5Rows = Object.entries(this.state.p5Grades).map(([studentId, grades]) => [studentId, JSON.stringify(grades)]);
                     if (p5Rows.length > 0) data.push({ range: this.SHEET_NAMES.P5_GRADES, values: [['studentId', 'gradesJson'], ...p5Rows] });

                    const notesRows = Object.entries(this.state.teacherNotes).map(([studentId, note]) => [studentId, note]);
                    if (notesRows.length > 0) data.push({ range: this.SHEET_NAMES.NOTES, values: [['studentId', 'note'], ...notesRows] });
                    
                    await gapi.client.sheets.spreadsheets.values.batchClear({
                        spreadsheetId: spreadsheetId,
                        resource: { ranges: Object.values(this.SHEET_NAMES) }
                    });

                    if (data.length > 0) {
                        await gapi.client.sheets.spreadsheets.values.batchUpdate({
                            spreadsheetId: spreadsheetId,
                            resource: { valueInputOption: 'USER_ENTERED', data: data }
                        });
                    }
                    this.updateSyncStatus('synced', 'Tersimpan di Google');
                }
            } catch (err) {
                console.error("Execute error", err);
                alert('Terjadi kesalahan saat sinkronisasi: ' + (err.result?.error?.message || err.message));
                this.updateSyncStatus('error', 'Gagal sinkronisasi');
            }
        },

        updateSyncStatus(status, text) {
            const sidebarIndicator = document.getElementById('sync-status-indicator');
            const sidebarStatusText = document.getElementById('sync-status-text');
            sidebarIndicator.className = 'sync-status-indicator'; 
            if (status === 'synced') sidebarIndicator.classList.add('synced');
            else if (status === 'syncing') sidebarIndicator.classList.add('syncing');
            else if (status === 'error') sidebarIndicator.classList.add('error');
            sidebarStatusText.textContent = text;
            
            const dashboardStatusContainer = document.getElementById('dashboard-sync-status');
            if (dashboardStatusContainer) {
                let indicatorClass = 'bg-gray-400';
                let textColorClass = 'text-gray-600';
                let statusMessage = 'Sinkronisasi Google tidak aktif.';
                let bgColorClass = 'bg-gray-200';

                if(isLoggedIn) {
                    switch(status) {
                        case 'synced':
                            indicatorClass = 'bg-green-500';
                            textColorClass = 'text-green-800';
                            bgColorClass = 'bg-green-100';
                            statusMessage = 'Sinkronisasi otomatis aktif dan data telah tersimpan.';
                            break;
                        case 'syncing':
                            indicatorClass = 'bg-amber-500 animate-pulse';
                            textColorClass = 'text-amber-800';
                            bgColorClass = 'bg-amber-100';
                            statusMessage = 'Menyimpan perubahan...';
                            break;
                        case 'error':
                            indicatorClass = 'bg-red-500';
                            textColorClass = 'text-red-800';
                            bgColorClass = 'bg-red-100';
                            statusMessage = 'Gagal sinkronisasi. Periksa koneksi Anda.';
                            break;
                        default: 
                             indicatorClass = 'bg-gray-400';
                             textColorClass = 'text-gray-600';
                             bgColorClass = 'bg-gray-200';
                             statusMessage = 'Terputus. Sinkronisasi otomatis nonaktif.';
                    }
                }
                
                dashboardStatusContainer.className = `flex items-center text-sm px-3 py-1 rounded-full ${bgColorClass} ${textColorClass}`;
                dashboardStatusContainer.innerHTML = `
                    <span class="w-2 h-2 rounded-full mr-2 ${indicatorClass}"></span>
                    <span class="font-medium">${statusMessage}</span>
                `;
            }
        },

        getFinalScore(scoreData) {
            if (!scoreData || (typeof scoreData !== 'object')) {
                return null;
            }
            const cpScores = scoreData.cp || [];
            const ptsScore = scoreData.pts;
            const pasScore = scoreData.pas;
        
            const allScores = [...cpScores, ptsScore, pasScore];
            
            const numericScores = allScores
                .map(s => (s === null || s === '') ? NaN : Number(s))
                .filter(s => !isNaN(s));
        
            if (numericScores.length === 0) {
                return null;
            }
            const sum = numericScores.reduce((a, b) => a + b, 0);
            return Math.round(sum / numericScores.length);
        },
        
        getPredicate(score) {
            if (score == null) return '-';
            score = parseInt(score, 10);
            const { gradeRanges } = this.state.settings;
            if (score >= gradeRanges.A) return 'A'; 
            if (score >= gradeRanges.B) return 'B'; 
            if (score >= gradeRanges.C) return 'C';
            return 'D';
        },

        getSubjectAbbreviation(columnName) {
            const map = {
                'Pendidikan Agama dan Budi Pekerti': 'PABP',
                'Pendidikan Pancasila': 'PP',
                'Bahasa Indonesia': 'B.Indo',
                'Matematika': 'MTK',
                'Ilmu Pengetahuan Alam dan Sosial (IPAS)': 'IPAS',
                'Seni Budaya': 'SB',
                'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)': 'PJOK',
                'Bahasa Inggris': 'B.Ing',
            };
            
            if (columnName.startsWith('Muatan Lokal')) {
                 const match = columnName.match(/\(([^)]+)\)/);
                 if (match) {
                     return match[1].split(' ').map(word => word[0]).join('').toUpperCase();
                 }
                 return 'Mulok';
            }

            for (const key in map) {
                if (columnName.startsWith(key)) {
                    return map[key];
                }
            }

            return columnName;
        },

        init() {
            this.loadState();
            this.setupEventListeners();
            this.navigateTo(window.location.hash || '#dashboard');
        },
        
        openModal() {
            document.getElementById('app-modal').classList.remove('hidden');
        },

        closeModal() {
            const modal = document.getElementById('app-modal');
            modal.classList.add('hidden');
            modal.querySelector('#modal-content-wrapper').innerHTML = ''; // Clear content
        },

        setupEventListeners() {
            window.addEventListener('hashchange', () => this.navigateTo(window.location.hash));
            document.querySelectorAll('.sidebar-item').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.navigateTo(e.currentTarget.getAttribute('href'));
                });
            });

            document.getElementById('authorize_button').onclick = handleAuthClick;
            document.getElementById('signout_button').onclick = handleSignoutClick;
            document.getElementById('google-sync-save-btn').onclick = () => this.saveState();

            document.getElementById('save-settings-btn').addEventListener('click', this.handleSaveSettings.bind(this));
            document.getElementById('cancel-settings-btn').addEventListener('click', this.renderSettings.bind(this));
            document.getElementById('add-subject-form').addEventListener('submit', this.handleAddSubject.bind(this));
            document.getElementById('setting-schoolLogo').addEventListener('change', this.handleLogoUpload.bind(this));
            document.getElementById('setting-className').addEventListener('input', this.handleClassNameChange.bind(this));
            const academicConfigSection = document.getElementById('academic-config-section');
            academicConfigSection.addEventListener('click', this.handleAcademicConfigActions.bind(this));
            academicConfigSection.addEventListener('change', e => {
                if (e.target.id === 'subject-select-dropdown') {
                    this.handleSubjectSelect(e);
                }
            });
            academicConfigSection.addEventListener('input', e => {
                if (e.target.matches('.subject-card textarea')) {
                    this.handleSubjectDataUpdate(e.target);
                }
            });
            
            document.getElementById('add-extracurricular-form').addEventListener('submit', this.handleAddExtracurricular.bind(this));
            document.getElementById('extracurricular-config-list').addEventListener('click', this.handleDeleteExtracurricular.bind(this));
            
            const p5ConfigSection = document.getElementById('p5-config-section');
            if (p5ConfigSection) {
                p5ConfigSection.addEventListener('click', this.handleP5ManagementActions.bind(this));
                p5ConfigSection.addEventListener('input', this.handleP5ManagementInput.bind(this));
            }

            document.getElementById('add-student-btn').addEventListener('click', () => this.showStudentModal());
            document.getElementById('download-template-btn').addEventListener('click', this.handleDownloadTemplate.bind(this));
            document.getElementById('upload-students-input').addEventListener('change', this.handleUploadStudents.bind(this));
            document.getElementById('students-table-body').addEventListener('click', this.handleStudentActions.bind(this));
            
            document.querySelector('#view-grades').addEventListener('click', (e) => {
                if(e.target.matches('.grades-tab-btn')) {
                    this.handleGradesTabClick(e);
                }
            });
            document.getElementById('edit-grades-btn').addEventListener('click', this.showEditStudentGradesModal.bind(this));
            document.getElementById('download-grades-btn').addEventListener('click', this.handleDownloadGrades.bind(this));
            document.getElementById('upload-grades-input').addEventListener('change', this.handleUploadGrades.bind(this));
        
            document.getElementById('generate-all-reports-btn').addEventListener('click', this.renderAllReportCards.bind(this));
            document.getElementById('print-all-reports-btn').addEventListener('click', () => window.print());

            document.getElementById('app-modal').addEventListener('click', (e) => {
                if (e.target.id === 'app-modal' || e.target.classList.contains('modal-close-btn')) {
                    this.closeModal();
                }
            });
        },

        navigateTo(hash) {
            const safeHash = hash || '#dashboard';
            if(window.location.hash !== safeHash) window.location.hash = safeHash;
            
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));

            const viewId = 'view-' + safeHash.substring(1);
            const activeView = document.getElementById(viewId);
            const activeLink = document.querySelector(`.sidebar-item[href="${safeHash}"]`);

            if (activeView) activeView.classList.add('active');
            if (activeLink) activeLink.classList.add('active');

            const renderMap = {
                '#dashboard': this.renderDashboard,
                '#settings': this.renderSettings,
                '#students': this.renderStudents,
                '#grades': this.renderGrades,
                '#extracurricular': this.renderExtracurricular,
                '#p5': this.renderP5,
                '#attendance': this.renderAttendance,
                '#notes': this.renderTeacherNotes,
                '#print': this.renderPrintView
            };

            const renderFunction = renderMap[safeHash];
            if (renderFunction) {
                renderFunction.call(this);
            }
        },

        handleP5ManagementInput(e) {
            const { target } = e;
            if(!target.dataset.field) return; 

            const { field, projectId } = target.dataset;

            const project = this.state.settings.p5Projects.find(p => p.id === projectId);
            if (!project) return;

            switch(field) {
                case 'name':
                    project.name = target.value;
                    const summary = target.closest('details').querySelector('summary > span');
                    if (summary) summary.textContent = target.value || 'Proyek Baru';
                    break;
                case 'description':
                    project.description = target.value;
                    break;
            }
            this.saveState();
        },

        handleP5ManagementActions(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const { action, projectId, dimensionId, subelementId } = button.dataset;
            let project;
            
            if (projectId) project = this.state.settings.p5Projects.find(p => p.id === projectId);

            const reRenderEditor = () => {
                this.renderP5ProjectEditor();
                this.saveState();
            };

            switch(action) {
                case 'add-project':
                    this.state.settings.p5Projects.push({
                        id: 'proj-' + Date.now(),
                        name: 'Proyek Baru', description: '', dimensions: []
                    });
                    reRenderEditor();
                    break;
                case 'delete-project':
                    if (confirm(`Yakin ingin menghapus proyek "${project.name}"? Semua data penilaian terkait akan hilang.`)) {
                        this.state.settings.p5Projects = this.state.settings.p5Projects.filter(p => p.id !== projectId);
                        Object.keys(this.state.p5Grades).forEach(studentId => {
                            if (this.state.p5Grades[studentId] && this.state.p5Grades[studentId][projectId]) {
                                delete this.state.p5Grades[studentId][projectId];
                            }
                        });
                        reRenderEditor();
                    }
                    break;
                case 'add-dimension':
                    this.showP5DimensionSelectorModal(projectId);
                    break;
                case 'delete-dimension':
                     if (confirm(`Hapus dimensi ini dari proyek?`)) {
                        project.dimensions = project.dimensions.filter(d => d.dimensionId !== dimensionId);
                        reRenderEditor();
                    }
                    break;
                case 'add-subelement':
                    this.showP5SubElementSelectorModal(projectId, dimensionId);
                    break;
                case 'delete-subelement':
                    const dim = project.dimensions.find(d => d.dimensionId === dimensionId);
                    if(dim) {
                        dim.subElementIds = dim.subElementIds.filter(id => id !== subelementId);
                    }
                    reRenderEditor();
                    break;
            }
        },

        showP5DimensionSelectorModal(projectId) {
            const project = this.state.settings.p5Projects.find(p => p.id === projectId);
            if (!project) return;

            const existingDimIds = project.dimensions.map(d => d.dimensionId);
            const availableDimensions = this.p5ProfileData.dimensions.filter(d => !existingDimIds.includes(d.id));

            if (availableDimensions.length === 0) {
                alert('Semua dimensi sudah ditambahkan ke proyek ini.');
                return;
            }

            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-lg';
            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-xl font-semibold mb-4">Pilih Dimensi Profil Pelajar Pancasila</h3>
                    <div class="space-y-2">
                        ${availableDimensions.map(dim => `
                            <div class="flex items-center">
                                <input type="radio" id="dim-radio-${dim.id}" name="p5-dimension" value="${dim.id}" class="h-4 w-4 text-blue-600 border-gray-300">
                                <label for="dim-radio-${dim.id}" class="ml-3 block text-sm font-medium text-gray-700">${dim.name}</label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button id="confirm-add-dimension" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Tambah Dimensi</button>
                    </div>
                </div>
            `;
            this.openModal();

            document.getElementById('confirm-add-dimension').onclick = () => {
                const selectedRadio = document.querySelector('input[name="p5-dimension"]:checked');
                if (selectedRadio) {
                    const dimensionId = selectedRadio.value;
                    project.dimensions.push({
                        dimensionId: dimensionId,
                        subElementIds: []
                    });
                    this.saveState();
                    this.renderP5ProjectEditor();
                    this.closeModal();
                    this.showP5SubElementSelectorModal(projectId, dimensionId);
                } else {
                    alert('Silakan pilih salah satu dimensi.');
                }
            };
        },

        showP5SubElementSelectorModal(projectId, dimensionId) {
            const project = this.state.settings.p5Projects.find(p => p.id === projectId);
            const dimensionData = this.p5ProfileData.dimensions.find(d => d.id === dimensionId);
            if (!project || !dimensionData) return;
            
            const projectDimension = project.dimensions.find(d => d.dimensionId === dimensionId);
            const existingSubElementIds = projectDimension ? projectDimension.subElementIds : [];

            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';
            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-xl font-semibold mb-2">Pilih Target Capaian untuk Dimensi:</h3>
                    <p class="font-bold text-blue-800 mb-4">${dimensionData.name}</p>
                    <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                        ${dimensionData.elements.map(element => `
                            <div>
                                <h4 class="font-semibold bg-gray-100 p-2 rounded-t-md border-b">${element.name}</h4>
                                <div class="space-y-2 p-3 border border-t-0 rounded-b-md">
                                    ${element.subElements.map(sub => `
                                        <div class="flex items-start">
                                            <input type="checkbox" id="sub-check-${sub.id}" name="p5-subelement" value="${sub.id}" class="mt-1 h-4 w-4 text-blue-600 border-gray-300 rounded" ${existingSubElementIds.includes(sub.id) ? 'checked' : ''}>
                                            <label for="sub-check-${sub.id}" class="ml-3 block text-sm text-gray-700">
                                                <span class="font-medium">${sub.name}</span>
                                                <p class="text-xs text-gray-500 italic mt-1"><strong>Target Fase B:</strong> ${sub.faseB}</p>
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button id="confirm-add-subelements" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan Pilihan</button>
                    </div>
                </div>
            `;

            this.openModal();

            document.getElementById('confirm-add-subelements').onclick = () => {
                const selectedCheckboxes = document.querySelectorAll('input[name="p5-subelement"]:checked');
                const selectedSubElementIds = Array.from(selectedCheckboxes).map(cb => cb.value);

                let projDim = project.dimensions.find(d => d.dimensionId === dimensionId);
                if (projDim) {
                    projDim.subElementIds = selectedSubElementIds;
                } else {
                    project.dimensions.push({ dimensionId, subElementIds: selectedSubElementIds });
                }
                
                this.saveState();
                this.renderP5ProjectEditor();
                this.closeModal();
            };
        },

        renderDashboard() {
            const { settings, students, grades } = this.state;
            document.getElementById('dashboard-teacher-name').textContent = settings.teacherName || 'Guru';
            document.getElementById('dashboard-class-name').textContent = settings.className || '-';
            document.getElementById('dashboard-student-count').textContent = students.length;
            document.getElementById('dashboard-school-year').textContent = settings.schoolYear || '-';
            document.getElementById('dashboard-semester').textContent = settings.semester || '-';

            this.updateSyncStatus(
                isLoggedIn ? (this.spreadsheetId ? 'synced' : 'syncing') : 'disconnected', 
                isLoggedIn ? 'Terhubung ke Google' : 'Sinkronisasi Google'
            );

            const analysisContainer = document.getElementById('dashboard-analysis-content');
            analysisContainer.innerHTML = ''; 

            if (!settings.className.trim()) {
                analysisContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Silakan tentukan nama kelas di menu <a href="#settings" class="text-blue-600 hover:underline" onclick="App.navigateTo('#settings')">Pengaturan</a>.</p>`;
                return;
            }
            if (students.length === 0) {
                analysisContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa. Silakan tambahkan siswa di menu <a href="#students" class="text-blue-600 hover:underline" onclick="App.navigateTo('#students')">Data Siswa</a>.</p>`;
                return;
            }

            const passingGrade = settings.gradeRanges.C || 70;
            const lowScorers = students.map(student => {
                const studentGrades = grades[student.id] || {};
                const lowScores = Object.entries(studentGrades)
                    .map(([subject, scoreObject]) => ({ subject, score: this.getFinalScore(scoreObject) }))
                    .filter(({score}) => score !== null && score < passingGrade);
                return { name: student.name, nisn: student.nisn, scores: lowScores };
            }).filter(s => s.scores.length > 0);

            if (lowScorers.length > 0) {
                analysisContainer.innerHTML = `<h4 class="font-semibold text-red-600 mb-3">Siswa dengan Nilai di Bawah KKM (${passingGrade})</h4><ul class="space-y-3">${lowScorers.map(student => `<li class="p-3 bg-red-50 border border-red-200 rounded-md"><p class="font-bold">${student.name} (NISN: ${student.nisn || '-'})</p><ul class="list-disc list-inside text-sm mt-1">${student.scores.map(s => `<li>${s.subject}: <span class="font-semibold">${s.score}</span></li>`).join('')}</ul></li>`).join('')}</ul>`;
            } else {
                const subjectStats = {};
                settings.subjects.filter(s => !s.isDeleted).forEach(subject => {
                    const finalScores = students.map(s => this.getFinalScore((grades[s.id] || {})[subject.name])).filter(score => score != null);
                    if (finalScores.length > 0) {
                        subjectStats[subject.name] = { avg: (finalScores.reduce((a, b) => a + b, 0) / finalScores.length).toFixed(1), min: Math.min(...finalScores), max: Math.max(...finalScores), count: finalScores.length };
                    } else { subjectStats[subject.name] = null; }
                });
                analysisContainer.innerHTML = `<h4 class="font-semibold text-green-700 mb-3">Semua siswa telah mencapai nilai KKM. Bagus!</h4><p class="mb-4 text-gray-600">Berikut adalah statistik nilai per mata pelajaran:</p><table class="w-full text-left text-sm"><thead class="bg-gray-100"><tr><th class="p-2">Mata Pelajaran</th><th class="p-2 text-center">Rata-rata</th><th class="p-2 text-center">Tertinggi</th><th class="p-2 text-center">Terendah</th><th class="p-2 text-center">Siswa Terisi</th></tr></thead><tbody>${Object.entries(subjectStats).map(([subject, stats]) => stats ? `<tr class="border-b"><td class="p-2 font-medium">${subject}</td><td class="p-2 text-center">${stats.avg}</td><td class="p-2 text-center">${stats.max}</td><td class="p-2 text-center">${stats.min}</td><td class="p-2 text-center">${stats.count} / ${students.length}</td></tr>` : `<tr class="border-b"><td class="p-2 font-medium">${subject}</td><td class="p-2 text-center text-gray-400" colspan="4">Belum ada nilai</td></tr>`).join('')}</tbody></table>`;
            }
        },

        renderSettings() {
            const { settings } = this.state;
            document.getElementById('setting-schoolName').value = settings.schoolName;
            document.getElementById('setting-npsn').value = settings.npsn;
            document.getElementById('setting-schoolAddress').value = settings.schoolAddress;
            document.getElementById('setting-village').value = settings.village;
            document.getElementById('setting-district').value = settings.district;
            document.getElementById('setting-province').value = settings.province;
            document.getElementById('setting-postalCode').value = settings.postalCode;
            document.getElementById('setting-schoolEmail').value = settings.schoolEmail;
            document.getElementById('setting-schoolPhone').value = settings.schoolPhone;
            document.getElementById('setting-website').value = settings.website;
            document.getElementById('setting-fax').value = settings.fax;
            document.getElementById('setting-className').value = settings.className;
            document.getElementById('setting-schoolYear').value = settings.schoolYear;
            document.getElementById('setting-semester').value = settings.semester;
            document.getElementById('setting-reportDate').value = settings.reportDate;
            document.getElementById('setting-headmasterName').value = settings.headmasterName;
            document.getElementById('setting-headmasterNip').value = settings.headmasterNip;
            document.getElementById('setting-teacherName').value = settings.teacherName;
            document.getElementById('setting-teacherNip').value = settings.teacherNip;
            document.getElementById('setting-grade-A').value = settings.gradeRanges.A;
            document.getElementById('setting-grade-B').value = settings.gradeRanges.B;
            document.getElementById('setting-grade-C').value = settings.gradeRanges.C;

            const logoPreview = document.getElementById('logo-preview');
            const logoPlaceholder = document.getElementById('logo-placeholder');
            if (settings.schoolLogo) {
                logoPreview.src = settings.schoolLogo;
                logoPreview.classList.remove('hidden');
                logoPlaceholder.classList.add('hidden');
            } else {
                logoPreview.classList.add('hidden');
                logoPlaceholder.classList.remove('hidden');
            }
            
            this.handleClassNameChange({ target: { value: settings.className } });
            this.renderSubjectEditor();
            this.renderExtracurricularConfig();
            this.renderP5ProjectEditor();
        },
        
        renderP5ProjectEditor() {
            const container = document.getElementById('p5-editor-container');
            if (!container) return;

            const projects = this.state.settings.p5Projects || [];
            
            if (projects.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-10">Belum ada proyek. Klik "Tambah Proyek Baru" untuk memulai.</p>';
                return;
            }
            
            const findSubElement = (subElementId) => {
                for (const dim of this.p5ProfileData.dimensions) {
                    for (const el of dim.elements) {
                        const sub = el.subElements.find(s => s.id === subElementId);
                        if (sub) return { ...sub, dimension: dim, element: el };
                    }
                }
                return null;
            };

            container.innerHTML = projects.map(project => `
                <details class="bg-white rounded-lg shadow-sm border" open>
                    <summary class="flex justify-between items-center p-4 cursor-pointer font-semibold text-lg">
                        <span>${project.name || 'Proyek Baru'}</span>
                        <div class="flex items-center gap-2">
                            <button data-action="delete-project" data-project-id="${project.id}" class="text-red-500 hover:text-red-700 text-sm font-medium">Hapus Proyek</button>
                        </div>
                    </summary>
                    <div class="p-4 border-t rounded-b-lg">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nama Proyek</label>
                                <input type="text" data-field="name" data-project-id="${project.id}" value="${project.name}" class="form-input w-full rounded-md border-gray-300" placeholder="e.g., Gaya Hidup Berkelanjutan">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi Proyek</label>
                                <textarea data-field="description" data-project-id="${project.id}" class="form-textarea w-full rounded-md border-gray-300" rows="3" placeholder="Jelaskan tujuan dan aktivitas proyek secara singkat...">${project.description}</textarea>
                            </div>
                            
                            <div class="border-t pt-4">
                                <div class="flex justify-between items-center mb-2">
                                   <h4 class="font-semibold">Dimensi & Target</h4>
                                   <button data-action="add-dimension" data-project-id="${project.id}" class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-md hover:bg-blue-200">+ Tambah Dimensi</button>
                                </div>
                                <div class="space-y-3">
                                ${project.dimensions.map(dimData => {
                                    const dimension = this.p5ProfileData.dimensions.find(d => d.id === dimData.dimensionId);
                                    if (!dimension) return '';
                                    return `
                                    <div class="bg-gray-50 p-3 rounded-md border">
                                        <div class="flex justify-between items-center gap-2 mb-2">
                                            <h5 class="font-bold text-blue-800">${dimension.name}</h5>
                                            <button data-action="delete-dimension" data-project-id="${project.id}" data-dimension-id="${dimension.id}" class="text-red-500 hover:text-red-700 p-1 rounded-full"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                        </div>
                                        ${dimData.subElementIds.map(subId => {
                                            const subElementData = findSubElement(subId);
                                            if (!subElementData) return '';
                                            return `
                                            <div class="pl-4 border-l-2 ml-2 mb-2 pb-2">
                                                <div class="flex justify-between items-start gap-2 mb-1">
                                                    <div>
                                                        <p class="text-sm font-semibold">${subElementData.element.name}</p>
                                                        <p class="text-xs text-gray-600">${subElementData.name}</p>
                                                    </div>
                                                    <button data-action="delete-subelement" data-project-id="${project.id}" data-dimension-id="${dimension.id}" data-subelement-id="${subId}" class="text-red-500 hover:text-red-700 p-1 rounded-full flex-shrink-0"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                                                </div>
                                                <div class="pl-4 mt-1">
                                                    <p class="text-xs italic bg-blue-50 border-l-2 border-blue-300 p-2 rounded-r-md"><strong>Target (Fase B):</strong> ${subElementData.faseB}</p>
                                                </div>
                                            </div>
                                            `
                                        }).join('')}
                                        <button data-action="add-subelement" data-project-id="${project.id}" data-dimension-id="${dimension.id}" class="text-blue-600 text-xs font-bold ml-2 mt-2 hover:text-blue-800">+ Tambah Sub Elemen / Target</button>
                                    </div>
                                `}).join('') || '<p class="text-sm text-center text-gray-500 py-4">Belum ada dimensi.</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                </details>
            `).join('');
        },

        renderExtracurricularConfig() {
            const container = document.getElementById('extracurricular-config-list');
            container.innerHTML = this.state.settings.extracurriculars.map(extra => `
                <div class="flex justify-between items-center p-2 bg-gray-100 rounded-md">
                    <span>${extra.name}</span>
                    <button type="button" data-id="${extra.id}" class="text-red-500 hover:text-red-700">Hapus</button>
                </div>
            `).join('');
        },
        
        renderSubjectEditor() {
            const container = document.getElementById('subjects-list');
            const subjects = this.state.settings.subjects.filter(s => !s.isDeleted).sort((a, b) => a.name.localeCompare(b.name));
            
            container.innerHTML = `
                <label for="subject-select-dropdown" class="block text-sm font-medium text-gray-700 mb-2">Pilih mata pelajaran untuk di-edit:</label>
                <select id="subject-select-dropdown" class="form-select w-full rounded-md border-gray-300 bg-gray-50 focus:border-blue-500 focus:ring-blue-500">
                    <option value="">-- Pilih Mata Pelajaran --</option>
                    ${subjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                </select>
                <div id="subject-details-container" class="mt-4 min-h-[100px]"></div>
            `;
            
            const dropdown = document.getElementById('subject-select-dropdown');
            if (this.selectedSubjectName && subjects.some(s => s.name === this.selectedSubjectName)) {
                dropdown.value = this.selectedSubjectName;
            } else {
                this.selectedSubjectName = dropdown.value;
            }
            this.renderSubjectDetails(this.selectedSubjectName);

            const deletedContainer = document.getElementById('deleted-subjects-container');
            const deletedListEl = document.getElementById('deleted-subjects-list');
            const deletedSubjects = this.state.settings.subjects.filter(s => s.isDeleted).sort((a, b) => a.name.localeCompare(b.name));
            
            deletedListEl.innerHTML = '';
            if (deletedSubjects.length > 0) {
                deletedContainer.classList.remove('hidden');
                deletedSubjects.forEach(subject => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.dataset.action = 'restore-subject';
                    button.dataset.subjectName = subject.name;
                    button.className = 'bg-gray-200 text-gray-700 px-3 py-1.5 rounded-md text-sm hover:bg-gray-300 flex items-center gap-2 transition-colors';
                    button.innerHTML = `<span>${subject.name}</span><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>`;
                    deletedListEl.appendChild(button);
                });
            } else {
                deletedContainer.classList.add('hidden');
            }
        },
        
        renderSubjectDetails(subjectName) {
            const container = document.getElementById('subject-details-container');
            if (!container) return;

            if (!subjectName) {
                container.innerHTML = '<p class="text-center text-gray-500 p-8 bg-gray-50 rounded-md border">Pilih mata pelajaran dari daftar di atas untuk melihat dan mengedit detailnya.</p>';
                return;
            }
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) {
                container.innerHTML = '<p class="text-center text-red-500 p-8">Mata pelajaran tidak ditemukan.</p>';
                return;
            }

            const studentForPreview = this.state.students.length > 0 ? this.state.students[0] : null;
            const studentNickname = studentForPreview ? (studentForPreview.panggilan || studentForPreview.name.split(' ')[0]) : 'Siswa';
            
            const capaianHTML = subject.capaian.map((cp, cpIndex) => `
                <div class="flex items-center gap-2">
                    <textarea data-field="capaian" data-cp-index="${cpIndex}" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="1" placeholder="Tulis capaian pembelajaran...">${cp}</textarea>
                    <button type="button" data-action="delete-cp" data-cp-index="${cpIndex}" class="text-red-500 hover:text-red-700 p-1 rounded-full bg-red-100 hover:bg-red-200">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            `).join('');

            const capaianText = subject.capaian.join(', ');
            const previewA = subject.deskripsi.A.replace(/\[nama\]/gi, studentNickname).replace(/\[cp\]/gi, capaianText);
            const previewB = subject.deskripsi.B.replace(/\[nama\]/gi, studentNickname).replace(/\[cp\]/gi, capaianText);
            const previewC = subject.deskripsi.C.replace(/\[nama\]/gi, studentNickname).replace(/\[cp\]/gi, capaianText);
            
            container.innerHTML = `
                <div class="subject-card p-4 bg-gray-50 border rounded-md" data-subject-name="${subject.name}">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-3">
                             <button type="button" data-action="add-cp" class="text-xs font-medium text-blue-600 bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded-md">+ Capaian</button>
                        </div>
                        <button type="button" data-action="delete-subject" data-subject-name="${subject.name}" class="text-red-500 hover:text-red-700 text-sm font-medium">Hapus Mapel</button>
                    </div>

                    <div class="space-y-3 pl-2 border-l-2 border-gray-200 ml-1">
                        <div>
                            <label class="text-sm font-semibold text-gray-600 mb-2 block">Daftar Capaian Pembelajaran (CP)</label>
                            <div class="space-y-2">
                                ${capaianHTML || `<p class="text-xs text-gray-500">Belum ada CP. Klik "+ Capaian" untuk menambahkan.</p>`}
                            </div>
                        </div>

                        <div>
                            <div class="space-y-3 mt-4">
                                <div>
                                    <label class="text-sm font-medium text-green-700">Deskripsi Predikat A (Sangat Baik)</label>
                                    <textarea data-field="deskripsi-A" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="2" placeholder="Tulis deskripsi...">${previewA}</textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-blue-700">Deskripsi Predikat B (Baik)</label>
                                    <textarea data-field="deskripsi-B" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="2" placeholder="Tulis deskripsi...">${previewB}</textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-yellow-700">Deskripsi Predikat C (Cukup)</label>
                                    <textarea data-field="deskripsi-C" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-white" rows="2" placeholder="Tulis deskripsi...">${previewC}</textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
        },

        renderStudents() {
            const tableBody = document.getElementById('students-table-body');
            tableBody.innerHTML = '';
            if (this.state.students.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Tidak ada data siswa. Tambahkan siswa secara manual atau unggah file Excel.</td></tr>`;
                return;
            }
            this.state.students.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-3 text-center">${index + 1}</td>
                    <td class="p-3">${student.name}</td>
                    <td class="p-3">${student.panggilan || '-'}</td>
                    <td class="p-3">${student.nis || '-'}</td>
                    <td class="p-3">${student.nisn || '-'}</td>
                    <td class="p-3 text-center space-x-1">
                        <button data-action="edit-student" data-id="${student.id}" class="text-blue-600 hover:underline px-2 py-1 font-bold">Edit</button>
                        <button data-action="edit-grades" data-id="${student.id}" class="text-purple-600 hover:underline px-2 py-1 font-bold">Nilai</button>
                        <button data-action="print-report" data-id="${student.id}" class="text-green-600 hover:underline px-2 py-1 font-bold">Print</button>
                        <button data-action="delete-student" data-id="${student.id}" class="text-red-600 hover:underline px-2 py-1 font-bold">Hapus</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        },

        renderGrades() {
            document.querySelector('.grades-tab-btn[data-tab="list"]').classList.add('active');
            document.querySelector('.grades-tab-btn[data-tab="input"]').classList.remove('active');
            document.getElementById('grades-content-list').classList.remove('hidden');
            document.getElementById('grades-content-input').classList.add('hidden');
            this.renderOverallGradesTable();
        },
        
        renderOverallGradesTable(sortBy = 'absen') {
            const container = document.getElementById('grades-content-list');
            if (this.state.students.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }
        
            const { students, grades, settings } = this.state;
        
            const subjectColumns = [
                'Pendidikan Agama dan Budi Pekerti', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 
                'Ilmu Pengetahuan Alam dan Sosial (IPAS)', 'Seni Budaya', 
                'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)', 'Bahasa Inggris', 'Muatan Lokal'
            ];
        
            let studentData = students.map((student, index) => {
                const studentGrades = grades[student.id] || {};
                const finalScores = Object.values(studentGrades)
                                        .map(scoreObject => this.getFinalScore(scoreObject))
                                        .filter(score => score !== null);
                const total = finalScores.reduce((sum, score) => sum + score, 0);
                const average = finalScores.length > 0 ? (total / finalScores.length) : 0;
                return { student, index, total, average };
            });
        
            studentData.sort((a, b) => b.total - a.total);
            let rank = 1;
            for (let i = 0; i < studentData.length; i++) {
                if (i > 0 && studentData[i].total < studentData[i-1].total) {
                    rank = i + 1;
                }
                studentData[i].rank = rank;
            }
        
            if (sortBy === 'absen') {
                studentData.sort((a, b) => a.index - b.index);
            }
        
            const getGradeForColumn = (student, header) => {
                const studentGrades = grades[student.id] || {};
                let prefix = '';
                if (header.startsWith('Pendidikan Agama')) prefix = 'Pendidikan Agama';
                else if (header.startsWith('Seni Budaya')) prefix = 'Seni Budaya';
                else if (header.startsWith('Muatan Lokal')) prefix = 'Muatan Lokal';
                else { 
                    return this.getFinalScore(studentGrades[header]) ?? '-';
                }
        
                for (const subjectName in studentGrades) {
                    if (subjectName.startsWith(prefix)) {
                         if (prefix === 'Pendidikan Agama') {
                            const religionInSubject = subjectName.match(/\(([^)]+)\)/)?.[1];
                            if (student.agama && religionInSubject && student.agama.toLowerCase() === religionInSubject.toLowerCase()) {
                                return this.getFinalScore(studentGrades[subjectName]) ?? '-';
                            }
                        } else {
                            const finalScore = this.getFinalScore(studentGrades[subjectName]);
                            if (finalScore !== null) return finalScore;
                        }
                    }
                }
                return '-';
            };
        
            const headerHtml = subjectColumns.map(col => `<th class="p-2 border whitespace-nowrap subject-col">${this.getSubjectAbbreviation(col)}</th>`).join('');
            
            const bodyHtml = studentData.map(data => {
                return `
                <tr class="border-b">
                    <td class="p-2 border text-center">${data.index + 1}</td>
                    <td class="p-2 border whitespace-nowrap overflow-hidden text-ellipsis" title="${data.student.name}">${data.student.name}</td>
                    ${subjectColumns.map(col => `<td class="p-2 border text-center">${getGradeForColumn(data.student, col)}</td>`).join('')}
                    <td class="p-2 border text-center font-semibold">${data.total}</td>
                    <td class="p-2 border text-center font-semibold">${Math.round(data.average)}</td>
                    <td class="p-2 border text-center font-bold">${data.rank}</td>
                </tr>
            `}).join('');
        
            container.innerHTML = `
                <div class="flex items-center gap-4 mb-4">
                    <span class="font-medium">Urutkan berdasarkan:</span>
                    <button class="px-3 py-1 rounded-md ${sortBy === 'absen' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" onclick="App.renderOverallGradesTable('absen')">No. Absen</button>
                    <button class="px-3 py-1 rounded-md ${sortBy === 'rank' ? 'bg-blue-600 text-white' : 'bg-gray-200'}" onclick="App.renderOverallGradesTable('rank')">Peringkat</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse overall-grades-table" style="table-layout: fixed;">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 border" style="width: 40px;">No</th>
                                <th class="p-2 border" style="width: 200px;">Nama Siswa</th>
                                ${headerHtml}
                                <th class="p-2 border" style="width: 70px;">Jumlah</th>
                                <th class="p-2 border" style="width: 70px;">Rata-rata</th>
                                <th class="p-2 border" style="width: 70px;">Peringkat</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>`;
        },
        
        renderGradeInput() {
            const container = document.getElementById('grades-content-input');
        
            const getSubjectSortOrder = (subjectName) => {
                const order = ['Pendidikan Agama', 'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam dan Sosial', 'Seni Budaya', 'Pendidikan Jasmani', 'Bahasa Inggris', 'Muatan Lokal'];
                const index = order.findIndex(prefix => subjectName.startsWith(prefix));
                return index === -1 ? order.length : index;
            };
        
            const sortedSubjects = [...this.state.settings.subjects]
                .filter(s => !s.isDeleted)
                .sort((a, b) => {
                    const orderA = getSubjectSortOrder(a.name);
                    const orderB = getSubjectSortOrder(b.name);
                    return orderA !== orderB ? orderA - orderB : a.name.localeCompare(b.name);
                });
        
            container.innerHTML = `
                <form id="grade-input-form">
                    <div class="flex items-center mb-4">
                        <div class="flex-grow">
                            <label for="grade-subject-select" class="block font-medium mb-1">Pilih Mata Pelajaran:</label>
                            <select id="grade-subject-select" class="form-select w-full md:w-2/3 rounded-md border-gray-300 bg-gray-50">
                                <option value="">-- Pilih Mapel --</option>
                                ${sortedSubjects.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="grade-input-save-button-container" class="ml-4 pt-6">
                            <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700 disabled:bg-gray-400" disabled>Simpan Nilai</button>
                        </div>
                    </div>
                    <div id="grade-input-table-container"></div>
                </form>
            `;
            
            const selectEl = document.getElementById('grade-subject-select');
            selectEl.addEventListener('change', (e) => {
                this.selectedGradeInputSubject = e.target.value;
                const saveBtn = container.querySelector('button[type="submit"]');
                if (this.selectedGradeInputSubject) {
                    saveBtn.disabled = false;
                } else {
                    saveBtn.disabled = true;
                }
                this.renderGradeInputTable(this.selectedGradeInputSubject);
            });
            
            document.getElementById('grade-input-form').addEventListener('submit', (e) => {
                e.preventDefault();
                if (this.selectedGradeInputSubject) {
                    this.handleSaveGradesForSubject(this.selectedGradeInputSubject);
                }
            });
        },
        
        renderGradeInputTable(subjectName) {
            const container = document.getElementById('grade-input-table-container');
            if (!subjectName) {
                container.innerHTML = `<p class="text-center text-gray-500 py-8 border-t mt-4">Pilih mata pelajaran untuk mulai memasukkan nilai.</p>`;
                return;
            }
        
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) {
                container.innerHTML = `<p class="text-center text-red-500 py-4">Error: Mata pelajaran tidak ditemukan.</p>`;
                return;
            }
            
            let studentsForSubject = [...this.state.students];
            const religionMatch = subjectName.match(/Pendidikan Agama dan Budi Pekerti \(([^)]+)\)/);
        
            if (religionMatch && religionMatch[1]) {
                const religion = religionMatch[1].toLowerCase();
                studentsForSubject = studentsForSubject.filter(s => s.agama && s.agama.toLowerCase() === religion);
            }
        
            if (studentsForSubject.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4 border-t mt-4">Tidak ada siswa yang sesuai untuk mata pelajaran ini.</p>`;
                return;
            }

            const capaian = subject.capaian || [];
            if (capaian.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500 py-4 border-t mt-4">Mata pelajaran ini belum memiliki Capaian Pembelajaran (CP). Silakan tambahkan CP di menu <a href="#settings" class="text-blue-600 hover:underline">Pengaturan</a>.</p>`;
                return;
            }

            const headerCols = capaian.map((cp, index) => 
                `<th class="p-2 text-center font-bold" title="${cp}">CP ${index + 1}</th>`
            ).join('');
        
            const tableRows = studentsForSubject.map((student, index) => {
                const gradeData = this.state.grades[student.id]?.[subjectName] || { cp: [], pts: null, pas: null };
                const cpScores = gradeData.cp || [];
                const ptsScore = gradeData.pts ?? '';
                const pasScore = gradeData.pas ?? '';
                const finalScore = this.getFinalScore(gradeData);

                const inputClass = "form-input w-full text-center rounded-md border-gray-300 bg-gray-100 hover:bg-gray-200 focus:bg-white focus:ring-1 focus:ring-blue-500 transition-colors";

                const inputCols = capaian.map((_, cpIndex) => `
                    <td class="p-1">
                        <input type="number" data-studentid="${student.id}" data-cp-index="${cpIndex}" value="${cpScores[cpIndex] ?? ''}" class="${inputClass}" placeholder="-" min="0" max="100" oninput="App.updateGradeAverage('${student.id}')">
                    </td>
                `).join('');

                const ptsInput = `
                    <td class="p-1">
                        <input type="number" data-studentid="${student.id}" data-score-type="pts" value="${ptsScore}" class="${inputClass}" placeholder="-" min="0" max="100" oninput="App.updateGradeAverage('${student.id}')">
                    </td>`;
                
                const pasInput = `
                    <td class="p-1">
                        <input type="number" data-studentid="${student.id}" data-score-type="pas" value="${pasScore}" class="${inputClass}" placeholder="-" min="0" max="100" oninput="App.updateGradeAverage('${student.id}')">
                    </td>`;

                return `
                    <tr class="border-b">
                        <td class="p-2 text-center">${index + 1}</td>
                        <td class="p-2 whitespace-nowrap overflow-hidden text-ellipsis" title="${student.name}">${student.name}</td>
                        ${inputCols}
                        ${ptsInput}
                        ${pasInput}
                        <td class="p-2 text-center font-semibold" data-average-for="${student.id}">${finalScore ?? '-'}</td>
                    </tr>
                `;
            }).join('');
        
            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 mt-4 pt-4 border-t">Input Nilai: ${subjectName}</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-center" style="width: 50px;">No</th>
                                <th class="p-2 text-left" style="width: 250px;">Nama Siswa</th>
                                ${headerCols}
                                <th class="p-2 text-center font-bold" style="width: 80px;">PTS</th>
                                <th class="p-2 text-center font-bold" style="width: 80px;">PAS</th>
                                <th class="p-2 text-center font-bold" style="width: 90px;">Rata-rata</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                </div>
            `;
        },
        
        renderExtracurricular() {
            const view = document.getElementById('view-extracurricular');
            const { students, settings, extracurricularGrades } = this.state;

            if (students.length === 0) {
                view.innerHTML = `<h2 class="text-3xl font-bold mb-6">Manajemen Data Ekstrakurikuler</h2><p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }

            const availableExtras = settings.extracurriculars || [];
            const extraOptions = `<option value="">-- Kosong --</option>` + availableExtras.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            const MAX_EXTRAS = 5;

            const tableRows = students.map((student, index) => {
                const studentExtras = extracurricularGrades[student.id] || [];
                let extraCells = '';
                for (let i = 0; i < MAX_EXTRAS; i++) {
                    const extraData = studentExtras[i];
                    extraCells += `
                        <td class="p-2 border-b">
                            <div class="space-y-1">
                                <select data-student-id="${student.id}" data-extra-index="${i}" data-field="id" class="form-select bg-gray-50 w-full text-xs rounded-md border-gray-300 p-1">
                                    ${extraOptions.replace(`value="${extraData?.id}"`, `value="${extraData?.id}" selected`)}
                                </select>
                                <input type="text" data-student-id="${student.id}" data-extra-index="${i}" data-field="grade" value="${extraData?.grade || ''}" class="form-input bg-gray-50 w-full text-xs rounded-md border-gray-300 p-1" placeholder="Predikat">
                                <input type="text" data-student-id="${student.id}" data-extra-index="${i}" data-field="description" value="${extraData?.description || ''}" class="form-input bg-gray-50 w-full text-xs rounded-md border-gray-300 p-1" placeholder="Deskripsi">
                            </div>
                        </td>
                    `;
                }

                return `
                    <tr>
                        <td class="p-2 border-b text-center align-top">${index + 1}</td>
                        <td class="p-2 border-b font-medium align-top whitespace-nowrap">${student.name}</td>
                        ${extraCells}
                    </tr>
                `;
            }).join('');

            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Ekstrakurikuler</h2>
                    <div class="flex gap-2">
                        <button id="download-extracurriculars-btn" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">Unduh Data</button>
                        <label for="upload-extracurriculars-input" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer">Unggah Data</label>
                        <input type="file" id="upload-extracurriculars-input" class="hidden" accept=".xlsx, .xls">
                        <button id="save-extracurriculars-btn" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Semua Perubahan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 w-12">No</th>
                                <th class="p-2 text-left" style="min-width: 150px;">Nama Siswa</th>
                                ${Array.from({ length: MAX_EXTRAS }, (_, i) => `<th class="p-2 text-center" style="min-width: 150px;">Ekstra ${i + 1}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="extracurricular-table-body">${tableRows}</tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('save-extracurriculars-btn').addEventListener('click', this.handleSaveAllExtracurriculars.bind(this));
            document.getElementById('download-extracurriculars-btn').addEventListener('click', this.handleDownloadExtracurriculars.bind(this));
            document.getElementById('upload-extracurriculars-input').addEventListener('change', this.handleUploadExtracurriculars.bind(this));
        },
        
        renderGenericNotesView(viewId, title, stateKey) {
            const view = document.getElementById(viewId);
            const { students } = this.state;
            const notesData = this.state[stateKey] || {};

            if (students.length === 0) {
                view.innerHTML = `<h2 class="text-3xl font-bold mb-6">${title}</h2><p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }

            const bodyHtml = students.map((student, index) => `
                <tr class="border-b">
                    <td class="p-2 text-center align-top">${index + 1}</td>
                    <td class="p-2 font-medium align-top">${student.name}</td>
                    <td class="p-2">
                        <textarea data-student-id="${student.id}" class="form-textarea w-full rounded-md border-gray-300 text-sm bg-gray-50" rows="3">${notesData[student.id] || ''}</textarea>
                    </td>
                </tr>
            `).join('');
            
            const isTeacherNotesView = stateKey === 'teacherNotes';
            const extraButtonHtml = isTeacherNotesView 
                ? `<button id="generate-preset-notes-btn" class="bg-sky-600 text-white px-5 py-2 rounded-md hover:bg-sky-700">Buat Catatan Preset</button>` 
                : '';

            view.innerHTML = `
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">${title}</h2>
                    <div class="flex gap-2">
                        ${extraButtonHtml}
                        <button data-action="save" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Perubahan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 w-12">No</th>
                                <th class="p-2 text-left w-64">Nama Siswa</th>
                                <th class="p-2 text-left">Catatan</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>
            `;
            
            view.querySelector('button[data-action="save"]').addEventListener('click', () => {
                const textareas = view.querySelectorAll('textarea[data-student-id]');
                textareas.forEach(ta => {
                    const studentId = ta.dataset.studentId;
                    this.state[stateKey][studentId] = ta.value.trim();
                });
                this.saveState();
                alert('Data berhasil disimpan!');
            });
            
            if (isTeacherNotesView) {
                document.getElementById('generate-preset-notes-btn').addEventListener('click', this.handleGeneratePresetNotes.bind(this));
            }
        },
        
        renderP5() {
            const projects = this.state.settings.p5Projects || [];
            const tabsContainer = document.getElementById('p5-project-tabs-container');

            if (projects.length === 0) {
                tabsContainer.innerHTML = '';
                document.getElementById('p5-project-content-container').innerHTML = `
                    <p class="text-center text-gray-500 py-8">Belum ada proyek P5 yang dibuat. Silakan kelola proyek di menu Pengaturan.</p>`;
                return;
            }

            const activeProjectId = this.state.activeP5Project || projects[0].id;

            tabsContainer.innerHTML = projects.map(p => `
                <button data-project-id="${p.id}" class="p5-project-tab py-2 px-4 border-b-2 font-semibold transition-colors duration-300 ${p.id === activeProjectId ? 'active' : ''}">
                    ${p.name}
                </button>
            `).join('');
            
            tabsContainer.querySelectorAll('.p5-project-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    this.state.activeP5Project = e.currentTarget.dataset.projectId;
                    this.renderP5();
                });
            });

            this.renderP5ProjectDetails(activeProjectId);
        },

        renderP5ProjectDetails(projectId) {
            const container = document.getElementById('p5-project-content-container');
            const project = this.state.settings.p5Projects.find(p => p.id === projectId);

            if (!project) {
                container.innerHTML = `<p class="text-center text-red-500 py-8">Proyek tidak ditemukan.</p>`;
                return;
            }
            
            const findSubElement = (subElementId) => {
                for (const dim of this.p5ProfileData.dimensions) {
                    for (const el of dim.elements) {
                        const sub = el.subElements.find(s => s.id === subElementId);
                        if (sub) return { ...sub, dimension: dim, element: el };
                    }
                }
                return null;
            };
            
            const dimensionsWithTargets = project.dimensions.filter(d => d.subElementIds && d.subElementIds.length > 0);
            
            if (dimensionsWithTargets.length === 0) {
                 container.innerHTML = `
                    <div class="border-b pb-4 mb-4">
                        <h3 class="text-xl font-bold text-blue-800">${project.name}</h3>
                        <p class="text-sm text-gray-600 mt-1">${project.description}</p>
                    </div>
                    <p class="text-center text-gray-500 py-8">Proyek ini belum memiliki target capaian. Silakan tambahkan dimensi dan target di menu Pengaturan.</p>`;
                return;
            }

            const allSubElements = [];
            dimensionsWithTargets.forEach(dimData => {
                 dimData.subElementIds.forEach(subId => {
                    const subData = findSubElement(subId);
                    if (subData) allSubElements.push(subData);
                });
            });

            const headerHTML = dimensionsWithTargets.map(dimData => {
                const dimension = this.p5ProfileData.dimensions.find(d => d.id === dimData.dimensionId);
                return `<th colspan="${dimData.subElementIds.length}" class="p-2 border border-gray-300 text-center bg-gray-100">${dimension.name}</th>`;
            }).join('');
            
            const subHeaderHTML = dimensionsWithTargets.flatMap(dimData => 
                dimData.subElementIds.map(subId => {
                    const subData = findSubElement(subId);
                    if (!subData) return '';
                    return `<th class="p-2 border border-gray-300 text-center text-xs font-normal align-bottom" title="${subData.faseB}">${subData.name}</th>`
                })
            ).join('');

            const p5Levels = {
                'BB': 'Belum Berkembang',
                'MB': 'Mulai Berkembang',
                'BSH': 'Berkembang Sesuai Harapan',
                'SB': 'Sangat Berkembang'
            };
            const levelOptions = `<option value="">-</option>` + Object.entries(p5Levels).map(([key, value]) => `<option value="${key}">${value}</option>`).join('');

            const studentRowsHTML = this.state.students.map((student, index) => {
                const studentGrades = this.state.p5Grades[student.id]?.[projectId] || {};
                const gradeCells = allSubElements.map(subEl => {
                    const grade = studentGrades[subEl.id] || '';
                    return `<td class="p-1 border border-gray-300"><select data-student-id="${student.id}" data-subelement-id="${subEl.id}" class="form-select w-full text-xs p-1 rounded-md border-gray-300 bg-gray-50">${levelOptions.replace(`value="${grade}"`, `value="${grade}" selected`)}</select></td>`;
                }).join('');
                return `<tr><td class="p-2 border border-gray-300 text-center">${index+1}</td><td class="p-2 border border-gray-300">${student.name}</td>${gradeCells}</tr>`;
            }).join('');

            container.innerHTML = `
                <div class="border-b pb-4 mb-4">
                    <h3 class="text-xl font-bold text-blue-800">${project.name}</h3>
                    <p class="text-sm text-gray-600 mt-1">${project.description}</p>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th rowspan="2" class="p-2 border border-gray-300 bg-gray-100" style="width: 40px;">No</th>
                                <th rowspan="2" class="p-2 border border-gray-300 bg-gray-100" style="min-width: 200px;">Nama Siswa</th>
                                ${headerHTML}
                            </tr>
                            <tr>
                                ${subHeaderHTML}
                            </tr>
                        </thead>
                        <tbody>
                            ${studentRowsHTML}
                        </tbody>
                    </table>
                </div>
                <div class="flex justify-end mt-6">
                    <button id="save-p5-grades-btn" data-project-id="${projectId}" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Penilaian Proyek Ini</button>
                </div>
            `;
            
            document.getElementById('save-p5-grades-btn').addEventListener('click', this.handleSaveP5Grades.bind(this));
        },
        
        renderTeacherNotes() {
            this.renderGenericNotesView('view-notes', 'Manajemen Catatan Wali Kelas', 'teacherNotes');
        },

        renderAttendance() {
            const view = document.getElementById('view-attendance');
            const { students, attendance } = this.state;

            if (students.length === 0) {
                view.innerHTML = `<h2 class="text-3xl font-bold mb-6">Manajemen Data Absensi</h2><p class="text-center text-gray-500 py-4">Belum ada data siswa.</p>`;
                return;
            }
            
            const bodyHtml = students.map((student, index) => {
                const studentAttendance = attendance[student.id] || { s: 0, i: 0, a: 0 };
                return `<tr class="border-b">
                    <td class="p-2 text-center">${index + 1}</td>
                    <td class="p-2 font-medium">${student.name}</td>
                    <td class="p-2"><input type="number" min="0" data-student-id="${student.id}" data-type="s" class="form-input w-20 text-center rounded-md bg-gray-50" value="${studentAttendance.s}"></td>
                    <td class="p-2"><input type="number" min="0" data-student-id="${student.id}" data-type="i" class="form-input w-20 text-center rounded-md bg-gray-50" value="${studentAttendance.i}"></td>
                    <td class="p-2"><input type="number" min="0" data-student-id="${student.id}" data-type="a" class="form-input w-20 text-center rounded-md bg-gray-50" value="${studentAttendance.a}"></td>
                </tr>`;
            }).join('');

            view.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Manajemen Data Absensi</h2>
                    <div class="flex gap-2">
                        <button id="download-attendance-btn" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">Unduh Data</button>
                        <label for="upload-attendance-input" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 cursor-pointer">Unggah Data</label>
                        <input type="file" id="upload-attendance-input" class="hidden" accept=".xlsx, .xls">
                        <button id="save-attendance-btn" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Perubahan</button>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 w-12">No</th>
                                <th class="p-2 text-left">Nama Siswa</th>
                                <th class="p-2 w-24 text-center">Sakit (S)</th>
                                <th class="p-2 w-24 text-center">Izin (I)</th>
                                <th class="p-2 w-24 text-center">Alfa (A)</th>
                            </tr>
                        </thead>
                        <tbody>${bodyHtml}</tbody>
                    </table>
                </div>`;
                
            document.getElementById('save-attendance-btn').addEventListener('click', this.handleSaveAttendance.bind(this));
            document.getElementById('download-attendance-btn').addEventListener('click', this.handleDownloadAttendance.bind(this));
            document.getElementById('upload-attendance-input').addEventListener('change', this.handleUploadAttendance.bind(this));
        },
        
        renderPrintView() {
            document.getElementById('print-output-area').innerHTML = '<div class="text-center text-gray-500">Klik "Hasilkan Pratinjau Rapor" untuk melihat rapor di sini.</div>';
            document.getElementById('print-all-reports-btn').classList.add('hidden');
        },
        
        renderAllReportCards() {
            const outputArea = document.getElementById('print-output-area');
            outputArea.innerHTML = '';
            if (this.state.students.length === 0) {
                 outputArea.innerHTML = '<div class="text-center text-red-500">Tidak ada data siswa untuk membuat rapor.</div>';
                 return;
            }
            this.state.students.forEach(student => {
                outputArea.innerHTML += this.createReportCardHTML(student, this.state.grades[student.id] || {});
            });
            document.getElementById('print-all-reports-btn').classList.remove('hidden');
        },

        handleSaveSettings() {
            const settings = this.state.settings;
            settings.schoolName = document.getElementById('setting-schoolName').value;
            settings.npsn = document.getElementById('setting-npsn').value;
            settings.schoolAddress = document.getElementById('setting-schoolAddress').value;
            settings.village = document.getElementById('setting-village').value;
            settings.district = document.getElementById('setting-district').value;
            settings.province = document.getElementById('setting-province').value;
            settings.postalCode = document.getElementById('setting-postalCode').value;
            settings.schoolEmail = document.getElementById('setting-schoolEmail').value;
            settings.schoolPhone = document.getElementById('setting-schoolPhone').value;
            settings.website = document.getElementById('setting-website').value;
            settings.fax = document.getElementById('setting-fax').value;
            settings.className = document.getElementById('setting-className').value;
            settings.schoolYear = document.getElementById('setting-schoolYear').value;
            settings.semester = document.getElementById('setting-semester').value;
            settings.reportDate = document.getElementById('setting-reportDate').value;
            settings.headmasterName = document.getElementById('setting-headmasterName').value;
            settings.headmasterNip = document.getElementById('setting-headmasterNip').value;
            settings.teacherName = document.getElementById('setting-teacherName').value;
            settings.teacherNip = document.getElementById('setting-teacherNip').value;
            
            settings.gradeRanges.A = parseInt(document.getElementById('setting-grade-A').value, 10) || 90;
            settings.gradeRanges.B = parseInt(document.getElementById('setting-grade-B').value, 10) || 80;
            settings.gradeRanges.C = parseInt(document.getElementById('setting-grade-C').value, 10) || 70;
            settings.passingGrade = settings.gradeRanges.C;
            
            this.saveState();
            alert('Pengaturan berhasil disimpan!');
            this.renderDashboard();
        },

        handleAddExtracurricular(e) {
            e.preventDefault();
            const input = document.getElementById('extracurricular-name-input');
            const name = input.value.trim();
            if (name && !this.state.settings.extracurriculars.some(ex => ex.name === name)) {
                this.state.settings.extracurriculars.push({ id: 'e' + Date.now(), name });
                this.saveState();
                this.renderExtracurricularConfig();
                input.value = '';
            }
        },

        handleDeleteExtracurricular(e) {
            if (e.target.tagName === 'BUTTON') {
                const extraId = e.target.dataset.id;
                this.state.settings.extracurriculars = this.state.settings.extracurriculars.filter(ex => ex.id !== extraId);
                Object.keys(this.state.extracurricularGrades).forEach(studentId => {
                    this.state.extracurricularGrades[studentId] = this.state.extracurricularGrades[studentId].filter(ex => ex.id !== extraId);
                });
                this.saveState();
                this.renderExtracurricularConfig();
            }
        },

        handleSaveAllExtracurriculars() {
            const newGrades = {};
            const MAX_EXTRAS = 5;

            this.state.students.forEach(student => {
                const studentExtras = [];
                for (let i = 0; i < MAX_EXTRAS; i++) {
                    const id = document.querySelector(`select[data-student-id="${student.id}"][data-extra-index="${i}"]`).value;
                    if (id) {
                        const description = document.querySelector(`input[data-student-id="${student.id}"][data-extra-index="${i}"][data-field="description"]`).value;
                        const grade = document.querySelector(`input[data-student-id="${student.id}"][data-extra-index="${i}"][data-field="grade"]`).value;
                        studentExtras.push({ id, description, grade });
                    }
                }
                newGrades[student.id] = studentExtras;
            });
            
            this.state.extracurricularGrades = newGrades;
            this.saveState();
            alert('Data ekstrakurikuler berhasil disimpan!');
        },

        handleDownloadExtracurriculars() {
            const { students, settings, extracurricularGrades } = this.state;
            const MAX_EXTRAS = 5;

            const metadata = [
                ['Nama Kelas', settings.className],
                ['Tahun Ajaran / Semester', `${settings.schoolYear} / ${settings.semester}`],
                ['Daftar Ekstrakurikuler Tersedia', settings.extracurriculars.map(e => e.name).join(', ')],
                [] 
            ];

            const headers = ['No. Absen', 'NISN', 'Nama Siswa'];
            for (let i = 0; i < MAX_EXTRAS; i++) {
                headers.push(`Ekstra ${i + 1} - Nama`);
                headers.push(`Ekstra ${i + 1} - Predikat`);
                headers.push(`Ekstra ${i + 1} - Deskripsi`);
            }

            const studentRows = students.map((student, index) => {
                const row = [
                    index + 1,
                    student.nisn || '',
                    student.name
                ];

                const studentExtras = extracurricularGrades[student.id] || [];

                for (let i = 0; i < MAX_EXTRAS; i++) {
                    const extraData = studentExtras[i];
                    let extraName = '';
                    if (extraData && extraData.id) {
                        const extraSetting = settings.extracurriculars.find(e => e.id === extraData.id);
                        if (extraSetting) {
                            extraName = extraSetting.name;
                        }
                    }
                    row.push(extraName);
                    row.push(extraData?.grade || '');
                    row.push(extraData?.description || '');
                }

                return row;
            });
            
            const finalSheetData = [...metadata, headers, ...studentRows];

            const ws = XLSX.utils.aoa_to_sheet(finalSheetData);
            
            ws['!cols'] = headers.map((header, i) => {
                const defaultWidth = String(header).length;
                const maxLength = Math.max(
                    defaultWidth,
                    ...finalSheetData.map(row => (row[i] ? String(row[i]).length : 0))
                );
                return { wch: Math.min(maxLength + 2, 60) };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Ekstrakurikuler");
            XLSX.writeFile(wb, "data_ekstrakurikuler.xlsx");
        },

        handleUploadExtracurriculars(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws);

                    const previewData = { validChanges: [], errors: [], warnings: [] };
                    const appStudentsByNisn = new Map(this.state.students.map(s => [String(s.nisn || '').trim(), s]));
                    const extraSettingsByName = new Map(this.state.settings.extracurriculars.map(ex => [ex.name, ex.id]));
                    const MAX_EXTRAS = 5;

                    jsonData.forEach((row, rowIndex) => {
                        const nisn = String(row['NISN'] || '').trim();
                        if (!nisn) {
                            previewData.warnings.push({ message: `Baris ${rowIndex + 2}: Ditemukan data tanpa NISN. Baris ini diabaikan.`});
                            return;
                        }
                        
                        const student = appStudentsByNisn.get(nisn);
                        if (!student) {
                            previewData.warnings.push({ message: `Siswa dengan NISN "${nisn}" (${row['Nama Siswa']}) tidak ditemukan. Data diabaikan.`});
                            return;
                        }

                        const newStudentExtras = [];
                        let hasChange = false;

                        for (let i = 1; i <= MAX_EXTRAS; i++) {
                            const extraName = row[`Ekstra ${i} - Nama`]?.trim();
                            if (extraName) {
                                const extraId = extraSettingsByName.get(extraName);
                                if (extraId) {
                                    const grade = row[`Ekstra ${i} - Predikat`] || '';
                                    const description = row[`Ekstra ${i} - Deskripsi`] || '';
                                    newStudentExtras.push({ id: extraId, grade, description });
                                    hasChange = true;
                                } else {
                                     previewData.warnings.push({ message: `Ekstrakurikuler "${extraName}" untuk siswa ${student.name} tidak ditemukan di Pengaturan. Data ini diabaikan.`});
                                }
                            }
                        }

                        if (hasChange) {
                            previewData.validChanges.push({ studentId: student.id, studentName: student.name, newExtras: newStudentExtras });
                        }
                    });

                    this.showUploadExtrasPreviewModal(previewData);

                } catch (error) {
                    console.error("Error processing Excel file for extracurriculars:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showUploadExtrasPreviewModal(previewData) {
            this.pendingExtraImport = previewData.validChanges;
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';

            const warningsHtml = previewData.warnings.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-yellow-600">Peringatan (Data Bermasalah Akan Diabaikan):</h4>
                <ul class="list-disc list-inside text-sm text-yellow-700">${previewData.warnings.map(w => `<li>${w.message}</li>`).join('')}</ul></div>` : '';
            
            const changesHtml = this.pendingExtraImport.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-blue-600">Data yang akan Diimpor (${this.pendingExtraImport.length} siswa):</h4>
                <ul class="list-disc list-inside text-sm text-blue-700 max-h-40 overflow-y-auto">${this.pendingExtraImport.map(change => `<li><b>${change.studentName}:</b> ${change.newExtras.length} kegiatan ekstra.</li>`).join('')}</ul></div>` : '<p class="text-gray-500">Tidak ada data baru yang akan diimpor.</p>';

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Pratinjau Unggah Data Ekstrakurikuler</h3>
                    <div class="max-h-80 overflow-y-auto pr-2">
                        ${warningsHtml}
                        ${changesHtml}
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Mengimpor data ini akan MENIMPA semua data ekstrakurikuler yang ada untuk siswa yang terpengaruh.</p>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Tutup</button>
                        <button id="confirm-extra-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ${this.pendingExtraImport.length === 0 ? 'hidden' : ''}">Konfirmasi Import</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-extra-import-btn').onclick = this.applyExtraImport.bind(this);
            this.openModal();
        },

        applyExtraImport() {
            if (!this.pendingExtraImport) return;
            
            this.pendingExtraImport.forEach(change => {
                this.state.extracurricularGrades[change.studentId] = change.newExtras;
            });
            
            this.saveState();
            this.pendingExtraImport = null;
            alert('Data ekstrakurikuler berhasil diimpor!');
            this.closeModal();
            this.renderExtracurricular();
        },

        handleClassNameChange(e) {
            const academicConfigSection = document.getElementById('academic-config-section');
            const className = e.target.value.trim();
            if (className) {
                const gradeMatch = className.match(/\d+/);
                const grade = gradeMatch ? parseInt(gradeMatch[0], 10) : null;
                
                if (grade) {
                    document.getElementById('academic-config-grade').textContent = grade;
                    academicConfigSection.classList.remove('hidden');

                    let needsRender = false;

                    const islamSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Islam)');
                    if (islamSubject && this.islamCpsByGrade[grade]) {
                        islamSubject.capaian = this.islamCpsByGrade[grade];
                        needsRender = true;
                    }
                    const kristenSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Kristen)');
                    if (kristenSubject && this.kristenCpsByGrade[grade]) {
                        kristenSubject.capaian = this.kristenCpsByGrade[grade];
                        needsRender = true;
                    }
                    const katolikSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Katolik)');
                    if (katolikSubject && this.katolikCpsByGrade[grade]) {
                        katolikSubject.capaian = this.katolikCpsByGrade[grade];
                        needsRender = true;
                    }
                    const hinduSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Hindu)');
                    if (hinduSubject && this.hinduCpsByGrade[grade]) {
                        hinduSubject.capaian = this.hinduCpsByGrade[grade];
                        needsRender = true;
                    }
                    const buddhaSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Buddha)');
                    if (buddhaSubject && this.buddhaCpsByGrade[grade]) {
                        buddhaSubject.capaian = this.buddhaCpsByGrade[grade];
                        needsRender = true;
                    }
                    const khonghucuSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Agama dan Budi Pekerti (Khonghucu)');
                    if (khonghucuSubject && this.khonghucuCpsByGrade[grade]) {
                        khonghucuSubject.capaian = this.khonghucuCpsByGrade[grade];
                        needsRender = true;
                    }

                    const pancasilaSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Pancasila');
                    if (pancasilaSubject && this.pancasilaCpsByGrade[grade]) {
                        pancasilaSubject.capaian = this.pancasilaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const matematikaSubject = this.state.settings.subjects.find(s => s.name === 'Matematika');
                    if (matematikaSubject && this.matematikaCpsByGrade[grade]) {
                        matematikaSubject.capaian = this.matematikaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const bahasaIndonesiaSubject = this.state.settings.subjects.find(s => s.name === 'Bahasa Indonesia');
                    if (bahasaIndonesiaSubject && this.bahasaIndonesiaCpsByGrade[grade]) {
                        bahasaIndonesiaSubject.capaian = this.bahasaIndonesiaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const ipasSubject = this.state.settings.subjects.find(s => s.name === 'Ilmu Pengetahuan Alam dan Sosial (IPAS)');
                    if (ipasSubject && this.ipasCpsByGrade[grade]) {
                        ipasSubject.capaian = this.ipasCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniDaerahSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Seni Daerah)');
                    if (seniDaerahSubject && this.seniDaerahCpsByGrade[grade]) {
                        seniDaerahSubject.capaian = this.seniDaerahCpsByGrade[grade];
                        needsRender = true;
                    }

                    const kerajinanDaerahSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Kerajinan Daerah)');
                    if (kerajinanDaerahSubject && this.kerajinanDaerahCpsByGrade[grade]) {
                        kerajinanDaerahSubject.capaian = this.kerajinanDaerahCpsByGrade[grade];
                        needsRender = true;
                    }

                    const kearifanLokalSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Kearifan Lokal)');
                    if (kearifanLokalSubject && this.kearifanLokalCpsByGrade[grade]) {
                        kearifanLokalSubject.capaian = this.kearifanLokalCpsByGrade[grade];
                        needsRender = true;
                    }
                    
                    const bahasaDaerahSubject = this.state.settings.subjects.find(s => s.name === 'Muatan Lokal (Bahasa Daerah)');
                    if (bahasaDaerahSubject && this.bahasaDaerahCpsByGrade[grade]) {
                        bahasaDaerahSubject.capaian = this.bahasaDaerahCpsByGrade[grade];
                        needsRender = true;
                    }

                    const bahasaInggrisSubject = this.state.settings.subjects.find(s => s.name === 'Bahasa Inggris');
                    if (bahasaInggrisSubject && this.bahasaInggrisCpsByGrade[grade]) {
                        bahasaInggrisSubject.capaian = this.bahasaInggrisCpsByGrade[grade];
                        needsRender = true;
                    }
                    
                    const pjokSubject = this.state.settings.subjects.find(s => s.name === 'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)');
                    if (pjokSubject && this.pjokCpsByGrade[grade]) {
                        pjokSubject.capaian = this.pjokCpsByGrade[grade];
                        needsRender = true;
                    }
                    
                    const prakaryaSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Prakarya)');
                    if (prakaryaSubject && this.prakaryaCpsByGrade[grade]) {
                        prakaryaSubject.capaian = this.prakaryaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniMusikSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Seni Musik)');
                    if (seniMusikSubject && this.seniMusikCpsByGrade[grade]) {
                        seniMusikSubject.capaian = this.seniMusikCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniRupaSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Seni Rupa)');
                    if (seniRupaSubject && this.seniRupaCpsByGrade[grade]) {
                        seniRupaSubject.capaian = this.seniRupaCpsByGrade[grade];
                        needsRender = true;
                    }

                    const seniTariSubject = this.state.settings.subjects.find(s => s.name === 'Seni Budaya (Seni Tari)');
                    if (seniTariSubject && this.seniTariCpsByGrade[grade]) {
                        seniTariSubject.capaian = this.seniTariCpsByGrade[grade];
                        needsRender = true;
                    }

                    if (needsRender) {
                        this.renderSubjectEditor();
                    }
                } else {
                    academicConfigSection.classList.add('hidden');
                }
            } else {
                academicConfigSection.classList.add('hidden');
            }
        },

        handleLogoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                this.state.settings.schoolLogo = event.target.result;
                const preview = document.getElementById('logo-preview');
                const placeholder = document.getElementById('logo-placeholder');
                preview.src = this.state.settings.schoolLogo;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        },

        handleAddSubject(e) {
            e.preventDefault();
            const input = document.getElementById('subject-name');
            const newSubjectName = input.value.trim();
            if (newSubjectName && !this.state.settings.subjects.some(s => s.name === newSubjectName)) {
                this.state.settings.subjects.push({ 
                    name: newSubjectName, 
                    capaian: [], 
                    deskripsi: { A: '', B: '', C: '' },
                    isDeleted: false
                });
                this.renderSubjectEditor();
                input.value = '';
            } else {
                alert('Mata pelajaran sudah ada atau nama tidak valid.');
            }
        },
        
        handleAcademicConfigActions(e) {
            const button = e.target.closest('button[data-action]');
            if (!button) return;

            const action = button.dataset.action;
            const subjectCard = button.closest('.subject-card');
            const subjectName = subjectCard ? subjectCard.dataset.subjectName : button.dataset.subjectName;

            const subject = this.state.settings.subjects.find(s => s.name === subjectName);

            switch(action) {
                case 'delete-subject':
                    if (!confirm(`Hapus mapel "${subjectName}"? Ini akan menghapus semua nilai terkait, namun bisa dikembalikan nanti.`)) return;
                    if (subject) {
                        subject.isDeleted = true;
                        Object.keys(this.state.grades).forEach(studentId => delete this.state.grades[studentId][subjectName]);
                        this.selectedSubjectName = null;
                        this.renderSubjectEditor();
                    }
                    break;
                case 'restore-subject':
                    if (subject) {
                        subject.isDeleted = false;
                        this.selectedSubjectName = subjectName;
                        this.renderSubjectEditor();
                    }
                    break;
                case 'add-cp':
                    if (subject) {
                        subject.capaian.push('');
                        this.renderSubjectDetails(subject.name);
                    }
                    break;
                case 'delete-cp':
                    if (subject) {
                        const cpIndex = parseInt(button.dataset.cpIndex, 10);
                        subject.capaian.splice(cpIndex, 1);
                        this.renderSubjectDetails(subject.name);
                    }
                    break;
            }
        },
        
        handleSubjectSelect(e) {
            this.selectedSubjectName = e.target.value;
            this.renderSubjectDetails(this.selectedSubjectName);
        },
        
        handleSubjectDataUpdate(targetTextarea) {
            const subjectCard = targetTextarea.closest('.subject-card');
            if (!subjectCard) return;

            const subjectName = subjectCard.dataset.subjectName;
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) return;

            const field = targetTextarea.dataset.field;
            
            if (field === 'capaian') {
                const cpIndex = parseInt(targetTextarea.dataset.cpIndex, 10);
                subject.capaian[cpIndex] = targetTextarea.value;
            } else if (field.startsWith('deskripsi-')) {
                const studentForPreview = this.state.students.length > 0 ? this.state.students[0] : null;
                const studentNickname = studentForPreview ? (studentForPreview.panggilan || studentForPreview.name.split(' ')[0]) : 'Siswa';
                const capaianText = subject.capaian.join(', ');

                const convertToTemplate = (previewText) => {
                    let template = previewText.replace(new RegExp(studentNickname.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), '[nama]');
                    if (capaianText) {
                        const escapedCapaianText = capaianText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        template = template.replace(new RegExp(escapedCapaianText, 'g'), '[cp]');
                    }
                    return template;
                };

                if(field === 'deskripsi-A') subject.deskripsi.A = convertToTemplate(targetTextarea.value);
                if(field === 'deskripsi-B') subject.deskripsi.B = convertToTemplate(targetTextarea.value);
                if(field === 'deskripsi-C') subject.deskripsi.C = convertToTemplate(targetTextarea.value);
            }
        },

        handleStudentActions(e) {
            const target = e.target.closest('button, a');
            if (!target) return;
            const action = target.dataset.action;
            const id = target.dataset.id;
            switch(action) {
                case 'edit-student': this.showStudentModal(id); break;
                case 'delete-student': this.handleDeleteStudent(id); break;
                case 'print-report': this.showPrintModalForStudent(id); break;
                case 'edit-grades': this.showEditStudentGradesModal(id); break;
            }
        },
        
        handleDeleteStudent(studentId) {
             if (confirm('Apakah Anda yakin ingin menghapus siswa ini beserta semua datanya?')) {
                this.state.students = this.state.students.filter(s => s.id !== studentId);
                delete this.state.grades[studentId];
                delete this.state.extracurricularGrades[studentId];
                delete this.state.attendance[studentId];
                delete this.state.p5Grades[studentId];
                delete this.state.teacherNotes[studentId];
                this.saveState();
                this.renderStudents();
            }
        },
        
        handleGradesTabClick(e) {
            const tab = e.target.dataset.tab;
            document.querySelectorAll('.grades-tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
        
            document.querySelectorAll('.grades-content').forEach(content => content.classList.add('hidden'));
            const activeContent = document.getElementById(`grades-content-${tab}`);
            activeContent.classList.remove('hidden');
        
            if (tab === 'list') {
                this.renderOverallGradesTable();
            } else if (tab === 'input') {
                this.renderGradeInput();
            }
        },
        
        handleSaveGradesForSubject(subjectName) {
            const form = document.getElementById('grade-input-form');
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject) return;

            const inputs = form.querySelectorAll(`input[type="number"][data-studentid]`);
            const studentScores = {}; 

            inputs.forEach(input => {
                const studentId = input.dataset.studentid;
                
                if (!studentScores[studentId]) {
                    studentScores[studentId] = {
                        cp: new Array(subject.capaian.length).fill(null),
                        pts: null,
                        pas: null
                    };
                }

                const value = input.value.trim() === '' ? null : parseInt(input.value, 10);
                
                if (input.dataset.cpIndex) {
                    const cpIndex = parseInt(input.dataset.cpIndex, 10);
                    studentScores[studentId].cp[cpIndex] = value;
                } else if (input.dataset.scoreType === 'pts') {
                    studentScores[studentId].pts = value;
                } else if (input.dataset.scoreType === 'pas') {
                    studentScores[studentId].pas = value;
                }
            });

            Object.keys(studentScores).forEach(studentId => {
                if (!this.state.grades[studentId]) {
                    this.state.grades[studentId] = {};
                }
                this.state.grades[studentId][subjectName] = studentScores[studentId];
            });
            
            this.saveState();
            alert(`Nilai untuk ${subjectName} berhasil disimpan!`);
        },
        
        handleSaveAttendance() {
            const inputs = document.querySelectorAll('#view-attendance input[type="number"]');
            inputs.forEach(input => {
                const studentId = input.dataset.studentId;
                const type = input.dataset.type;
                if (!this.state.attendance[studentId]) {
                    this.state.attendance[studentId] = { s: 0, i: 0, a: 0 };
                }
                this.state.attendance[studentId][type] = parseInt(input.value, 10) || 0;
            });
            this.saveState();
            alert('Data absensi berhasil disimpan!');
        },

        handleDownloadAttendance() {
            const { students, settings, attendance } = this.state;
            
            const metadata = [
                ['Nama Kelas', settings.className],
                ['Tahun Ajaran / Semester', `${settings.schoolYear} / ${settings.semester}`],
                [] 
            ];

            const headers = ['No. Absen', 'NISN', 'Nama Siswa', 'Sakit', 'Izin', 'Alfa'];

            const studentRows = students.map((student, index) => {
                const studentAttendance = attendance[student.id] || { s: 0, i: 0, a: 0 };
                return [
                    index + 1,
                    student.nisn || '',
                    student.name,
                    studentAttendance.s,
                    studentAttendance.i,
                    studentAttendance.a
                ];
            });

            const finalSheetData = [...metadata, headers, ...studentRows];

            const ws = XLSX.utils.aoa_to_sheet(finalSheetData);
            
            ws['!cols'] = headers.map((header, i) => {
                const defaultWidth = String(header).length;
                const maxLength = Math.max(
                    defaultWidth,
                    ...finalSheetData.map(row => (row[i] ? String(row[i]).length : 0))
                );
                return { wch: Math.min(maxLength + 2, 60) };
            });

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Absensi");
            XLSX.writeFile(wb, "data_absensi.xlsx");
        },

        handleUploadAttendance(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws, { range: 3 }); 

                    const previewData = { validChanges: [], errors: [], warnings: [] };
                    const appStudentsByNisn = new Map(this.state.students.map(s => [String(s.nisn || '').trim(), s]));

                    jsonData.forEach((row, rowIndex) => {
                        const nisn = String(row['NISN'] || '').trim();
                        if (!nisn) {
                            previewData.warnings.push({ message: `Baris ${rowIndex + 5}: Ditemukan data tanpa NISN. Baris ini diabaikan.` });
                            return;
                        }
                        
                        const student = appStudentsByNisn.get(nisn);
                        if (!student) {
                            previewData.warnings.push({ message: `Siswa dengan NISN "${nisn}" (${row['Nama Siswa']}) tidak ditemukan. Data diabaikan.` });
                            return;
                        }
                        
                        const sakit = parseInt(row['Sakit'], 10) || 0;
                        const izin = parseInt(row['Izin'], 10) || 0;
                        const alfa = parseInt(row['Alfa'], 10) || 0;
                        
                        previewData.validChanges.push({ 
                            studentId: student.id, 
                            studentName: student.name, 
                            attendance: { s: sakit, i: izin, a: alfa } 
                        });
                    });

                    this.showUploadAttendancePreviewModal(previewData);

                } catch (error) {
                    console.error("Error processing Excel file for attendance:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showUploadAttendancePreviewModal(previewData) {
            this.pendingAttendanceImport = previewData.validChanges;
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';

            const warningsHtml = previewData.warnings.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-yellow-600">Peringatan (Data Bermasalah Akan Diabaikan):</h4>
                <ul class="list-disc list-inside text-sm text-yellow-700">${previewData.warnings.map(w => `<li>${w.message}</li>`).join('')}</ul></div>` : '';
            
            const changesHtml = this.pendingAttendanceImport.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-blue-600">Data Absensi yang akan Diimpor (${this.pendingAttendanceImport.length} siswa):</h4>
                <ul class="list-disc list-inside text-sm text-blue-700 max-h-40 overflow-y-auto">${this.pendingAttendanceImport.map(change => `<li><b>${change.studentName}:</b> S: ${change.attendance.s}, I: ${change.attendance.i}, A: ${change.attendance.a}</li>`).join('')}</ul></div>` : '<p class="text-gray-500">Tidak ada data baru yang akan diimpor.</p>';

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Pratinjau Unggah Data Absensi</h3>
                    <div class="max-h-80 overflow-y-auto pr-2">
                        ${warningsHtml}
                        ${changesHtml}
                    </div>
                    <p class="text-xs text-gray-500 mt-4">Mengimpor data ini akan MENIMPA semua data absensi yang ada untuk siswa yang terpengaruh.</p>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Tutup</button>
                        <button id="confirm-attendance-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ${this.pendingAttendanceImport.length === 0 ? 'hidden' : ''}">Konfirmasi Import</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-attendance-import-btn').onclick = this.applyAttendanceImport.bind(this);
            this.openModal();
        },

        applyAttendanceImport() {
            if (!this.pendingAttendanceImport) return;
            
            this.pendingAttendanceImport.forEach(change => {
                this.state.attendance[change.studentId] = change.attendance;
            });
            
            this.saveState();
            this.pendingAttendanceImport = null;
            alert('Data absensi berhasil diimpor!');
            this.closeModal();
            this.renderAttendance();
        },

        handleGeneratePresetNotes() {
            if (!confirm('Tindakan ini akan menimpa semua catatan wali kelas yang ada dengan preset baru. Lanjutkan?')) {
                return;
            }

            const { students, grades } = this.state;

            students.forEach(student => {
                const studentGrades = grades[student.id] || {};
                
                let excellentSubjects = [];
                let highestScore = -1;
                let subjectWithHighestScore = null;

                Object.entries(studentGrades).forEach(([subjectName, scoreObject]) => {
                    const finalScore = this.getFinalScore(scoreObject);
                    if (finalScore !== null) {
                        if (this.getPredicate(finalScore) === 'A') {
                            excellentSubjects.push(subjectName);
                        }
                        if (finalScore > highestScore) {
                            highestScore = finalScore;
                            subjectWithHighestScore = subjectName;
                        }
                    }
                });

                let bestSubjectText = '';
                if (excellentSubjects.length > 0) {
                    const mainSubjects = new Set();
                    excellentSubjects.forEach(s => {
                        mainSubjects.add(s.split('(')[0].trim());
                    });
                    bestSubjectText = Array.from(mainSubjects).join(', ');
                } else if (subjectWithHighestScore) {
                    bestSubjectText = subjectWithHighestScore.split('(')[0].trim();
                }

                const praises = [
                    "Sikap positif dan rasa ingin tahu Ananda sangat tinggi.",
                    "Ananda menunjukkan bakat dan potensi yang luar biasa.",
                    "Ananda adalah aset berharga di kelas ini dengan semangat belajarnya.",
                    "Kemampuan Ananda dalam beradaptasi dan bekerja sama sangat baik."
                ];

                const motivations = [
                    "Teruslah belajar dan berusaha menjadi versi terbaik dari dirimu.",
                    "Ibu/Bapak Guru yakin Ananda bisa meraih semua cita-cita.",
                    "Jangan pernah ragu untuk bertanya dan terus kembangkan potensimu.",
                    "Pertahankan semangat yang membara ini hingga akhir semester."
                ];
                
                const randomPraise = praises[Math.floor(Math.random() * praises.length)];
                const randomMotivation = motivations[Math.floor(Math.random() * motivations.length)];
                const studentNickname = student.panggilan || student.name.split(' ')[0];
                
                let note = '';
                if (bestSubjectText) {
                    note = `${studentNickname} menunjukkan pencapaian yang sangat baik, terutama dalam mata pelajaran ${bestSubjectText}. ${randomPraise} ${randomMotivation} Pertahankan terus prestasi dan semangat belajarmu, ya!`;
                } else {
                    note = `${studentNickname} adalah siswa yang rajin dan bersemangat. ${randomPraise} ${randomMotivation} Tingkatkan terus prestasimu di semester depan agar lebih gemilang!`;
                }

                this.state.teacherNotes[student.id] = note;
            });

            this.renderTeacherNotes();
            alert('Catatan preset berhasil dibuat untuk semua siswa!');
        },

        updateGradeAverage(studentId) {
            const scoreInputs = document.querySelectorAll(`input[data-studentid="${studentId}"]`);
            const gradeData = { cp: [], pts: null, pas: null };

            let maxCpIndex = -1;
            scoreInputs.forEach(input => {
                if (input.dataset.cpIndex) {
                    maxCpIndex = Math.max(maxCpIndex, parseInt(input.dataset.cpIndex, 10));
                }
            });
            gradeData.cp = new Array(maxCpIndex + 1).fill(null);

            scoreInputs.forEach(input => {
                const val = input.value.trim() === '' ? null : Number(input.value);
                if (input.dataset.cpIndex) {
                    gradeData.cp[parseInt(input.dataset.cpIndex, 10)] = val;
                } else if (input.dataset.scoreType === 'pts') {
                    gradeData.pts = val;
                } else if (input.dataset.scoreType === 'pas') {
                    gradeData.pas = val;
                }
            });
            
            const finalScore = this.getFinalScore(gradeData);
            const averageCell = document.querySelector(`td[data-average-for="${studentId}"]`);
            if (averageCell) {
                averageCell.textContent = finalScore ?? '-';
            }
        },

        handleDownloadTemplate() {
            const emptyStudent = this.getEmptyStudent();
            const headers = Object.keys(emptyStudent);
            
            const studentData = this.state.students.map(student => {
                const row = {};
                headers.forEach(header => {
                    row[header] = student[header] !== undefined ? student[header] : '';
                });
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(studentData, { header: headers });
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Data Siswa");
            XLSX.writeFile(wb, "template_data_siswa.xlsx");
        },

        handleUploadStudents(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws);
                    
                    const emptyStudent = this.getEmptyStudent();
                    const requiredHeaders = ['name', 'nisn', 'nis'];
                    const fileHeaders = Object.keys(jsonData[0] || {});
                    const missingHeaders = requiredHeaders.filter(h => !fileHeaders.includes(h));

                    if (missingHeaders.length > 0) {
                        alert(`File tidak valid. Kolom yang wajib ada: ${missingHeaders.join(', ')}`);
                        return;
                    }
                    
                    const newStudents = jsonData.map(row => {
                         const student = { ...emptyStudent };
                         Object.keys(emptyStudent).forEach(key => {
                             if (row[key] !== undefined) {
                                student[key] = String(row[key]);
                             }
                         });
                         return student;
                    });

                    this.state.students = newStudents.map((s, index) => ({ ...s, id: s.id || `s${Date.now() + index}`}));
                    this.saveState();
                    this.renderStudents();
                    alert(`${newStudents.length} data siswa berhasil diimpor dan menimpa data lama.`);

                } catch (error) {
                    console.error("Error processing Excel file:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan format kolom sudah benar sesuai template.");
                } finally {
                    event.target.value = ''; 
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showStudentModal(studentId = null) {
            const student = studentId ? this.state.students.find(s => s.id === studentId) : this.getEmptyStudent();
            const title = studentId ? 'Edit Data Siswa' : 'Tambah Siswa Baru';
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-2 border shadow-lg rounded-md bg-white w-full max-w-4xl';

            const formFields = [
                { label: 'Nama Lengkap', id: 'name', type: 'text', required: true, span: 'md:col-span-2' },
                { label: 'Nama Panggilan', id: 'panggilan', type: 'text' },
                { label: 'NIS', id: 'nis', type: 'text' },
                { label: 'NISN', id: 'nisn', type: 'text' },
                { label: 'Tempat, Tanggal Lahir', id: 'ttl', type: 'text', placeholder: 'e.g., Jakarta, 01 Januari 2015' },
                { label: 'Jenis Kelamin', id: 'jenisKelamin', type: 'select', options: ['Laki-laki', 'Perempuan'] },
                { label: 'Agama', id: 'agama', type: 'select', options: ['Islam', 'Kristen', 'Katolik', 'Hindu', 'Buddha', 'Khonghucu'] },
                { label: 'Kewarganegaraan', id: 'kewarganegaraan', type: 'text' },
                { label: 'Status Keluarga', id: 'statusKeluarga', type: 'text' },
                { label: 'Anak Ke-', id: 'anakKe', type: 'number' },
                { label: 'Asal TK', id: 'asalTk', type: 'text' },
                { label: 'Alamat Siswa', id: 'alamat', type: 'text', span: 'md:col-span-2' },
                { label: 'Nama Ayah', id: 'namaAyah', type: 'text' },
                { label: 'Nama Ibu', id: 'namaIbu', type: 'text' },
                { label: 'Pekerjaan Ayah', id: 'pekerjaanAyah', type: 'text' },
                { label: 'Pekerjaan Ibu', id: 'pekerjaanIbu', type: 'text' },
                { label: 'Alamat Orang Tua', id: 'alamatOrtu', type: 'text', span: 'md:col-span-2' },
                { label: 'Telepon Orang Tua', id: 'teleponOrtu', type: 'tel' },
                { label: 'Nama Wali', id: 'namaWali', type: 'text' },
                                { label: 'Pekerjaan Wali', id: 'pekerjaanWali', type: 'text' },
                { label: 'Alamat Wali', id: 'alamatWali', type: 'text', span: 'md:col-span-2' },
                { label: 'Telepon Wali', id: 'teleponWali', type: 'tel' }
            ];

            const createInput = (field) => {
                const value = student[field.id] || '';
                if (field.type === 'select') {
                    return `<select id="modal-${field.id}" class="form-select w-full rounded-md border-gray-300 bg-gray-50">${field.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}</select>`;
                }
                return `<input type="${field.type}" id="modal-${field.id}" value="${value}" placeholder="${field.placeholder || ''}" ${field.required ? 'required' : ''} class="form-input w-full rounded-md border-gray-300 bg-gray-50">`;
            };

            modalContent.innerHTML = `
                <form id="student-form" class="p-4">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[70vh] overflow-y-auto pr-2 pb-4">
                        ${formFields.map(field => `
                            <div class="${field.span || ''}">
                                <label for="modal-${field.id}" class="block text-sm font-medium mb-1">${field.label}${field.required ? ' *' : ''}</label>
                                ${createInput(field)}
                            </div>
                        `).join('')}
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t mt-4">
                        <button type="button" class="modal-close-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Batal</button>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Simpan</button>
                    </div>
                </form>
            `;

            document.getElementById('student-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const newStudentData = { ...student };
                formFields.forEach(field => {
                    newStudentData[field.id] = document.getElementById(`modal-${field.id}`).value;
                });

                if (studentId) {
                    const index = this.state.students.findIndex(s => s.id === studentId);
                    this.state.students[index] = newStudentData;
                } else {
                    newStudentData.id = 's' + Date.now();
                    this.state.students.push(newStudentData);
                }
                this.saveState();
                this.renderStudents();
                this.closeModal();
            });

            this.openModal();
        },

        showPrintModalForStudent(studentId) {
             const student = this.state.students.find(s => s.id === studentId);
             const studentGrades = this.state.grades[student.id] || {};
             const modalContent = document.getElementById('modal-content-wrapper');
             modalContent.className = 'relative mx-auto p-0 border shadow-lg rounded-md bg-white w-full max-w-5xl';
             modalContent.innerHTML = `
                <div class="p-4 bg-gray-100 flex justify-between items-center no-print rounded-t-md">
                    <h3 class="text-xl font-semibold">Pratinjau Rapor - ${student.name}</h3>
                    <div>
                        <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Cetak</button>
                        <button class="modal-close-btn ml-2 bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Tutup</button>
                    </div>
                </div>
                <div class="print-area max-h-[80vh] overflow-y-auto">
                    ${this.createReportCardHTML(student, studentGrades)}
                </div>
            `;
            this.openModal();
        },
        
        showEditStudentGradesModal(studentId = null) {
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-4xl';
        
            const studentOptions = this.state.students.map(s => 
                `<option value="${s.id}" ${studentId === s.id ? 'selected' : ''}>${s.name}</option>`
            ).join('');
        
            modalContent.innerHTML = `
                <div class="p-2">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-2xl font-semibold">Edit Nilai Siswa</h3>
                        <button type="button" class="modal-close-btn bg-gray-200 px-4 py-2 rounded-md hover:bg-gray-300">Tutup</button>
                    </div>
                    <div class="mb-4">
                        <label for="student-grade-selector" class="block font-medium mb-1">Pilih Siswa:</label>
                        <select id="student-grade-selector" class="form-select w-full md:w-1/2 rounded-md border-gray-300 bg-gray-50">
                            <option value="">-- Pilih Siswa --</option>
                            ${studentOptions}
                        </select>
                    </div>
                    <div id="student-grades-editor-container" class="max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>
            `;
        
            const selector = document.getElementById('student-grade-selector');
            selector.addEventListener('change', (e) => this.renderStudentGradesEditor(e.target.value));
        
            if (studentId) {
                this.renderStudentGradesEditor(studentId);
            } else {
                document.getElementById('student-grades-editor-container').innerHTML = 
                    `<p class="text-center text-gray-500 py-8">Pilih siswa untuk melihat dan mengedit nilai.</p>`;
            }
        
            this.openModal();
        },
        
        renderStudentGradesEditor(studentId) {
            const container = document.getElementById('student-grades-editor-container');
            if (!studentId) {
                container.innerHTML = `<p class="text-center text-gray-500 py-8">Pilih siswa untuk melihat dan mengedit nilai.</p>`;
                return;
            }
            
            const student = this.state.students.find(s => s.id === studentId);
            
            const tableRows = this.state.settings.subjects.filter(s => !s.isDeleted).map(subject => {
                const gradeData = this.state.grades[studentId]?.[subject.name] || { cp: [], pts: null, pas: null };
                const finalScore = this.getFinalScore(gradeData);
                const inputFields = subject.capaian.map((cp, index) => 
                    `<input type="number" data-cp-index="${index}" value="${gradeData.cp[index] ?? ''}" class="grade-input" placeholder="-" title="${cp}">`
                ).join('');
        
                return `
                    <tr class="border-b">
                        <td class="p-2 align-top">${subject.name}</td>
                        <td class="p-2 align-top"><div class="flex gap-1">${inputFields}</div></td>
                        <td class="p-2 align-top"><input type="number" data-score-type="pts" value="${gradeData.pts ?? ''}" class="grade-input" placeholder="-"></td>
                        <td class="p-2 align-top"><input type="number" data-score-type="pas" value="${gradeData.pas ?? ''}" class="grade-input" placeholder="-"></td>
                        <td class="p-2 align-top text-center font-bold" data-final-score-cell="true">${finalScore ?? '-'}</td>
                    </tr>
                `;
            }).join('');
        
            container.innerHTML = `
                <style>.grade-input { width: 50px; text-align: center; border-radius: 4px; border: 1px solid #ccc; padding: 4px; }</style>
                <form id="single-student-grade-form" data-studentid="${studentId}">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="p-2 text-left">Mata Pelajaran</th>
                                <th class="p-2 text-left">Nilai Formatif (CP)</th>
                                <th class="p-2">PTS</th>
                                <th class="p-2">PAS</th>
                                <th class="p-2">Rata-rata</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                    </table>
                    <div class="text-right mt-4">
                        <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-md hover:bg-green-700">Simpan Nilai ${student.name}</button>
                    </div>
                </form>
            `;
        
            const form = document.getElementById('single-student-grade-form');
            form.addEventListener('submit', this.handleSaveSingleStudentGrades.bind(this));
            form.addEventListener('input', this.handleSingleStudentGradeInputChange.bind(this));
        },
        
        handleSingleStudentGradeInputChange(e) {
            if (e.target.classList.contains('grade-input')) {
                const row = e.target.closest('tr');
                const cpInputs = Array.from(row.querySelectorAll('input[data-cp-index]'));
                const ptsInput = row.querySelector('input[data-score-type="pts"]');
                const pasInput = row.querySelector('input[data-score-type="pas"]');
                const finalScoreCell = row.querySelector('td[data-final-score-cell]');
        
                const scoreData = {
                    cp: cpInputs.map(input => input.value.trim() === '' ? null : Number(input.value)),
                    pts: ptsInput.value.trim() === '' ? null : Number(ptsInput.value),
                    pas: pasInput.value.trim() === '' ? null : Number(pasInput.value),
                };
        
                const finalScore = this.getFinalScore(scoreData);
                finalScoreCell.textContent = finalScore ?? '-';
            }
        },
        
        handleSaveSingleStudentGrades(e) {
            e.preventDefault();
            const form = e.target;
            const studentId = form.dataset.studentid;
            const rows = form.querySelectorAll('tbody tr');
            
            if (!this.state.grades[studentId]) this.state.grades[studentId] = {};
        
            rows.forEach(row => {
                const subjectName = row.cells[0].textContent;
                const subject = this.state.settings.subjects.find(s => s.name === subjectName);
                if (!subject) return;
        
                const cpInputs = row.querySelectorAll('input[data-cp-index]');
                const ptsInput = row.querySelector('input[data-score-type="pts"]');
                const pasInput = row.querySelector('input[data-score-type="pas"]');
        
                const newGradeData = {
                    cp: Array.from(cpInputs).map(input => input.value.trim() === '' ? null : parseInt(input.value, 10)),
                    pts: ptsInput.value.trim() === '' ? null : parseInt(ptsInput.value, 10),
                    pas: pasInput.value.trim() === '' ? null : parseInt(pasInput.value, 10),
                };
                
                this.state.grades[studentId][subjectName] = newGradeData;
            });
        
            this.saveState();
            alert(`Nilai untuk siswa ini berhasil disimpan!`);
            this.closeModal();
            if(window.location.hash === '#grades') this.renderOverallGradesTable();
        },
        
        handleDownloadGrades() {
            const { students, grades, settings } = this.state;
            const subjects = settings.subjects.filter(s => !s.isDeleted);
            
            let maxCps = 0;
            subjects.forEach(s => {
                maxCps = Math.max(maxCps, s.capaian.length);
            });
            
            const headers = ['No. Absen', 'NISN', 'Nama Siswa'];
            subjects.forEach(s => {
                for (let i = 1; i <= maxCps; i++) {
                    headers.push(`${s.name} - CP${i}`);
                }
                headers.push(`${s.name} - PTS`);
                headers.push(`${s.name} - PAS`);
            });

            const data = students.map((student, index) => {
                const studentRow = [index + 1, student.nisn, student.name];
                subjects.forEach(s => {
                    const gradeData = grades[student.id]?.[s.name] || { cp: [], pts: null, pas: null };
                    for (let i = 0; i < maxCps; i++) {
                        studentRow.push(gradeData.cp[i] ?? '');
                    }
                    studentRow.push(gradeData.pts ?? '');
                    studentRow.push(gradeData.pas ?? '');
                });
                return studentRow;
            });

            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Nilai');
            XLSX.writeFile(wb, 'data_nilai.xlsx');
        },
        
        handleUploadGrades(event) {
             const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const ws = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(ws);
                    
                    const previewData = { validChanges: {}, errors: [], warnings: [] };
                    const appStudentsByNisn = new Map(this.state.students.map(s => [String(s.nisn || '').trim(), s]));
                    const fileHeaders = Object.keys(jsonData[0] || {});
                    
                    jsonData.forEach((row, rowIndex) => {
                        const nisn = String(row['NISN'] || '').trim();
                        if (!nisn) {
                             previewData.warnings.push({ message: `Baris ${rowIndex + 2}: Ditemukan data tanpa NISN. Baris diabaikan.`});
                             return;
                        }

                        const student = appStudentsByNisn.get(nisn);
                        if (!student) {
                             previewData.warnings.push({ message: `Siswa NISN "${nisn}" tidak ditemukan. Data diabaikan.`});
                             return;
                        }

                        if (!previewData.validChanges[student.id]) {
                            previewData.validChanges[student.id] = { studentName: student.name, grades: {} };
                        }

                        this.state.settings.subjects.filter(s => !s.isDeleted).forEach(subject => {
                            const gradeData = { cp: [], pts: null, pas: null };
                            let hasData = false;
                            
                            for (const header of fileHeaders) {
                                if (header.startsWith(subject.name)) {
                                    const value = row[header];
                                    if(value !== undefined && value !== null && value !== '') {
                                        hasData = true;
                                        const numValue = parseInt(value, 10);
                                        if (header.includes(' - CP')) {
                                            const cpIndex = parseInt(header.split('CP')[1], 10) - 1;
                                            gradeData.cp[cpIndex] = numValue;
                                        } else if (header.includes(' - PTS')) {
                                            gradeData.pts = numValue;
                                        } else if (header.includes(' - PAS')) {
                                            gradeData.pas = numValue;
                                        }
                                    }
                                }
                            }
                            if (hasData) {
                                previewData.validChanges[student.id].grades[subject.name] = gradeData;
                            }
                        });
                    });
                    
                    this.showUploadGradesPreviewModal(previewData);

                } catch (error) {
                    console.error("Error processing grades Excel file:", error);
                    alert("Terjadi kesalahan saat memproses file. Pastikan formatnya benar.");
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsArrayBuffer(file);
        },

        showUploadGradesPreviewModal(previewData) {
            this.pendingGradeImport = previewData.validChanges;
            const modalContent = document.getElementById('modal-content-wrapper');
            modalContent.className = 'relative mx-auto p-5 border shadow-lg rounded-md bg-white w-full max-w-2xl';

            const warningsHtml = previewData.warnings.length > 0 ? `<div class="mb-4"><h4 class="font-bold text-yellow-600">Peringatan:</h4><ul class="list-disc list-inside text-sm text-yellow-700">${previewData.warnings.map(w => `<li>${w.message}</li>`).join('')}</ul></div>` : '';
            
            const changes = Object.values(this.pendingGradeImport);
            const changesHtml = changes.length > 0 ? `
                <div class="mb-4"><h4 class="font-bold text-blue-600">Nilai yang akan Diimpor (${changes.length} siswa):</h4>
                <ul class="list-disc list-inside text-sm text-blue-700 max-h-40 overflow-y-auto">${changes.map(c => `<li><b>${c.studentName}:</b> ${Object.keys(c.grades).length} mata pelajaran.</li>`).join('')}</ul></div>` : '<p class="text-gray-500">Tidak ada data nilai baru yang akan diimpor.</p>';

            modalContent.innerHTML = `
                <div class="p-4">
                    <h3 class="text-2xl font-semibold mb-4">Pratinjau Unggah Nilai</h3>
                    ${warningsHtml}
                    ${changesHtml}
                    <p class="text-xs text-gray-500 mt-4">Mengimpor data ini akan MENIMPA semua data nilai yang ada untuk siswa yang terpengaruh.</p>
                    <div class="flex justify-end gap-3 pt-4 mt-4 border-t">
                        <button type="button" class="modal-close-btn px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Tutup</button>
                        <button id="confirm-grade-import-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ${changes.length === 0 ? 'hidden' : ''}">Konfirmasi Import</button>
                    </div>
                </div>`;
            
            document.getElementById('confirm-grade-import-btn').onclick = this.applyGradeImport.bind(this);
            this.openModal();
        },

        applyGradeImport() {
            if (!this.pendingGradeImport) return;
            
            Object.entries(this.pendingGradeImport).forEach(([studentId, change]) => {
                if (!this.state.grades[studentId]) this.state.grades[studentId] = {};
                Object.assign(this.state.grades[studentId], change.grades);
            });
            
            this.saveState();
            this.pendingGradeImport = null;
            alert('Data nilai berhasil diimpor!');
            this.closeModal();
            this.renderGrades();
        },

        handleSaveP5Grades(e) {
            const projectId = e.target.dataset.projectId;
            const selects = document.querySelectorAll(`#p5-project-content-container select[data-student-id]`);
            
            selects.forEach(select => {
                const { studentId, subelementId } = select.dataset;
                const value = select.value;
                
                if (!this.state.p5Grades[studentId]) this.state.p5Grades[studentId] = {};
                if (!this.state.p5Grades[studentId][projectId]) this.state.p5Grades[studentId][projectId] = {};

                if (value) {
                    this.state.p5Grades[studentId][projectId][subelementId] = value;
                } else {
                    delete this.state.p5Grades[studentId][projectId][subelementId];
                }
            });
            
            this.saveState();
            alert('Penilaian Proyek P5 berhasil disimpan!');
        },

        generateGradeDescription(student, subjectName, gradeData) {
            const subject = this.state.settings.subjects.find(s => s.name === subjectName);
            if (!subject || !gradeData) return "Belum ada capaian yang tuntas.";

            const finalScore = this.getFinalScore(gradeData);
            if (finalScore === null) return "Belum ada capaian yang tuntas.";

            const predicate = this.getPredicate(finalScore);
            let descriptionTemplate = '';
            if (predicate === 'A') descriptionTemplate = subject.deskripsi.A;
            else if (predicate === 'B') descriptionTemplate = subject.deskripsi.B;
            else descriptionTemplate = subject.deskripsi.C;

            if (!descriptionTemplate) return "Deskripsi belum diatur.";
            
            const studentNickname = student.panggilan || student.name.split(' ')[0];
            const capaianScores = (gradeData.cp || []).map((score, index) => ({ score, index }))
                                                  .filter(item => item.score !== null);

            if (capaianScores.length === 0) return "Belum ada capaian yang tuntas.";
            
            capaianScores.sort((a, b) => b.score - a.score);

            const bestCp = subject.capaian[capaianScores[0].index];
            const worstCp = subject.capaian[capaianScores[capaianScores.length - 1].index];
            
            let combinedCpText = `Ananda sangat baik dalam ${bestCp}`;
            if (capaianScores.length > 1 && bestCp !== worstCp) {
                combinedCpText += `, namun perlu bimbingan dalam ${worstCp}`;
            }
            
            const capaianText = subject.capaian.join(', ');

            return descriptionTemplate
                .replace(/\[nama\]/gi, studentNickname)
                .replace(/\[cp\]/gi, capaianText)
                .replace(/\[cp_terbaik\]/gi, bestCp)
                .replace(/\[cp_terendah\]/gi, worstCp)
                .replace(/\[cp_kombinasi\]/gi, combinedCpText);
        },

        createReportCardHTML(student, studentGrades) {
            const { settings } = this.state;
            const tableCellStyle = 'border border-black p-2';
            
            // Academic Grades Table
            const subjectsForReport = this.state.settings.subjects
                .filter(s => !s.isDeleted)
                .filter(s => {
                    if (s.name.startsWith('Pendidikan Agama')) {
                        const religionInSubject = s.name.match(/\(([^)]+)\)/)?.[1];
                        return religionInSubject && student.agama && student.agama.toLowerCase() === religionInSubject.toLowerCase();
                    }
                    return studentGrades[s.name] && this.getFinalScore(studentGrades[s.name]) !== null;
                });
                
            let academicRows = '';
            let groupA_count = 0;
            const renderRowsForGroup = (groupName) => {
                const groupSubjects = subjectsForReport.filter(s => s.name.startsWith(groupName));
                return groupSubjects.map((subject, idx) => {
                    const gradeData = studentGrades[subject.name];
                    const finalScore = this.getFinalScore(gradeData);
                    const predicate = this.getPredicate(finalScore);
                    const description = this.generateGradeDescription(student, subject.name, gradeData);
                    groupA_count++;
                    return `<tr><td class="${tableCellStyle} text-center">${idx + 1}</td><td class="${tableCellStyle}">${subject.name}</td><td class="${tableCellStyle} text-center">${finalScore}</td><td class="${tableCellStyle}">${description}</td></tr>`;
                }).join('');
            };
            
            academicRows += `<tr><td class="${tableCellStyle}" colspan="4"><b>Kelompok A</b></td></tr>`;
            academicRows += renderRowsForGroup('Pendidikan Agama');
            academicRows += renderRowsForGroup('Pendidikan Pancasila');
            academicRows += renderRowsForGroup('Bahasa Indonesia');
            academicRows += renderRowsForGroup('Matematika');
            academicRows += renderRowsForGroup('Ilmu Pengetahuan Alam dan Sosial');
            
            academicRows += `<tr><td class="${tableCellStyle}" colspan="4"><b>Kelompok B</b></td></tr>`;
            academicRows += subjectsForReport.filter(s => !s.name.startsWith('Pendidikan') && !s.name.startsWith('Bahasa I') && !s.name.startsWith('Mate') && !s.name.startsWith('Ilmu Pengetahuan'))
                .map((subject, idx) => {
                     const gradeData = studentGrades[subject.name];
                     const finalScore = this.getFinalScore(gradeData);
                     const description = this.generateGradeDescription(student, subject.name, gradeData);
                     return `<tr><td class="${tableCellStyle} text-center">${idx + 1}</td><td class="${tableCellStyle}">${subject.name}</td><td class="${tableCellStyle} text-center">${finalScore}</td><td class="${tableCellStyle}">${description}</td></tr>`;
                 }).join('');

            // Extracurriculars
            const extraGrades = this.state.extracurricularGrades[student.id] || [];
            const extraRows = extraGrades.map((ex, index) => {
                const extraInfo = settings.extracurriculars.find(e => e.id === ex.id);
                return `<tr><td class="${tableCellStyle} text-center">${index + 1}</td><td class="${tableCellStyle}">${extraInfo.name}</td><td class="${tableCellStyle}">${ex.description}</td></tr>`;
            }).join('') || `<tr><td class="${tableCellStyle} text-center" colspan="3">Tidak mengikuti kegiatan ekstrakurikuler.</td></tr>`;

            // Attendance
            const attendance = this.state.attendance[student.id] || { s: 0, i: 0, a: 0 };

            // P5 Projects
            const p5GradesForStudent = this.state.p5Grades[student.id] || {};
            const p5ReportsHTML = settings.p5Projects.map(project => {
                const projectGrades = p5GradesForStudent[project.id] || {};
                const dimensionsWithTargets = project.dimensions.filter(d => d.subElementIds && d.subElementIds.length > 0);
                
                // Only render the project in the report if it's fully configured with targets.
                if (dimensionsWithTargets.length === 0) return '';

                const p5Levels = { BB: 'Belum Berkembang', MB: 'Mulai Berkembang', BSH: 'Berkembang Sesuai Harapan', SB: 'Sangat Berkembang' };
                const findSubElement = (subId) => {
                     for (const dim of this.p5ProfileData.dimensions) for (const el of dim.elements) {
                         const sub = el.subElements.find(s => s.id === subId); if (sub) return sub;
                     } return null;
                };

                const narrativeParts = [];
                Object.entries(projectGrades).forEach(([subId, grade]) => {
                    const subData = findSubElement(subId);
                    if (subData && (grade === 'BSH' || grade === 'SB')) {
                        narrativeParts.push(subData.name.toLowerCase());
                    }
                });

                let narrative = `${student.panggilan || student.name} telah menunjukkan perkembangan yang baik dalam proyek ini. Ananda sudah mampu ${narrativeParts.join(', ')}. Perlu bimbingan lebih lanjut untuk meningkatkan kemampuan lainnya.`;
                if(narrativeParts.length === 0) narrative = `${student.panggilan || student.name} sudah berpartisipasi aktif dalam proyek ini, namun masih perlu bimbingan untuk mencapai target capaian.`;
                
                return `
                    <div class="report-card p-8 bg-white shadow-lg mx-auto" style="width: 210mm; min-height: 297mm; font-size: 11pt;">
                        <h3 class="font-bold text-center text-lg mb-4">LAPORAN PROJEK PENGUATAN PROFIL PELAJAR PANCASILA</h3>
                        <div class="mb-4">
                            <p><b>Nama Proyek:</b> ${project.name}</p>
                            <p class="text-justify mt-1"><b>Deskripsi:</b> ${project.description}</p>
                        </div>
                        <div class="border border-black p-4">
                            <b>Catatan Proses:</b><br>
                            <p class="mt-2 text-justify">${narrative}</p>
                        </div>
                        <table class="w-full border-collapse border border-black mt-4">
                            <thead>
                                <tr>
                                    <th class="${tableCellStyle} w-1/2">Dimensi</th>
                                    <th class="${tableCellStyle} text-center">BB</th>
                                    <th class="${tableCellStyle} text-center">MB</th>
                                    <th class="${tableCellStyle} text-center">BSH</th>
                                    <th class="${tableCellStyle} text-center">SB</th>
                                </tr>
                            </thead>
                            <tbody>
                               ${dimensionsWithTargets.map(dimData => {
                                    const dimension = this.p5ProfileData.dimensions.find(d => d.id === dimData.dimensionId);
                                    let hasGrade = false;
                                    let maxGrade = 'BB';
                                    const gradeValues = { 'BB': 1, 'MB': 2, 'BSH': 3, 'SB': 4 };
                                    dimData.subElementIds.forEach(subId => {
                                        if (projectGrades[subId]) {
                                            hasGrade = true;
                                            if (gradeValues[projectGrades[subId]] > gradeValues[maxGrade]) {
                                                maxGrade = projectGrades[subId];
                                            }
                                        }
                                    });
                                    // Always show the row if targets are configured, even if no grade is entered yet.
                                    return `<tr>
                                        <td class="${tableCellStyle}">${dimension.name}</td>
                                        ${Object.keys(p5Levels).map(level => `<td class="${tableCellStyle} text-center">${hasGrade && maxGrade === level ? '✔' : ''}</td>`).join('')}
                                    </tr>`
                                }).join('')}
                            </tbody>
                        </table>
                        <div class="text-xs mt-2">
                            <b>Keterangan:</b> BB: Belum Berkembang; MB: Mulai Berkembang; BSH: Berkembang Sesuai Harapan; SB: Sangat Berkembang.
                        </div>
                    </div>
                `;
            }).join('');
            
            const teacherNote = this.state.teacherNotes[student.id] || '';

            return `
            <div class="report-card p-8 bg-white shadow-lg mx-auto" style="width: 210mm; min-height: 297mm; font-family: 'Times New Roman', serif; font-size: 11pt; line-height: 1.5;">
                <!-- Header -->
                <h3 class="font-bold text-center text-lg mb-4">LAPORAN HASIL BELAJAR</h3>
                
                <!-- Student Info -->
                <table class="w-full text-left mb-4">
                    <tr>
                        <td class="w-1/4">Nama Sekolah</td><td class="w-1/2">: ${settings.schoolName}</td>
                        <td class="w-1/4">Kelas</td><td>: ${settings.className}</td>
                    </tr>
                    <tr><td>Alamat</td><td>: ${settings.schoolAddress}</td><td>Semester</td><td>: ${settings.semester}</td></tr>
                    <tr><td>Nama Peserta Didik</td><td>: ${student.name}</td><td>Tahun Ajaran</td><td>: ${settings.schoolYear}</td></tr>
                    <tr><td>Nomor Induk/NISN</td><td>: ${student.nis} / ${student.nisn}</td><td></td><td></td></tr>
                </table>

                <!-- Academic Section -->
                <h4 class="font-bold">A. Capaian Akademik</h4>
                <table class="w-full border-collapse border border-black mt-2">
                    <thead>
                        <tr>
                            <th class="${tableCellStyle} w-8">No</th>
                            <th class="${tableCellStyle} w-1/4">Mata Pelajaran</th>
                            <th class="${tableCellStyle} w-20">Nilai Akhir</th>
                            <th class="${tableCellStyle}">Capaian Kompetensi</th>
                        </tr>
                    </thead>
                    <tbody>${academicRows}</tbody>
                </table>
                
                <!-- Extracurricular Section -->
                <h4 class="font-bold mt-4">B. Ekstrakurikuler</h4>
                 <table class="w-full border-collapse border border-black mt-2">
                    <thead>
                        <tr>
                            <th class="${tableCellStyle} w-8">No</th>
                            <th class="${tableCellStyle} w-1/3">Kegiatan Ekstrakurikuler</th>
                            <th class="${tableCellStyle}">Keterangan</th>
                        </tr>
                    </thead>
                    <tbody>${extraRows}</tbody>
                </table>
                
                 <!-- Attendance & Notes -->
                 <div class="flex mt-4 gap-4">
                    <div class="w-1/3">
                        <h4 class="font-bold">C. Ketidakhadiran</h4>
                        <table class="w-full border-collapse border border-black mt-2">
                             <tr><td class="border border-black p-1 w-2/3">Sakit</td><td class="border border-black p-1 text-center">${attendance.s} hari</td></tr>
                             <tr><td class="border border-black p-1 w-2/3">Izin</td><td class="border border-black p-1 text-center">${attendance.i} hari</td></tr>
                             <tr><td class="border border-black p-1 w-2/3">Tanpa Keterangan</td><td class="border border-black p-1 text-center">${attendance.a} hari</td></tr>
                        </table>
                    </div>
                    <div class="w-2/3">
                        <h4 class="font-bold">D. Catatan Wali Kelas</h4>
                        <div class="border border-black p-2 mt-2 h-24">${teacherNote}</div>
                    </div>
                 </div>

                 <!-- Signatures -->
                 <div class="flex justify-between mt-8">
                     <div class="text-center">Mengetahui,<br>Orang Tua/Wali<br><br><br><br>.........................</div>
                     <div class="text-center">${settings.reportDate}<br>Wali Kelas<br><br><br><br><b>${settings.teacherName}</b><br>NIP. ${settings.teacherNip}</div>
                 </div>
                 <div class="flex justify-center mt-6">
                    <div class="text-center">Mengetahui,<br>Kepala Sekolah<br><br><br><br><b>${settings.headmasterName}</b><br>NIP. ${settings.headmasterNip}</div>
                 </div>
            </div>
            ${p5ReportsHTML}
            `;
        }
    };

    window.App = App; // Make it globally accessible for inline event handlers
    App.init();
});
</script>

<script>
function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  await gapi.client.init({
    apiKey: API_KEY,
    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
  });
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: CLIENT_ID,
    scope: SCOPES,
    callback: '' // akan diisi saat login
  });
}
</script>

</body>
</html>
