<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RKT - Rapor Kelas Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="data:application/manifest+json;base64,eyJzaG9ydF9uYW1lIjoiUktUIiwibmFtZSI6IlJLVCAtIFJhcG9yIEtlbGFzIFRlcnBhZHUiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9waWNzdW0ucGhvdG9zLzE5Mi8xOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIiwic2l6ZXMiOiIxOTJ4MTkyIn0seyJzcmMiOiJodHRwczovL3BpY3N1bS5waG90b3MvNTEyLzUxMiIsInR5cGUiOiJpbWFnZS9wbmciLCJzaXplcyI6IjUxMng1MTIifV0sInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsInRoZW1lX2NvbG9yIjoiIzRmNDZlNSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmYWZjIn0=" />
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <meta name="theme-color" content="#ffffff" />
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.16.0"
  }
}
</script>
</head>
  <body class="bg-slate-50">
    <div id="root"></div>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script type="text/babel" data-type="module">
import React, { useState, useCallback, useEffect, useMemo, useRef } from 'react';
import ReactDOM from 'react-dom/client';
import { GoogleGenAI } from "@google/genai";

// --- START: Embedded Types ---

const subjectKeys = ['PABP', 'PP', 'BIndo', 'MTK', 'IPAS', 'SB', 'PJOK', 'BIng', 'Mulok'];

const subjectLabels = {
  PABP: 'PABP',
  PP: 'PP',
  BIndo: 'B.Indo',
  MTK: 'MTK',
  IPAS: 'IPAS',
  SB: 'SB',
  PJOK: 'PJOK',
  BIng: 'B.Ing',
  Mulok: 'Mulok'
};

const subjectFullNames = {
  PABP: 'Pendidikan Agama dan Budi Pekerti',
  PP: 'Pendidikan Pancasila',
  BIndo: 'Bahasa Indonesia',
  MTK: 'Matematika',
  IPAS: 'Ilmu Pengetahuan Alam dan Sosial',
  SB: 'Seni Budaya',
  PJOK: 'Pendidikan Jasmani, Olahraga, dan Kesehatan',
  BIng: 'Bahasa Inggris',
  Mulok: 'Muatan Lokal'
};

// --- END: Embedded Types ---


// --- START: Embedded Constants ---

const NAV_ITEMS = [
  { id: 'DASHBOARD', label: 'Dashboard' },
  { id: 'DATA_SISWA', label: 'Data Siswa' },
  { id: 'DATA_NILAI', label: 'Data Nilai' },
  { id: 'DATA_EKSTRAKURIKULER', label: 'Data Ekstrakurikuler' },
  { id: 'DATA_PROYEK_P5', label: 'Data Proyek P5' },
  { id: 'DATA_ABSENSI', label: 'Data Absensi' },
  { id: 'CATATAN_WALI_KELAS', label: 'Catatan Wali Kelas' },
  { id: 'PRINT_RAPOR', label: 'Print Rapor' },
  { id: 'PENGATURAN', label: 'Pengaturan' },
];

const DATA_ACTIONS = [
  { id: 'EKSPORT', label: 'Ekspor Seluruh Data' },
  { id: 'IMPORT', label: 'Impor Seluruh Data' },
];

// --- END: Embedded Constants ---


// --- START: Embedded Components ---

const TermsPage = () => {
  return (
    <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200 max-w-4xl mx-auto space-y-6">
      <h1 className="text-3xl font-bold text-slate-800">Ketentuan Layanan</h1>
      <div className="text-slate-700 space-y-4">
        <p>Selamat datang di RKT - Rapor Kelas Terpadu. Dengan menggunakan aplikasi kami, Anda setuju untuk terikat oleh ketentuan layanan berikut. Harap baca dengan saksama.</p>
        <div>
          <h2 className="text-xl font-semibold mb-2">1. Penggunaan Aplikasi</h2>
          <p>Aplikasi ini ditujukan untuk penggunaan oleh guru wali kelas untuk mengelola data akademik siswa. Anda bertanggung jawab atas semua data yang Anda masukkan dan kelola melalui aplikasi ini.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">2. Akun Pengguna</h2>
          <p>Aplikasi ini beroperasi secara lokal di perangkat Anda. Tidak ada data yang dikirim atau disimpan di server kami. Anda bertanggung jawab penuh untuk menjaga keamanan data di perangkat Anda.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">3. Data Siswa</h2>
          <p>Anda setuju untuk hanya memasukkan data siswa yang akurat dan relevan untuk tujuan pendidikan. Anda harus memiliki otorisasi yang sesuai untuk mengelola data pribadi siswa sesuai dengan peraturan yang berlaku.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">4. Batasan Tanggung Jawab</h2>
          <p>Aplikasi ini disediakan "sebagaimana adanya". Kami tidak bertanggung jawab atas kehilangan data atau kerusakan apa pun yang timbul dari penggunaan aplikasi ini. Sangat disarankan untuk secara teratur mengekspor dan mencadangkan data Anda.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">5. Perubahan pada Ketentuan</h2>
          <p>Kami dapat memperbarui ketentuan layanan ini dari waktu ke waktu. Perubahan akan diposting di halaman ini. Penggunaan aplikasi secara berkelanjutan setelah perubahan merupakan penerimaan Anda terhadap ketentuan baru.</p>
        </div>
      </div>
    </div>
  );
};

const PrivacyPage = () => {
  return (
    <div className="bg-white p-8 rounded-xl shadow-md border border-slate-200 max-w-4xl mx-auto space-y-6">
      <h1 className="text-3xl font-bold text-slate-800">Kebijakan Privasi</h1>
      <div className="text-slate-700 space-y-4">
        <p>Kebijakan Privasi ini menjelaskan bagaimana RKT - Rapor Kelas Terpadu ("Aplikasi") menangani data Anda.</p>
        <div>
          <h2 className="text-xl font-semibold mb-2">1. Pengumpulan dan Penggunaan Data</h2>
          <p>Aplikasi ini dirancang untuk beroperasi sepenuhnya secara offline di perangkat Anda. Kami tidak mengumpulkan, menyimpan, atau mentransmisikan data pribadi apa pun, termasuk data siswa, data nilai, atau informasi pribadi Anda, ke server kami atau pihak ketiga mana pun.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">2. Penyimpanan Data</h2>
          <p>Semua data yang Anda masukkan ke dalam Aplikasi, seperti informasi siswa, nilai, dan pengaturan, disimpan secara lokal di dalam browser Anda menggunakan mekanisme penyimpanan web (seperti localStorage). Data ini tetap berada di perangkat Anda dan tidak dapat diakses oleh kami atau pihak lain.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">3. Keamanan Data</h2>
          <p>Anda bertanggung jawab untuk mengamankan perangkat yang Anda gunakan untuk mengakses Aplikasi ini. Karena data disimpan secara lokal, keamanan data bergantung pada keamanan perangkat dan browser Anda. Kami menyarankan untuk menggunakan perangkat yang aman dan terlindungi kata sandi.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">4. Ekspor dan Impor Data</h2>
          <p>Aplikasi menyediakan fungsionalitas untuk mengekspor data Anda ke file lokal. Proses ini sepenuhnya dikendalikan oleh Anda dan terjadi di perangkat Anda. Data yang diekspor adalah tanggung jawab Anda untuk disimpan dan diamankan. Demikian pula, saat mengimpor data, file tersebut dibaca secara lokal oleh browser Anda dan tidak diunggah ke server mana pun.</p>
        </div>
        <div>
          <h2 className="text-xl font-semibold mb-2">5. Perubahan pada Kebijakan Privasi</h2>
          <p>Setiap perubahan pada kebijakan privasi ini akan tercermin dalam pembaruan Aplikasi. Kami mendorong Anda untuk meninjau kebijakan ini secara berkala.</p>
        </div>
      </div>
    </div>
  );
};


const PlaceholderPage = ({ title }) => {
  return (
    <div className="flex flex-col items-center justify-center h-full text-center bg-white p-10 rounded-xl shadow-md border border-slate-200">
      <h1 className="text-3xl font-bold text-slate-800 mb-4">{title}</h1>
      <p className="mt-4 text-slate-600 max-w-md">
        Halaman ini sedang dalam pengembangan. Fitur untuk mengelola {title.toLowerCase()} akan segera tersedia di sini.
      </p>
    </div>
  );
};

const StatCard = ({ title, value, description, actionText, onActionClick }) => (
    <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200 flex flex-col justify-between">
        <div>
            <h3 className="text-lg font-semibold text-slate-700">{title}</h3>
            <p className="mt-4 text-4xl font-bold text-slate-900">{value}</p>
            <p className="mt-2 text-sm text-slate-500">{description}</p>
        </div>
        {actionText && onActionClick && (
             <button onClick={onActionClick} className="mt-4 text-sm font-semibold text-indigo-600 hover:text-indigo-800 text-left">
                {actionText} &rarr;
            </button>
        )}
    </div>
);

const AnalysisItem = ({ title, description, status }) => {
    const statusClasses = {
        complete: 'bg-green-100 text-green-800 border-green-400',
        incomplete: 'bg-yellow-100 text-yellow-800 border-yellow-400',
        attention: 'bg-red-100 text-red-800 border-red-400',
    };
    const statusText = {
        complete: 'Lengkap',
        incomplete: 'Belum Lengkap',
        attention: 'Perhatian',
    };

    return (
        <div className={`bg-white p-4 rounded-lg shadow-sm border-l-4 ${statusClasses[status]}`}>
            <div className="flex justify-between items-start">
                <div className="flex-1">
                    <h4 className="font-semibold text-slate-800">{title}</h4>
                    <p className="text-sm text-slate-500 mt-1">{description}</p>
                </div>
                <span className={`ml-4 text-xs font-bold px-2 py-1 rounded-full ${statusClasses[status]}`}>{statusText[status]}</span>
            </div>
        </div>
    );
};

const Dashboard = ({ setActivePage, settings, students }) => {
  const waliKelasName = settings.nama_wali_kelas || "Wali Kelas";

  const stats = [
    { 
        title: "Kelas", 
        value: settings.nama_kelas || "-", 
        description: "Kelas yang diampu saat ini.",
        actionText: "Klik Pengaturan untuk mengubah",
        onActionClick: () => setActivePage('PENGATURAN'),
    },
    { 
        title: "Jumlah Siswa", 
        value: students.length.toString(), 
        description: "Siswa yang terdaftar di kelas.",
        actionText: "Klik Data Siswa untuk menambah",
        onActionClick: () => setActivePage('DATA_SISWA'),
    },
    { 
        title: "Tahun Ajaran", 
        value: settings.tahun_ajaran || "-", 
        description: "Tahun ajaran yang sedang berjalan.",
        actionText: "Klik Pengaturan untuk mengubah",
        onActionClick: () => setActivePage('PENGATURAN'),
    },
    { 
        title: "Semester", 
        value: settings.semester || "-", 
        description: "Semester yang sedang berlangsung.",
        actionText: "Klik Pengaturan untuk mengubah",
        onActionClick: () => setActivePage('PENGATURAN'),
    },
  ];
  
  const analysisItems = [];

  return (
    <div className="space-y-8">
      <div>
        <h2 className="text-3xl font-bold text-slate-800">Dashboard</h2>
        <p className="mt-2 text-slate-600">Selamat datang, {waliKelasName}</p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {stats.map(stat => <StatCard key={stat.title} {...stat} />)}
      </div>

      <div>
        <h3 className="text-2xl font-bold text-slate-800">Analisis Data</h3>
        <p className="mt-1 text-slate-600">Ringkasan data penting yang memerlukan perhatian Anda.</p>
        <div className="mt-6">
          {analysisItems.length > 0 ? (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {analysisItems.map(item => <AnalysisItem key={item.title} {...item} />)}
            </div>
          ) : (
            <div className="bg-white p-10 rounded-xl shadow-sm border border-slate-200 text-center">
              <p className="text-slate-500">Tidak ada data analisis yang tersedia untuk ditampilkan.</p>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

const FormField = ({ label, id, type = 'text', placeholder, value, onChange }) => (
    <div className="col-span-1">
        <label htmlFor={id} className="block text-sm font-medium text-slate-700 mb-1">
            {label}
        </label>
        <input
            type={type}
            id={id}
            name={id}
            value={value}
            onChange={onChange}
            className="w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-slate-900 placeholder:text-slate-400"
            placeholder={placeholder}
        />
    </div>
);

const FileInputField = ({ label, id, onChange, fileName }) => (
     <div className="col-span-1">
        <label htmlFor={id} className="block text-sm font-medium text-slate-700 mb-1">
            {label}
        </label>
        <div className="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
            <div className="space-y-1 text-center">
                <svg className="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
                </svg>
                <div className="flex text-sm text-slate-600">
                    <label htmlFor={id} className="relative cursor-pointer bg-white rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-indigo-500">
                        <span>Unggah file</span>
                        <input id={id} name={id} type="file" className="sr-only" onChange={onChange} accept="image/*" />
                    </label>
                    <p className="pl-1">atau seret dan lepas</p>
                </div>
                {fileName ? (
                    <p className="text-xs text-green-600">{fileName}</p>
                ) : (
                    <p className="text-xs text-slate-500">PNG, JPG, GIF hingga 10MB</p>
                )}
            </div>
        </div>
    </div>
);

const SettingsPage = ({ settings, onSettingsChange, onSave }) => {

    return (
        <div className="space-y-8">
            <div>
                <h2 className="text-3xl font-bold text-slate-800">Pengaturan</h2>
                <p className="mt-2 text-slate-600">Kelola informasi sekolah, periode akademik, dan data penting lainnya.</p>
            </div>

            <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <div className="space-y-12">
                    {/* Profil Sekolah */}
                    <section>
                        <h3 className="text-xl font-bold text-slate-800 border-b pb-3 mb-6">Profil Sekolah</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <FormField label="Nama Sekolah" id="nama_sekolah" value={settings.nama_sekolah} onChange={onSettingsChange} />
                            <FormField label="NPSN" id="npsn" value={settings.npsn} onChange={onSettingsChange} />
                            <FormField label="Alamat Sekolah" id="alamat_sekolah" value={settings.alamat_sekolah} onChange={onSettingsChange} />
                            <FormField label="Desa / Kelurahan" id="desa_kelurahan" value={settings.desa_kelurahan} onChange={onSettingsChange} />
                            <FormField label="Kecamatan" id="kecamatan" value={settings.kecamatan} onChange={onSettingsChange} />
                            <FormField label="Provinsi" id="provinsi" value={settings.provinsi} onChange={onSettingsChange} />
                            <FormField label="Kode Pos" id="kode_pos" value={settings.kode_pos} onChange={onSettingsChange} />
                            <FormField label="Email Sekolah" id="email_sekolah" type="email" value={settings.email_sekolah} onChange={onSettingsChange} />
                            <FormField label="Telepon Sekolah" id="telepon_sekolah" value={settings.telepon_sekolah} onChange={onSettingsChange} />
                            <FormField label="Website Sekolah" id="website_sekolah" value={settings.website_sekolah} onChange={onSettingsChange} />
                            <FormField label="Faksimile" id="faksimile" value={settings.faksimile} onChange={onSettingsChange} />
                            <FileInputField label="Logo Sekolah" id="logo_sekolah" onChange={onSettingsChange} fileName={settings.logo_sekolah?.name} />
                        </div>
                    </section>

                    {/* Periode Akademik & Kepala Sekolah */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-x-12 gap-y-12">
                         <section>
                            <h3 className="text-xl font-bold text-slate-800 border-b pb-3 mb-6">Periode Akademik</h3>
                             <div className="space-y-4">
                                <FormField label="Nama Kelas" id="nama_kelas" value={settings.nama_kelas} onChange={onSettingsChange} />
                                <FormField label="Tahun Ajaran" id="tahun_ajaran" placeholder="e.g. 2023/2024" value={settings.tahun_ajaran} onChange={onSettingsChange} />
                                <FormField label="Semester" id="semester" placeholder="e.g. Ganjil atau Genap" value={settings.semester} onChange={onSettingsChange}/>
                                <FormField label="Tempat, Tanggal Rapor" id="tanggal_rapor" placeholder="e.g. Jakarta, 20 Desember 2023" value={settings.tanggal_rapor} onChange={onSettingsChange}/>
                            </div>
                        </section>
                        <section>
                            <h3 className="text-xl font-bold text-slate-800 border-b pb-3 mb-6">Kepala Sekolah dan Guru</h3>
                             <div className="space-y-4">
                                <FormField label="Nama Kepala Sekolah" id="nama_kepala_sekolah" value={settings.nama_kepala_sekolah} onChange={onSettingsChange} />
                                <FormField label="NIP Kepala Sekolah" id="nip_kepala_sekolah" value={settings.nip_kepala_sekolah} onChange={onSettingsChange} />
                                <FormField label="Nama Wali Kelas" id="nama_wali_kelas" value={settings.nama_wali_kelas} onChange={onSettingsChange} />
                                <FormField label="NIP Wali Kelas" id="nip_wali_kelas" value={settings.nip_wali_kelas} onChange={onSettingsChange} />
                            </div>
                        </section>
                    </div>

                    <div className="pt-5">
                        <div className="flex justify-end">
                            <button
                                type="button"
                                className="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                Batal
                            </button>
                            <button
                                type="button"
                                onClick={onSave}
                                className="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                            >
                                Simpan Perubahan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

const emptyStudent = {
    namaLengkap: '', namaPanggilan: '', nis: '', nisn: '', tempatLahir: '',
    tanggalLahir: '', jenisKelamin: '', agama: '', kewarganegaraan: 'WNI',
    statusDalamKeluarga: '', anakKe: '', asalTk: '', alamatSiswa: '',
    namaAyah: '', namaIbu: '', pekerjaanAyah: '', pekerjaanIbu: '',
    alamatOrangTua: '', teleponOrangTua: '', namaWali: '', pekerjaanWali: '',
    alamatWali: '', teleponWali: '',
};

const StudentModal = ({ isOpen, onClose, onSave, studentToEdit }) => {
    const [formData, setFormData] = useState(emptyStudent);

    useEffect(() => {
        setFormData(studentToEdit ? { ...studentToEdit } : emptyStudent);
    }, [studentToEdit, isOpen]);
    
    if (!isOpen) return null;

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        onSave(formData);
        onClose();
    };

    const FormField = ({name, label, type = 'text', required = false}) => (
        <div>
            <label htmlFor={name} className="block text-sm font-medium text-slate-700">{label}</label>
            <input type={type} name={name} id={name} value={formData[name] || ''} onChange={handleChange} required={required} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" />
        </div>
    );

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4" aria-modal="true" role="dialog">
            <div className="bg-slate-50 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                <div className="flex justify-between items-center p-4 border-b">
                    <h2 className="text-xl font-bold text-slate-800">{studentToEdit ? 'Edit Data Siswa' : 'Tambah Siswa Baru'}</h2>
                    <button onClick={onClose} className="text-slate-500 hover:text-slate-800">&times;</button>
                </div>
                <form onSubmit={handleSubmit} className="overflow-y-auto p-6 space-y-6">
                    {/* Data Pribadi Siswa */}
                    <fieldset className="border p-4 rounded-md">
                        <legend className="text-lg font-semibold text-slate-700 px-2">Data Pribadi Siswa</legend>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                            <FormField name="namaLengkap" label="Nama Lengkap" required />
                            <FormField name="namaPanggilan" label="Nama Panggilan" />
                            <FormField name="nis" label="NIS" />
                            <FormField name="nisn" label="NISN" />
                            <FormField name="tempatLahir" label="Tempat Lahir" />
                            <FormField name="tanggalLahir" label="Tanggal Lahir" type="date" />
                             <div>
                                <label htmlFor="jenisKelamin" className="block text-sm font-medium text-slate-700">Jenis Kelamin</label>
                                <select name="jenisKelamin" id="jenisKelamin" value={formData.jenisKelamin} onChange={handleChange} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="">Pilih...</option>
                                    <option value="Laki-laki">Laki-laki</option>
                                    <option value="Perempuan">Perempuan</option>
                                </select>
                            </div>
                            <FormField name="agama" label="Agama" />
                            <FormField name="kewarganegaraan" label="Kewarganegaraan" />
                            <FormField name="statusDalamKeluarga" label="Status dalam Keluarga" />
                            <FormField name="anakKe" label="Anak Ke-" />
                            <FormField name="asalTk" label="Asal TK" />
                            <div className="md:col-span-2 lg:col-span-3">
                                <label htmlFor="alamatSiswa" className="block text-sm font-medium text-slate-700">Alamat Siswa</label>
                                <textarea name="alamatSiswa" id="alamatSiswa" value={formData.alamatSiswa} onChange={handleChange} rows={2} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                            </div>
                        </div>
                    </fieldset>
                     {/* Data Orang Tua & Wali */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <fieldset className="border p-4 rounded-md">
                            <legend className="text-lg font-semibold text-slate-700 px-2">Data Orang Tua</legend>
                            <div className="space-y-4 mt-4">
                                <FormField name="namaAyah" label="Nama Ayah" />
                                <FormField name="pekerjaanAyah" label="Pekerjaan Ayah" />
                                <FormField name="namaIbu" label="Nama Ibu" />
                                <FormField name="pekerjaanIbu" label="Pekerjaan Ibu" />
                                <FormField name="teleponOrangTua" label="Telepon Orang Tua" />
                                <div>
                                <label htmlFor="alamatOrangTua" className="block text-sm font-medium text-slate-700">Alamat Orang Tua</label>
                                <textarea name="alamatOrangTua" id="alamatOrangTua" value={formData.alamatOrangTua} onChange={handleChange} rows={2} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                            </div>
                            </div>
                        </fieldset>
                        <fieldset className="border p-4 rounded-md">
                             <legend className="text-lg font-semibold text-slate-700 px-2">Data Wali (jika ada)</legend>
                            <div className="space-y-4 mt-4">
                                <FormField name="namaWali" label="Nama Wali" />
                                <FormField name="pekerjaanWali" label="Pekerjaan Wali" />
                                <FormField name="teleponWali" label="Telepon Wali" />
                                <div>
                                    <label htmlFor="alamatWali" className="block text-sm font-medium text-slate-700">Alamat Wali</label>
                                    <textarea name="alamatWali" id="alamatWali" value={formData.alamatWali} onChange={handleChange} rows={2} className="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                                </div>
                            </div>
                        </fieldset>
                    </div>

                    <div className="flex justify-end items-center p-4 border-t mt-auto">
                        <button type="button" onClick={onClose} className="bg-white py-2 px-4 border border-slate-300 rounded-md shadow-sm text-sm font-medium text-slate-700 hover:bg-slate-50">Batal</button>
                        <button type="submit" className="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">Simpan Data</button>
                    </div>
                </form>
            </div>
        </div>
    );
};

const DataSiswaPage = ({ students, namaKelas, onSaveStudent, onDeleteStudent }) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [studentToEdit, setStudentToEdit] = useState(null);
    const [activeView, setActiveView] = useState('DAFTAR_SISWA');
    const fileInputRef = useRef(null);

    const handleAddNew = () => {
        setStudentToEdit(null);
        setIsModalOpen(true);
    };

    const handleEdit = (student) => {
        setStudentToEdit(student);
        setIsModalOpen(true);
    };

    const handleDelete = (student) => {
        if (window.confirm(`Apakah Anda yakin ingin menghapus data siswa bernama ${student.namaLengkap}?`)) {
            onDeleteStudent(student.id);
        }
    };
    
    const studentHeaderMapping = [
        ['no', "No"], ['namaLengkap', "Nama Lengkap"], ['namaPanggilan', "Nama Panggilan"],
        ['nis', "NIS"], ['nisn', "NISN"], ['tempatLahir', "Tempat Lahir"],
        ['tanggalLahir', "Tanggal Lahir"], ['jenisKelamin', "Jenis Kelamin"], ['agama', "Agama"],
        ['kewarganegaraan', "Kewarganegaraan"], ['statusDalamKeluarga', "Status dalam Keluarga"],
        ['anakKe', "Anak Ke-"], ['asalTk', "Asal TK"], ['alamatSiswa', "Alamat Siswa"],
        ['namaAyah', "Nama Ayah"], ['namaIbu', "Nama Ibu"], ['pekerjaanAyah', "Pekerjaan Ayah"],
        ['pekerjaanIbu', "Pekerjaan Ibu"], ['alamatOrangTua', "Alamat Orang Tua"],
        ['teleponOrangTua', "Telepon Orang Tua"], ['namaWali', "Nama Wali"],
        ['pekerjaanWali', "Pekerjaan Wali"], ['alamatWali', "Alamat Wali"], ['teleponWali', "Telepon Wali"]
    ];

    const handleExport = useCallback(() => {
        if (typeof XLSX === 'undefined') {
            alert('Pustaka ekspor (SheetJS) tidak termuat.');
            return;
        }

        const formattedStudents = students.map((student, index) => {
            const newStudent = {};
            studentHeaderMapping.forEach(([key, header]) => {
                if (key === 'no') {
                    newStudent[header] = index + 1;
                } else {
                    newStudent[header] = student[key];
                }
            });
            return newStudent;
        });

        const worksheet = XLSX.utils.json_to_sheet(formattedStudents);
        worksheet['!cols'] = studentHeaderMapping.map(([, header]) => ({ wch: header.length < 15 ? 15 : header.length + 2 }));
        
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data Siswa");
        XLSX.writeFile(workbook, "Data_Siswa.xlsx");
    }, [students, studentHeaderMapping]);

    const triggerImport = () => {
        fileInputRef.current?.click();
    };

    const handleFileSelected = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = event.target?.result;
                const workbook = XLSX.read(data, { type: 'binary', cellDates: true });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                const headerToKeyMap = new Map();
                studentHeaderMapping.forEach(([key, header]) => {
                    if (key !== 'no') {
                        headerToKeyMap.set(header, key);
                    }
                });

                let importedCount = 0;
                json.forEach(row => {
                    const newStudent = { ...emptyStudent };
                    let hasData = false;
                    for (const header in row) {
                        if (headerToKeyMap.has(header)) {
                            const key = headerToKeyMap.get(header);
                             let value = row[header];
                            if (key === 'tanggalLahir' && value instanceof Date) {
                                value = value.toISOString().split('T')[0];
                            }
                            newStudent[key] = value;
                            if (key === 'namaLengkap' && value) {
                                hasData = true;
                            }
                        }
                    }

                    if (hasData) {
                        onSaveStudent(newStudent);
                        importedCount++;
                    }
                });

                if (importedCount > 0) {
                    alert(`${importedCount} data siswa berhasil diimpor.`);
                } else {
                    alert('Tidak ada data siswa yang valid untuk diimpor. Pastikan nama kolom di file Excel sesuai dengan template unduhan.');
                }

            } catch (error) {
                console.error('Error processing Excel file:', error);
                alert('Terjadi kesalahan saat memproses file Excel.');
            } finally {
                if (e.target) e.target.value = '';
            }
        };
        reader.readAsBinaryString(file);
    };
    
    const inactiveButtonClass = "px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 transition-colors";
    const activeButtonClass = "px-4 py-2 text-sm font-medium text-white bg-indigo-700 border border-indigo-700 rounded-lg shadow-sm";

    const renderContent = () => {
        switch(activeView) {
            case 'DAFTAR_SISWA':
                return (
                    <div className="space-y-6">
                        <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800">Daftar Siswa</h3>
                                <p className="mt-1 text-slate-600">
                                    Menampilkan {students.length} siswa terdata di kelas {namaKelas || '(Nama Kelas Belum Diatur)'}.
                                </p>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={handleAddNew} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-lg shadow-sm hover:bg-indigo-700">
                                    + Tambah Siswa
                                </button>
                            </div>
                        </div>

                        <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left text-slate-500">
                                    <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                                        <tr>
                                            <th scope="col" className="px-6 py-3">No</th>
                                            <th scope="col" className="px-6 py-3">Nama Lengkap</th>
                                            <th scope="col" className="px-6 py-3">Nama Panggilan</th>
                                            <th scope="col" className="px-6 py-3">NIS</th>
                                            <th scope="col" className="px-6 py-3">NISN</th>
                                            <th scope="col" className="px-6 py-3 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {students.length > 0 ? (
                                            students.map((student, index) => (
                                                <tr key={student.id} className="bg-white border-b hover:bg-slate-50">
                                                    <td className="px-6 py-4">{index + 1}</td>
                                                    <th scope="row" className="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">{student.namaLengkap}</th>
                                                    <td className="px-6 py-4">{student.namaPanggilan}</td>
                                                    <td className="px-6 py-4">{student.nis}</td>
                                                    <td className="px-6 py-4">{student.nisn}</td>
                                                    <td className="px-6 py-4 text-center space-x-2">
                                                        <button onClick={() => handleEdit(student)} className="font-medium text-indigo-600 hover:underline">Edit</button>
                                                        <button onClick={() => alert('Fitur Nilai akan datang!')} className="font-medium text-green-600 hover:underline">Nilai</button>
                                                        <button onClick={() => alert('Fitur Print Rapor akan datang!')} className="font-medium text-blue-600 hover:underline">Print</button>
                                                        <button onClick={() => handleDelete(student)} className="font-medium text-red-600 hover:underline">Hapus</button>
                                                    </td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan={6} className="text-center py-10 text-slate-500">
                                                    Belum ada data siswa. Klik 'Tambah Siswa' untuk memulai.
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            case 'DATA_SISWA':
                return (
                    <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                        <h3 className="text-xl font-bold text-slate-800">Unduh dan Unggah Data Siswa</h3>
                        <p className="text-sm text-slate-500 mt-1">Unduh template data siswa dalam format Excel, atau unggah file Excel yang sudah diisi untuk mengimpor data siswa secara massal.</p>
                        <div className="mt-6 flex flex-col sm:flex-row gap-4">
                            <button onClick={handleExport} className="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 text-center">
                                Unduh Template Data
                            </button>
                            <button onClick={triggerImport} className="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 text-center">
                                Unggah Data Siswa
                            </button>
                        </div>
                    </div>
                );
        }
    };

    return (
        <div className="space-y-6">
            <StudentModal 
                isOpen={isModalOpen} 
                onClose={() => setIsModalOpen(false)} 
                onSave={onSaveStudent}
                studentToEdit={studentToEdit}
            />
            <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileSelected}
                style={{ display: 'none' }}
                accept=".xlsx, .xls"
            />
            <div>
                <h2 className="text-3xl font-bold text-slate-800">Data Siswa</h2>
                <p className="mt-1 text-slate-600">
                    Kelola data identitas siswa di kelas {namaKelas || '(Nama Kelas Belum Diatur)'}.
                </p>
            </div>
             <div className="flex flex-wrap items-center gap-2">
                <button
                    key="daftar"
                    onClick={() => setActiveView('DAFTAR_SISWA')}
                    className={activeView === 'DAFTAR_SISWA' ? activeButtonClass : inactiveButtonClass}
                >
                    Daftar Siswa
                </button>
                <button
                    key="data"
                    onClick={() => setActiveView('DATA_SISWA')}
                    className={activeView === 'DATA_SISWA' ? activeButtonClass : inactiveButtonClass}
                >
                    Unduh/Unggah Data
                </button>
            </div>

            {renderContent()}
        </div>
    );
};

const DeskripsiNilaiView = ({ students, grades }) => {
    const [selectedSubject, setSelectedSubject] = useState(subjectKeys[0]);
    const [descriptions, setDescriptions] = useState({});
    const [isLoading, setIsLoading] = useState({});
    const [isGeneratingAll, setIsGeneratingAll] = useState(false);

    const ai = useMemo(() => new GoogleGenAI({ apiKey: process.env.API_KEY }), []);

    const handleDescriptionChange = (studentId, text) => {
        setDescriptions(prev => ({
            ...prev,
            [`${studentId}-${selectedSubject}`]: text,
        }));
    };

    const handleGenerate = useCallback(async (student) => {
        if (!selectedSubject) return;

        setIsLoading(prev => ({ ...prev, [student.id]: true }));

        try {
            const studentGradeData = grades.find(g => g.studentId === student.id);
            const grade = studentGradeData?.[selectedSubject];
            const subjectName = subjectFullNames[selectedSubject];

            if (grade === undefined || grade === null) {
                alert(`Nilai untuk ${student.namaLengkap} pada mapel ${subjectName} belum diisi.`);
                return;
            }

            const prompt = `Buatkan deskripsi penilaian rapor singkat dalam satu paragraf untuk siswa bernama ${student.namaLengkap} pada mata pelajaran ${subjectName}. Nilai yang diperoleh adalah ${grade}. Deskripsi harus positif, menyoroti pencapaian siswa, dan menyertakan kalimat motivasi untuk terus belajar. Tulis dalam Bahasa Indonesia.`;

            const response = await ai.models.generateContent({
                model: 'gemini-2.5-flash',
                contents: prompt,
            });

            const generatedText = response.text;
            setDescriptions(prev => ({
                ...prev,
                [`${student.id}-${selectedSubject}`]: generatedText.trim(),
            }));

        } catch (error) {
            console.error("Error generating description:", error);
            alert("Gagal menghasilkan deskripsi. Silakan periksa koneksi atau kunci API Anda dan coba lagi.");
        } finally {
            setIsLoading(prev => ({ ...prev, [student.id]: false }));
        }
    }, [selectedSubject, grades, ai.models]);

    const handleGenerateAll = useCallback(async () => {
        if (students.length === 0) return;
        setIsGeneratingAll(true);
        for (const student of students) {
            await handleGenerate(student);
        }
        setIsGeneratingAll(false);
    }, [students, handleGenerate]);

    useEffect(() => {
        setIsLoading({});
    }, [selectedSubject]);

    return (
        <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200 space-y-6">
            <div className="flex flex-col sm:flex-row justify-between sm:items-center gap-4 p-4 bg-slate-50 rounded-lg">
                <div>
                    <label htmlFor="subject-select" className="block text-sm font-medium text-slate-700 mb-1">Pilih Mata Pelajaran</label>
                    <select
                        id="subject-select"
                        value={selectedSubject}
                        onChange={e => setSelectedSubject(e.target.value)}
                        className="w-full sm:w-72 px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-slate-900"
                    >
                        {subjectKeys.map(key => (
                            <option key={key} value={key}>{subjectFullNames[key]}</option>
                        ))}
                    </select>
                </div>
                <button
                    onClick={handleGenerateAll}
                    disabled={isGeneratingAll || students.length === 0}
                    className="w-full sm:w-auto px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-lg shadow-sm hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed"
                >
                    {isGeneratingAll ? 'Menghasilkan...' : 'Hasilkan Semua Deskripsi'}
                </button>
            </div>

            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2 -mr-2">
                {students.length > 0 ? (
                    students.map(student => {
                        const grade = grades.find(g => g.studentId === student.id)?.[selectedSubject];
                        const descriptionKey = `${student.id}-${selectedSubject}`;
                        return (
                            <div key={student.id} className="p-4 border rounded-lg bg-slate-50/50">
                                <div className="flex justify-between items-center mb-2">
                                    <h4 className="font-semibold text-slate-800">{student.namaLengkap}</h4>
                                    <span className="text-sm font-medium text-slate-600 bg-slate-200 px-2 py-1 rounded">Nilai: {grade ?? 'N/A'}</span>
                                </div>
                                <textarea
                                    value={descriptions[descriptionKey] || ''}
                                    onChange={(e) => handleDescriptionChange(student.id, e.target.value)}
                                    placeholder="Deskripsi akan muncul di sini setelah dihasilkan..."
                                    className="w-full p-2 mt-2 text-sm bg-white border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-slate-900"
                                    rows={4}
                                    aria-label={`Deskripsi nilai untuk ${student.namaLengkap}`}
                                />
                                <div className="text-right mt-2">
                                    <button
                                        onClick={() => handleGenerate(student)}
                                        disabled={isLoading[student.id] || isGeneratingAll}
                                        className="px-3 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-100 border border-transparent rounded-md hover:bg-indigo-200 disabled:bg-slate-200 disabled:text-slate-500 disabled:cursor-not-allowed"
                                    >
                                        {isLoading[student.id] ? 'Memproses...' : 'Hasilkan'}
                                    </button>
                                </div>
                            </div>
                        )
                    })
                ) : (
                    <div className="text-center py-10 text-slate-500">
                        <p>Tidak ada siswa yang terdata. Silakan tambahkan siswa di halaman 'Data Siswa'.</p>
                    </div>
                )}
            </div>
        </div>
    );
};

const RentangView = ({ initialPredikats, onUpdate, namaKelas }) => {
    const [localPredikats, setLocalPredikats] = useState(initialPredikats);

    useEffect(() => {
        setLocalPredikats(initialPredikats);
    }, [initialPredikats]);

    const handleBlur = () => {
        onUpdate(localPredikats);
    };

    return (
      <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200 max-w-2xl mx-auto">
        <h3 className="text-xl font-bold text-slate-800">Rentang Nilai</h3>
        <p className="mt-2 text-sm text-slate-600">Masukkan rentang nilai yang sesuai pada kolom berikut. Perubahan akan disimpan secara otomatis.</p>
        
        <div className="mt-8 space-y-6">
            <div className="flex items-center justify-between gap-4">
                <label htmlFor="predikatA" className="text-sm font-medium text-slate-700 whitespace-nowrap">Predikat A (Mulai dari):</label>
                <input type="number" name="a" id="predikatA" value={localPredikats.a} onChange={(e) => setLocalPredikats(p => ({...p, a: e.target.value}))} onBlur={handleBlur} placeholder="cth. 90" className="w-32 text-center px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-slate-900" />
            </div>
            <div className="flex items-center justify-between gap-4">
                <label htmlFor="predikatB" className="text-sm font-medium text-slate-700 whitespace-nowrap">Predikat B (Mulai dari):</label>
                <input type="number" name="b" id="predikatB" value={localPredikats.b} onChange={(e) => setLocalPredikats(p => ({...p, b: e.target.value}))} onBlur={handleBlur} placeholder="cth. 80" className="w-32 text-center px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-slate-900" />
            </div>
             <div className="flex items-start justify-between gap-4">
                <label htmlFor="predikatC" className="text-sm font-medium text-slate-700 whitespace-nowrap pt-2">Predikat C (Mulai dari):</label>
                <div className="flex-shrink-0">
                    <input type="number" name="c" id="predikatC" value={localPredikats.c} onChange={(e) => setLocalPredikats(p => ({...p, c: e.target.value}))} onBlur={handleBlur} placeholder="cth. 70" className="w-32 text-center px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm placeholder-slate-400 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm text-slate-900" />
                    <p className="text-xs text-slate-500 mt-1 text-right">Nilai di bawah ini akan ditandai.</p>
                </div>
            </div>
        </div>
      </div>
    );
};

const DataNilaiPage = ({ students, grades, namaKelas, onUpdateGrade, onBulkUpdateGrades }) => {
  const [activeView, setActiveView] = useState('NILAI_KESELURUHAN');
  const [sortBy, setSortBy] = useState('no');
  const [predikats, setPredikats] = useState({ a: '90', b: '80', c: '70' });
  const [localGrades, setLocalGrades] = useState(grades);
  const [hasChanges, setHasChanges] = useState(false);
  const [uploadType, setUploadType] = useState('nilai');

  const fileInputRef = useRef(null);

  useEffect(() => {
    setLocalGrades(grades);
    setHasChanges(false);
  }, [grades, activeView]);

  const processedData = useMemo(() => {
    const gradesToUse = activeView === 'NILAI_KESELURUHAN' ? localGrades : grades;
    const dataWithCalculations = students.map((student, index) => {
      const studentGrades = gradesToUse.find(g => g.studentId === student.id) || { studentId: student.id };
      let total = 0;
      let subjectCount = 0;
      subjectKeys.forEach(key => {
        const grade = studentGrades[key];
        if (typeof grade === 'number') {
          total += grade;
          subjectCount++;
        }
      });
      const average = subjectCount > 0 ? total / subjectCount : 0;
      return {
        ...student,
        no: index + 1,
        grades: studentGrades,
        total,
        average,
        rank: 0, 
      };
    });

    const sortedByTotal = [...dataWithCalculations].sort((a, b) => b.total - a.total);
    const rankedData = sortedByTotal.map((student, index) => {
      let rank;
      if (index > 0 && student.total === sortedByTotal[index - 1].total) {
        rank = sortedByTotal[index - 1].rank;
      } else {
        rank = index + 1;
      }
      return { ...student, rank: student.total > 0 ? rank : '-' };
    });

    const dataWithRanks = dataWithCalculations.map(d => {
      const studentWithRank = rankedData.find(s => s.id === d.id);
      return { ...d, rank: studentWithRank?.rank || '-' };
    });

    if (sortBy === 'rank') {
      return dataWithRanks.sort((a, b) => {
        if (a.rank === '-') return 1;
        if (b.rank === '-') return -1;
        if ((a.rank) < (b.rank)) return -1;
        if ((a.rank) > (b.rank)) return 1;
        return a.no - b.no;
      });
    }
    
    return dataWithRanks.sort((a, b) => a.no - b.no);
  }, [students, grades, localGrades, sortBy, activeView]);

  const handleGradeChange = (studentId, subject, value) => {
    const numericValue = value === '' ? null : parseInt(value, 10);
    if (value === '' || (numericValue !== null && !isNaN(numericValue) && numericValue >= 0 && numericValue <= 100)) {
        setLocalGrades(prev => {
            const studentGradeIndex = prev.findIndex(g => g.studentId === studentId);
            const updatedGrades = [...prev];
            if (studentGradeIndex > -1) {
                const newGrade = { ...updatedGrades[studentGradeIndex], [subject]: numericValue };
                updatedGrades[studentGradeIndex] = newGrade;
            } else {
                updatedGrades.push({ studentId, [subject]: numericValue });
            }
            return updatedGrades;
        });
        setHasChanges(true);
    }
  };

  const handleSaveChanges = () => {
    onBulkUpdateGrades(localGrades);
    setHasChanges(false);
    alert('Perubahan nilai berhasil disimpan.');
  };

  const handleCancelChanges = () => {
    setLocalGrades(grades);
    setHasChanges(false);
  };
  
  const handleExportTemplate = useCallback(() => {
    if (typeof XLSX === 'undefined') {
        alert('Gagal memuat pustaka ekspor. Silakan coba lagi.');
        return;
    }

    const wb = XLSX.utils.book_new();

    const nilaiData = processedData.map(d => {
        const row = {
            "No": d.no,
            "Nama Siswa": d.namaLengkap,
        };
        subjectKeys.forEach(key => {
            row[subjectLabels[key]] = d.grades[key] ?? '';
        });
        row["Jumlah"] = d.total;
        row["Rata-rata"] = parseFloat(d.average.toFixed(2));
        row["Peringkat"] = d.rank;
        return row;
    });
    const wsNilai = XLSX.utils.json_to_sheet(nilaiData);
    wsNilai['!cols'] = [
        { wch: 5 }, { wch: 30 }, ...subjectKeys.map(() => ({ wch: 8 })), { wch: 10 }, { wch: 10 }, { wch: 10 }
    ];
    XLSX.utils.book_append_sheet(wb, wsNilai, "Nilai Keseluruhan");

    const academicSubjects = [
      'Pendidikan Agama dan Budi Pekerti (Buddha)', 'Pendidikan Agama dan Budi Pekerti (Hindu)',
      'Pendidikan Agama dan Budi Pekerti (Islam)', 'Pendidikan Agama dan Budi Pekerti (Katolik)',
      'Pendidikan Agama dan Budi Pekerti (Khonghucu)', 'Pendidikan Agama dan Budi Pekerti (Kristen)',
      'Pendidikan Pancasila', 'Bahasa Indonesia', 'Matematika', 'Ilmu Pengetahuan Alam dan Sosial',
      'Seni Budaya (Prakarya)', 'Seni Budaya (Seni Musik)', 'Seni Budaya (Seni Rupa)', 'Seni Budaya (Seni Tari)',
      'Pendidikan Jasmani, Olahraga, dan Kesehatan', 'Bahasa Inggris', 'Muatan Lokal (Bahasa Daerah)',
      'Muatan Lokal (Kearifan Lokal)', 'Muatan Lokal (Kerajinan Daerah)', 'Muatan Lokal (Seni Daerah)',
    ];
    const tpHeaders = ["No", "Nama Mapel", ...Array.from({ length: 28 }, (_, i) => `TP ${i + 1}`)];
    const tpData = academicSubjects.map((subject, index) => [index + 1, subject, ...Array(28).fill('')]);
    const wsTujuan = XLSX.utils.aoa_to_sheet([tpHeaders, ...tpData]);
    wsTujuan['!cols'] = [{ wch: 5 }, { wch: 45 }, ...Array(28).fill({ wch: 8 })];
    XLSX.utils.book_append_sheet(wb, wsTujuan, "Tujuan Pembelajaran");
    
    const deskripsiHeaders = ["No", "Nama Siswa", ...subjectKeys.map(key => `Deskripsi ${subjectFullNames[key]}`)];
    const deskripsiData = students.map((student, index) => {
        const row = [index + 1, student.namaLengkap];
        subjectKeys.forEach(() => row.push(''));
        return row;
    });
    const wsDeskripsi = XLSX.utils.aoa_to_sheet([deskripsiHeaders, ...deskripsiData]);
    wsDeskripsi['!cols'] = [{ wch: 5 }, { wch: 30 }, ...subjectKeys.map(() => ({ wch: 40 }))];
    XLSX.utils.book_append_sheet(wb, wsDeskripsi, "Deskripsi Rapor");

    const rentangData = [
        ["Predikat", "Nilai Minimum"],
        ["A", predikats.a],
        ["B", predikats.b],
        ["C", predikats.c]
    ];
    const wsRentang = XLSX.utils.aoa_to_sheet(rentangData);
    wsRentang['!cols'] = [{ wch: 15 }, { wch: 15 }];
    XLSX.utils.book_append_sheet(wb, wsRentang, "Rentang Nilai");

    XLSX.writeFile(wb, "Template_Lengkap_RKT.xlsx");
  }, [processedData, students, predikats]);

  const handleUpdatePredikats = (newPredikats) => {
    setPredikats(newPredikats);
  };

  const triggerFileUpload = (type) => {
    setUploadType(type);
    fileInputRef.current?.click();
  };

  const handleFileSelected = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const data = event.target?.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            
            if (uploadType === 'nilai') {
                const sheetName = workbook.SheetNames.find(name => name.toLowerCase().includes('nilai'));
                if (!sheetName) {
                    alert('Sheet "Data Nilai" tidak ditemukan di file Excel.');
                    return;
                }
                const worksheet = workbook.Sheets[sheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                const labelToKeyMap = {};
                Object.entries(subjectLabels).forEach(([key, label]) => {
                    labelToKeyMap[label] = key;
                });

                const newGrades = [];
                json.forEach(row => {
                    const studentName = row['Nama Siswa']?.trim();
                    if (!studentName) return;

                    const student = students.find(s => s.namaLengkap.trim().toLowerCase() === studentName.toLowerCase());

                    if (student) {
                        const studentGrade = { studentId: student.id };
                        Object.keys(row).forEach(header => {
                            const subjectKey = labelToKeyMap[header];
                            if (subjectKey) {
                                const gradeValue = row[header];
                                if (typeof gradeValue === 'number' && gradeValue >= 0 && gradeValue <= 100) {
                                    studentGrade[subjectKey] = gradeValue;
                                } else {
                                    studentGrade[subjectKey] = null;
                                }
                            }
                        });
                        newGrades.push(studentGrade);
                    }
                });

                if (newGrades.length > 0) {
                    onBulkUpdateGrades(newGrades);
                    alert(`${newGrades.length} data nilai siswa berhasil diimpor.`);
                } else {
                    alert('Tidak ada data nilai yang valid untuk diimpor. Pastikan nama siswa di file Excel sesuai dengan data di aplikasi.');
                }
            } else if (uploadType === 'tujuan') {
                alert('Fitur untuk mengimpor Tujuan Pembelajaran sedang dalam pengembangan.');
            }
        } catch (error) {
            console.error('Error processing Excel file:', error);
            alert('Terjadi kesalahan saat memproses file Excel.');
        } finally {
            if (e.target) e.target.value = '';
        }
    };
    reader.readAsBinaryString(file);
  };
  
  const inactiveButtonClass = "px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 transition-colors";
  const activeButtonClass = "px-4 py-2 text-sm font-medium text-white bg-indigo-700 border border-indigo-700 rounded-lg shadow-sm";

  const buttons = [
    { id: 'NILAI_KESELURUHAN', label: 'Nilai Keseluruhan' },
    { id: 'NILAI_PER_MAPEL', label: 'Nilai per Mapel' },
    { id: 'RENTANG', label: 'Rentang' },
    { id: 'TUJUAN_PEMBELAJARAN', label: 'Tujuan Pembelajaran' },
    { id: 'DESKRIPSI', label: 'Deskripsi' },
    { id: 'DATA_NILAI', label: 'Unggah/Unduh Data' },
  ];

  const renderContent = () => {
    switch(activeView) {
      case 'NILAI_KESELURUHAN':
        return (
          <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                  <div className="flex items-center">
                    <span className="text-sm font-medium text-slate-700 mr-4">Urutkan:</span>
                    <div className="flex items-center gap-4">
                        <label className="flex items-center cursor-pointer">
                            <input type="radio" name="sort" value="no" checked={sortBy === 'no'} onChange={() => setSortBy('no')} className="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500" aria-label="Urutkan berdasarkan Nomor Absen"/>
                            <span className="ml-2 text-sm text-slate-600">No. Absen</span>
                        </label>
                        <label className="flex items-center cursor-pointer">
                            <input type="radio" name="sort" value="rank" checked={sortBy === 'rank'} onChange={() => setSortBy('rank')} className="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500" aria-label="Urutkan berdasarkan Peringkat"/>
                            <span className="ml-2 text-sm text-slate-600">Peringkat</span>
                        </label>
                    </div>
                  </div>
                   {hasChanges && (
                      <div className="flex items-center gap-2">
                          <button onClick={handleCancelChanges} className="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50">Batal</button>
                          <button onClick={handleSaveChanges} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 border border-transparent rounded-lg shadow-sm hover:bg-indigo-700">Simpan Perubahan</button>
                      </div>
                  )}
              </div>
              <div className="overflow-x-auto">
                <table className="w-full text-sm text-left text-slate-500">
                  <thead className="text-xs text-slate-700 uppercase bg-slate-100">
                    <tr>
                      <th scope="col" className="px-3 py-3 w-10 text-center">{sortBy === 'rank' ? 'Peringkat' : 'No'}</th>
                      <th scope="col" className="px-6 py-3 min-w-[200px]">Nama Siswa</th>
                      {subjectKeys.map(key => (
                        <th key={key} scope="col" className="px-2 py-3 w-20 text-center" title={subjectFullNames[key]}>{subjectLabels[key]}</th>
                      ))}
                      <th scope="col" className="px-2 py-3 w-20 text-center">Jumlah</th>
                      <th scope="col" className="px-2 py-3 w-20 text-center">Rata-rata</th>
                    </tr>
                  </thead>
                  <tbody>
                    {processedData.length > 0 ? (
                      processedData.map((data) => (
                        <tr key={data.id} className="bg-white border-b hover:bg-slate-50">
                          <td className="px-3 py-2 text-center font-medium">{sortBy === 'rank' ? data.rank : data.no}</td>
                          <th scope="row" className="px-6 py-2 font-medium text-slate-900 whitespace-nowrap">{data.namaLengkap}</th>
                          {subjectKeys.map(key => {
                              const grade = data.grades[key];
                              const predicateCValue = parseInt(predikats.c, 10);
                              const isBelowC = !isNaN(predicateCValue) && typeof grade === 'number' && grade < predicateCValue;
                              return (
                                <td key={key} className="px-2 py-1">
                                  <input
                                    type="number"
                                    min="0"
                                    max="100"
                                    value={data.grades[key] ?? ''}
                                    onChange={(e) => handleGradeChange(data.id, key, e.target.value)}
                                    className={`w-16 p-2 text-center bg-slate-50 border border-slate-200 rounded-md focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-slate-100 ${isBelowC ? 'text-red-600 font-bold' : ''}`}
                                    aria-label={`Nilai ${subjectLabels[key]} untuk ${data.namaLengkap}`}
                                  />
                                </td>
                              );
                          })}
                          <td className="px-2 py-2 text-center font-semibold text-slate-800">{data.total}</td>
                          <td className="px-2 py-2 text-center font-semibold text-slate-800">{data.average.toFixed(2)}</td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan={subjectKeys.length + 4} className="text-center py-10 text-slate-500">
                          Belum ada data siswa. Silakan tambahkan siswa di halaman 'Data Siswa'.
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
          </div>
        );
      case 'DESKRIPSI':
        return <DeskripsiNilaiView students={students} grades={grades} />;
      case 'NILAI_PER_MAPEL':
        return (
          <div className="bg-white p-10 rounded-xl shadow-sm border border-slate-200 text-center">
            <h3 className="text-xl font-bold text-slate-800">Nilai per Mapel</h3>
            <p className="mt-4 text-slate-600 max-w-md mx-auto">
                Halaman ini sedang dalam pengembangan. Fitur untuk mengelola dan melihat nilai per mata pelajaran akan segera tersedia di sini.
            </p>
          </div>
        );
      case 'RENTANG': {
        return <RentangView initialPredikats={predikats} onUpdate={handleUpdatePredikats} namaKelas={namaKelas} />;
      }
      case 'TUJUAN_PEMBELAJARAN':
        return (
          <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
            <h3 className="text-xl font-bold text-slate-800">Tujuan Pembelajaran</h3>
            <p className="text-sm text-slate-500 mt-1">Unduh template lengkap untuk mengisi tujuan pembelajaran, atau unggah file yang sudah diisi.</p>
            <div className="mt-6 flex flex-col sm:flex-row gap-4">
                <button onClick={handleExportTemplate} className="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 text-center">
                    Unduh Template Lengkap
                </button>
                <button onClick={() => triggerFileUpload('tujuan')} className="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 text-center">
                    Unggah Template
                </button>
            </div>
          </div>
        );
      case 'DATA_NILAI':
        return (
          <div className="bg-white p-6 rounded-xl shadow-md border border-slate-200">
            <h3 className="text-xl font-bold text-slate-800">Unggah dan Unduh Data</h3>
            <p className="text-sm text-slate-500 mt-1">Unduh template lengkap yang berisi sheet untuk Nilai, Tujuan Pembelajaran, Deskripsi, dan Rentang. Atau unggah file Excel untuk mengimpor nilai.</p>
            <div className="mt-6 flex flex-col sm:flex-row gap-4">
                <button onClick={handleExportTemplate} className="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 text-center">
                    Unduh Template Lengkap
                </button>
                <button onClick={() => triggerFileUpload('nilai')} className="flex-1 px-4 py-3 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg shadow-sm hover:bg-slate-50 text-center">
                    Unggah Data Nilai
                </button>
            </div>
          </div>
        );
      default:
        return null;
    }
  };

  return (
    <div className="space-y-6">
      <input
        type="file"
        ref={fileInputRef}
        onChange={handleFileSelected}
        style={{ display: 'none' }}
        accept=".xlsx, .xls"
      />
      
      <div className="flex flex-col md:flex-row justify-between md:items-center gap-4">
        <div>
          <h2 className="text-3xl font-bold text-slate-800">Data Nilai</h2>
          <p className="mt-1 text-slate-600">Kelola nilai, deskripsi, dan tujuan pembelajaran siswa kelas {namaKelas || '(Belum Diatur)'}.</p>
        </div>
      </div>
      
       <div className="flex flex-wrap items-center gap-2">
        {buttons.map((button) => (
          <button
            key={button.id}
            onClick={() => setActiveView(button.id)}
            className={activeView === button.id ? activeButtonClass : inactiveButtonClass}
          >
            {button.label}
          </button>
        ))}
      </div>

      <div>
        {renderContent()}
      </div>
    </div>
  );
};

const Sidebar = ({ activePage, setActivePage, onExport, onImport }) => {
  const handleDataAction = (id) => {
    if (id === 'EKSPORT') {
      onExport();
    } else {
      onImport();
    }
  };
  
  return (
    <aside className="w-64 bg-white shadow-lg flex flex-col">
      <div className="flex items-center justify-center h-20 border-b px-4">
        <div className="text-center">
          <h1 className="text-3xl font-extrabold text-indigo-600 tracking-tight">RKT</h1>
          <p className="text-sm text-slate-500 font-medium tracking-wide mt-1">Rapor Kelas Terpadu</p>
        </div>
      </div>
      <nav className="flex-1 px-4 py-6 space-y-2">
        {NAV_ITEMS.map((item) => (
          <a
            key={item.id}
            href="#"
            onClick={(e) => {
              e.preventDefault();
              setActivePage(item.id);
            }}
            className={`block px-4 py-2.5 text-sm font-medium rounded-lg transition-colors duration-200 ${
              activePage === item.id
                ? 'bg-indigo-600 text-white shadow-md'
                : 'text-slate-600 hover:bg-slate-100'
            }`}
          >
            {item.label}
          </a>
        ))}
      </nav>
      <div className="px-4 py-6 border-t">
        <div className="space-y-2">
        {DATA_ACTIONS.map((action) => (
          <button
            key={action.id}
            onClick={() => handleDataAction(action.id)}
            className="w-full text-left px-4 py-2.5 text-sm font-medium text-slate-600 rounded-lg hover:bg-slate-100 transition-colors duration-200"
          >
            {action.label}
          </button>
        ))}
        </div>
      </div>
      <div className="px-4 py-4 mt-auto border-t">
        <div className="flex justify-between items-center text-xs text-slate-500">
          <a
            href="#"
            onClick={(e) => { e.preventDefault(); setActivePage('KETENTUAN_LAYANAN'); }}
            className="font-medium hover:text-indigo-600 transition-colors duration-200"
          >
            Ketentuan Layanan
          </a>
          <a
            href="#"
            onClick={(e) => { e.preventDefault(); setActivePage('KEBIJAKAN_PRIVASI'); }}
            className="font-medium hover:text-indigo-600 transition-colors duration-200"
          >
            Kebijakan Privasi
          </a>
        </div>
      </div>
    </aside>
  );
};

// --- END: Embedded Components ---

// --- START: Main App Component ---

const initialSettings = {
  nama_sekolah: '', npsn: '', alamat_sekolah: '', desa_kelurahan: '',
  kecamatan: '', provinsi: '', kode_pos: '', email_sekolah: '',
  telepon_sekolah: '', website_sekolah: '', faksimile: '', logo_sekolah: null,
  nama_kelas: '', tahun_ajaran: '', semester: '', tanggal_rapor: '',
  nama_kepala_sekolah: '', nip_kepala_sekolah: '', nama_wali_kelas: '', nip_wali_kelas: ''
};

const initialStudents = [
  {
      id: 1,
      namaLengkap: 'DUMMY RUMMY',
      namaPanggilan: 'DUMMY',
      nis: '1234',
      nisn: '12345678',
      tempatLahir: 'Jakarta',
      tanggalLahir: '2015-01-01',
      jenisKelamin: 'Laki-laki',
      agama: 'Islam',
      kewarganegaraan: 'Indonesia',
      statusDalamKeluarga: 'Anak Kandung',
      anakKe: '1',
      asalTk: 'TK Harapan Bangsa',
      alamatSiswa: 'Jl. Cendrawasih No. 10',
      namaAyah: 'Budi Santoso',
      namaIbu: 'Citra Lestari',
      pekerjaanAyah: 'Wiraswasta',
      pekerjaanIbu: 'Ibu Rumah Tangga',
      alamatOrangTua: 'Jl. Cendrawasih No. 10',
      teleponOrangTua: '081234567890',
      namaWali: '',
      pekerjaanWali: '',
      alamatWali: '',
      teleponWali: ''
  }
];

const initialGrades = [
    { studentId: 1 }
];


const App = () => {
  const [activePage, setActivePage] = useState('DASHBOARD');
  
  const [settings, setSettings] = useState(() => {
    try {
        const saved = localStorage.getItem('appSettings');
        return saved ? JSON.parse(saved) : initialSettings;
    } catch (e) {
        return initialSettings;
    }
  });
  const [students, setStudents] = useState(() => {
    try {
        const saved = localStorage.getItem('appStudents');
        return saved ? JSON.parse(saved) : initialStudents;
    } catch (e) {
        return initialStudents;
    }
  });
  const [grades, setGrades] = useState(() => {
    try {
        const saved = localStorage.getItem('appGrades');
        return saved ? JSON.parse(saved) : initialGrades;
    } catch (e) {
        return initialGrades;
    }
  });

  useEffect(() => {
    localStorage.setItem('appSettings', JSON.stringify(settings));
  }, [settings]);

  useEffect(() => {
    localStorage.setItem('appStudents', JSON.stringify(students));
  }, [students]);

  useEffect(() => {
    localStorage.setItem('appGrades', JSON.stringify(grades));
  }, [grades]);

  const handleSettingsChange = useCallback((e) => {
    const { name, value, files, type } = e.target;
    if (type === 'file' && files && files[0]) {
        const fileReader = new FileReader();
        fileReader.readAsDataURL(files[0]);
        fileReader.onload = () => {
            setSettings(prev => ({ ...prev, [name]: fileReader.result }));
        };
    } else {
        setSettings(prev => ({ ...prev, [name]: value }));
    }
  }, []);

  const saveSettings = useCallback(() => {
    alert('Pengaturan berhasil disimpan!');
  }, []);
  
  const handleSaveStudent = useCallback((studentData) => {
    setStudents(prev => {
        if (studentData.id) {
            return prev.map(s => s.id === studentData.id ? { ...s, ...studentData } : s);
        } else {
            const newId = prev.length > 0 ? Math.max(...prev.map(s => s.id)) + 1 : 1;
            const newStudent = { ...studentData, id: newId };
            setGrades(g_prev => [...g_prev, { studentId: newId }]);
            return [...prev, newStudent];
        }
    });
  }, []);

  const handleDeleteStudent = useCallback((studentId) => {
    setStudents(prev => prev.filter(s => s.id !== studentId));
    setGrades(prev => prev.filter(g => g.studentId !== studentId));
  }, []);
  
  const handleUpdateGrade = useCallback((studentId, subject, value) => {
    setGrades(prev => {
        const studentGradeIndex = prev.findIndex(g => g.studentId === studentId);
        if (studentGradeIndex > -1) {
            const updatedGrades = [...prev];
            const newGrade = { ...updatedGrades[studentGradeIndex], [subject]: value };
            updatedGrades[studentGradeIndex] = newGrade;
            return updatedGrades;
        }
        return [...prev, { studentId, [subject]: value }];
    });
  }, []);

  const handleBulkUpdateGrades = useCallback((newGrades) => {
    setGrades(prev => {
        const updatedGradesMap = new Map(prev.map(g => [g.studentId, g]));
        newGrades.filter(Boolean).forEach(newGrade => {
            const existing = updatedGradesMap.get(newGrade.studentId) || {};
            updatedGradesMap.set(newGrade.studentId, { ...existing, ...newGrade });
        });
        return Array.from(updatedGradesMap.values());
    });
  }, []);

  const handleExportAll = useCallback(() => {
    try {
        const data = { settings, students, grades };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `RKT_Backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (error) {
        console.error("Gagal mengekspor data:", error);
        alert("Gagal mengekspor data.");
    }
  }, [settings, students, grades]);

  const handleImportAll = useCallback(() => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target?.result);
                if (data.settings && data.students && data.grades) {
                    setSettings(data.settings);
                    setStudents(data.students);
                    setGrades(data.grades);
                    alert("Data berhasil diimpor!");
                } else {
                    alert("File impor tidak valid.");
                }
            } catch (error) {
                console.error("Gagal mengimpor data:", error);
                alert("Gagal membaca file impor.");
            }
        };
        reader.readAsText(file);
    };
    input.click();
  }, []);

  const renderPage = () => {
    switch (activePage) {
      case 'DASHBOARD':
        return <Dashboard setActivePage={setActivePage} settings={settings} students={students} />;
      case 'DATA_SISWA':
        return <DataSiswaPage students={students} namaKelas={settings.nama_kelas} onSaveStudent={handleSaveStudent} onDeleteStudent={handleDeleteStudent} />;
      case 'DATA_NILAI':
        return <DataNilaiPage students={students} grades={grades} namaKelas={settings.nama_kelas} onUpdateGrade={handleUpdateGrade} onBulkUpdateGrades={handleBulkUpdateGrades}/>;
      case 'PENGATURAN':
        return <SettingsPage settings={settings} onSettingsChange={handleSettingsChange} onSave={saveSettings} />;
      case 'KETENTUAN_LAYANAN':
        return <TermsPage />;
      case 'KEBIJAKAN_PRIVASI':
        return <PrivacyPage />;
      default:
        const navItem = NAV_ITEMS.find(item => item.id === activePage);
        return <PlaceholderPage title={navItem ? navItem.label : 'Halaman'} />;
    }
  };
  
  return (
    <div className="flex h-screen bg-slate-100 font-sans">
      <Sidebar
        activePage={activePage}
        setActivePage={setActivePage}
        onExport={handleExportAll}
        onImport={handleImportAll}
      />
      <main className="flex-1 p-6 lg:p-8 overflow-y-auto">
        {renderPage()}
      </main>
    </div>
  );
};

// --- END: Main App Component ---


// --- START: React Root Render ---

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

// --- END: React Root Render ---
    </script>
  </body>
</html>
